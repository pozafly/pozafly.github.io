<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.15.0"/><meta name="description" content="로컬에서는 되는데 배포하면 깨지던 Playwright PDF를, Docker 기반 환경 통제로 EKS까지 안정적으로 배포한 과정 정리." data-gatsby-head="true"/><meta property="og:site_name" content="Pozafly&#x27;s Blog" data-gatsby-head="true"/><meta property="og:type" content="article" data-gatsby-head="true"/><meta property="og:title" content="Playwright PDF 생성 환경을 EKS 기준으로 로컬에서 재현하는 방법(with Next.js)" data-gatsby-head="true"/><meta property="og:description" content="로컬에서는 되는데 배포하면 깨지던 Playwright PDF를, Docker 기반 환경 통제로 EKS까지 안정적으로 배포한 과정 정리." data-gatsby-head="true"/><meta property="og:url" content="https://pozafly.github.io/infrastructure/reproducing-nextjs-playwright-pdf-environment-for-eks/" data-gatsby-head="true"/><meta property="og:image" content="https://pozafly.github.io/static/9990ba7500d931bbb6c858b0a5da1e77/63766/main.webp" data-gatsby-head="true"/><meta property="article:published_time" content="2025-12-13T00:00:00.000Z" data-gatsby-head="true"/><meta property="article:tag" content="Infrastructure" data-gatsby-head="true"/><meta name="github:card" content="summary_large_image" data-gatsby-head="true"/><meta name="github:title" content="Playwright PDF 생성 환경을 EKS 기준으로 로컬에서 재현하는 방법(with Next.js)" data-gatsby-head="true"/><meta name="github:description" content="로컬에서는 되는데 배포하면 깨지던 Playwright PDF를, Docker 기반 환경 통제로 EKS까지 안정적으로 배포한 과정 정리." data-gatsby-head="true"/><meta name="github:url" content="https://pozafly.github.io/infrastructure/reproducing-nextjs-playwright-pdf-environment-for-eks/" data-gatsby-head="true"/><meta name="github:image" content="https://pozafly.github.io/static/9990ba7500d931bbb6c858b0a5da1e77/63766/main.webp" data-gatsby-head="true"/><meta name="github:label1" content="Written by" data-gatsby-head="true"/><meta name="github:data1" content="Pozafly" data-gatsby-head="true"/><meta name="github:label2" content="Filed under" data-gatsby-head="true"/><meta name="github:data2" content="Infrastructure" data-gatsby-head="true"/><meta name="github:site" content="@pozafly" data-gatsby-head="true"/><meta name="github:creator" content="@pozafly" data-gatsby-head="true"/><meta property="og:image:width" content="1" data-gatsby-head="true"/><meta property="og:image:height" content="0.5623931623931624" data-gatsby-head="true"/><style data-href="/styles.d4d27a32d6eda6a27949.css" data-identity="gatsby-global-css">@font-face{font-display:swap;font-family:Pretendard;font-weight:700;src:local("Pretendard Bold"),url(/fonts/pretendard/Pretendard-Bold.subset.woff2) format("woff2")}@font-face{font-display:swap;font-family:Pretendard;font-weight:600;src:local("Pretendard SemiBold"),url(/fonts/pretendard/Pretendard-SemiBold.subset.woff2) format("woff2")}@font-face{font-display:swap;font-family:Pretendard;font-weight:500;src:local("Pretendard Medium"),url(/fonts/pretendard/Pretendard-Medium.subset.woff2) format("woff2")}@font-face{font-display:swap;font-family:Pretendard;font-weight:400;src:local("Pretendard Regular"),url(/fonts/pretendard/Pretendard-Regular.subset.woff2) format("woff2")}@font-face{font-display:swap;font-family:Pretendard;font-weight:300;src:local("Pretendard Light"),url(/fonts/pretendard/Pretendard-Light.subset.woff2) format("woff2")}</style><link rel="icon" href="/favicon-32x32.png?v=a62d45ddbe29cf42da820a576d9375e1" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=a62d45ddbe29cf42da820a576d9375e1"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=a62d45ddbe29cf42da820a576d9375e1"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=a62d45ddbe29cf42da820a576d9375e1"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=a62d45ddbe29cf42da820a576d9375e1"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=a62d45ddbe29cf42da820a576d9375e1"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=a62d45ddbe29cf42da820a576d9375e1"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=a62d45ddbe29cf42da820a576d9375e1"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=a62d45ddbe29cf42da820a576d9375e1"/><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><style type="text/css">
    .auto-link.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .auto-link.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .auto-link svg,
    h2 .auto-link svg,
    h3 .auto-link svg,
    h4 .auto-link svg,
    h5 .auto-link svg,
    h6 .auto-link svg {
      visibility: hidden;
    }
    h1:hover .auto-link svg,
    h2:hover .auto-link svg,
    h3:hover .auto-link svg,
    h4:hover .auto-link svg,
    h5:hover .auto-link svg,
    h6:hover .auto-link svg,
    h1 .auto-link:focus svg,
    h2 .auto-link:focus svg,
    h3 .auto-link:focus svg,
    h4 .auto-link:focus svg,
    h5 .auto-link:focus svg,
    h6 .auto-link:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 100)
          }), 0)
        }
      }
    })
  </script><link rel="canonical" href="https://pozafly.github.io/infrastructure/reproducing-nextjs-playwright-pdf-environment-for-eks/" data-baseprotocol="https:" data-basehost="pozafly.github.io"/><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SLQNH3ND3J"></script><script>
      
      function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='G-SLQNH3ND3J',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
      if(!(navigator.doNotTrack == "1" || window.doNotTrack == "1")) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-SLQNH3ND3J', {"anonymize_ip":true,"cookie_expires":0,"send_page_view":false});
      }
      </script><link rel="preload" href="/fonts/pretendard/Pretendard-Bold.subset.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/pretendard/Pretendard-SemiBold.subset.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/pretendard/Pretendard-Medium.subset.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/pretendard/Pretendard-Regular.subset.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/pretendard/Pretendard-Light.subset.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><title data-gatsby-head="true">Playwright PDF 생성 환경을 EKS 기준으로 로컬에서 재현하는 방법(with Next.js)</title></head><body><script>
  (function() {
    window.__onThemeChange = function() {}; // 컴포넌트에서 정의할 테마 변경 콜백

    let preferredTheme; // 초기화에 사용할 테마
    try {
      const saved = localStorage.getItem('theme') // 로컬 스토리지에 있는 것 사용
      if (saved) {
        preferredTheme = saved.toLowerCase()
      }
    } catch (err) { }

    // 테마 설정 함수
    window.__setPreferredTheme = function(newTheme) {
      window.__theme = newTheme; // 테마는 전역 변수에 저장
      preferredTheme = newTheme;
      document.body.className = newTheme; // 바디에 클래스 추가
      window.__onThemeChange(newTheme); // 콜백 실행

      try {
        localStorage.setItem('theme', newTheme);
      } catch (err) {}
    }

    // 컬러모드 미디어 쿼리 객체를 가져온다
    const darkQuery = window.matchMedia('(prefers-color-scheme: dark)');

    // 컬러모드 변경 탐지 이벤트 리스터 추가
    darkQuery.addListener(function(e) {
      window.__setPreferredTheme(e.matches ? 'dark' : 'light')
    });

    // 테마 설정. 저장된 테마가 없으면 시스템 설정을 사용한다.
    window.__setPreferredTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'));
  })();
  </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="post-template"><style data-emotion="css-global 10pnfog">html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,dl,dt,dd,ol,fieldset,form,label,legend,article,aside,canvas,details,embed,figure,figcaption,footer,header,hgroup,menu,nav,output,ruby,section,summary,time,mark,audio,video{margin:0;padding:0;font:inherit;font-size:16px;vertical-align:baseline;border:0;}html .error-front-page,body .error-front-page,div .error-front-page,span .error-front-page,applet .error-front-page,object .error-front-page,iframe .error-front-page,h1 .error-front-page,h2 .error-front-page,h3 .error-front-page,h4 .error-front-page,h5 .error-front-page,h6 .error-front-page,p .error-front-page,blockquote .error-front-page,pre .error-front-page,a .error-front-page,abbr .error-front-page,acronym .error-front-page,address .error-front-page,big .error-front-page,cite .error-front-page,code .error-front-page,del .error-front-page,dfn .error-front-page,em .error-front-page,img .error-front-page,ins .error-front-page,kbd .error-front-page,q .error-front-page,s .error-front-page,samp .error-front-page,small .error-front-page,strike .error-front-page,strong .error-front-page,sub .error-front-page,sup .error-front-page,tt .error-front-page,var .error-front-page,dl .error-front-page,dt .error-front-page,dd .error-front-page,ol .error-front-page,fieldset .error-front-page,form .error-front-page,label .error-front-page,legend .error-front-page,article .error-front-page,aside .error-front-page,canvas .error-front-page,details .error-front-page,embed .error-front-page,figure .error-front-page,figcaption .error-front-page,footer .error-front-page,header .error-front-page,hgroup .error-front-page,menu .error-front-page,nav .error-front-page,output .error-front-page,ruby .error-front-page,section .error-front-page,summary .error-front-page,time .error-front-page,mark .error-front-page,audio .error-front-page,video .error-front-page{font-size:1.6rem;}html{overflow:hidden scroll;box-sizing:border-box;font-size:62.5%;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:rgb(0 0 0 / 0);}body{overflow-x:hidden;font-size:1.6rem;-moz-font-feature-settings:'liga' on;font-weight:400;font-style:normal;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;line-height:1.6em;color:var(--body-color);letter-spacing:0;background:var(--background-color);text-rendering:optimizeLegibility;word-break:break-word;}body::-webkit-scrollbar{width:6px;background-color:transparent;}body::-webkit-scrollbar-thumb{background-color:hsl(230 5% 35%);border-radius:8px;}body.light{--body-color:#303a3e;--background-color:#fff;--main-color:#000;--link-color:#0a0b0c;--border-top-color:#e4eaed;--nav-background:rgb(255 255 255 / 0.4);--nav-border-color:rgb(0 0 0 / 0.05);--header-color:var(--background-color);--header-after:var(--background-color);--header-before:rgb(0 0 0 / 0.15);--author-border:#fff;--home-header-color:#15171A;--home-header-border-bottom:#eaeff1;--header-author-link:#15171A;--no-image-border:#eaeff1;--strong-font-weight:600;--anchor-color:#0b63f0;--anchor-secondary-color:#768086;--loader-color:hsla(230 40% 10% / 0.8);--loader-color2:hsla(230 40% 10% / 0.2);--image-border-color:hsl(230 25% 94%);--image-border-color__dark:hsl(230 6% 23%);--post-card-title:rgb(21 23 26);--post-card-description:rgb(48 58 62);--post-card-by-line:#434952;--strong-color:#0a0b0c;--figcaption-color:#000;--table-first-of-type:linear-gradient(
        to right,
        rgb(255 255 255) 50%,
        rgb(255 255 255 / 0) 100%
      );--table-last-of-type:linear-gradient(
        to left,
        rgb(255 255 255) 50%,
        rgb(255 255 255 / 0) 100%
      );--table-th-background:#f4f8fb;--table-th-border:#e1edf4;--tag-boxshadow:hsl(218 53% 10% / 0.12);--tag-background:#f5f5f5;--post-full-border:#e4eaed;--post-full-meta-link:#2c3036;--post-full-meta-link-hover:#15171A;--post-full-title:#0b0c0e;--highlight-background:#fafafa;--highlight-border:#d1d1d1;--pre-code-color:#000;--little-code-background:var(--highlight-background);--little-code-border:#d1d1d1;--prism-background:hsl(0 0% 90.66%);--prism-border-left:hsl(0 0% 82.88%);--about-box-shadow:10px 10px 30px #bebebe,-10px -10px 30px #fff;--post-card-opacity:0;--post-card-background:rgb(0 0 0 / 0.1);--post-card-after-opacity:1;}body.dark{--body-color:rgba(255 255 255 / 0.75);--background-color:#191b1f;--main-color:#fff;--link-color:rgba(255 255 255 / 0.9);--border-top-color:#2b2f36;--nav-background:rgba(25 27 31 / 0.4);--nav-border-color:rgba(255 255 255 / 0.05);--header-color:#0a0b0c;--header-after:#191b1f;--header-before:rgba(0 0 0 / 0.6);--author-border:#1a1c20;--home-header-color:rgba(255 255 255 / 0.9);--home-header-border-bottom:#272a30;--header-author-link:rgba(255 255 255 / 0.75);--no-image-border:#3b4049;--strong-font-weight:500;--anchor-color:#2071f3;--anchor-secondary-color:#90a2aa;--loader-color:hsl(230 40% 90% / 0.8);--loader-color2:hsl(230 40% 90% / 0.2);--image-border-color:hsl(230 6% 23%);--image-border-color__dark:hsl(230 6% 23%);--post-card-title:rgba(255 255 255 / 0.85);--post-card-description:#768086;--post-card-by-line:rgba(255 255 255 / 0.75);--strong-color:#f2f2f2;--figcaption-color:rgba(255 255 255 / 0.6);--table-first-of-type:linear-gradient(
        to right,
        #191b1f 50%,
        #191b1f 100%
      );--table-last-of-type:linear-gradient(270deg, #191b1f 50%, rgb(25 27 31));--table-th-background:#2b2f36;--table-th-border:var(--table-th-background);--tag-background:#1f2125;--tag-boxshadow:#090f1a;--post-full-border:#3b4049;--post-full-meta-link:rgb(255 255 255 / 0.75);--post-full-meta-link-hover:#fff;--post-full-title:rgb(255 255 255 / 0.9);--highlight-background:rgb(32 36 39);--highlight-border:none;--pre-code-color:#c9d1d9;--little-code-background:rgb(96 98 100 / 0.4);--little-code-border:none;--prism-background:rgb(0 0 0 / 0.4);--prism-border-left:#818181;--about-box-shadow:10px 20px 20px hsl(0 0 0 / 0.3);--post-card-opacity:0.6;--post-card-background:rgb(0 0 0 / 0.3);--post-card-after-opacity:0.1;}html,body{font-family:Pretendard,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans','Ubuntu','Droid Sans','Helvetica Neue',sans-serif;}a{color:var(--anchor-color);-webkit-text-decoration:none;text-decoration:none;background-color:transparent;}a:hover{-webkit-text-decoration:underline;text-decoration:underline;}a:active,a:hover{outline:0;}ol,ul{max-width:100%;padding-left:1.3em;list-style:none;}blockquote,q{quotes:none;}blockquote:before,blockquote:after,q:before,q:after{content:none;}table{border-spacing:0;border-collapse:collapse;}img{max-width:100%;border:0;}*,*:before,*:after{box-sizing:inherit;}b,strong{font-weight:var(--strong-font-weight);}i,em,dfn{font-style:italic;}small{font-size:80%;}sub,sup{position:relative;font-size:75%;line-height:0;vertical-align:baseline;}sup{top:-0.5em;}sub{bottom:-0.25em;}mark{background-color:#fdffb6;}code,kbd,pre,samp{font-family:monospace;font-size:1em;}button,input,optgroup,select,textarea{margin:0;font:inherit;color:inherit;}button{overflow:visible;border:none;}button,select{text-transform:none;}button,html input[type='button'],input[type='reset'],input[type='submit']{cursor:pointer;-webkit-appearance:button;}button[disabled],html input[disabled]{cursor:default;}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0;}input{line-height:normal;}input:focus{outline:none;}input[type='checkbox'],input[type='radio']{box-sizing:border-box;padding:0;}input[type='number']::-webkit-inner-spin-button,input[type='number']::-webkit-outer-spin-button{height:auto;}input[type='search']{box-sizing:content-box;-webkit-appearance:textfield;}input[type='search']::-webkit-search-cancel-button,input[type='search']::-webkit-search-decoration{-webkit-appearance:none;}legend{padding:0;border:0;}textarea{resize:vertical;overflow:auto;}td,th{padding:0;}hr{position:relative;display:block;width:100%;height:1px;margin:2.5em 0 3.5em;padding:0;border:0;border-top:1px solid var(--border-top-color);}audio,canvas,iframe,img,svg,video{vertical-align:middle;}svg:not(:root){overflow:hidden;}fieldset{margin:0;padding:0;border:0;}p,ul,ol,dl,blockquote{margin:0 0 1.5em;}ul{list-style:disc;}ol{list-style:decimal;}ol ol,ul ul,ul ol,ol ul{margin:0.5em 0 1em;}li{margin:0.4em 0;padding-left:0.3em;line-height:1.6em;}dt{float:left;width:120px;margin:0 20px 0 0;font-weight:500;color:#15171A;text-align:right;}dd{margin:0 0 5px;text-align:left;}blockquote{margin:1.5em 0;padding:0 1.6em;border-left:#e5eff5 0.5em solid;}blockquote p{margin:0.8em 0;font-size:1.2em;font-weight:400;}blockquote small{display:inline-block;margin:0.8em 0 0.8em 1.5em;font-size:0.9em;opacity:0.8;}blockquote cite{font-weight:700;}blockquote cite a{font-weight:400;}h1,h2,h3,h4,h5,h6{margin-top:0;font-weight:600;line-height:1.15;text-rendering:optimizeLegibility;}h1 a.auto-link,h2 a.auto-link,h3 a.auto-link,h4 a.auto-link,h5 a.auto-link,h6 a.auto-link{box-shadow:none!important;}h1 a.auto-link:hover,h2 a.auto-link:hover,h3 a.auto-link:hover,h4 a.auto-link:hover,h5 a.auto-link:hover,h6 a.auto-link:hover{box-shadow:none!important;}h1 a.auto-link svg,h2 a.auto-link svg,h3 a.auto-link svg,h4 a.auto-link svg,h5 a.auto-link svg,h6 a.auto-link svg{opacity:0;fill:var(--link-color)!important;-webkit-transition:0.25s ease;transition:0.25s ease;}h1:hover a.auto-link svg,h2:hover a.auto-link svg,h3:hover a.auto-link svg,h4:hover a.auto-link svg,h5:hover a.auto-link svg,h6:hover a.auto-link svg{opacity:1;}h1{margin:0 0 0.5em;font-size:5.5rem;font-weight:600;}@media (max-width: 500px){h1{font-size:2.2rem;}}h2{margin:1.5em 0 0.5em;font-size:2.2rem;}@media (max-width: 500px){h2{font-size:1.8rem;}}h3{margin:1.5em 0 0.5em;font-size:1.8rem;font-weight:500;}@media (max-width: 500px){h3{font-size:1.7rem;}}h4{margin:1.5em 0 0.5em;font-size:1.6rem;font-weight:500;}h5{margin:1.5em 0 0.5em;font-size:1.4rem;font-weight:500;}h6{margin:1.5em 0 0.5em;font-size:1.4rem;font-weight:500;}.medium-zoom-overlay{-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);}.gatsby-resp-image-background-image{border-radius:6px;}.gatsby-resp-image-wrapper{margin:40px 0;}@media (max-width: 800px){.gatsby-resp-image-wrapper{width:100%;margin:initial;}}.medium-zoom-image{box-shadow:none!important;}.copyright{font-size:1.4rem;}.copyright a{font-size:inherit;}</style><style data-emotion="css vva9px">.css-vva9px .site-main{margin-top:64px;padding-bottom:4vw;background:var(--background-color);}</style><style data-emotion="css 163jdes">.css-163jdes{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100vh;}.css-163jdes .site-main{margin-top:64px;padding-bottom:4vw;background:var(--background-color);}</style><div class="css-163jdes e1xu36er0"><header class="site-header"><style data-emotion="css 1kbvt30">.css-1kbvt30{position:relative;padding:0 5vw;position:fixed;z-index:1000;top:0;right:0;left:0;background:var(--nav-background);-webkit-backdrop-filter:saturate(180%) blur(20px);backdrop-filter:saturate(180%) blur(20px);border-bottom:1px solid var(--nav-border-color);}</style><div class="css-1kbvt30"><style data-emotion="css 8aaawc">.css-8aaawc{width:100%;max-width:1040px;margin:0 auto;}</style><div class="css-8aaawc"><style data-emotion="css tetqay">.css-tetqay{position:relative;z-index:100;overflow-y:hidden;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;height:52px;font-size:1.3rem;}</style><nav class="css-tetqay"><style data-emotion="css qxzoul">.css-qxzoul{overflow:hidden;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1 0 auto;-ms-flex:1 0 auto;flex:1 0 auto;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin-right:10px;font-weight:500;text-transform:uppercase;letter-spacing:0.2px;white-space:nowrap;-webkit-overflow-scrolling:touch;-ms-overflow-scrolling:touch;}@media (max-width: 700px){.css-qxzoul{margin-right:0;}}</style><div class="site-nav-left css-qxzoul esgr0m44"><style data-emotion="css yn94hc">.css-yn94hc{position:relative;z-index:100;display:inline-block;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:32px;padding:12px 0;font-size:1.7rem;font-weight:700;line-height:1.8rem;color:#fff;text-transform:none;letter-spacing:-0.5px;}.css-yn94hc:hover{-webkit-text-decoration:none;text-decoration:none;}.css-yn94hc img{display:block;width:auto;height:21px;}@media (max-width: 700px){.css-yn94hc{margin-right:18px;}}</style><a class="site-nav-logo css-yn94hc" href="/"><img src="/static/a62d45ddbe29cf42da820a576d9375e1/aef42/alien.png" alt="Pozafly&#x27;s Blog" width="21" height="21"/></a><style data-emotion="css 1xdepn">.css-1xdepn{position:relative;-webkit-align-self:flex-start;-ms-flex-item-align:flex-start;align-self:flex-start;}</style><div class="css-1xdepn esgr0m43"><style data-emotion="css f30i1v">.css-f30i1v{position:absolute;z-index:1000;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin:0 0 0 -12px;padding:0;list-style:none;-webkit-transition:all 1s cubic-bezier(0.19, 1, 0.22, 1);transition:all 1s cubic-bezier(0.19, 1, 0.22, 1);}.css-f30i1v li{display:block;margin:0;padding:0;}.css-f30i1v li a{position:relative;display:block;padding:10px 12px;font-size:1.2rem;color:var(--main-color);opacity:0.7;-webkit-transition:opacity 0.2s ease-in-out;transition:opacity 0.2s ease-in-out;}@media (max-width: 700px){.css-f30i1v li a{padding:10px 8px;}}.css-f30i1v li a:hover{-webkit-text-decoration:none;text-decoration:none;opacity:1;}.css-f30i1v .nav-current{opacity:1;}</style><ul role="menu" class="css-f30i1v"><li role="menuitem"><a href="/">Home</a></li><li role="menuitem"><a href="/about/">About</a></li><li role="menuitem"><a href="/tags/">Tags</a></li><li role="menuitem"><a href="/tags/diary/">Diary</a></li></ul><style data-emotion="css 289bqd">.css-289bqd{position:absolute;top:10px;-webkit-transform:translateY(175%);-moz-transform:translateY(175%);-ms-transform:translateY(175%);transform:translateY(175%);font-size:1.7rem;font-weight:400;color:var(--main-color);text-transform:none;visibility:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(0.19, 1, 0.22, 1);transition:all 1s cubic-bezier(0.19, 1, 0.22, 1);}.css-289bqd .dash{left:-25px;}.css-289bqd .dash:before{content:'- ';opacity:0.5;}@media (max-width: 700px){.css-289bqd{overflow:hidden;max-width:calc(100vw - 126px);text-overflow:ellipsis;white-space:nowrap;}}</style><span class="nav-post-title css-289bqd esgr0m40">Playwright PDF 생성 환경을 EKS 기준으로 로컬에서 재현하는 방법(with Next.js)</span></div></div><style data-emotion="css 1wxq7hc">.css-1wxq7hc{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:0 1 auto;-ms-flex:0 1 auto;flex:0 1 auto;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;}</style><div class="css-1wxq7hc esgr0m42"><style data-emotion="css 150gfpr">.css-150gfpr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}@media (max-width: 700px){.css-150gfpr .not-mobile{display:none;}}</style><div class="css-150gfpr esgr0m41"><style data-emotion="css u4kwjs">.css-u4kwjs{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;margin:0;padding:10px;opacity:0.8;-webkit-transition:opacity 0.35s ease;transition:opacity 0.35s ease;}.css-u4kwjs:hover{opacity:1;}.css-u4kwjs svg{height:1.8rem;fill:var(--main-color);-webkit-transition:fill 0.45s ease;transition:fill 0.45s ease;}.css-u4kwjs.is-white svg{fill:#fff;}</style><a class="not-mobile css-u4kwjs" href="https://github.com/pozafly" title="Github" target="_blank" rel="noopener noreferrer"><svg width="21px" height="21px" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" transform="scale(64)"></path></svg></a><style data-emotion="css-global 8o55qm">body .theme-toggler{overflow:hidden;margin:6px;padding:2px;background:transparent;border-radius:50%;-webkit-transition:all 0.3s ease;transition:all 0.3s ease;}body .theme-toggler #switch{position:relative;overflow:hidden;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;width:21px;height:21px;padding:0;background:transparent;border:0;}body .theme-toggler .mode{position:relative;width:18px;height:18px;opacity:0.8;background:#000;-webkit-clip-path:path(
          'M17.5306 13.5882C16.6384 13.8558 15.689 14 14.7044 14C9.5004 14 5.28174 9.97061 5.28174 5.00005C5.28174 3.32422 5.76127 1.75538 6.59643 0.411865C2.77326 1.55853 0 4.96994 0 9.00001C0 13.9706 4.21866 18 9.42265 18C12.8721 18 15.8887 16.2296 17.5306 13.5882Z'
        );clip-path:path(
          'M17.5306 13.5882C16.6384 13.8558 15.689 14 14.7044 14C9.5004 14 5.28174 9.97061 5.28174 5.00005C5.28174 3.32422 5.76127 1.75538 6.59643 0.411865C2.77326 1.55853 0 4.96994 0 9.00001C0 13.9706 4.21866 18 9.42265 18C12.8721 18 15.8887 16.2296 17.5306 13.5882Z'
        );border-radius:50%;-webkit-transition:all 0.45s ease;transition:all 0.45s ease;}body .theme-toggler .mode:before{content:'';position:absolute;z-index:-1;top:50%;left:50%;-webkit-transform:translateX(-50%) translateY(-50%);-moz-transform:translateX(-50%) translateY(-50%);-ms-transform:translateX(-50%) translateY(-50%);transform:translateX(-50%) translateY(-50%);width:5px;height:5px;opacity:0;background:inherit;border-radius:50%;-webkit-transition:box-shadow 0.4s 0s ease;transition:box-shadow 0.4s 0s ease;}body .theme-toggler .mode:after{content:'';position:absolute;top:-20%;left:30%;width:90%;height:90%;background:rgb(255 255 255 / 1);border-radius:50%;-webkit-transition:all 0.3s ease;transition:all 0.3s ease;}body .theme-toggler .mode:hover{opacity:1;}body .theme-toggler:hover{background:rgb(215 215 215 / 0.9);}body .theme-toggler.is-white .mode{background:#fff;}body .theme-toggler.is-white:hover{background:rgb(215 215 215 / 0.2);}body.dark .theme-toggler{background:transparent;}body.dark .theme-toggler:hover{background:rgb(255 255 255 / 0.1);}body.dark .theme-toggler .mode{-webkit-transform:scale(0.5);-moz-transform:scale(0.5);-ms-transform:scale(0.5);transform:scale(0.5);overflow:initial;opacity:0.8;background:white;-webkit-clip-path:none;clip-path:none;}body.dark .theme-toggler .mode:before{opacity:1;box-shadow:0 -16px 0 0 white,0 16px 0 0 white,-16px 0 0 0 white,16px 0 0 0 white,12px 12px 0 0 white,12px -12px 0 0 white,-12px 12px 0 0 white,-12px -12px 0 0 white;}body.dark .theme-toggler .mode:after{-webkit-transform:translateX(50%) translateY(-50%);-moz-transform:translateX(50%) translateY(-50%);-ms-transform:translateX(50%) translateY(-50%);transform:translateX(50%) translateY(-50%);opacity:0;-webkit-transition:background 0.45s ease;transition:background 0.45s ease;}body.dark .theme-toggler.is-white .mode:before{box-shadow:0 -16px 0 0 white,0 16px 0 0 white,-16px 0 0 0 white,16px 0 0 0 white,12px 12px 0 0 white,12px -12px 0 0 white,-12px 12px 0 0 white,-12px -12px 0 0 white;}</style><button class="theme-toggler " aria-label="theme toggle button" type="button"><div id="switch"><div class="mode"></div></div></button></div></div></nav></div></div></header><style data-emotion="css 1h9yqcb">.css-1h9yqcb{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;position:relative;padding:0 5vw;}</style><main id="site-main" class="site-main css-1h9yqcb"><div class="css-8aaawc"><style data-emotion="css 150a24d">.css-150a24d{position:relative;}</style><article class="css-150a24d"><style data-emotion="css iltggy">.css-iltggy{position:relative;margin:0 auto;padding:70px 100px 50px;word-break:keep-all;border-top-left-radius:3px;border-top-right-radius:3px;}@media (max-width: 1170px){.css-iltggy{padding:60px 11vw 50px;}}@media (max-width: 800px){.css-iltggy{padding-right:5vw;padding-left:5vw;}}@media (max-width: 500px){.css-iltggy{padding:20px 0 35px;}}</style><header class="post-full-header css-iltggy edf4ga72"><style data-emotion="css 1njwbu9">.css-1njwbu9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:start;-ms-flex-pack:start;-webkit-justify-content:flex-start;justify-content:flex-start;font-size:1.2rem;font-weight:600;line-height:1.4em;color:#738a94;}.css-1njwbu9 a{font-size:1.2rem;color:var(--anchor-secondary-color);}</style><section class="post-full-tags css-1njwbu9 emmlh0d3"><a href="/tags/infrastructure/">Infrastructure</a>,  <a href="/tags/docker/">Docker</a>,  <a href="/tags/playwright/">Playwright</a></section><style data-emotion="css 18a1ftz">.css-18a1ftz{margin:0 0 0.2em;color:var(--post-full-title);word-break:keep-all;}@media (max-width: 500px){.css-18a1ftz{margin-top:0.2em;font-size:3.3rem;}}</style><h1 class="post-full-title css-18a1ftz edf4ga71">Playwright PDF 생성 환경을 EKS 기준으로 로컬에서 재현하는 방법(with Next.js)</h1><style data-emotion="css d62skr">.css-d62skr{margin:20px 0 0;font-size:2rem;font-weight:300;line-height:1.4em;color:var(--post-card-description);}@media (max-width: 500px){.css-d62skr{font-size:1.9rem;line-height:1.5em;}}</style><p class="post-full-custom-excerpt css-d62skr emmlh0d2">로컬에서는 되는데 배포하면 깨지던 Playwright PDF를, Docker 기반 환경 통제로 EKS까지 안정적으로 배포한 과정 정리.</p><style data-emotion="css sglr6c">.css-sglr6c{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;margin:35px 0 0;padding-top:15px;border-top:1px solid var(--post-full-border);}.css-sglr6c .post-full-byline-content{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}.css-sglr6c .post-full-byline-content .author-list{-webkit-box-pack:start;-ms-flex-pack:start;-webkit-justify-content:flex-start;justify-content:flex-start;padding:0 12px 0 0;}.css-sglr6c .post-full-byline-meta{margin:2px 0 0;font-size:1.4rem;line-height:1.2em;color:#768086;letter-spacing:0.2px;}.css-sglr6c .post-full-byline-meta .author-name{margin:0 0 3px;font-size:1.4rem;font-weight:500;line-height:1.3em;}.css-sglr6c .post-full-byline-meta .author-name a{font-size:13px;color:var(--post-full-meta-link);}.css-sglr6c .post-full-byline-meta .author-name a:hover{color:var(--post-full-meta-link-hover);}.css-sglr6c .post-full-byline-meta .byline-reading-time,.css-sglr6c .post-full-byline-meta .byline-meta-date,.css-sglr6c .post-full-byline-meta .byline-modified-time{font-size:13px;}.css-sglr6c .post-full-byline-meta .bull{display:inline-block;margin:0 4px;opacity:0.6;}</style><div class="post-full-byline css-sglr6c emmlh0d1"><section class="post-full-byline-content"><style data-emotion="css 12fmpzj">.css-12fmpzj{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin:0 0 0 4px;padding:0;list-style:none;}</style><ul class="author-list css-12fmpzj emmlh0d0"><style data-emotion="css 4q5div">.css-4q5div{position:relative;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin:0;padding:0;}.css-4q5div:hover .author-name-tooltip{-webkit-transform:translate(-10px, -2px);-moz-transform:translate(-10px, -2px);-ms-transform:translate(-10px, -2px);transform:translate(-10px, -2px);opacity:1;}</style><li class="author-list-item css-4q5div e13xkhp00"><style data-emotion="css aezf96">.css-aezf96{overflow:hidden;display:block;width:40px;height:40px;margin:0 -4px;border:2px solid var(--author-border);border-radius:100%;}@media (max-width: 500px){.css-aezf96{width:36px;height:36px;}}</style><a class="author-avatar css-aezf96" href="/about/"><style data-emotion="css 1ip6e3z">.css-1ip6e3z{display:block;width:100%;height:100%;object-fit:cover;background:var(--background-color);border-radius:100%;}.css-1ip6e3z img{border-radius:100%;}</style><div data-gatsby-image-wrapper="" class="gatsby-image-wrapper author-profile-image css-1ip6e3z"><div aria-hidden="true" style="padding-top:100%"></div><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear;background-color:#6808f8;position:absolute;top:0;left:0;bottom:0;right:0"></div><picture><source type="image/webp" data-srcset="/static/8c061761f263c344f2c0416607c8adf1/ae5f4/pozafly.webp 40w,/static/8c061761f263c344f2c0416607c8adf1/87ddd/pozafly.webp 80w,/static/8c061761f263c344f2c0416607c8adf1/2988d/pozafly.webp 120w" sizes="100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="100vw" decoding="async" loading="lazy" data-src="/static/8c061761f263c344f2c0416607c8adf1/b9493/pozafly.jpg" data-srcset="/static/8c061761f263c344f2c0416607c8adf1/5e3dc/pozafly.jpg 40w,/static/8c061761f263c344f2c0416607c8adf1/d18de/pozafly.jpg 80w,/static/8c061761f263c344f2c0416607c8adf1/b9493/pozafly.jpg 120w" alt="Pozafly"/></picture><noscript><picture><source type="image/webp" srcSet="/static/8c061761f263c344f2c0416607c8adf1/ae5f4/pozafly.webp 40w,/static/8c061761f263c344f2c0416607c8adf1/87ddd/pozafly.webp 80w,/static/8c061761f263c344f2c0416607c8adf1/2988d/pozafly.webp 120w" sizes="100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="100vw" decoding="async" loading="lazy" src="/static/8c061761f263c344f2c0416607c8adf1/b9493/pozafly.jpg" srcSet="/static/8c061761f263c344f2c0416607c8adf1/5e3dc/pozafly.jpg 40w,/static/8c061761f263c344f2c0416607c8adf1/d18de/pozafly.jpg 80w,/static/8c061761f263c344f2c0416607c8adf1/b9493/pozafly.jpg 120w" alt="Pozafly"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div></a></li></ul><section class="post-full-byline-meta"><div class="author-name"><a href="/about/">Pozafly</a></div><div class="byline-meta-content"><time class="byline-meta-date" dateTime="2025-12-13"> <!-- -->2025-12-13</time><span class="byline-reading-time"><span class="bull">•</span>21 min read</span></div></section></section></div></header><style data-emotion="css 1y1xnji">.css-1y1xnji{width:80%;max-height:800px;margin:25px auto 100px;-webkit-background-size:cover;background-size:cover;}.css-1y1xnji .image-wrapper{overflow:hidden;width:100%;border:1px solid var(--image-border-color);border-radius:8px;}.css-1y1xnji .image-wrapper img{border-radius:8px;}@media (max-width: 1170px){.css-1y1xnji .image-wrapper img{max-width:1170px;}}@media (max-width: 800px){.css-1y1xnji{width:100%;margin:25px auto 60px;}}</style><figure class="css-1y1xnji e16cwxex1"><div class="image-wrapper"><div data-gatsby-image-wrapper="" style="height:100%" class="gatsby-image-wrapper"><div aria-hidden="true" style="padding-top:56.23931623931624%"></div><img aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear" decoding="async" src="data:image/webp;base64,UklGRqwAAABXRUJQVlA4IKAAAAAQBACdASoUAAsAPm0qkUWkIqGYBABABsSgCdAYw61bS/YRfeeJuMdAAAD++vgTrYPnqteIiXOdoeneNNQtSXBJ9v+Z4eAUc+KxOyIY4Maf7CadQU7SfY2M6bYpmUZy46AWXEPq8YwLNk/R6gd9eq/7N8nqj+HOyYqRJ+drSRVCdsai03zbYcH4VT5i7BLj7/ITeZTY+AJ6ABOH0Ad2sAAA" alt=""/><picture><source type="image/avif" data-srcset="/static/9990ba7500d931bbb6c858b0a5da1e77/b400f/main.avif 500w,/static/9990ba7500d931bbb6c858b0a5da1e77/4ec68/main.avif 800w,/static/9990ba7500d931bbb6c858b0a5da1e77/d4b7e/main.avif 1170w" sizes="100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="100vw" decoding="async" loading="lazy" data-src="/static/9990ba7500d931bbb6c858b0a5da1e77/63766/main.webp" data-srcset="/static/9990ba7500d931bbb6c858b0a5da1e77/d4cbf/main.webp 500w,/static/9990ba7500d931bbb6c858b0a5da1e77/03a08/main.webp 800w,/static/9990ba7500d931bbb6c858b0a5da1e77/63766/main.webp 1170w" alt="Playwright PDF 생성 환경을 EKS 기준으로 로컬에서 재현하는 방법(with Next.js)"/></picture><noscript><picture><source type="image/avif" srcSet="/static/9990ba7500d931bbb6c858b0a5da1e77/b400f/main.avif 500w,/static/9990ba7500d931bbb6c858b0a5da1e77/4ec68/main.avif 800w,/static/9990ba7500d931bbb6c858b0a5da1e77/d4b7e/main.avif 1170w" sizes="100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="100vw" decoding="async" loading="lazy" src="/static/9990ba7500d931bbb6c858b0a5da1e77/63766/main.webp" srcSet="/static/9990ba7500d931bbb6c858b0a5da1e77/d4cbf/main.webp 500w,/static/9990ba7500d931bbb6c858b0a5da1e77/03a08/main.webp 800w,/static/9990ba7500d931bbb6c858b0a5da1e77/63766/main.webp 1170w" alt="Playwright PDF 생성 환경을 EKS 기준으로 로컬에서 재현하는 방법(with Next.js)"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div></div><style data-emotion="css 2cqlea">.css-2cqlea{max-width:728px;margin:10px auto;font-size:12px;text-align:center;}.css-2cqlea a,.css-2cqlea span{font-size:12px;color:var(--anchor-secondary-color);}@media (max-width: 800px){.css-2cqlea{font-size:11px;}.css-2cqlea a,.css-2cqlea span{font-size:11px;}}</style><figcaption class="css-2cqlea e16cwxex0">Background photo by <a href="https://unsplash.com/ko/@theshubhamdhage" target="_blank" rel="noreferrer">Shubham Dhage</a> <!-- -->on<!-- --> <a href="https://unsplash.com" target="_blank" rel="noreferrer">Unsplash</a></figcaption></figure><style data-emotion="css 13di0oz">.css-13di0oz *:not(pre)>code[class*='language-']{border-radius:0.3em;background:var(--little-code-background);border:1px solid var(--little-code-border);color:var(--main-color);padding:0.15em 0.5em;white-space:normal;font-size:13px;}@media (max-width: 800px){.css-13di0oz *:not(pre)>code[class*='language-']{display:inline;}}.css-13di0oz .gatsby-highlight-code-line{display:block;margin-right:-1.3125rem;margin-left:-1.3125rem;padding-right:1em;padding-left:1.25em;border-left:0.25em solid var(--prism-border-left);font-size:1.4rem;background-image:linear-gradient(90deg, var(--prism-background) 60%, rgba(0, 0, 0, 0) 100%),none!important;}.css-13di0oz .gatsby-highlight{margin-bottom:1.75rem;margin-left:-1.3125rem;margin-right:-1.3125rem;border-radius:10px;background:var(--highlight-background);box-shadow:inset 0 0 0 1px var(--highlight-border);-webkit-overflow-scrolling:touch;overflow:auto;}.css-13di0oz .gatsby-highlight pre[class*='language-']{float:left;min-width:100%;font-size:1.4rem;line-height:24px;}.css-13di0oz pre[class*='language-'],.css-13di0oz code[class*='language-']{color:var(--pre-code-color);text-shadow:none;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;}.css-13di0oz pre[class*='language-']::-webkit-scrollbar,.css-13di0oz code[class*='language-']::-webkit-scrollbar{background-color:transparent;height:4px;}.css-13di0oz pre[class*='language-']::-webkit-scrollbar-thumb,.css-13di0oz code[class*='language-']::-webkit-scrollbar-thumb{border-radius:8px;background-color:hsla(230, 5%, 35%, 1);}@media (max-width: 800px){.css-13di0oz pre[class*='language-'],.css-13di0oz code[class*='language-']{display:inline-block;}}.css-13di0oz pre[class*='language-']{overflow:auto;}.css-13di0oz .token{font-size:1.4rem;}.css-13di0oz pre[data-line]{padding:1em 0 1em 3em;position:relative;}@media print{.css-13di0oz pre[class*='language-'],.css-13di0oz code[class*='language-']{text-shadow:none;}}.css-13di0oz pre[class*='language-']{padding:1em;overflow:auto;margin:0;}.css-13di0oz:not(pre)>code[class*='language-']{padding:0.1em 0.3em;border-radius:0.3em;color:#c9d1d9;background:#343942;}.css-13di0oz pre[data-line]{position:relative;}.css-13di0oz pre[class*='language-']>code[class*='language-']{position:relative;z-index:1;}.css-13di0oz .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:#2f2a1e;box-shadow:inset 5px 0 0 #674c16;z-index:0;pointer-events:none;line-height:inherit;white-space:pre;}.css-13di0oz .namespace{opacity:0.7;}.css-13di0oz .token.comment,.css-13di0oz .token.prolog,.css-13di0oz .token.doctype,.css-13di0oz .token.cdata{color:#8b949e;}.css-13di0oz .token.punctuation{color:#c9d1d9;}.css-13di0oz .token.property,.css-13di0oz .token.tag,.css-13di0oz .token.boolean,.css-13di0oz .token.number,.css-13di0oz .token.constant,.css-13di0oz .token.symbol,.css-13di0oz .token.deleted{color:#79c0ff;}.css-13di0oz .token.selector,.css-13di0oz .token.attr-name,.css-13di0oz .token.string,.css-13di0oz .token.char,.css-13di0oz .token.builtin,.css-13di0oz .token.inserted{color:#a5d6ff;}.css-13di0oz .token.operator,.css-13di0oz .token.entity,.css-13di0oz .token.url,.css-13di0oz .language-css .token.string,.css-13di0oz .style .token.string{color:#a5d6ff;}.css-13di0oz .token.atrule,.css-13di0oz .token.attr-value,.css-13di0oz .token.keyword{color:#a5d6ff;}.css-13di0oz .token.function{color:#d2a8ff;}.css-13di0oz .token.regex,.css-13di0oz .token.important,.css-13di0oz .token.variable{color:#a8daff;}.css-13di0oz .token.important,.css-13di0oz .token.bold{font-weight:bold;}.css-13di0oz .token.italic{font-style:italic;}.css-13di0oz .token.entity{cursor:help;}</style><style data-emotion="css 1x2k2ne">.css-1x2k2ne{position:relative;min-height:230px;margin:0 auto;padding:0 100px 6vw;font-size:2rem;line-height:1.6em;background:var(--background-color);border-radius:6px;}.css-1x2k2ne .no-image{padding-top:0;}.css-1x2k2ne h1,.css-1x2k2ne h2,.css-1x2k2ne h3,.css-1x2k2ne h4,.css-1x2k2ne h5,.css-1x2k2ne h6,.css-1x2k2ne p,.css-1x2k2ne ul,.css-1x2k2ne ol,.css-1x2k2ne dl,.css-1x2k2ne pre,.css-1x2k2ne blockquote,.css-1x2k2ne .post-full-comments,.css-1x2k2ne .footnotes{min-width:100%;margin:0 0 1.5em;}.css-1x2k2ne li>ul,.css-1x2k2ne li>ol{margin:0;}.css-1x2k2ne li{word-break:break-word;}.css-1x2k2ne li p{margin:0;}.css-1x2k2ne a[class*='image'],.css-1x2k2ne a[class*='image']:hover{box-shadow:none;}.css-1x2k2ne a[class*='image'] span[class*='image'],.css-1x2k2ne a[class*='image']:hover span[class*='image']{border-radius:6px;}.css-1x2k2ne strong,.css-1x2k2ne em{color:var(--strong-color);}.css-1x2k2ne small{display:inline-block;line-height:1.6em;}.css-1x2k2ne img,.css-1x2k2ne video{display:block;max-width:840px;height:auto;margin:2em auto;border:1px solid var(--image-border-color);border-radius:8px;}.css-1x2k2ne hr+p{margin-top:1.2em;}.css-1x2k2ne img[src$='#full']{width:100vw;max-width:none;}.css-1x2k2ne img+br+small{display:block;margin-top:-3em;margin-bottom:1.5em;text-align:center;}.css-1x2k2ne iframe{margin:10px auto 20px;}.css-1x2k2ne blockquote{margin:0 0 1.5em;padding:0 1.5em;border-left:3px solid var(--image-border-color);}.css-1x2k2ne blockquote p{margin:0 0 1em;font-size:inherit;font-style:italic;line-height:inherit;color:inherit;}.css-1x2k2ne blockquote p:last-child{margin-bottom:0;}.css-1x2k2ne code{padding:0 5px 2px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans','Ubuntu','Droid Sans','Helvetica Neue',sans-serif;font-size:0.8em;font-weight:400!important;line-height:1em;border-radius:3px;}.css-1x2k2ne p code{word-break:keep-all;}.css-1x2k2ne pre{overflow-x:auto;max-width:100%;padding:20px;font-size:1.4rem;line-height:1.5em;color:#e5eff5;border-radius:5px;}.css-1x2k2ne pre code{padding:0;font-size:inherit;line-height:inherit;background:transparent;}.css-1x2k2ne pre code :not(span){color:inherit;}.css-1x2k2ne .fluid-width-video-wrapper{margin:1.5em 0 3em;}.css-1x2k2ne hr{margin:2em 0;}.css-1x2k2ne h1,.css-1x2k2ne h2,.css-1x2k2ne h3,.css-1x2k2ne h4,.css-1x2k2ne h5,.css-1x2k2ne h6{color:var(--home-header-color);}.css-1x2k2ne h1{margin:0.5em 0 0.4em;font-size:4.2rem;font-weight:600;line-height:1.25em;}.css-1x2k2ne p+h1{margin-top:0.8em;}.css-1x2k2ne h2{margin:1.2em 0 0.6em;font-size:3.4rem;font-weight:600;line-height:1.25em;}.css-1x2k2ne p+h2{margin-top:0.8em;}.css-1x2k2ne h3{margin:1rem 0 0.2em;padding-top:1.8rem;font-size:2.6rem;font-weight:600;line-height:1.3em;}.css-1x2k2ne h2+h3{margin-top:0.7em;}.css-1x2k2ne h4{margin:1em 0 0.2em;font-size:2rem;font-weight:800;}.css-1x2k2ne h2+h4{margin-top:0.7em;}.css-1x2k2ne h3+h4{margin-top:0;}.css-1x2k2ne h5{display:block;margin:0.5em 0;font-size:1.8rem;font-weight:600;line-height:1.35em;border:0;}.css-1x2k2ne h6{margin:0.5em 0 0.2em;font-size:2rem;font-weight:700;}.css-1x2k2ne table{overflow-x:auto;display:inline-block;border-spacing:0;border-collapse:collapse;width:auto;max-width:100%;margin:0.5em 0 2.5em;font-size:1.6rem;white-space:nowrap;vertical-align:top;background:radial-gradient(ellipse at left, rgb(0 0 0 / 0.2) 0%, rgb(0 0 0 / 0) 75%) 0 center,radial-gradient(ellipse at right, rgb(0 0 0 / 0.2) 0%, rgb(0 0 0 / 0) 75%) 100% center;background-repeat:no-repeat;background-attachment:scroll,scroll;-webkit-background-size:10px 100%,10px 100%;background-size:10px 100%,10px 100%;-webkit-overflow-scrolling:touch;}.css-1x2k2ne table th{font-size:1.2rem;font-weight:700;color:var(--home-header-color);text-align:left;text-transform:uppercase;letter-spacing:0.2px;background-color:var(--table-th-background);}.css-1x2k2ne table th,.css-1x2k2ne table td{padding:6px 12px;border:var(--table-th-border) 1px solid;}.css-1x2k2ne table td:first-of-type{background-image:var(--table-first-of-type);background-repeat:no-repeat;-webkit-background-size:20px 100%;background-size:20px 100%;}.css-1x2k2ne table td:last-child{background-image:var(--table-last-of-type);background-repeat:no-repeat;-webkit-background-position:100% 0;background-position:100% 0;-webkit-background-size:20px 100%;background-size:20px 100%;}.css-1x2k2ne figcaption{color:var(--figcaption-color);}@media (max-width: 1170px){.css-1x2k2ne{padding:0 11vw;}}@media (max-width: 800px){.css-1x2k2ne{padding:0 5vw;font-size:1.8rem;}}@media (max-width: 500px){.css-1x2k2ne{padding:0;}}@media (max-width: 500px){.css-1x2k2ne .post-full-custom-excerpt{font-size:1.9rem;line-height:1.5em;}}@media (max-width: 500px){.css-1x2k2ne p,.css-1x2k2ne ul,.css-1x2k2ne ol,.css-1x2k2ne dl,.css-1x2k2ne pre,.css-1x2k2ne .post-full-comments,.css-1x2k2ne .footnotes{margin-bottom:1.28em;}}@media (max-width: 1040px){.css-1x2k2ne img,.css-1x2k2ne video{width:100%;}}@media (max-width: 500px){.css-1x2k2ne blockquote{padding:0 1.3em;}}@media (max-width: 800px){.css-1x2k2ne h1{font-size:3.2rem;line-height:1.25em;}.css-1x2k2ne h2{margin:0.5rem 0 0.3em;font-size:2.8rem;line-height:1.25em;}.css-1x2k2ne h3{margin:0.5rem 0 0.3em;font-size:2.4rem;line-height:1.3em;}.css-1x2k2ne h4{margin-bottom:0.3em;font-size:1.8rem;line-height:1.3em;}.css-1x2k2ne h5{max-width:1060px;padding:0 0 0.5em;font-size:2.4rem;text-align:initial;}.css-1x2k2ne h6{font-size:1.8rem;line-height:1.4em;}}.css-1x2k2ne *:not(pre)>code[class*='language-']{border-radius:0.3em;background:var(--little-code-background);border:1px solid var(--little-code-border);color:var(--main-color);padding:0.15em 0.5em;white-space:normal;font-size:13px;}@media (max-width: 800px){.css-1x2k2ne *:not(pre)>code[class*='language-']{display:inline;}}.css-1x2k2ne .gatsby-highlight-code-line{display:block;margin-right:-1.3125rem;margin-left:-1.3125rem;padding-right:1em;padding-left:1.25em;border-left:0.25em solid var(--prism-border-left);font-size:1.4rem;background-image:linear-gradient(90deg, var(--prism-background) 60%, rgba(0, 0, 0, 0) 100%),none!important;}.css-1x2k2ne .gatsby-highlight{margin-bottom:1.75rem;margin-left:-1.3125rem;margin-right:-1.3125rem;border-radius:10px;background:var(--highlight-background);box-shadow:inset 0 0 0 1px var(--highlight-border);-webkit-overflow-scrolling:touch;overflow:auto;}.css-1x2k2ne .gatsby-highlight pre[class*='language-']{float:left;min-width:100%;font-size:1.4rem;line-height:24px;}.css-1x2k2ne pre[class*='language-'],.css-1x2k2ne code[class*='language-']{color:var(--pre-code-color);text-shadow:none;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;}.css-1x2k2ne pre[class*='language-']::-webkit-scrollbar,.css-1x2k2ne code[class*='language-']::-webkit-scrollbar{background-color:transparent;height:4px;}.css-1x2k2ne pre[class*='language-']::-webkit-scrollbar-thumb,.css-1x2k2ne code[class*='language-']::-webkit-scrollbar-thumb{border-radius:8px;background-color:hsla(230, 5%, 35%, 1);}@media (max-width: 800px){.css-1x2k2ne pre[class*='language-'],.css-1x2k2ne code[class*='language-']{display:inline-block;}}.css-1x2k2ne pre[class*='language-']{overflow:auto;}.css-1x2k2ne .token{font-size:1.4rem;}.css-1x2k2ne pre[data-line]{padding:1em 0 1em 3em;position:relative;}@media print{.css-1x2k2ne pre[class*='language-'],.css-1x2k2ne code[class*='language-']{text-shadow:none;}}.css-1x2k2ne pre[class*='language-']{padding:1em;overflow:auto;margin:0;}.css-1x2k2ne:not(pre)>code[class*='language-']{padding:0.1em 0.3em;border-radius:0.3em;color:#c9d1d9;background:#343942;}.css-1x2k2ne pre[data-line]{position:relative;}.css-1x2k2ne pre[class*='language-']>code[class*='language-']{position:relative;z-index:1;}.css-1x2k2ne .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:#2f2a1e;box-shadow:inset 5px 0 0 #674c16;z-index:0;pointer-events:none;line-height:inherit;white-space:pre;}.css-1x2k2ne .namespace{opacity:0.7;}.css-1x2k2ne .token.comment,.css-1x2k2ne .token.prolog,.css-1x2k2ne .token.doctype,.css-1x2k2ne .token.cdata{color:#8b949e;}.css-1x2k2ne .token.punctuation{color:#c9d1d9;}.css-1x2k2ne .token.property,.css-1x2k2ne .token.tag,.css-1x2k2ne .token.boolean,.css-1x2k2ne .token.number,.css-1x2k2ne .token.constant,.css-1x2k2ne .token.symbol,.css-1x2k2ne .token.deleted{color:#79c0ff;}.css-1x2k2ne .token.selector,.css-1x2k2ne .token.attr-name,.css-1x2k2ne .token.string,.css-1x2k2ne .token.char,.css-1x2k2ne .token.builtin,.css-1x2k2ne .token.inserted{color:#a5d6ff;}.css-1x2k2ne .token.operator,.css-1x2k2ne .token.entity,.css-1x2k2ne .token.url,.css-1x2k2ne .language-css .token.string,.css-1x2k2ne .style .token.string{color:#a5d6ff;}.css-1x2k2ne .token.atrule,.css-1x2k2ne .token.attr-value,.css-1x2k2ne .token.keyword{color:#a5d6ff;}.css-1x2k2ne .token.function{color:#d2a8ff;}.css-1x2k2ne .token.regex,.css-1x2k2ne .token.important,.css-1x2k2ne .token.variable{color:#a8daff;}.css-1x2k2ne .token.important,.css-1x2k2ne .token.bold{font-weight:bold;}.css-1x2k2ne .token.italic{font-style:italic;}.css-1x2k2ne .token.entity{cursor:help;}</style><section class="post-full-content css-1x2k2ne edf4ga70"><div class="post-content"><p>PDF를 유저에게 보여줘야 하는 일이 생겼다. PDF 생성은 전통적인 방법으로 SpringBoot의 라이브러리(OpenHTMLtoPDF등)를 사용해 서버에서 생성하는 방법이 있다. 하지만, 유저에게 보여주어야 할 PDF가 단순히 문자열로만 구성된 것이 아니라 복잡한 layout과 다양한 CSS 기법이 적용되어야 했다. 또한, 유저에 따라 동적인 layout이 적용되어야 했다.</p>
<p>SpringBoot의 PDF 라이브러리는 text만 표시하지 않고 HTML을 렌더링해서 PDF 형식으로 만들어내는 방법도 존재했지만, CSS 지원이 제한적이라 미묘한 깨짐이 발생할 수 있다. 그리고 복잡한 layout의 PDF는 FE쪽 리소스를 투입하는게 낫다.</p>
<p>FE에서 PDF를 생성할 수 있는 라이브러리로, <a href="https://pptr.dev/" target="_blank" rel="nofollow">Puppeteer</a>, <a href="https://playwright.dev/" target="_blank" rel="nofollow">Playwright</a>와 같은 Headless Browser를 이용해 렌더링 하는 방법이 떠올랐다. Playwright를 선택한 이유는 앞으로 Playwright로 E2E Testing을 할 계획을 가지고 있기도 했고, Playwright를 이전 Puppeteer 개발자 주도해 만들었기 때문이다(사실 아주 거창한 이유는 없다).</p>
<p>Nextjs를 사용하고 있기 때문에 Node 영역에서 Playwright의 Headless Browser를 구동시켜 페이지를 렌더링 시키고, 그 페이지를 PDF로 만들어내면 되겠다. 자세한 기법은 추후 블로깅 할 생각.</p>
<p>이번 글은 개발을 끝낸 뒤, 이걸 어떻게 배포 환경까지 안정적으로 가져갔는지에 대한 기록이다. 특히 ‘로컬에서는 되는데 배포에서는 깨지는’ 문제를 피하기 위해 실행 환경을 통제하고, 재현 가능한 형태로 굳혀간 과정을 정리한다.</p>
<h2 id="얻어갈-수-있는-것" style="position:relative;">얻어갈 수 있는 것<a href="#%EC%96%BB%EC%96%B4%EA%B0%88-%EC%88%98-%EC%9E%88%EB%8A%94-%EA%B2%83" aria-label="얻어갈 수 있는 것 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<ul>
<li>Playwright 실행 환경(브라우저/OS 의존성/폰트)을 <strong>Base 이미지로 고정</strong>하는 방법</li>
<li>로컬에서 배포 환경과 유사하게 재현하는 <strong>로컬 Docker 테스트 패턴</strong></li>
<li>Playwright npm 버전 변화에 맞춰 <strong>Base 이미지 버전과 Dockerfile FROM을 자동 갱신</strong>하는 방법</li>
<li>Docker build cache / tag 문제를 피하는 <strong>timestamp 태깅 전략</strong></li>
<li>이미지 이동/적재(docker save/load + gzip)로 <strong>외부 다운로드 의존성 제거</strong></li>
</ul>
<h2 id="전제" style="position:relative;">전제<a href="#%EC%A0%84%EC%A0%9C" aria-label="전제 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>이 글은 Next.js 기반 애플리케이션의 복잡한 PDF 생성 모듈을 Playwright를 사용하여 Docker/Kubernetes(EKS) 환경에 배포하는 과정을 다룬다. 아래 기술들에 대한 간단한 이해가 있다면 내용을 더 쉽게 파악할 수 있다.</p>
<ul>
<li><strong>Next.js (Page Router / Standalone)</strong>: next build 이후 standalone 아티팩트가 어떤 식으로 서버를 구성하는지</li>
<li><strong>Playwright</strong>: Headless Browser(Chromium)를 제어해서 페이지를 렌더링하고 PDF를 생성한다는 개념</li>
<li><strong>Docker</strong>: Dockerfile, 이미지/컨테이너, FROM/ARG/ENV/USER 같은 기본 문법과 컨테이너 네트워크</li>
<li><strong>ECR/EKS</strong>: 이미지 push/pull, 그리고 그 이미지를 기반으로 Pod가 뜬다는 흐름</li>
<li><strong>CI/CD</strong>: GitHub Actions로 빌드→이미지 생성→레지스트리 push→배포까지 이어지는 전체 흐름</li>
<li><strong>기본 쉘 명령</strong>: apt-get, sed, gzip, docker save/load 같은 명령의 역할</li>
</ul>
<h2 id="환경" style="position:relative;">환경<a href="#%ED%99%98%EA%B2%BD" aria-label="환경 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<h3 id="FE" style="position:relative;">FE<a href="#FE" aria-label="FE permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<ul>
<li>Next.js (Page Router)</li>
<li>Playwright</li>
</ul>
<h3 id="Deployment" style="position:relative;">Deployment<a href="#Deployment" aria-label="Deployment permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<ul>
<li><a href="https://nextjs.org/docs/app/api-reference/config/next-config-js/output#automatically-copying-traced-files" target="_blank" rel="nofollow">Nextjs Standalone</a></li>
<li>GitHub Actions</li>
<li>Docker / ECR(Amazon Elastic Container Registry)</li>
<li>EKS(Amazon Elastic Kubernetes Service)</li>
</ul>
<p>아래는 현재 CI/CD 배포 파이프라인이다.</p>
<div class="gatsby-highlight" data-language="mermaid"><pre class="language-mermaid"><code class="language-mermaid"><span class="token keyword">sequenceDiagram</span>
    actor Developer
    <span class="token keyword">participant</span> GitHub
    <span class="token keyword">participant</span> Actions Runner
    <span class="token keyword">participant</span> ECR
    <span class="token keyword">participant</span> EKS

    Developer <span class="token arrow operator">->></span> GitHub<span class="token operator">:</span> FE commit <span class="token text string">(Push)</span>
    GitHub <span class="token arrow operator">-->></span> Actions Runner<span class="token operator">:</span> Workflow Trigger
    <span class="token keyword">activate</span> Actions Runner

    Actions Runner <span class="token arrow operator">->></span> Actions Runner<span class="token operator">:</span> nextjs build <span class="token text string">(Standalone Artifacts 생성)</span>
    Actions Runner <span class="token arrow operator">->></span> Actions Runner<span class="token operator">:</span> Docker build 시작 <span class="token text string">(Dockerfile 실행)</span>

    Actions Runner <span class="token arrow operator">->></span> ECR<span class="token operator">:</span> Base Image Pull <span class="token text string">(FROM)</span>
    ECR <span class="token arrow operator">-->></span> Actions Runner<span class="token operator">:</span> Base Image 제공

    Actions Runner <span class="token arrow operator">->></span> Actions Runner<span class="token operator">:</span> Nextjs Artifacts Copy <span class="token text string">(COPY)</span>
    Actions Runner <span class="token arrow operator">->></span> Actions Runner<span class="token operator">:</span> 새로운 Docker Image 생성 완료
    Actions Runner <span class="token arrow operator">->></span> ECR<span class="token operator">:</span> Docker Image Push
    ECR <span class="token arrow operator">-->></span> Actions Runner<span class="token operator">:</span> Image Push Success

    Actions Runner <span class="token arrow operator">->></span> EKS<span class="token operator">:</span> 배포 요청
    EKS <span class="token arrow operator">-->></span> EKS<span class="token operator">:</span> 새로운 Image로 Deployment/Pod 업데이트
    <span class="token keyword">deactivate</span> Actions Runner</code></pre></div>
<br/>
<h2 id="PDF가-유저에게-도달하는-흐름-요약" style="position:relative;">PDF가 유저에게 도달하는 흐름 (요약)<a href="#PDF%EA%B0%80-%EC%9C%A0%EC%A0%80%EC%97%90%EA%B2%8C-%EB%8F%84%EB%8B%AC%ED%95%98%EB%8A%94-%ED%9D%90%EB%A6%84-%EC%9A%94%EC%95%BD" aria-label="PDF가 유저에게 도달하는 흐름 요약 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<div class="gatsby-highlight" data-language="mermaid"><pre class="language-mermaid"><code class="language-mermaid"><span class="token keyword">sequenceDiagram</span>
    <span class="token keyword">autonumber</span>
    actor 사용자
    <span class="token keyword">participant</span> Page as PDF렌더링 페이지&lt;br/><span class="token text string">(PdfViewer)</span>
    <span class="token keyword">participant</span> API as API Routes
    <span class="token keyword">participant</span> Headless as Playwright&lt;br/><span class="token text string">(Headless Chrome)</span>
    <span class="token keyword">participant</span> Backend as 백엔드 API&lt;br/><span class="token text string">(SpringBoot)</span>

    사용자<span class="token arrow operator">->></span>Page<span class="token operator">:</span> /pdf/something 접속
    Page<span class="token arrow operator">->></span>API<span class="token operator">:</span> PDF 요청
    API<span class="token arrow operator">->></span>Headless<span class="token operator">:</span> 헤드리스 브라우저 오픈
    Headless<span class="token arrow operator">->></span>Backend<span class="token operator">:</span> SSR PDF 데이터 API 호출
    Backend<span class="token arrow operator">-->></span>Headless<span class="token operator">:</span> 데이터 응답
    Headless<span class="token arrow operator">->></span>Headless<span class="token operator">:</span> 1. SSR 페이지 오픈&lt;br/>2. PDF Buffer 생성
    Headless<span class="token arrow operator">-->></span>API<span class="token operator">:</span> PDF Buffer 응답
    API<span class="token arrow operator">->></span>Page<span class="token operator">:</span> PDF Buffer 전달
    Page<span class="token arrow operator">->></span>사용자<span class="token operator">:</span> 환경에 따라 Blob<span class="token text string">(네이티브 뷰어)</span>&lt;br/>혹은 pdf.js<span class="token text string">(Canvas)</span>로 렌더링</code></pre></div>
<p>API Routes 영역부터는 Node.js Runtime 영역이다.</p>
<ul>
<li>서버(Node)에서 Playwright로 Headless Chromium을 구동한다.</li>
<li>Headless Browser가 Next.js로 배포된 “PDF 렌더링 페이지”를 연다.</li>
<li>해당 페이지는 SSR 과정에서 백엔드(SpringBoot)로부터 데이터를 받아 렌더링된다.</li>
<li>Playwright는 렌더링 결과를 PDF로 변환(<code class="language-text">page.pdf()</code>)한다.</li>
<li>생성된 PDF 바이너리를 API Routes가 받아 유저 브라우저로 내려준다.</li>
</ul>
<h2 id="Playwright-구성-요소" style="position:relative;">Playwright 구성 요소<a href="#Playwright-%EA%B5%AC%EC%84%B1-%EC%9A%94%EC%86%8C" aria-label="Playwright 구성 요소 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>먼저, Playwright를 사용하기 위해서는 3가지를 알고 있어야 한다.</p>
<ul>
<li><strong>playwright 패키지</strong>: 브라우저를 제어하는 코드(런타임 라이브러리)</li>
<li><strong>브라우저 바이너리(Chromium 등)</strong>: 실제 실행 엔진</li>
<li><strong>브라우저 시스템 종속성(OS Dependencies)</strong>: 브라우저가 뜨기 위해 필요한 OS 라이브러리/폰트/로케일 등</li>
</ul>
<p>비유를 들면,</p>
<ul>
<li>Playwright 패키지 = 운전자 + 운전 매뉴얼</li>
<li>브라우저 바이너리 = 실제 자동차</li>
<li>OS 종속성 = 자동차가 달릴 수 있는 도로(기반 환경)</li>
</ul>
<p>PDF는 결과물이라서, 이 3개 중 하나라도 흔들리면 <strong>폰트/간격/줄바꿈 같은 것이 달라진다.</strong> 즉, PDF는 코드만 맞추면 끝나는 문제가 아니라 <strong>실행 환경까지 같이 고정해야</strong> 한다.</p>
<h3 id="브라우저-시스템-종속성OS-Dependencies" style="position:relative;">브라우저 시스템 종속성(OS Dependencies)<a href="#%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EC%A2%85%EC%86%8D%EC%84%B1OS-Dependencies" aria-label="브라우저 시스템 종속성OS Dependencies permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<h4 id="local-환경mac" style="position:relative;">local 환경(mac)<a href="#local-%ED%99%98%EA%B2%BDmac" aria-label="local 환경mac permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h4>
<p>local에서 개발할 때는 <code class="language-text">$ npx playwright install chromium</code> 명령어로 local에 headless browser를 설치할 수 있다. 이때 CDN으로 <code class="language-text">https://cdn.playwright.dev/dbazure/download/playwright/builds/chromium/1187/chromium-mac-arm64.zip</code> 경로를 통해 자동으로 바이너리를 받아온다(맥의 경우임, OS마다 다른 바이너리 파일을 다운 받음).</p>
<p>브라우저 시스템 종속성은 local 환경에서는 다운 받을 필요 없다. 브라우저 실행에 필요한 OS 라이브러리가 이미 OS 자체에 있기 때문이다.</p>
<h4 id="배포-환경docker-container---linux" style="position:relative;">배포 환경(docker container - linux)<a href="#%EB%B0%B0%ED%8F%AC-%ED%99%98%EA%B2%BDdocker-container---linux" aria-label="배포 환경docker container   linux permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h4>
<p>배포 환경은 Docker 이미지를 생성하고 실행하지만, <strong>외부 네트워크 접근에 제약이 있는 환경(내부망)이다.</strong> 이로 인해 다음과 같은 문제가 존재함.</p>
<ol>
<li><code class="language-text">npx playwright install</code> 명령어를 통한 <strong>브라우저 바이너리(Chromium) 다운로드 불가.</strong></li>
<li>Playwright가 요구하는 <strong>운영체제 종속성(OS Dependencies) 설치 및 버전 관리의 어려움.</strong> (내부 저장소 부재, 환경 통제의 필요성)</li>
</ol>
<p><a href="https://playwright.dev/docs/docker" target="_blank" rel="nofollow">playwright의 공식 문서에서 docker 이미지</a>를 따로 제공하고 있다는 걸 알게 되었다. 이 이미지는 headless browser 바이너리와 브라우저 시스템 종속성을 포함하고 있다. 따라서 이미지를 빌드할 때 일일이 바이너리와 종속성을 따로 받지 않아도 된다. 따라서 Nextjs 빌드 결과물을 이 이미지에 입혀 EKS pod에 배포하면 되는 것이다.</p>
<h2 id="문제-발생" style="position:relative;">문제 발생<a href="#%EB%AC%B8%EC%A0%9C-%EB%B0%9C%EC%83%9D" aria-label="문제 발생 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>처음에는 공식 Playwright Docker 이미지를 쓰면 다 해결될 것이라고 생각했다. 실제로 공식 이미지는 브라우저 바이너리와 대부분의 OS 의존성을 포함하고 있고, Playwright가 기대하는 디렉토리 구조나 권한도 맞춰져 있다.</p>
<p>그런데 배포 환경에서 돌려보니, 로컬에서 멀쩡하던 PDF가 깨지거나, 오류가 발생했다.</p>
<ul>
<li>브라우저 실행 경로 문제(/ms-playwright 하위 경로 등)</li>
<li>브라우저 콘솔 에러, 렌더링 타이밍 이슈</li>
<li>SSR에서 백엔드 호출 URL/네트워크 설정 문제</li>
<li>한글 폰트/이모지 렌더링 문제</li>
<li>쿠키/세션 처리 문제, user-agent 차이 등</li>
</ul>
<p>세부 오류는 여기서 다 풀지는 않겠지만 공식 이미지 만으로는 결과물이 고정되지 않는다. 브라우저/폰트/아키텍처/환경변수/네트워크가 조금만 달라도 PDF는 달라진다.</p>
<p>그래서 완벽히 동일하진 않더라도, 최소한 <strong>로컬에서 배포 환경과 유사한 조건을 강제</strong>할 수 있어야 디버깅이 가능하다고 판단했다. 이게 Part 1(로컬 Docker 환경 구축)을 시작한 이유다.</p>
<h2 id="Part-1-로컬-Docker-환경-구축" style="position:relative;">Part 1: 로컬 Docker 환경 구축<a href="#Part-1-%EB%A1%9C%EC%BB%AC-Docker-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%B6%95" aria-label="Part 1 로컬 Docker 환경 구축 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<h3 id="Step-1-code-classlanguage-textdockerDockerfilelocalcode-신규-생성" style="position:relative;">Step 1. <code class="language-text">docker/Dockerfile.local</code> (신규 생성)<a href="#Step-1-code-classlanguage-textdockerDockerfilelocalcode-%EC%8B%A0%EA%B7%9C-%EC%83%9D%EC%84%B1" aria-label="Step 1 code classlanguage textdockerDockerfilelocalcode 신규 생성 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>기존 <code class="language-text">docker/Dockerfile</code> 은 프로덕션 배포용이었기 때문에, 로컬 테스트를 위해 별도의 Dockerfile을 만든다. <code class="language-text">Dockerfile.local</code> 파일을 작성한다.</p>
<div class="gatsby-highlight" data-language="docker"><pre class="language-docker"><code class="language-docker"><span class="token comment">#	Dockerfile.local</span>

<span class="token comment"># 로컬 Docker 테스트용 Dockerfile (playwright 1.46.1 사용)</span>
<span class="token instruction"><span class="token keyword">FROM</span> mcr.microsoft.com/playwright:v1.46.1-jammy <span class="token keyword">AS</span> base</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>

<span class="token instruction"><span class="token keyword">EXPOSE</span> 3000</span>
<span class="token instruction"><span class="token keyword">ENV</span> PORT=3000</span>
<span class="token instruction"><span class="token keyword">ENV</span> HOST=0.0.0.0</span>

<span class="token instruction"><span class="token keyword">COPY</span> public ./public</span>
<span class="token instruction"><span class="token keyword">COPY</span> .next/standalone ./</span>
<span class="token instruction"><span class="token keyword">COPY</span> .next/static ./.next/static</span>

<span class="token instruction"><span class="token keyword">USER</span> root</span>
<span class="token instruction"><span class="token keyword">RUN</span> mkdir -p .next/cache &amp;&amp; chown -R pwuser:pwuser .next</span>

<span class="token instruction"><span class="token keyword">USER</span> pwuser</span>

<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">"node"</span>, <span class="token string">"server.js"</span>]</span></code></pre></div>
<h3 id="세부-설명" style="position:relative;">세부 설명<a href="#%EC%84%B8%EB%B6%80-%EC%84%A4%EB%AA%85" aria-label="세부 설명 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p><strong><code class="language-text">FROM mcr.microsoft.com/playwright:v1.46.1-jammy</code></strong></p>
<ul>
<li>Microsoft 공식 Playwright 이미지 사용</li>
<li>npm에 설치된 Playwright 버전과 <strong>명시적으로 맞춘다</strong></li>
<li>브라우저 바이너리와 OS 종속성을 직접 설치하지 않아도 됨</li>
</ul>
<p><strong><code class="language-text">ENV HOST=0.0.0.0</code></strong></p>
<ul>
<li>Next.js 서버를 모든 네트워크 인터페이스에 바인딩</li>
<li>컨테이너 내부에서 들어오는 요청을 정상적으로 받기 위함</li>
</ul>
<p><strong><code class="language-text">USER pwuser</code></strong></p>
<ul>
<li>Playwright 공식 이미지에 포함된 일반 사용자</li>
<li>root로 실행하지 않도록 기본 보안 설정 유지</li>
<li>단, .next/cache 디렉토리는 root에서 권한만 미리 맞춰준다</li>
</ul>
<h3 id="Step-2-code-classlanguage-textenvlocal-dockercode-신규-생성" style="position:relative;">Step 2. <code class="language-text">.env.local-docker</code> (신규 생성)<a href="#Step-2-code-classlanguage-textenvlocal-dockercode-%EC%8B%A0%EA%B7%9C-%EC%83%9D%EC%84%B1" aria-label="Step 2 code classlanguage textenvlocal dockercode 신규 생성 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>로컬 개발 서버(pnpm dev)와 Docker 컨테이너에서 실행되는 서버는 네트워크 구조가 완전히 다르다. 그래서 기존 .env.localhost를 그대로 쓰면 의도하지 않은 문제가 생긴다.</p>
<p>Docker 환경 전용으로 <code class="language-text">.env.local-docker</code> 를 따로 만들었다.</p>
<div class="gatsby-highlight" data-language="env"><pre class="language-env"><code class="language-env"># .env.local-docker
NEXT_PUBLIC_APP_ENV=local-docker
NEXT_PUBLIC_BROWSER_API_URL=http://localhost:3000
NEXT_PUBLIC_INTERNAL_API_URL=...
NEXT_PUBLIC_PDF_INTERNAL_URL=http://host.docker.internal:3000
SERVER_API_URL=...</code></pre></div>
<div class="gatsby-highlight" data-language="env"><pre class="language-env"><code class="language-env"># .env.local
NEXT_PUBLIC_APP_ENV=localhost
NEXT_PUBLIC_BROWSER_API_URL=http://localhost:3000
NEXT_PUBLIC_INTERNAL_API_URL=http://localhost:3000
NEXT_PUBLIC_PDF_INTERNAL_URL=http://localhost:3000
SERVER_API_URL=...</code></pre></div>
<h4 id="envlocal-docker-설명" style="position:relative;">.env.local-docker 설명<a href="#envlocal-docker-%EC%84%A4%EB%AA%85" aria-label="envlocal docker 설명 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h4>
<p><strong><code class="language-text">NEXT_PUBLIC_BROWSER_API_URL=http://localhost:3000</code></strong></p>
<ul>
<li>브라우저(클라이언트)에서 API 호출 시 사용하는 URL</li>
<li>사용자가 <code class="language-text">http://localhost:3000</code>으로 접속하므로 그대로 유지</li>
</ul>
<p>단, 여기서 dev 서버는 CORS 때문에 <code class="language-text">next.config.js</code>에 프록시 역할을 하도록 설정해두었었고, docker 환경에서도 프록시 역할을 하도록 해준다.</p>
<div class="gatsby-highlight has-highlighted-lines" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// next.config.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">async</span> <span class="token function">rewrites</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NEXT_PUBLIC_APP_ENV</span> <span class="token operator">===</span> <span class="token string">'localhost'</span> <span class="token operator">||</span>
<span class="gatsby-highlight-code-line">    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NEXT_PUBLIC_APP_ENV</span> <span class="token operator">===</span> <span class="token string">'local-docker'</span></span>    <span class="token operator">?</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token comment">// api 프록시</span>
          <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token string">'/b2c-api/api/:path*'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">destination</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SERVER_API_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/:path*</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span>
    <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// ...</span></code></pre></div>
<p><strong><code class="language-text">NEXT_PUBLIC_INTERNAL_API_URL=...</code></strong></p>
<ul>
<li>SSR시, middleware 등 Node.js runtime에서 API 호출에 사용</li>
<li>Docker 컨테이너 내부에서 <code class="language-text">localhost:3000</code>은 자기 자신을 가리키므로 외부 테스트 서버 사용</li>
<li>EKS 환경에서는 내부에 배포된 pod 서버 주소를 사용한다. (브라우저가 아니라 node 서버에서 SpringBoot 서버로 쏘므로)</li>
</ul>
<p><strong><code class="language-text">NEXT_PUBLIC_PDF_INTERNAL_URL=http://host.docker.internal:3000</code></strong></p>
<ul>
<li>PDF 생성 시 Playwright가 페이지 접속에 사용하는 URL</li>
<li>로컬 개발 서버(호스트 PC)와 달리, Docker 컨테이너 내부에서 <code class="language-text">localhost</code>는 컨테이너 자신을 가리킴</li>
<li>따라서 컨테이너에서 **호스트 머신(Next.js 서버가 실행 중인 PC)**으로 루프백 요청을 보내기 위해 Docker Desktop이 제공하는 특수 DNS인 <code class="language-text">host.docker.internal</code>을 사용함.</li>
</ul>
<p>Playwright는 headless browser에서 PDF 생성 대상이 되는 페이지를 열기 위해 자기 자신을 호출한다. (그래야 FE에서 복잡한 CSS를 가진 페이지를 만들 수 있고, PDF 관리도 FE에서 가능하기 때문이다.)</p>
<div class="gatsby-highlight" data-language="mermaid"><pre class="language-mermaid"><code class="language-mermaid"><span class="token keyword">sequenceDiagram</span>
    box <span class="token string">"단일 로컬 PC 환경"</span>
        <span class="token keyword">participant</span> PlaywrightApp as Playwright/Node.js 서버
        <span class="token keyword">participant</span> Browser as Playwright 헤드리스 브라우저
    <span class="token keyword">end</span>

    PlaywrightApp <span class="token arrow operator">->></span> Browser<span class="token operator">:</span> 1. 브라우저 실행 <span class="token punctuation">(</span>launch browser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">activate</span> Browser

    PlaywrightApp <span class="token arrow operator">->></span> Browser<span class="token operator">:</span> 2. 새 페이지 열기 <span class="token punctuation">(</span>newPage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    Browser <span class="token arrow operator">-->></span> PlaywrightApp<span class="token operator">:</span> 3. 페이지 인스턴스 반환

    <span class="token keyword">Note over</span> PlaywrightApp<span class="token operator">:</span> 4. PDF 생성 대상 URL 결정&lt;br><span class="token text string">(예: http://localhost:3000/content)</span>

    PlaywrightApp <span class="token arrow operator">->></span> Browser<span class="token operator">:</span> 5. page.goto<span class="token text string">('http://localhost:PORT/경로')</span>

    Browser <span class="token arrow operator">->></span> PlaywrightApp<span class="token operator">:</span> 6. 페이지 콘텐츠를 위한 HTTP 요청 <span class="token text string">(Loopback 통신)</span>
    <span class="token keyword">activate</span> PlaywrightApp

    PlaywrightApp <span class="token arrow operator">->></span> Browser<span class="token operator">:</span> 7. HTTP 응답 <span class="token text string">(HTML/CSS/JS)</span>
    <span class="token keyword">deactivate</span> PlaywrightApp

    Browser <span class="token arrow operator">->></span> Browser<span class="token operator">:</span> 8. 페이지 콘텐츠 렌더링

    PlaywrightApp <span class="token arrow operator">->></span> Browser<span class="token operator">:</span> 9. PDF 파일 생성 명령 <span class="token punctuation">(</span>page.pdf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    Browser <span class="token arrow operator">-->></span> PlaywrightApp<span class="token operator">:</span> 10. PDF 이진 데이터 반환

    <span class="token keyword">deactivate</span> Browser
    PlaywrightApp <span class="token arrow operator">->></span> PlaywrightApp<span class="token operator">:</span> 11. PDF 파일 저장 또는 스트림 처리</code></pre></div>
<p>자기 자신을 호출하는 것을 **로컬 루프백(Local Loopback)**이라고 한다. 이때 local(<code class="language-text">pnpm dev</code>로 실행하는 dev서버)에서는 <code class="language-text">http://localhost:3000</code> 주소를 사용해도 된다. 왜냐하면 Next.js가 떠있는게 localhost:3000 이기 때문이다. 같은 OS(호스트 PC) 위에서 실행되기 때문이다.</p>
<blockquote>
<ul>
<li><strong>Host PC (Next.js Server):</strong> PDF 렌더링에 필요한 HTML/CSS/데이터를 제공하는 웹 서버.</li>
<li><strong>Docker Container (Playwright App):</strong> Next.js 코드를 실행하며, Headless Browser를 구동하여 PDF를 생성하는 주체.</li>
</ul>
</blockquote>
<p>하지만 Docker 환경은 다르다. Docker Container 내부에서 localhost는 호스트 PC가 아닌 Docker Container 자기 자신이기 때문이다. 컨테이너 내부 3000번 포트로 요청을 보낸다. 그러면 dev 서버와 동일하게 자기자신을 가리키기 때문에 문제 없이 호출되어야 하는 것이 맞다. 하지만 localhost:3000이 실패했고, <code class="language-text">host.docker.internal:3000</code> 으로 접근했을 경우만 성공했다.</p>
<p>왜냐면 docker container 내부에 localhost가 네트워크로 바인딩 되어있지 않기 때문이다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># docker container 내부</span>

$ <span class="token function">cat</span> /etc/hosts
<span class="token number">127.0</span>.0.1       localhost
::1     localhost ip6-localhost ip6-loopback
fe00::  ip6-localnet
ff00::  ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
<span class="token number">172.17</span>.0.2      3c2c98fbe2ae</code></pre></div>
<p>DNS로 127.0.0.1에 localhost가 바인딩 되어있지만, 실제로는 172.17.0.2에 Next.js 어플리케이션이 떠있다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># docker container 내부</span>

$ <span class="token function">node</span> /app/server.js
 ⨯ Failed to start server
Error: listen EADDRINUSE: address already <span class="token keyword">in</span> use <span class="token number">172.17</span>.0.2:3000
    at <span class="token operator">&lt;</span>unknown<span class="token operator">></span> <span class="token punctuation">(</span>Error: listen EADDRINUSE: address already <span class="token keyword">in</span> use <span class="token number">172.17</span>.0.2:3000<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  code: <span class="token string">'EADDRINUSE'</span>,
  errno: -98,
  syscall: <span class="token string">'listen'</span>,
  address: <span class="token string">'172.17.0.2'</span>,
  port: <span class="token number">3000</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Next.js 서버를 다시 한번 실행하는 명령어인데, 이미 <code class="language-text">172.17.0.2:3000</code> 에 떠 있는 것을 볼 수 있기 때문이다. 그렇다면 방법은 두 가지다.</p>
<ol>
<li><code class="language-text">NEXT_PUBLIC_PDF_INTERNAL_URL</code>에 localhost:3000 대신, <code class="language-text">172.17.0.2:3000</code> 이 주소를 넣어준다.</li>
<li>docker run 시 <code class="language-text">--dns=127.0.01</code> 옵션을 준다.
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1454px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 18%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAuklEQVR42kWP6wrCMAyF+/6vJ4oI+mPrel9vyjYn2zHtigZCTr6EQ8K4MHA+oR8UTucbLtc7jAtwY4KlNC7WamuNjR/atllhxaPsMqkdpvmNmJ6QykIZV7UPCaOPVYeYf+nIyIeMlF+ImfYa09bXXZZpUGKaZnCh0PUCHRcQ0tDVsjKhDPW6cY2BmCRW+qIHoXF/dGQcwNBiXT/oORnyYqLpHQ9Pb4RYLg21HheG2tvRY14W7PuGbfvnF4GCLjuJnRJxAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="dns-option"
        title=""
        src="/static/c4e19889ca88eb4eb19b6c172744cf7a/b62b2/dns-option.png"
        srcset="/static/c4e19889ca88eb4eb19b6c172744cf7a/b30f8/dns-option.png 500w,
/static/c4e19889ca88eb4eb19b6c172744cf7a/332ff/dns-option.png 1000w,
/static/c4e19889ca88eb4eb19b6c172744cf7a/b62b2/dns-option.png 1454w"
        sizes="(max-width: 1454px) 100vw, 1454px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
    </span>
<ul>
<li><a href="https://docs.docker.com/engine/network/#dns-services" target="_blank" rel="nofollow">https://docs.docker.com/engine/network/#dns-services</a></li>
</ul>
</li>
<li><code class="language-text">NEXT_PUBLIC_PDF_INTERNAL_URL</code>에 host.docker.internal을 주어 <strong>호스트 NAT 우회</strong> 한다.</li>
</ol>
<p>나는 3번을 선택했는데, 호스트 PC를 호출해서 호스트 PC가 다시 docker container의 Next.js 서버를 찌르게 만드는 방법이다. 이는 docker에서 제공하는 특수 DNS 이름이다.</p>
<div class="gatsby-highlight" data-language="mermaid"><pre class="language-mermaid"><code class="language-mermaid"><span class="token keyword">sequenceDiagram</span>
    <span class="token keyword">autonumber</span>

    box <span class="token string">"Host PC"</span>
        <span class="token keyword">participant</span> Browser as Browser <span class="token text string">(Client)</span>
        <span class="token keyword">participant</span> NAT as Docker NAT / Port Publish
    <span class="token keyword">end</span>

    box <span class="token string">"Docker Container"</span>
        <span class="token keyword">participant</span> App as Next.js + Playwright
        <span class="token keyword">participant</span> B as Headless Chromium
    <span class="token keyword">end</span>

    Browser<span class="token arrow operator">->></span>App<span class="token operator">:</span> /api/pdf 요청 <span class="token text string">(localhost:3000)</span>
    App<span class="token arrow operator">->></span>B<span class="token operator">:</span> launch + page.newPage

    <span class="token keyword">Note over</span> App<span class="token operator">:</span> 내부 접근 시도&lt;br/>http<span class="token operator">:</span>//localhost<span class="token operator">:</span>3000/content
    B<span class="token arrow operator">->></span>App<span class="token operator">:</span> GET localhost<span class="token operator">:</span>3000 ❌ <span class="token text string">(실패)</span>

    <span class="token keyword">Note over</span> App<span class="token operator">:</span> 우회 경로 선택&lt;br/>http<span class="token operator">:</span>//host.docker.internal<span class="token operator">:</span>3000/content
    B<span class="token arrow operator">->></span>NAT<span class="token operator">:</span> GET host.docker.internal<span class="token operator">:</span>3000
    NAT<span class="token arrow operator">->></span>App<span class="token operator">:</span> 포트 매핑으로 전달
    App<span class="token arrow operator">-->></span>B<span class="token operator">:</span> HTML/CSS/JS

    B<span class="token arrow operator">->></span>B<span class="token operator">:</span> 렌더링 + PDF 생성
    B<span class="token arrow operator">-->></span>App<span class="token operator">:</span> PDF 바이너리
    App<span class="token arrow operator">-->></span>Browser<span class="token operator">:</span> PDF 응답</code></pre></div>
<p>위와 같은 경로로 전달된다. 당연히 local에서 docker를 통해 테스트를 하기 때문에 host.docker.internal을 사용했지만, 실제 배포 환경에서는 저런 방식으로 우회해서 사용하는게 아니라 명확한 주소를 매핑 시켜놓는 것이 좋다. 또한 만약 docker 정책이 container 자신의 주소가 172.17.0.2가 아닌 다른 주소가 된다해도 host.docker.internal를 사용하고 있으므로 local에서 테스트 용도로 적합하다고 생각했다.</p>
<h3 id="Step-3-code-classlanguage-textpackagejsoncode" style="position:relative;">Step 3. <code class="language-text">package.json</code><a href="#Step-3-code-classlanguage-textpackagejsoncode" aria-label="Step 3 code classlanguage textpackagejsoncode permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>로컬 Docker 테스트는 <code class="language-text">빌드 -> 이미지 생성 -> 실행</code> 을 매번 손으로 하면 바로 귀찮아진다. 한 줄로 끝나야 한다.</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"local-docker.build"</span><span class="token operator">:</span> <span class="token string">"env-cmd -f .env.local-docker next build"</span><span class="token punctuation">,</span>
    <span class="token property">"local-docker.start"</span><span class="token operator">:</span> <span class="token string">"pnpm local-docker.build &amp;&amp; docker build -f ./docker/Dockerfile.local -t my-next-app:local --platform linux/amd64 . &amp;&amp; docker run --rm -p 3000:3000 my-next-app:local"</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="세부-설명-1" style="position:relative;">세부 설명<a href="#%EC%84%B8%EB%B6%80-%EC%84%A4%EB%AA%85-1" aria-label="세부 설명 1 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p><strong><code class="language-text">local-docker.build</code></strong></p>
<ul>
<li><code class="language-text">.env.local-docker</code> 환경변수를 사용하여 Next.js 빌드</li>
<li><code class="language-text">env-cmd -f</code> 플래그로 특정 환경 파일 지정</li>
</ul>
<p><strong><code class="language-text">local-docker.start</code></strong></p>
<ul>
<li>전체 프로세스를 한 번에 실행하는 통합 스크립트
<ul>
<li>Next.js 빌드 -> Docker 이미지 생성 -> 컨테이너 실행</li>
</ul>
</li>
<li><code class="language-text">-platform linux/amd64</code>: M1/M2/M3 Mac에서도 호환성 보장</li>
<li><code class="language-text">-rm</code>: 컨테이너 종료 시 자동 삭제</li>
</ul>
<p>이제 아래 명령어 한 줄로 현재 작성된 Next.js 코드를 local에서 docker container로 띄운 환경에 접속 가능하다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">pnpm</span> local-docker.start</code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 2000px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 52.800000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB7ElEQVR42pWS6W7bMBCE9RwFXDu2DovUaV2MJFsW5CM+UrcpigZF2/d/i8mQdtqk//rjw1IrcnZ3SKtoz8jrE1J1QLm8QHUXuGEDW1SwpcJMlJi4ASaONIxt78YcH2cuRLRAlBWIi5oMsPzFGX56gswvkMUTxQaKKTjBPRxJAopLilNYFzDirwUYx7bAaOpxHcOLN7BkdkKQP+IaPyEoLvwxUHhFwRrzZIN5umPcQiweyMHgJzuI7Ghyfrol3BP3sIwICcsnhMUXeFGHOy80I41t/w8TR/zD35zeO/UiNqIF2ZFgd7pDHc2IHO+OG8wBV94OefTMecd4dvVyTC/v3NA0Y8n8TLErWsgJao7bmnG1uP626eXUz1gkJgm7IfPEFLqKvwr22kP6V3xGUH41F6NjWH5DVD0jrn8irL4bkvoX+Y1Y/UCkns3aT498BYriqZlI+2iJdE2D15CLAUHWI8y3SKoDonKPqNgx30HEDWS6NIikJQ1E2iLMeDZW7E6YG3f4Cqzt4YTd8YzNwxH70yOqZoWsuodqOzRdz+8lMlWjrFuzLkn1BtWuEOeKRTN4QQyr3x7M4yzrFZr1gLbfoBv2SLjpw8SmP55hNHXfrUdvcvpirrfuw6pXPWSSm7Zn88DgiIjGy9vT+T9eAFOVVnjZrtKvAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="docker-build-cli.png"
        title=""
        src="/static/32eb77f9e39ce13b0a2824b76df8492c/99e71/docker-build-cli.png"
        srcset="/static/32eb77f9e39ce13b0a2824b76df8492c/b30f8/docker-build-cli.png 500w,
/static/32eb77f9e39ce13b0a2824b76df8492c/332ff/docker-build-cli.png 1000w,
/static/32eb77f9e39ce13b0a2824b76df8492c/99e71/docker-build-cli.png 2000w,
/static/32eb77f9e39ce13b0a2824b76df8492c/c6eff/docker-build-cli.png 2074w"
        sizes="(max-width: 2000px) 100vw, 2000px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 2000px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 3.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAPklEQVR42k3LMRJAAAwFUfc/qCL5ChLCmFiGxuu22EGayFg455E+Vj4Xf5lJVSEJM6O733Z3IuL5A3Ox7c0NSm5Nd21hDz4AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="docker-desktop-result.png"
        title=""
        src="/static/adeb59617629efc07580f91f40f9abfe/99e71/docker-desktop-result.png"
        srcset="/static/adeb59617629efc07580f91f40f9abfe/b30f8/docker-desktop-result.png 500w,
/static/adeb59617629efc07580f91f40f9abfe/332ff/docker-desktop-result.png 1000w,
/static/adeb59617629efc07580f91f40f9abfe/99e71/docker-desktop-result.png 2000w,
/static/adeb59617629efc07580f91f40f9abfe/ed510/docker-desktop-result.png 2128w"
        sizes="(max-width: 2000px) 100vw, 2000px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
    </span></p>
<h3 id="로컬-Docker에서도-완전히-같지는-않다" style="position:relative;">로컬 Docker에서도 완전히 같지는 않다<a href="#%EB%A1%9C%EC%BB%AC-Docker%EC%97%90%EC%84%9C%EB%8F%84-%EC%99%84%EC%A0%84%ED%9E%88-%EA%B0%99%EC%A7%80%EB%8A%94-%EC%95%8A%EB%8B%A4" aria-label="로컬 Docker에서도 완전히 같지는 않다 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>PDF 결과물의 폰트 및 간격이 amd64로 빌드 했을 때 달라져 꽤 오랜시간 애를 먹었다. 원인은 docker build 할 때 platform을 설정했기 때문이었다.</p>
<p><code class="language-text">--platform linux/amd64</code> 같은 경우 EKS pod 환경이 linux/amd64 이기 때문에 플랫폼을 맞춰주기 위해서 넣은 것이다. 하지만, mac에서 amd64 플랫폼으로 동작하지만, PDF를 브라우저에 렌더링 했을 경우 폰트 및 간격이 실제 EKS에 배포했을 때와는 다르다. 이유는 Mac은 arm64 환경이기 때문이다.</p>
<blockquote>
<ul>
<li><a href="https://www.docker.com/blog/faster-multi-platform-builds-dockerfile-cross-compilation-guide/" target="_blank" rel="nofollow">멀티 플랫폼 빌드(크로스 컴파일 가이드) - Docker 공식 블로그</a></li>
<li><a href="https://www.docker.com/blog/multi-arch-images/" target="_blank" rel="nofollow">Docker Desktop을 사용하여 Arm 및 x86용 멀티 아키텍처 이미지 빌드하기 - Docker 공식 블로그</a></li>
</ul>
</blockquote>
<p>따라서 <code class="language-text">--platform</code> 옵션은 실제 ECR에 올릴 이미지를 생성할 때만 넣어주어야 한다.</p>
<p>그래서 로컬 검증은 <strong>기능 동작 여부</strong> 중심으로 하고, 결과물의 픽셀 단위 동일성은 <strong>실제 아키텍처 amd64(Mac)에서 최종 확인</strong>하는 방식으로 했다.</p>
<br/>
<h2 id="Part-2-ECR-Base-이미지-작성-및-배포-프로세스" style="position:relative;">Part 2: ECR Base 이미지 작성 및 배포 프로세스<a href="#Part-2-ECR-Base-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EC%9E%91%EC%84%B1-%EB%B0%8F-%EB%B0%B0%ED%8F%AC-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4" aria-label="Part 2 ECR Base 이미지 작성 및 배포 프로세스 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>로컬에서 Playwright 이미지에 Nextjs 빌드 결과물을 Docker Container로 띄웠다면, 이제 실제 EKS에 배포될 이미지의 기본값이 될 playwright base 이미지를 만들어야 한다.</p>
<p>Playwright는 단순한 npm 패키지가 아니다.</p>
<ul>
<li>브라우저 바이너리</li>
<li>OS 종속성</li>
<li>폰트, locale, timezone</li>
<li>Chromium 버전</li>
</ul>
<p>이 모든 것이 <strong>Base 이미지에 강하게 결합</strong>되어 있다. 즉, Base 이미지가 흔들리면 PDF 결과물도 같이 흔들린다. Playwright Base 이미지를 직접 만들고, ECR에 올리고, 그 버전만 사용하도록 한다.</p>
<blockquote>
<p>※ playwright 버전</p>
<p>기존에 <a href="mailto:playwright@1.41.1" target="_blank" rel="nofollow">playwright@1.41.1</a>을 사용하고 있었지만, 보안 취약점이 발견되어 최신 버전의 이미지(1.57.0)를 사용해야 했다. npm package에서 playwright 버전이 올라가면 playwright docker 이미지도 버전이 올라가야 한다. 만약 npm playwright 버전과 playwright 이미지의 버전이 맞지 않는다면 headless browser가 실행되지 않는다.</p>
<p>따라서 FE에서 npm을 통해 playwright를 업데이트하면 당연히 base 이미지도 업데이트 해야 한다.</p>
</blockquote>
<p>위에서 봤듯, FE 배포 프로세스를 보면 아래와 같다.</p>
<div class="gatsby-highlight" data-language="mermaid"><pre class="language-mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> LR
		A<span class="token text string">[developer]</span> <span class="token arrow operator">--></span><span class="token label property">|FE commit push|</span> B
    B<span class="token text string">[GitHub]</span> <span class="token arrow operator">--></span> C<span class="token text string">(Actions Runner)</span>
    C <span class="token arrow operator">--></span><span class="token label property">|playwright base 이미지 요청|</span> D<span class="token text string">[(ECR)]</span>
    D <span class="token arrow operator">--></span><span class="token label property">|playwright base 이미지 응답|</span> C
    C <span class="token arrow operator">--></span><span class="token label property">|base 이미지에 Next.js Artifact ㅊ추가|</span> F<span class="token text string">[EKS]</span></code></pre></div>
<p>배포때 GitHub Actions에서 ECR로 playwright base 이미지를 요청하게 된다. 저 base 이미지를 local PC해서 만들고 내부망으로 이동시켜 ECR에 푸시하도록 한다.</p>
<div class="gatsby-highlight" data-language="mermaid"><pre class="language-mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> LR
    A<span class="token text string">[로컬 빌드]</span> <span class="token arrow operator">--></span> B<span class="token text string">(tar 압축)</span>
    B <span class="token arrow operator">--></span> C<span class="token text string">[내부망 이동]</span>
    C <span class="token arrow operator">--></span> D<span class="token text string">[(ECR 푸시)]</span></code></pre></div>
<h3 id="Step-1-code-classlanguage-textdockerDockerfilebasecode-신규-생성" style="position:relative;">Step 1. <code class="language-text">docker/Dockerfile.base</code> (신규 생성)<a href="#Step-1-code-classlanguage-textdockerDockerfilebasecode-%EC%8B%A0%EA%B7%9C-%EC%83%9D%EC%84%B1" aria-label="Step 1 code classlanguage textdockerDockerfilebasecode 신규 생성 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<ol>
<li><strong>Playwright 공식 이미지</strong>를 기반,</li>
<li><strong>한국 시간대 / 한글 + 이모지 폰트 / HTTPS APT / 안정적인 apt-get 패턴 / 이미지 용량 정리</strong>를 설정하고</li>
<li>마지막에 <strong>비루트 계정(pwuser)</strong> 로 내려서 브라우저와 Node를 구동하는, PDF/스크린샷 생성에 최적화된 베이스 이미지를 만든다.</li>
</ol>
<div class="gatsby-highlight" data-language="dockerfile"><pre class="language-dockerfile"><code class="language-dockerfile"><span class="token comment"># docker/Dockerfile.base</span>

<span class="token comment"># 골든 베이스: Playwright + 폰트/타임존</span>
<span class="token instruction"><span class="token keyword">FROM</span> mcr.microsoft.com/playwright:latest</span>
<span class="token instruction"><span class="token keyword">USER</span> root</span>
<span class="token instruction"><span class="token keyword">ENV</span> DEBIAN_FRONTEND=noninteractive</span>
<span class="token instruction"><span class="token keyword">ENV</span> TZ=Asia/Seoul</span>
<span class="token comment"># ── 견고한 APT 패턴: HTTPS 미러, 인덱스 초기화, 재시도, 한 RUN에서 update→install→clean ──</span>
<span class="token instruction"><span class="token keyword">RUN</span> set -eux; <span class="token operator">\</span>
    <span class="token comment"># 0) 미러 HTTPS로 고정(사내 미러 쓰면 여기서 sources.list 교체)</span>
    sed -i <span class="token string">'s|http://archive.ubuntu.com|https://archive.ubuntu.com|g'</span> /etc/apt/sources.list; <span class="token operator">\</span>
    sed -i <span class="token string">'s|http://security.ubuntu.com|https://security.ubuntu.com|g'</span> /etc/apt/sources.list; <span class="token operator">\</span>
    <span class="token comment"># 1) 인덱스 초기화 + 재시도 옵션</span>
    rm -rf /var/lib/apt/lists/*; mkdir -p /var/lib/apt/lists/partial; <span class="token operator">\</span>
    echo <span class="token string">'Acquire::Retries "5";'</span> > /etc/apt/apt.conf.d/80-retries; <span class="token operator">\</span>
    <span class="token comment"># 2) 타임존 사전 지정(프롬프트 방지)</span>
    ln -snf /usr/share/zoneinfo/<span class="token variable">$TZ</span> /etc/localtime; echo <span class="token string">"$TZ"</span> > /etc/timezone; <span class="token operator">\</span>
    <span class="token comment"># 3) 업데이트</span>
    apt-get update -o Acquire::http::No-Cache=true -o Acquire::http::Pipeline-Depth=0; <span class="token operator">\</span>
    <span class="token comment"># 4) 필요한 패키지 일괄 설치(폰트 + tzdata + 인증서)</span>
    apt-get install -y --no-install-recommends <span class="token operator">\</span>
        fonts-noto-cjk <span class="token operator">\</span>
        fonts-noto-color-emoji <span class="token operator">\</span>
        tzdata <span class="token operator">\</span>
        ca-certificates <span class="token operator">\</span>
    ; <span class="token operator">\</span>
    <span class="token comment"># (환경에 따라) tzdata 재설정도 비대화식으로 강제</span>
    dpkg-reconfigure -f noninteractive tzdata; <span class="token operator">\</span>
    <span class="token comment"># 5) 클린업</span>
    rm -rf /var/lib/apt/lists/*</span>
<span class="token comment"># 권장: 기본 유저를 Playwright의 pwuser로</span>
<span class="token instruction"><span class="token keyword">USER</span> pwuser</span></code></pre></div>
<h4 id="세부-설명-2" style="position:relative;">세부 설명<a href="#%EC%84%B8%EB%B6%80-%EC%84%A4%EB%AA%85-2" aria-label="세부 설명 2 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h4>
<h3 id="code-classlanguage-textFROM-mcrmicrosoftcomplaywrightlatestcode" style="position:relative;"><code class="language-text">FROM mcr.microsoft.com/playwright:latest</code><a href="#code-classlanguage-textFROM-mcrmicrosoftcomplaywrightlatestcode" aria-label="code classlanguage textFROM mcrmicrosoftcomplaywrightlatestcode permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<ul>
<li>브라우저 설치, OS 의존성, 디스플레이 관련 설정 등을 직접 신경쓰지 않아도 됨.</li>
<li>Playwright가 기대하는 디렉토리 구조, 유저, 퍼미션이 맞춰져 있음.</li>
<li>즉, Node + 브라우저까지 설치 되어 있는 OS</li>
</ul>
<h3 id="code-classlanguage-textENV-TZAsiaSeoulcode" style="position:relative;"><code class="language-text">ENV TZ=Asia/Seoul</code><a href="#code-classlanguage-textENV-TZAsiaSeoulcode" aria-label="code classlanguage textENV TZAsiaSeoulcode permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<ul>
<li>컨테이너 기본 타임존을 한국 시간으로 맞춘다.</li>
<li>PDF 생성 시각/로그 타임스탬프/서버 시간 해석이 로컬/서버에서 어긋나는 문제를 줄인다.</li>
</ul>
<h3 id="code-classlanguage-textapt-get-update-code" style="position:relative;"><code class="language-text">apt-get update ...</code><a href="#code-classlanguage-textapt-get-update-code" aria-label="code classlanguage textapt get update code permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<ul>
<li><code class="language-text">No-Cache</code>, <code class="language-text">Pipeline-Depth=0</code> 같은 옵션으로 네트워크/프록시 환경에서 실패율을 낮추려는 설정.</li>
</ul>
<h3 id="code-classlanguage-textapt-get-install--y---no-install-recommends-code" style="position:relative;"><code class="language-text">apt-get install -y --no-install-recommends ...</code><a href="#code-classlanguage-textapt-get-install--y---no-install-recommends-code" aria-label="code classlanguage textapt get install  y   no install recommends code permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<ul>
<li>필요한 것만 최소 설치.</li>
<li>설치 항목 의미:
<ul>
<li><code class="language-text">fonts-noto-cjk</code>: 한글(CJK) 폰트. PDF에서 한글 깨짐 방지</li>
<li><code class="language-text">fonts-noto-color-emoji</code>: 컬러 이모지 렌더링</li>
<li><code class="language-text">tzdata</code>: 타임존 데이터</li>
<li><code class="language-text">ca-certificates</code>: HTTPS 통신(내부/외부) 인증서 신뢰 기반</li>
</ul>
</li>
</ul>
<h3 id="code-classlanguage-textdpkg-reconfigure--f-noninteractive-tzdatacode" style="position:relative;"><code class="language-text">dpkg-reconfigure -f noninteractive tzdata</code><a href="#code-classlanguage-textdpkg-reconfigure--f-noninteractive-tzdatacode" aria-label="code classlanguage textdpkg reconfigure  f noninteractive tzdatacode permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<ul>
<li>tzdata 설치 후 재설정도 <strong>비대화식으로 강제</strong> 시킴.</li>
<li>빌드 환경에 따라 타임존 적용이 안되는 것을 막음.</li>
</ul>
<h3 id="code-classlanguage-textrm--rf-varlibaptlistscode" style="position:relative;"><code class="language-text">rm -rf /var/lib/apt/lists/*</code><a href="#code-classlanguage-textrm--rf-varlibaptlistscode" aria-label="code classlanguage textrm  rf varlibaptlistscode permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<ul>
<li>레이어 용량을 줄이기 위해 apt-get으로 설치한 라이브러리 리스트 제거.</li>
<li>이미지 사이즈 감소 + 캐시 오염 방지 목적.</li>
</ul>
<h3 id="Step-2-Base-이미지-빌드-로컬" style="position:relative;">Step 2. Base 이미지 빌드 (로컬)<a href="#Step-2-Base-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%B9%8C%EB%93%9C-%EB%A1%9C%EC%BB%AC" aria-label="Step 2 Base 이미지 빌드 로컬 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>package.json에 스크립트를 생성하자.</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token property">"docker.build-base:amd64"</span><span class="token operator">:</span> <span class="token string">"docker build -f ./docker/Dockerfile.base -t [...].dkr.ecr.ap-northeast-2.amazonaws.com/common/playwright:latest-with-font --platform linux/amd64 ."</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<ul>
<li><code class="language-text">build -f ./docker/Dockerfile.base</code> : <code class="language-text">./docker/Dockerfile.base</code> 파일을 사용해 빌드</li>
<li><code class="language-text">-t [...].dkr.ecr.ap-northeast-2.amazonaws.com/common/playwright:latest-with-font</code> : ECR 리포지토리: <code class="language-text">common/playwright</code> 주소 설정과 태그를 붙임</li>
<li><code class="language-text">--platform linux/amd64</code>: ECR은 linux/amd64이므로 플랫폼 강제 고정</li>
</ul>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">pnpm</span> docker.build-base:amd64</code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1804px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 4.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAL0lEQVR42lWJSQoAMAwC+//fZsWbIUKhFWQGPQDo7szMjxEhf/dbMxM33a1/WVUcMctNLzMJMMEAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="docker-build-base-amd64.png"
        title=""
        src="/static/b7a465c545342b5133a3adba5f0c5021/e9bfc/docker-build-base-amd64.png"
        srcset="/static/b7a465c545342b5133a3adba5f0c5021/b30f8/docker-build-base-amd64.png 500w,
/static/b7a465c545342b5133a3adba5f0c5021/332ff/docker-build-base-amd64.png 1000w,
/static/b7a465c545342b5133a3adba5f0c5021/e9bfc/docker-build-base-amd64.png 1804w"
        sizes="(max-width: 1804px) 100vw, 1804px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
    </span></p>
<h3 id="Step-3-Base-이미지를-tar-파일로-고정" style="position:relative;">Step 3. Base 이미지를 tar 파일로 고정<a href="#Step-3-Base-%EC%9D%B4%EB%AF%B8%EC%A7%80%EB%A5%BC-tar-%ED%8C%8C%EC%9D%BC%EB%A1%9C-%EA%B3%A0%EC%A0%95" aria-label="Step 3 Base 이미지를 tar 파일로 고정 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>docker image를 내부 망으로 들이기위해 tar 파일로 저장한다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">docker</span> save <span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span>.dkr.ecr.ap-northeast-2.amazonaws.com/common/playwright:latest-with-font <span class="token parameter variable">-o</span> playwright-base.tar</code></pre></div>
<h3 id="Step-4-내부망으로-전송-및-ECR-push" style="position:relative;">Step 4. 내부망으로 전송 및 ECR push<a href="#Step-4-%EB%82%B4%EB%B6%80%EB%A7%9D%EC%9C%BC%EB%A1%9C-%EC%A0%84%EC%86%A1-%EB%B0%8F-ECR-push" aria-label="Step 4 내부망으로 전송 및 ECR push permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>내부망으로 들일 때는 tar로 압축해서 보내면 리소스를 아낄 수 있다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">gzip</span> playwright-base.tar</code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 198px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 139.3939393939394%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAYAAABh2p9gAAAACXBIWXMAABYlAAAWJQFJUiTwAAACyUlEQVR42q2V60/aYBTG+buXLEuWZR+WLPugkUYuCopzyRY1mvnFfUAWFy/RkcBwAbkoYROBXqAthbbPzjmzCU7cqFmTk5a276/P+5wLEcxweJ4H3/dneRUR/OdjKpDVBOG6LjRNg67rjwcOh0No+m9Ip9PBq9dvsKAswrKsxwEt2xZVqqoKNBpLIpFagUHX/X4/PNAe2jAMQ2ADAijxJSixBBxnKB/hZ6G3zEp4oWWaiBIwvpxG9eIClcoFGo0GwZ3ZgfzyYDAQqEPw5y9eIrG0DJs8bLfbuLm5kY+GApqkjIHj8RhPnj7D/IIi191ul6ITEjhyYFNiGMrw/dxnnJ19pXuWeNjr9cIBR6ORLAigrjume454augGVE0N5yFvjRcwlIOh7GngK2c/NJBV8lknRcViEaVSSUAmQVmpQ89DAbnlOLg7uEwal5eiVJI16MsH/wkMJgp7x8ZLUBKCruE25OCymWnLPKaCEJVj9872WfGk+tDja3LqPGp8cdGen5+jXC7j+vpaolarodVqyb1qtSpxenoqSQp6evKDkckbW1tbWF1dRTweRzQaxfb2NtLpNFKpFLLZrFwrioLNzU1sbGzg5OTknpd3FDabTcmqdduzV1dXkqBgZNXrdeTzeRHA9cleT91yoJCzF2yDzefgZ1x/nOlgggedxCX0JzQSZJeP/VwOsdgikskkMmtv6TqO9fV3KBQKtN0VzM3N4+j4GHt7n5DJZLCzs3OvHu8o5Bpjs0ulb2jUaPaVv6NerVA9dlGtlFEqFmTgHn45wO7uR7HE972/FPbt2XB81HouuqaPNtlnku8tw4dm+/hpuGiqVKs+ZilsX7A/1BF2830s5zS8O9RRbA7x4VjH2oGG90cGElnqHpML+/7/9VSFztgnVaTI8iT6tgfV9NAbuNDpd5fOUxIc/o9+loaJPLSQ17ID/gPxEPAXTKBqUyi5H/8AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="base-image-gzip"
        title=""
        src="/static/fdc3afe38070999d9115b1f3568d7512/920f7/base-image-gzip.png"
        srcset="/static/fdc3afe38070999d9115b1f3568d7512/920f7/base-image-gzip.png 198w"
        sizes="(max-width: 198px) 100vw, 198px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
    </span></p>
<h3 id="Step-5-내부망에서-ECR-푸시" style="position:relative;">Step 5. 내부망에서 ECR 푸시<a href="#Step-5-%EB%82%B4%EB%B6%80%EB%A7%9D%EC%97%90%EC%84%9C-ECR-%ED%91%B8%EC%8B%9C" aria-label="Step 5 내부망에서 ECR 푸시 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ gunzip playwright-base.tar.gz</code></pre></div>
<p>압축을 푼다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">docker</span> load <span class="token parameter variable">-i</span> playwright-base.tar
$ <span class="token function">docker</span> images <span class="token operator">|</span> <span class="token function">grep</span> playwright</code></pre></div>
<p>docker image를 내부망 컴퓨터에 로드시킨 후, docker images 명령어로 이미지가 제대로 로드 되었는지 확인한다.</p>
<p>그다음 PC에서 aws cli로 ECR에 로그인 후, push 하면 된다.</p>
<h3 id="결과-확인" style="position:relative;">결과 확인<a href="#%EA%B2%B0%EA%B3%BC-%ED%99%95%EC%9D%B8" aria-label="결과 확인 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>이제 FE에서 playwright 버전(1.57.0)을 업데이트하고 commit 후 push해서 GitHub Actions가 돌게 한 후, 배포를 기다려보자. 완료 이후 PDF를 출력해보니 문제가 생겼다.</p>
<p>Next.js node runtime의 playwright 버전은 1.57.0 버전이지만, 이미지 버전은 여전히 1.46.1 버전이라는 에러 문구다.</p>
<p>어떻게 된건지 GitHub Actions의 Dockerfile을 보자.</p>
<div class="gatsby-highlight" data-language="dockerfile"><pre class="language-dockerfile"><code class="language-dockerfile"><span class="token instruction"><span class="token keyword">FROM</span>  [...].dkr.ecr.ap-northeast-2.amazonaws.com/common/playwright:latest-with-font <span class="token keyword">AS</span> base</span>

<span class="token comment"># ...</span></code></pre></div>
<p>ECR에 push 했을 때 분명 새로운 이미지로 교체 되었는데 여전히 새로운 이미지로 빌드되지 않았다. 문제는 <strong>태그</strong>였는데, 새로운 이미지의 태그도 <code class="language-text">latest-with-font</code> 였고, <code class="language-text">docker build --pull</code> 명령어가 아닌 <code class="language-text">docker build</code>로만 실행되었기 때문에 기존에 있는 base 이미지로만 사용했기 때문에 문제가 되었다. 같은 태그를 쓰면 Docker는 로컬에 캐시된 이미지를 우선 사용해서, ECR에 새 이미지를 올려도 빌드가 그대로 지난 이미지가 사용된다.</p>
<h3 id="태그를-timestamp-기반으로" style="position:relative;">태그를 timestamp 기반으로<a href="#%ED%83%9C%EA%B7%B8%EB%A5%BC-timestamp-%EA%B8%B0%EB%B0%98%EC%9C%BC%EB%A1%9C" aria-label="태그를 timestamp 기반으로 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>새로운 이미지는 새로운 태그로 대체하기로 했다. <code class="language-text">docker build --pull</code> 옵션을 주면 docker 이미지 digest가 변경되었다면 새로 pull 받아 이미지를 생성한다. 하지만, 사람이 알아보는 것은 쉽지 않다. 따라서 현재 빌드 시점을 태깅해서 ECR로 push 하고, 빌드 시 해당 태그의 이미지를 사용하도록 한다.</p>
<p>이렇게 하면 Docker cache가 무력화되고 FROM 단계에서 반드시 새 이미지를 사용하게 된다.</p>
<div class="gatsby-highlight" data-language="sh"><pre class="language-sh"><code class="language-sh"><span class="token comment"># scripts/build-and-update-base.sh</span>

<span class="token comment">#!/bin/bash</span>
<span class="token builtin class-name">set</span> <span class="token parameter variable">-e</span>

<span class="token comment"># Timestamp 생성</span>
<span class="token assign-left variable">TIMESTAMP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d-%H%M%S<span class="token variable">)</span></span>
<span class="token assign-left variable">VERSION_TAG</span><span class="token operator">=</span><span class="token string">"v<span class="token variable">${TIMESTAMP}</span>"</span>

<span class="token comment"># ECR 정보</span>
<span class="token assign-left variable">ECR_REGISTRY</span><span class="token operator">=</span><span class="token string">"[...].dkr.ecr.ap-northeast-2.amazonaws.com"</span>
<span class="token assign-left variable">IMAGE_NAME</span><span class="token operator">=</span><span class="token string">"common/playwright"</span>
<span class="token assign-left variable">FULL_IMAGE</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${ECR_REGISTRY}</span>/<span class="token variable">${IMAGE_NAME}</span>:<span class="token variable">${VERSION_TAG}</span>"</span>

<span class="token builtin class-name">echo</span> <span class="token string">"🚀 Docker base 이미지 빌드 중..."</span>
<span class="token builtin class-name">echo</span> <span class="token string">"   Version: <span class="token variable">${VERSION_TAG}</span>"</span><span class="token punctuation">\</span>
<span class="token builtin class-name">echo</span> <span class="token string">""</span>

<span class="token comment"># Docker 빌드</span>
<span class="token function">docker</span> build <span class="token punctuation">\</span>
  <span class="token parameter variable">-f</span> ./docker/Dockerfile.base <span class="token punctuation">\</span>
  <span class="token parameter variable">-t</span> <span class="token string">"<span class="token variable">${FULL_IMAGE}</span>"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--platform</span> linux/amd64 <span class="token punctuation">\</span>
  --no-cache <span class="token punctuation">\</span>
  <span class="token builtin class-name">.</span>

<span class="token builtin class-name">echo</span> <span class="token string">""</span>
<span class="token builtin class-name">echo</span> <span class="token string">"✅ Docker 이미지 빌드 완료: <span class="token variable">${FULL_IMAGE}</span>"</span>
<span class="token builtin class-name">echo</span> <span class="token string">""</span></code></pre></div>
<p>자동화 스크립트를 작성하고 package.json에서 명령어에 이 sh 파일을 실행시킨다.</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token property">"docker.build-base:amd64"</span><span class="token operator">:</span> <span class="token string">"sh ./scripts/build-and-update-base.sh"</span></code></pre></div>
<p>하지만, GitHub Actions에서 도는 Dockerfile은 하드코딩으로 태그 값이 박혀있다. 조금 위험할 수도 있지만 이것도 자동화 해보자. Dockerfile FROM절에 방금 만든 timestamp로 태그 명을 대체하고 자동 commit을 생성하는 방법이다. 쉘 스크립트에 이어서 추가한다.</p>
<div class="gatsby-highlight" data-language="sh"><pre class="language-sh"><code class="language-sh"><span class="token comment"># scripts/build-and-update-base.sh 이어서</span>

<span class="token comment"># ...</span>

<span class="token comment"># Dockerfile 업데이트</span>
<span class="token assign-left variable">DOCKERFILE_PATH</span><span class="token operator">=</span><span class="token string">"./docker/Dockerfile"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"📝 <span class="token variable">${DOCKERFILE_PATH}</span> 태그 업데이트 중..."</span>

<span class="token comment"># FROM 절 업데이트 (sed를 사용하여 기존 태그를 새 버전으로 변경)</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token environment constant">$OSTYPE</span>"</span> <span class="token operator">==</span> <span class="token string">"darwin"</span>* <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token comment"># macOS</span>
  <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">''</span> <span class="token string">"s|FROM  <span class="token variable">${ECR_REGISTRY}</span>/<span class="token variable">${IMAGE_NAME}</span>:.*AS base|FROM  <span class="token variable">${ECR_REGISTRY}</span>/<span class="token variable">${IMAGE_NAME}</span>:<span class="token variable">${VERSION_TAG}</span> AS base|g"</span> <span class="token string">"<span class="token variable">${DOCKERFILE_PATH}</span>"</span>
<span class="token keyword">else</span>
  <span class="token comment"># Linux</span>
  <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s|FROM  <span class="token variable">${ECR_REGISTRY}</span>/<span class="token variable">${IMAGE_NAME}</span>:.*AS base|FROM  <span class="token variable">${ECR_REGISTRY}</span>/<span class="token variable">${IMAGE_NAME}</span>:<span class="token variable">${VERSION_TAG}</span> AS base|g"</span> <span class="token string">"<span class="token variable">${DOCKERFILE_PATH}</span>"</span>
<span class="token keyword">fi</span>

<span class="token builtin class-name">echo</span> <span class="token string">"✅ Dockerfile 업데이트 완료 (버전: <span class="token variable">${VERSION_TAG}</span>)"</span>
<span class="token builtin class-name">echo</span> <span class="token string">""</span>

<span class="token comment"># Git commit</span>
<span class="token builtin class-name">echo</span> <span class="token string">"📦 변경사항 커밋 중..."</span>
<span class="token function">git</span> <span class="token function">add</span> <span class="token string">"<span class="token variable">${DOCKERFILE_PATH}</span>"</span>
<span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"chore: bump version docker golden image <span class="token variable">${VERSION_TAG}</span>"</span>

<span class="token builtin class-name">echo</span> <span class="token string">""</span>
<span class="token builtin class-name">echo</span> <span class="token string">"🎉 완료!"</span></code></pre></div>
<p>이렇게 해주면 <code class="language-text">pnpm docker.build-base:amd64</code> 한 줄로</p>
<ul>
<li>playwright 최신 버전 이미지 pull</li>
<li>Dockerfile.base에서 font, tz 등 작업</li>
<li>이미지 생성(태그 timestamp)</li>
<li>ECR에서 pull 받아 작업할 Dockerfile FROM절에 timestamp 태깅</li>
<li>Dockerfile commit</li>
</ul>
<p>자동화가 완성되었다.</p>
<h3 id="playwright-버전-자동화" style="position:relative;">playwright 버전 자동화<a href="#playwright-%EB%B2%84%EC%A0%84-%EC%9E%90%EB%8F%99%ED%99%94" aria-label="playwright 버전 자동화 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>다시 돌아가보자. playwright가 1.47.1 버전이 취약함에 따라 버전 업데이트가 필요했고, 베이스 이미지도 업데이트가 필요했으므로 일일이 버전 업데이트를 진행해주어야 한다. 일일이 변경해주기보다, package.json에 playwright를 업데이트하면 그 버전 값을 보고 그 버전에 해당하는 playwright docker 이미지를 base로 하도록 하자.</p>
<p>Dockerfile에서 ARG 를 이용해 외부에서 값을 받아올 수 있도록 하자.</p>
<div class="gatsby-highlight" data-language="dockerfile"><pre class="language-dockerfile"><code class="language-dockerfile"><span class="token comment"># Dockerfile.base</span>

<span class="token instruction"><span class="token keyword">ARG</span> PLAYWRIGHT_VERSION</span>
<span class="token instruction"><span class="token keyword">FROM</span> mcr.microsoft.com/playwright:v<span class="token variable">${PLAYWRIGHT_VERSION}</span>-jammy</span>

<span class="token comment"># ...</span></code></pre></div>
<p>그리고 local docker image 빌드, ECR에 배포할 이미지 빌드시 <code class="language-text">--build-arg</code> 에 playwright 버전 값을 넣어주도록 하자.</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token property">"local-docker.build-base"</span><span class="token operator">:</span> <span class="token string">"docker build -f ./docker/Dockerfile.base -t application-base:local --build-arg PLAYWRIGHT_VERSION=$(node -p \"require('./package.json').dependencies.playwright\") ."</span></code></pre></div>
<p><code class="language-text">$ node -p "require('./package.json').dependencies.playwright"</code> 로 package.json을 참조하도록 한다.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1052px; "
    >
      <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 7.3999999999999995%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAS0lEQVR42h3KSRKAIAwFUQ8jmhCgHHBMIQfw/uf5Rha96XpdzhWqL+K0wfECjgUkJ3qawUEhqYLC1XK8wqdiPeYUoxxm7ub+P/gdH+IIH0R8sEDLAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="node-p-reference"
        title=""
        src="/static/b0b165a161a14e1b5523aa078967f04d/8f870/node-p-reference.png"
        srcset="/static/b0b165a161a14e1b5523aa078967f04d/b30f8/node-p-reference.png 500w,
/static/b0b165a161a14e1b5523aa078967f04d/332ff/node-p-reference.png 1000w,
/static/b0b165a161a14e1b5523aa078967f04d/8f870/node-p-reference.png 1052w"
        sizes="(max-width: 1052px) 100vw, 1052px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
    </span></p>
<p>이제 FE에서 npm playwright 패키지만 업데이트 하면 base 이미지는 자동으로 해당 버전에 맞는 이미지를 가져오도록 설정 되었다.</p>
<h3 id="local-docker-image와-ECR에-배포할-base를-한-파일로" style="position:relative;">local docker image와 ECR에 배포할 base를 한 파일로<a href="#local-docker-image%EC%99%80-ECR%EC%97%90-%EB%B0%B0%ED%8F%AC%ED%95%A0-base%EB%A5%BC-%ED%95%9C-%ED%8C%8C%EC%9D%BC%EB%A1%9C" aria-label="local docker image와 ECR에 배포할 base를 한 파일로 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h3>
<p>현재 local에서 테스트용 docker image, ECR에 배포할 base 이미지를 만드는 Dockerfile은 다르지만 내용은 동일하게 맞춰주어야 local에서 테스트하는 의미가 있다.</p>
<p>따라서, 아래와 같이 base 용 이미지 생성 Dockerfile과 어플리케이션 전용 Dockerfile만 나누어 진행하도록 하자.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">docker/
  ├── Dockerfile.base    # 공통 Base 이미지 - 로컬/프로덕션 모두 사용
  ├── Dockerfile.local   # 로컬 테스트용 애플리케이션
  └── Dockerfile         # 프로덕션용 애플리케이션</code></pre></div>
<p>최종 Dockerfile이다.</p>
<div class="gatsby-highlight" data-language="dockerfile"><pre class="language-dockerfile"><code class="language-dockerfile"><span class="token comment"># Dockerfile.base</span>

<span class="token comment"># ============================================</span>
<span class="token comment"># 골든 베이스: Playwright + 폰트/타임존</span>
<span class="token comment"># ============================================</span>
<span class="token instruction"><span class="token keyword">ARG</span> PLAYWRIGHT_VERSION</span>
<span class="token instruction"><span class="token keyword">FROM</span> mcr.microsoft.com/playwright:v<span class="token variable">${PLAYWRIGHT_VERSION}</span>-jammy</span>

<span class="token comment"># FROM 이후 ARG 재선언 (scope 유지)</span>
<span class="token instruction"><span class="token keyword">ARG</span> PLAYWRIGHT_VERSION</span>

<span class="token instruction"><span class="token keyword">USER</span> root</span>
<span class="token instruction"><span class="token keyword">ENV</span> DEBIAN_FRONTEND=noninteractive</span>
<span class="token instruction"><span class="token keyword">ENV</span> TZ=Asia/Seoul</span>

<span class="token comment"># ARG 검증: PLAYWRIGHT_VERSION이 비어있으면 빌드 실패</span>
<span class="token instruction"><span class="token keyword">RUN</span> test -n <span class="token string">"${PLAYWRIGHT_VERSION}"</span> || (echo <span class="token string">"ERROR: PLAYWRIGHT_VERSION is required"</span> &amp;&amp; exit 1)</span>

<span class="token comment"># 견고한 APT 패턴: HTTPS 미러, 인덱스 초기화, 재시도, 한 RUN에서 update→install→clean</span>
<span class="token instruction"><span class="token keyword">RUN</span> set -eux; <span class="token operator">\</span>
    <span class="token comment"># 0) 미러 HTTPS로 고정</span>
    sed -i <span class="token string">'s|http://archive.ubuntu.com|https://archive.ubuntu.com|g'</span> /etc/apt/sources.list; <span class="token operator">\</span>
    sed -i <span class="token string">'s|http://security.ubuntu.com|https://security.ubuntu.com|g'</span> /etc/apt/sources.list; <span class="token operator">\</span>
    <span class="token comment"># 1) 인덱스 초기화 + 재시도 옵션</span>
    rm -rf /var/lib/apt/lists/*; mkdir -p /var/lib/apt/lists/partial; <span class="token operator">\</span>
    echo <span class="token string">'Acquire::Retries "5";'</span> > /etc/apt/apt.conf.d/80-retries; <span class="token operator">\</span>
    <span class="token comment"># 2) 타임존 사전 지정(프롬프트 방지)</span>
    ln -snf /usr/share/zoneinfo/<span class="token variable">$TZ</span> /etc/localtime; echo <span class="token string">"$TZ"</span> > /etc/timezone; <span class="token operator">\</span>
    <span class="token comment"># 3) 업데이트</span>
    apt-get update -o Acquire::http::No-Cache=true -o Acquire::http::Pipeline-Depth=0; <span class="token operator">\</span>
    <span class="token comment"># 4) 필요한 패키지 일괄 설치(폰트 + tzdata + 인증서)</span>
    apt-get install -y --no-install-recommends <span class="token operator">\</span>
        fonts-noto-cjk <span class="token operator">\</span>
        fonts-noto-color-emoji <span class="token operator">\</span>
        tzdata <span class="token operator">\</span>
        ca-certificates <span class="token operator">\</span>
    ; <span class="token operator">\</span>
    <span class="token comment"># 5) tzdata 재설정도 비대화식으로 강제</span>
    dpkg-reconfigure -f noninteractive tzdata; <span class="token operator">\</span>
    <span class="token comment"># 6) 클린업</span>
    rm -rf /var/lib/apt/lists/*</span>

<span class="token instruction"><span class="token keyword">USER</span> pwuser</span></code></pre></div>
<div class="gatsby-highlight" data-language="dockerfile"><pre class="language-dockerfile"><code class="language-dockerfile"><span class="token comment"># Dockerfile.local</span>

<span class="token comment"># ============================================</span>
<span class="token comment"># Application (Base 이미지 참조)</span>
<span class="token comment"># ============================================</span>
<span class="token instruction"><span class="token keyword">ARG</span> BASE_IMAGE</span>
<span class="token instruction"><span class="token keyword">FROM</span> <span class="token variable">${BASE_IMAGE}</span></span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>

<span class="token instruction"><span class="token keyword">EXPOSE</span> 3000</span>
<span class="token instruction"><span class="token keyword">ENV</span> PORT=3000</span>
<span class="token instruction"><span class="token keyword">ENV</span> HOST=0.0.0.0</span>

<span class="token instruction"><span class="token keyword">COPY</span> public ./public</span>
<span class="token instruction"><span class="token keyword">COPY</span> .next/standalone ./</span>
<span class="token instruction"><span class="token keyword">COPY</span> .next/static ./.next/static</span>

<span class="token instruction"><span class="token keyword">USER</span> root</span>
<span class="token instruction"><span class="token keyword">RUN</span> mkdir -p .next/cache &amp;&amp; chown -R pwuser:pwuser .next</span>

<span class="token instruction"><span class="token keyword">USER</span> pwuser</span>

<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">"node"</span>, <span class="token string">"server.js"</span>]</span></code></pre></div>
<div class="gatsby-highlight" data-language="dockerfile"><pre class="language-dockerfile"><code class="language-dockerfile"><span class="token comment"># Dockerfile</span>

<span class="token instruction"><span class="token keyword">FROM</span>  [...].dkr.ecr.ap-northeast-2.amazonaws.com/common/playwright:v20205... <span class="token keyword">AS</span> base</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>

<span class="token instruction"><span class="token keyword">EXPOSE</span> 3000</span>
<span class="token instruction"><span class="token keyword">ENV</span> PORT 3000</span>
<span class="token instruction"><span class="token keyword">ENV</span> HOST 0.0.0.0</span>

<span class="token instruction"><span class="token keyword">COPY</span> public ./public</span>
<span class="token instruction"><span class="token keyword">COPY</span> .next/standalone ./</span>
<span class="token instruction"><span class="token keyword">COPY</span> .next/static ./.next/static</span>

<span class="token instruction"><span class="token keyword">USER</span> root</span>
<span class="token instruction"><span class="token keyword">RUN</span> mkdir -p .next/cache &amp;&amp; chown -R pwuser:pwuser .next</span>

<span class="token instruction"><span class="token keyword">USER</span> pwuser</span>

<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">"node"</span>, <span class="token string">"server.js"</span>]</span></code></pre></div>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token comment">// package.json</span>

<span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"local-docker.build"</span><span class="token operator">:</span> <span class="token string">"env-cmd -f .env.local-docker next build"</span><span class="token punctuation">,</span>
    <span class="token property">"local-docker.build-base"</span><span class="token operator">:</span> <span class="token string">"docker build -f ./docker/Dockerfile.base -t application-base:local --build-arg PLAYWRIGHT_VERSION=$(node -p \"require('./package.json').dependencies.playwright\") ."</span><span class="token punctuation">,</span>
    <span class="token property">"local-docker.start"</span><span class="token operator">:</span> <span class="token string">"pnpm local-docker.build-base &amp;&amp; pnpm local-docker.build &amp;&amp; docker build -f ./docker/Dockerfile.local -t application-local:local --build-arg BASE_IMAGE=application-base:local . &amp;&amp; docker run --rm -p 3000:3000 application-local:local"</span><span class="token punctuation">,</span>
    <span class="token property">"docker.build-base:amd64"</span><span class="token operator">:</span> <span class="token string">"sh ./scripts/build-and-update-base.sh"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># scripts/build-and-update-base.sh</span>

<span class="token comment">#!/bin/bash</span>
<span class="token builtin class-name">set</span> <span class="token parameter variable">-e</span>

<span class="token comment"># Timestamp 생성</span>
<span class="token assign-left variable">TIMESTAMP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d-%H%M%S<span class="token variable">)</span></span>
<span class="token assign-left variable">VERSION_TAG</span><span class="token operator">=</span><span class="token string">"v<span class="token variable">${TIMESTAMP}</span>"</span>

<span class="token comment"># ECR 정보</span>
<span class="token assign-left variable">ECR_REGISTRY</span><span class="token operator">=</span><span class="token string">"[...].dkr.ecr.ap-northeast-2.amazonaws.com"</span>
<span class="token assign-left variable">IMAGE_NAME</span><span class="token operator">=</span><span class="token string">"common/playwright"</span>
<span class="token assign-left variable">FULL_IMAGE</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${ECR_REGISTRY}</span>/<span class="token variable">${IMAGE_NAME}</span>:<span class="token variable">${VERSION_TAG}</span>"</span>

<span class="token comment"># Playwright 버전 가져오기</span>
<span class="token assign-left variable">PLAYWRIGHT_VERSION</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">node</span> <span class="token parameter variable">-p</span> <span class="token string">"require('./package.json').dependencies.playwright"</span><span class="token variable">)</span></span>

<span class="token builtin class-name">echo</span> <span class="token string">"🚀 Docker base 이미지 빌드 중..."</span>
<span class="token builtin class-name">echo</span> <span class="token string">"   Version: <span class="token variable">${VERSION_TAG}</span>"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"   Playwright: <span class="token variable">${PLAYWRIGHT_VERSION}</span>"</span>
<span class="token builtin class-name">echo</span> <span class="token string">""</span>

<span class="token comment"># Docker 빌드</span>
<span class="token function">docker</span> build <span class="token punctuation">\</span>
  <span class="token parameter variable">-f</span> ./docker/Dockerfile.base <span class="token punctuation">\</span>
  <span class="token parameter variable">-t</span> <span class="token string">"<span class="token variable">${FULL_IMAGE}</span>"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--platform</span> linux/amd64 <span class="token punctuation">\</span>
  --build-arg <span class="token assign-left variable">PLAYWRIGHT_VERSION</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${PLAYWRIGHT_VERSION}</span>"</span> <span class="token punctuation">\</span>
  --no-cache <span class="token punctuation">\</span>
  <span class="token builtin class-name">.</span>

<span class="token builtin class-name">echo</span> <span class="token string">""</span>
<span class="token builtin class-name">echo</span> <span class="token string">"✅ Docker 이미지 빌드 완료: <span class="token variable">${FULL_IMAGE}</span>"</span>
<span class="token builtin class-name">echo</span> <span class="token string">""</span>

<span class="token comment"># Dockerfile 업데이트</span>
<span class="token assign-left variable">DOCKERFILE_PATH</span><span class="token operator">=</span><span class="token string">"./docker/Dockerfile"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"📝 <span class="token variable">${DOCKERFILE_PATH}</span> 태그 업데이트 중..."</span>

<span class="token comment"># FROM 절 업데이트 (sed를 사용하여 기존 태그를 새 버전으로 변경)</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token environment constant">$OSTYPE</span>"</span> <span class="token operator">==</span> <span class="token string">"darwin"</span>* <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token comment"># macOS</span>
  <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">''</span> <span class="token string">"s|FROM  <span class="token variable">${ECR_REGISTRY}</span>/<span class="token variable">${IMAGE_NAME}</span>:.*AS base|FROM  <span class="token variable">${ECR_REGISTRY}</span>/<span class="token variable">${IMAGE_NAME}</span>:<span class="token variable">${VERSION_TAG}</span> AS base|g"</span> <span class="token string">"<span class="token variable">${DOCKERFILE_PATH}</span>"</span>
<span class="token keyword">else</span>
  <span class="token comment"># Linux</span>
  <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s|FROM  <span class="token variable">${ECR_REGISTRY}</span>/<span class="token variable">${IMAGE_NAME}</span>:.*AS base|FROM  <span class="token variable">${ECR_REGISTRY}</span>/<span class="token variable">${IMAGE_NAME}</span>:<span class="token variable">${VERSION_TAG}</span> AS base|g"</span> <span class="token string">"<span class="token variable">${DOCKERFILE_PATH}</span>"</span>
<span class="token keyword">fi</span>

<span class="token builtin class-name">echo</span> <span class="token string">"✅ Dockerfile 업데이트 완료 (버전: <span class="token variable">${VERSION_TAG}</span>)"</span>
<span class="token builtin class-name">echo</span> <span class="token string">""</span>

<span class="token comment"># Git commit</span>
<span class="token builtin class-name">echo</span> <span class="token string">"📦 변경사항 커밋 중..."</span>
<span class="token function">git</span> <span class="token function">add</span> <span class="token string">"<span class="token variable">${DOCKERFILE_PATH}</span>"</span>
<span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"chore: bump version docker golden image <span class="token variable">${VERSION_TAG}</span>"</span>

<span class="token builtin class-name">echo</span> <span class="token string">""</span>
<span class="token builtin class-name">echo</span> <span class="token string">"🎉 완료!"</span></code></pre></div>
<h2 id="마치며" style="position:relative;">마치며<a href="#%EB%A7%88%EC%B9%98%EB%A9%B0" aria-label="마치며 permalink" class="auto-link after"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a></h2>
<p>환경 통제에 관련한 부분은 쉽지 않은 것 같다. 환경이 서로 다르기 때문에 개발 결과물과 배포 시 결과물이 서로 다를 때는 어떤 부분을 어떻게 접근해야하는지 때로는 감이 오지 않는 경우가 많다. 이번 기회에 docker로 local에서 배포 환경과 최대한 비슷하게 환경을 맞추고 어떤 부분에서 문제가 생겼는지 디버깅 하면서 인프라에 대한 지식을 조금이나마 얻을 수 있었던 것 같다.</p>
<p>덤으로, 이 구조의 단점은 이미지가 크다는 점이다. local에서 확인하기 위해 만들어지는 이미지는 총 2개로, playwright base 이미지와 base 이미지에 Next.js 빌드 결과물을 COPY 한 이미지(application 이미지) 총 2가지인데, 각각 3.5GB, 3.79GB이다. 그리고 ECR에 push할 이미지는 802MB다. 이는 playwright의 이미지 자체가 alpine처럼 최소화 한 이미지가 아닌, ubuntu 기반의 이미지라서인데 <a href="https://playwright.dev/docs/docker#build-your-own-image" target="_blank" rel="nofollow">playwright 공식 문서에서 Docker 커스텀 이미지 생성 방법</a>도 제안하고 있다. 단, Node.js, Playwight 브라우저 바이너리, OS 종속성을 직접 설치하는 방법이다. 이 방법을 통해 추후에 이미지 용량을 최적화해볼 수 있을 것 같다.</p>
<p>그리고 작업을 하면서 Next.js가 동작할 Application 이미지에 굳이 playwright 용 이미지 위에 올릴 필요는 없겠다는 생각도 들었다. 지금이야 하나의 어플리케이션이 pod에 배포되는 구조이지만, PDF 렌더링만 담당하는 Node.js 서버를 따로 만들고 해당 서버에서 Next.js 페이지를 참조할 통로를 열고 Next.js -> Playwright PDF 렌더링 서버 -> Nest.js 리턴 하는 방법을 사용하면 서로를 격리시키면서 단일 책임만 가져가게끔 작업하면 좋겠다는 생각도 했다.</p>
<p>그리고 build-and-update-base.sh에서 이미지 버전을 자동으로 commit을 남겨주는 방법을 사용한건 GitHub Actions를 최대한 건들이고 싶지 않았는데, 충분히 다른 방법을 통해 개선할 수 있을 것 같다. 예를 들면, GitHub Actions에서 BASE_IMAGE_TAG를 입력값/환경변수로 받아 Dockerfile을 건드리지 않고 빌드하도록 만드는 방법이 있을 것 같다.</p></div></section></article><style data-emotion="css lhozv1">.css-lhozv1{position:relative;box-sizing:border-box;width:100%;max-width:760px;margin-right:auto;margin-left:auto;}</style><div class="css-lhozv1"><div></div></div></div></main><style data-emotion="css dcfhc9">.css-dcfhc9{position:relative;padding:0 5vw;}</style><style data-emotion="css 1exn8a1">.css-1exn8a1{background:#0a0b0c;position:relative;padding:0 5vw;}.css-1exn8a1 .post-card{padding-bottom:0;border-bottom:none;}.css-1exn8a1 .post-card:after{display:none;}.css-1exn8a1 .post-card-primary-tag{color:#fff;opacity:0.6;}.css-1exn8a1 .post-card-title{color:#fff;word-break:keep-all;opacity:0.8;-webkit-transition:all 0.2s ease-in-out;transition:all 0.2s ease-in-out;}.css-1exn8a1 .post-card:hover .post-card-image{opacity:1;}.css-1exn8a1 .post-card-excerpt{color:rgb(255 255 255 / 0.6);}.css-1exn8a1 .static-avatar{border-color:#000;}.css-1exn8a1 .post-card-byline-content{color:rgb(255 255 255 / 0.6);}.css-1exn8a1 .post-card-byline-content a{color:rgb(255 255 255 / 0.8);}.css-1exn8a1 .author-avatar{border-color:#0a0b0c;}.css-1exn8a1 .author-profile-image{background:#0a0b0c;}@media (max-width: 650px){.css-1exn8a1 .post-card{-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;margin:25px;padding:25px 0 0;}}</style><aside class="read-next css-1exn8a1 e7ky4j51"><div class="css-8aaawc"><style data-emotion="css 2ud111">.css-2ud111{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin:0 -25px;padding:60px 0 0;}</style><div class="read-next-feed css-2ud111 e7ky4j50"><style data-emotion="css 1ncrsd">.css-1ncrsd{position:relative;overflow:hidden;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:0 1 326px;-ms-flex:0 1 326px;flex:0 1 326px;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;margin:0 25px 50px;padding:25px;background:linear-gradient(
    #1a1c20,
    #0a0b0c
  );border-radius:12px;}.css-1ncrsd a{-webkit-transition:all 0.2s ease-in-out;transition:all 0.2s ease-in-out;}.css-1ncrsd a:hover{-webkit-text-decoration:none;text-decoration:none;}@media (max-width: 1170px){.css-1ncrsd{-webkit-flex:1 1 261px;-ms-flex:1 1 261px;flex:1 1 261px;margin-bottom:5vw;}}@media (max-width: 650px){.css-1ncrsd{display:none;-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;margin:0 25px;padding:0;background:none;}}</style><article class="read-next-card css-1ncrsd ez817vd4"><header class="read-next-card-header"><style data-emotion="css 18chcim">.css-18chcim{margin:0;font-size:1.3rem;font-weight:300;line-height:1em;color:rgb(255 255 255 / 0.6);letter-spacing:0.4px;}.css-18chcim span,.css-18chcim a{font-size:inherit;}.css-18chcim a{font-weight:500;color:#fff;-webkit-text-decoration:none;text-decoration:none;opacity:0.8;}.css-18chcim a:hover{opacity:1;}</style><h3 class="css-18chcim ez817vd3"><span>More in</span> <a href="/tags/infrastructure/">Infrastructure</a></h3></header><style data-emotion="css 1vix6iq">.css-1vix6iq{font-size:1.3rem;}.css-1vix6iq ul{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;margin:0;padding:0;list-style:none;}.css-1vix6iq li{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;margin:0;padding:20px 0;border-bottom:rgb(255 255 255 / 0.1);}.css-1vix6iq li:last-of-type{padding-bottom:5px;border:none;}.css-1vix6iq h4{margin:0;font-size:1.3rem;font-weight:600;line-height:1.6em;}.css-1vix6iq li a{display:block;font-size:inherit;color:#fff;opacity:0.8;}.css-1vix6iq li a:hover{opacity:1;}</style><div class="read-next-card-content css-1vix6iq ez817vd2"><ul><li><h4><a href="/nextjs/nextjs-standalone-dependency-tracing-issue/">Next.js standalone 종속성 추적 삽질기 (feat. pino)</a></h4><style data-emotion="css 1qhf9t">.css-1qhf9t{margin-top:2px;font-size:1.2rem;font-weight:400;line-height:1.4em;}.css-1qhf9t p{margin:0;font-size:inherit;color:rgb(255 255 255 / 0.6);}.css-1qhf9t p time{font-size:inherit;}</style><div class="read-next-card-meta css-1qhf9t ez817vd1"><p><time dateTime="2025-09-12">2025-09-12</time> -<!-- --> <!-- -->13 min read</p></div></li></ul></div><style data-emotion="css ok4czd">.css-ok4czd{position:relative;margin:40px 0 5px;}.css-ok4czd a{padding:7px 12px 8px 14px;font-size:1.3rem;color:rgb(255 255 255 / 0.6);border:1px solid rgb(255 255 255 / 0.6);border-radius:999px;-webkit-transition:all 0.35s ease-in-out;transition:all 0.35s ease-in-out;}.css-ok4czd a:hover{color:#fecd35;-webkit-text-decoration:none;text-decoration:none;border-color:#fecd35;}</style><footer class="read-next-card-footer css-ok4czd ez817vd0"><a href="/tags/infrastructure/">See all 2 posts<!-- --> →</a></footer></article><style data-emotion="css 1a2xhz7">.css-1a2xhz7{position:relative;overflow:hidden;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1 1 301px;-ms-flex:1 1 301px;flex:1 1 301px;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:220px;margin:0 20px 60px;-webkit-background-size:cover;background-size:cover;}.css-1a2xhz7 img{-webkit-transform:scale(1)!important;-moz-transform:scale(1)!important;-ms-transform:scale(1)!important;transform:scale(1)!important;-webkit-transition:opacity 0.3s ease-out 0s,-webkit-transform 0.5s ease 0s!important;transition:opacity 0.3s ease-out 0s,transform 0.5s ease 0s!important;}.css-1a2xhz7:hover .post-card-image:after{opacity:var(--post-card-after-opacity);}.css-1a2xhz7:hover img[data-main-image]{-webkit-transform:scale(1.03)!important;-moz-transform:scale(1.03)!important;-ms-transform:scale(1.03)!important;transform:scale(1.03)!important;}.css-1a2xhz7.is-next .post-card-image{background:#191b1f;border:1px solid var(--image-border-color__dark);}.css-1a2xhz7.is-next .post-card-primary-tag a{color:#90a2aa;}.css-1a2xhz7.is-next .post-card-excerpt{color:#768086;}.css-1a2xhz7.is-next .post-card-byline-content{color:#90a2aa;}</style><article class="post-card is-next css-1a2xhz7"><style data-emotion="css uih3rl">.css-uih3rl{position:relative;overflow:hidden;display:block;border-radius:12px;}</style><a class="post-card-image-link css-uih3rl" href="/nextjs/nextjs-standalone-dependency-tracing-issue/"><style data-emotion="css pg199o">.css-pg199o{overflow:hidden;width:auto;height:200px;background-color:var(--background-color);-webkit-background-size:cover;background-size:cover;border:1px solid var(--image-border-color);border-radius:12px;}.css-pg199o:after{content:'';position:absolute;top:0;left:0;display:block;width:100%;height:100%;opacity:var(--post-card-opacity);background-color:var(--post-card-background);-webkit-transition:all 0.3s ease 0s;transition:all 0.3s ease 0s;}.css-pg199o img{border-radius:12px;}</style><div class="post-card-image css-pg199o ezywgfd6"><div data-gatsby-image-wrapper="" style="height:100%" class="gatsby-image-wrapper"><div aria-hidden="true" style="padding-top:56.25%"></div><img aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear" decoding="async" src="data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIDBQb/xAAXAQADAQAAAAAAAAAAAAAAAAABAwQF/9oADAMBAAIQAxAAAAHLjx3ZaFkFf//EABsQAAICAwEAAAAAAAAAAAAAAAECAAMREhQh/9oACAEBAAEFAnPpxLKyWM2PeyKZ/8QAGREBAAIDAAAAAAAAAAAAAAAAAQARAyFR/9oACAEDAQE/AQsvkM+p/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAEDITH/2gAIAQIBAT8BwcNn/8QAHBAAAgIDAQEAAAAAAAAAAAAAAAERIgIhYTFB/9oACAEBAAY/AvkrRaxL2+GXGxYTWBN+n//EAB0QAQEAAgEFAAAAAAAAAAAAAAERACFRMXGx8PH/2gAIAQEAAT8hQSRqcHvOJg1Xj7iMcnQnepcnQqo9rk0NG4pn/9oADAMBAAIAAwAAABAk3//EABoRAQACAwEAAAAAAAAAAAAAAAEAEUGBkfD/2gAIAQMBAT8QsBgvIYC325//xAAaEQEAAgMBAAAAAAAAAAAAAAABABEhMaHw/9oACAECAQE/EEtnShGtXuT/xAAdEAEAAgICAwAAAAAAAAAAAAABETEAIVFhQXGR/9oACAEBAAE/EHrGtYOYOz0hMlN9gGSoMzSG+omMYigShQ1UmEShCIkAdarWAQjFuFX5d/KrF4U1SjU6eAz/2Q==" alt=""/><picture><source type="image/webp" data-srcset="/static/0152e08f5e4324b47115749c8231fdb1/d704a/main.webp 750w,/static/0152e08f5e4324b47115749c8231fdb1/b21f9/main.webp 1080w,/static/0152e08f5e4324b47115749c8231fdb1/4094c/main.webp 1366w,/static/0152e08f5e4324b47115749c8231fdb1/91943/main.webp 1920w" sizes="100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="100vw" decoding="async" loading="lazy" data-src="/static/0152e08f5e4324b47115749c8231fdb1/a464d/main.jpg" data-srcset="/static/0152e08f5e4324b47115749c8231fdb1/796f4/main.jpg 750w,/static/0152e08f5e4324b47115749c8231fdb1/8d2a5/main.jpg 1080w,/static/0152e08f5e4324b47115749c8231fdb1/91332/main.jpg 1366w,/static/0152e08f5e4324b47115749c8231fdb1/a464d/main.jpg 1920w" alt="Next.js standalone 종속성 추적 삽질기 (feat. pino) cover image"/></picture><noscript><picture><source type="image/webp" srcSet="/static/0152e08f5e4324b47115749c8231fdb1/d704a/main.webp 750w,/static/0152e08f5e4324b47115749c8231fdb1/b21f9/main.webp 1080w,/static/0152e08f5e4324b47115749c8231fdb1/4094c/main.webp 1366w,/static/0152e08f5e4324b47115749c8231fdb1/91943/main.webp 1920w" sizes="100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="100vw" decoding="async" loading="lazy" src="/static/0152e08f5e4324b47115749c8231fdb1/a464d/main.jpg" srcSet="/static/0152e08f5e4324b47115749c8231fdb1/796f4/main.jpg 750w,/static/0152e08f5e4324b47115749c8231fdb1/8d2a5/main.jpg 1080w,/static/0152e08f5e4324b47115749c8231fdb1/91332/main.jpg 1366w,/static/0152e08f5e4324b47115749c8231fdb1/a464d/main.jpg 1920w" alt="Next.js standalone 종속성 추적 삽질기 (feat. pino) cover image"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div></div></a><style data-emotion="css z5atxi">.css-z5atxi{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><div class="post-card-content css-z5atxi ezywgfd5"><style data-emotion="css 1k7wcu">.css-1k7wcu{margin:15px 0 0.2em;font-size:1.2rem;font-weight:500;color:#90a2aa;letter-spacing:0.2px;}.css-1k7wcu a{font-size:1.2rem;color:var(--anchor-secondary-color);}</style><div class="post-card-primary-tag css-1k7wcu ezywgfd4"><a href="/tags/next-js/">Next.js</a>,  <a href="/tags/infrastructure/">Infrastructure</a></div><style data-emotion="css 1fjrpmt">.css-1fjrpmt{position:relative;display:block;color:#15171A;}.css-1fjrpmt:hover{-webkit-text-decoration:none;text-decoration:none;}</style><a class="post-card-content-link css-1fjrpmt" href="/nextjs/nextjs-standalone-dependency-tracing-issue/"><header><style data-emotion="css 18yvs8h">.css-18yvs8h{margin:0 0 0.4em;line-height:1.15em;color:var(--post-card-title);word-break:keep-all;}</style><h2 class="post-card-title css-18yvs8h ezywgfd3">Next.js standalone 종속성 추적 삽질기 (feat. pino)</h2></header><style data-emotion="css 1uf2vd9">.css-1uf2vd9{font-size:1.6rem;color:var(--post-card-description);}.css-1uf2vd9 p{overflow:hidden;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;width:100%;margin-bottom:0.4em;font-size:1.4rem;text-overflow:ellipsis;word-break:keep-all;}</style><section class="post-card-excerpt css-1uf2vd9 ezywgfd2"><p>Next.js를 standalone 모드로 빌드하면서 종속성 누락 문제를 겪었다. @vercel/nft의 정적 추적 방식, pnpm의 심볼릭 링크 구조, 그리고 pino-pretty를 포함해 종속성이 빠지는 이유와 해결 과정을 기록한다.</p></section></a><style data-emotion="css 143c7df">.css-143c7df{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;padding:0;}</style><footer class="post-card-meta css-143c7df ezywgfd1"><style data-emotion="css 137vq87">.css-137vq87{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1 1 50%;-ms-flex:1 1 50%;flex:1 1 50%;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;font-weight:400;line-height:1.4em;color:#90a2aa;letter-spacing:0.2px;}.css-137vq87 time{font-size:1.3rem;}.css-137vq87 span{margin:0;font-size:1.3rem;}.css-137vq87 a{font-weight:600;color:var(--post-card-by-line);}</style><div class="post-card-byline-content css-137vq87 ezywgfd0"><span class="post-card-byline-date"><time dateTime="2025-09-12T09:00">2025-09-12</time> <span class="bull">•</span> <span>13 min read</span></span></div></footer></div></article></div></div></aside><style data-emotion="css d4eprp">.css-d4eprp{position:relative;padding:0 5vw;position:relative;padding-top:20px;padding-bottom:22px;color:#fff;background:#000;}</style><footer class="css-d4eprp"><style data-emotion="css 98e3yl">.css-98e3yl{width:100%;max-width:1040px;margin:0 auto;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;font-size:1.3rem;color:rgb(255 255 255 / 0.7);}.css-98e3yl a{color:rgb(255 255 255 / 0.7);}.css-98e3yl a:hover{color:rgb(255 255 255 / 1);-webkit-text-decoration:none;text-decoration:none;}@media (max-width: 650px){.css-98e3yl{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}</style><div class="css-98e3yl"><section class="copyright">© <!-- -->2025<!-- --> <span>|  </span><a href="https://www.gatsbyjs.com/" target="_blank" rel="nofollow noreferrer">Pozafly&#x27;s Blog<!-- --> <!-- -->is based on Gatsby</a></section><style data-emotion="css 13qgqyf">.css-13qgqyf{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}.css-13qgqyf a{position:relative;margin-left:20px;font-size:1.3rem;}.css-13qgqyf a:before{content:'';position:absolute;top:11px;left:-11px;display:block;width:2px;height:2px;background:#fff;border-radius:100%;}.css-13qgqyf a:first-of-type:before{display:none;}@media (max-width: 650px){.css-13qgqyf a:first-of-type{margin-left:0;}}</style><nav class="css-13qgqyf e69t7dt0"><a href="/">Latest Posts</a><a href="https://github.com/pozafly" target="_blank" rel="noopener noreferrer">Github</a><a href="/rss.xml">RSS</a></nav></div></footer></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/infrastructure/reproducing-nextjs-playwright-pdf-environment-for-eks/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-243e2874ddabdf35db56.js\"],\"component---src-pages-404-tsx\":[\"/component---src-pages-404-tsx-f80f5932485c0e6741e2.js\"],\"component---src-pages-about-tsx\":[\"/component---src-pages-about-tsx-64d7d3ccee767ca30264.js\"],\"component---src-pages-tags-tsx\":[\"/component---src-pages-tags-tsx-e6639ae25a8295c07e04.js\"],\"component---src-templates-index-tsx\":[\"/component---src-templates-index-tsx-8414d5ce6bad9b108f3d.js\"],\"component---src-templates-post-tsx\":[],\"component---src-templates-tags-tsx\":[\"/component---src-templates-tags-tsx-0db7949eed88ccf541bc.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="f2408e1fe37e92453db8";</script><script src="/webpack-runtime-908b5685f7239c199847.js" async></script><script src="/app-243e2874ddabdf35db56.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>