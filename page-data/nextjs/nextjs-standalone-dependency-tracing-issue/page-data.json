{"componentChunkName":"component---src-templates-post-tsx","path":"/nextjs/nextjs-standalone-dependency-tracing-issue/","result":{"data":{"markdownRemark":{"html":"<p>Next.js를 실행하면 클라이언트 측 로그는 브라우저의 콘솔에 나타나지만, 서버 측 로그는 제대로 된 로그를 출력해주지 않았다. 이번에 프로젝트에 Next.js의 node 환경에서 log를 찍기 위해 라이브러리를 사용하면서 만난 트러블슈팅을 기록한다.</p>\n<p>먼저 <a href=\"https://github.com/pinojs/pino\" target=\"_blank\" rel=\"nofollow\">pino</a>라는 라이브러리를 사용했는데, pino는 node 진영에서 <a href=\"https://github.com/winstonjs/winston\" target=\"_blank\" rel=\"nofollow\">winston</a>과 함께 많이 사용되는 로깅 라이브러리다. 짧게 이야기하면 로깅 라이브러리는 비동기를 사용하는 pino로 결정. 그리고 <a href=\"https://github.com/pinojs/pino-pretty\" target=\"_blank\" rel=\"nofollow\">pino-pretty</a> 라이브러리는 pino로 찍은 로그를 더 알아보기 쉬운 형태로 포매팅 해주는 도구다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 847px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 78.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsTAAALEwEAmpwYAAABmklEQVR42o2TCY7jIBBFfY60AS9hX2yM8R47mfsfaopE6R5p1N3+khEYXvELiowxbq2zzgmlpJTKGMoZynN8Qtk4juuyhanvYrMs64ef8nZA0iIqfodDCMd+d4MX3nRdQE1ENuD6ign5HQarIfQ1oyW7Qgq4polE6JRtzvkyz8KogkEEhq4Mn1bGGGu910KwsqSUEdi5rE/DnIFto5QFnjFSXXFZnYUvl0sf4zTP1jU8XdLHK2H0TvvVIU8Vb72GGcEEpo0xwzj2cQh9bNo29D1EhDYOSWBNKagAq7WGldAXySZPcJ7n8O92HPt+rOt22/dtS+1+HPfHH2ghkHMOKgj2RP8ogw+cQ7AnABEgxO3+eKxpfOtCku86l5LiwFNKv3IWUlhjuVG14lppIhThqqgqyA+m86c+0/6vSJQEg8t941ZKIXOuEJOptt8n99Npw5PY1rWfVhuWxlksNQJet8h4THm6NlJ8CzdNCxUWhimMq/ctlibBxqci5xoBX3wPxxiXeWmHwfRxmiYET0popBwyLZIGV/UP5v8C3XGMVSiCtPMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pino-pretty-formatting\"\n        title=\"\"\n        src=\"/static/7d887646d34bf30c82ed744634c1a64c/ba37d/pino-pretty-formatting.png\"\n        srcset=\"/static/7d887646d34bf30c82ed744634c1a64c/b30f8/pino-pretty-formatting.png 500w,\n/static/7d887646d34bf30c82ed744634c1a64c/ba37d/pino-pretty-formatting.png 847w\"\n        sizes=\"(max-width: 847px) 100vw, 847px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>pino를 Next.js 프로젝트에 예쁘게 입혔지만 포맷이 마음에 들지 않았기 때문에 pino-pretty 라이브러리를 추가로 설치하고 프로젝트에 설정해주었다.</p>\n<p>로컬에서 두 도구를 사용해 API Routes, SSR 측 fetching API 로그를 콘솔에서 확인 후에 테스트를 해보기 위해 테스트 서버로 올렸다. 하지만, 로컬에선 멀쩡히 예쁘게 찍히던 pino 로그가 테스트 서버로 올리자마자 아래 에러와 함께 /500 페이지로 이동했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">error: unable to determine transport target for \"pino-pretty\"</code></pre></div>\n<p>처음에는 <strong>설정이 틀렸나?</strong> 했다가, 한참을 돌아보니 Next.js의 standalone 빌드 방식 + pino의 transport 로딩 구조 + pnpm의 심볼릭 링크 특성이 합쳐져 터진 문제였다. 일단 pino 설정 코드부터 보자.</p>\n<br/>\n<h2 id=\"pino-설정-코드\" style=\"position:relative;\">pino 설정 코드<a href=\"#pino-%EC%84%A4%EC%A0%95-%EC%BD%94%EB%93%9C\" aria-label=\"pino 설정 코드 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> pino <span class=\"token keyword\">from</span> <span class=\"token string\">'pino'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> logger <span class=\"token operator\">=</span> <span class=\"token function\">pino</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// level 등은 생략</span>\n  transport<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    target<span class=\"token operator\">:</span> <span class=\"token string\">'pino-pretty'</span><span class=\"token punctuation\">,</span></span>    options<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      colorize<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      translateTime<span class=\"token operator\">:</span> <span class=\"token string\">'SYS:HH:MM:ss'</span><span class=\"token punctuation\">,</span>\n      customColors<span class=\"token operator\">:</span> <span class=\"token string\">'err:red,info:blue'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token operator\">...</span><span class=\"token punctuation\">(</span>isLocal <span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> singleLine<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>pino는 transport 옵션을 줄 수 있는데, 로그를 전송하고 변환할 수 있게 해줄 수 있는 옵션이다. 포매팅을 넣고 싶다면 <code class=\"language-text\">target</code> 에 적어줄 수 있다(<a href=\"https://github.com/pinojs/pino/blob/main/docs/transports.md#pino-pretty\" target=\"_blank\" rel=\"nofollow\">공식 문서</a>).</p>\n<p>target에 문자열로 pino-pretty를 적어주는 방법이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1005px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 10.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAiElEQVR42j2Myw6CMADA/A8vHowmajLGNmAMgjwlICCI//8plXjw0KS9dCd0iMsq2udEWjSY9IPLB/L6QT/OxHWPV7/Q9YDfrui8Q4cxKkqQgUWFbnOHtgkX4bPbH46cbx7jsjLMb7Ky5F41FE1HNy1M8zYJIjwVIJVBSIM0dpvFP7RN/326Cr600EQo2nz5KwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pretty-log\"\n        title=\"\"\n        src=\"/static/b111cfde7499f70a1c7c6eb5bf2cc100/66ac9/pretty-log.png\"\n        srcset=\"/static/b111cfde7499f70a1c7c6eb5bf2cc100/b30f8/pretty-log.png 500w,\n/static/b111cfde7499f70a1c7c6eb5bf2cc100/332ff/pretty-log.png 1000w,\n/static/b111cfde7499f70a1c7c6eb5bf2cc100/66ac9/pretty-log.png 1005w\"\n        sizes=\"(max-width: 1005px) 100vw, 1005px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위 사진과 같이 이 방법으로 로컬에서 문제 없이 동작했다. 하지만, 테스트 서버에서의 로그는 unable to determine transport target for “pino-pretty” 라고 에러를 뱉고 있었다. (물론 빌드도 문제 없이 성공했다)</p>\n<p>처음엔 몇 가지 해결책을 시도해봤다.</p>\n<ol>\n<li>devDependencies → dependencies로 승격</li>\n</ol>\n<p>pino-pretty 라이브러리는 운영에 배포되면 안되겠다는 가벼운 생각 때문에 devDependencies로 설치했지만, 생각해보니 코드 모두 운영에 올라가야 맞다는 생각으로 dependencies로 옮겨주었다. 여전히 해결되지 않았다.</p>\n<ol start=\"2\">\n<li>import로 라이브러리 가져오기</li>\n</ol>\n<p>문자열로 선언해서 라이브러리를 가져오지 못할 것이라 예상해서 아래 코드와 같이 먼저 import 구분으로 가져왔다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> pinoPretty <span class=\"token keyword\">from</span> <span class=\"token string\">'pino-pretty'</span><span class=\"token punctuation\">;</span></span>\ntransport<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  target<span class=\"token operator\">:</span> pinoPretty<span class=\"token punctuation\">,</span></span>  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>프로젝트는 package.json에 type module을 통해 프로젝트 전체를 ESM으로 사용하고 있었기 때문에 import 구문이 문제가 없을 것이라 생각했지만,</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">⨯ TypeError: The \"path\" argument must be of type string. Received function build\n    at eval (src/shared/server/common/config/loggerConfig.ts:15:20)\n    ...\n> 15 | const logger = pino({\n     |                    ^\n  17 |   transport: {\n  18 |     target: pinoPretty, {\n  code: 'ERR_INVALID_ARG_TYPE',</code></pre></div>\n<p>이런 에러가 발생했다. ERR_INVALID_ARG_TYPE 에러는 Node.js에서 함수나 메서드에 넘긴 인자의 타입이 예상한 타입과 다를 때 발생하는 에러인데, path에 function 타입 대신 string 타입을 넣어야 한다는 뜻이다.</p>\n<p>node_modules에 있는 pino-pretty/index.js 파일을 까보았다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">build</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">opts <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> pretty <span class=\"token operator\">=</span> <span class=\"token function\">prettyFactory</span><span class=\"token punctuation\">(</span>opts<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">abstractTransport</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">source</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n\nmodule<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span>default <span class=\"token operator\">=</span> build</code></pre></div>\n<p>역시 pino 및 pino-pretty는 Node.js 서버 환경에서 주로 사용하는 라이브러리라 그런지 CommonJS 형태로 작성되어 있다.</p>\n<p>default로 export 하는 것은 함수다. 따라서 공식문서에서 권장하는 대로 string 값인 ‘pino-pretty’ 를 적어주는게 맞았던 것이다. CommonJs 문법으로 작성된 걸 보니 혹시나 싶어 require로 가져오도록 해봤지만 여전히 해결되지 않았다.</p>\n<p>왜 로컬에서는 동작하고, 테스트 서버 환경에서는 동작하지 않는지 곰곰이 생각해보니 Next.js를 standalone으로 배포하고 있다는게 떠올랐다.</p>\n<br/>\n<h2 id=\"Nextjs의-standalone-빌드\" style=\"position:relative;\">Next.js의 standalone 빌드<a href=\"#Nextjs%EC%9D%98-standalone-%EB%B9%8C%EB%93%9C\" aria-label=\"Nextjs의 standalone 빌드 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<p><a href=\"https://nextjs.org/docs/pages/api-reference/config/next-config-js/output#automatically-copying-traced-files\" target=\"_blank\" rel=\"nofollow\">Next.js output 공식문서</a>에 따르면 standalone은 node_modules에서 프로덕션 배포에 필요한 파일만 복사하는 방식을 사용한다.</p>\n<p>즉, 어플리케이션을 실행하는데 필요한 최소한의 코드만 node_modules에 가져가고, 이는 빌드 시 <code class=\"language-text\">.next/standalone</code> 하위에 저장하고 사용하겠다는 뜻이다. 즉, 사용하지 않은 코드 및 모듈은 모두 트리쉐이킹 되어 artifact에 포함되지 않는다. 그러면 docker image에 파일크기가 적은 상태로 빌드 되고, image 용량이 줄기 때문에 빌드 시간 및 EKS에 도달하는 속도도 획기적으로 줄일 수 있게 된다.</p>\n<p>테스트 서버에서 pino-pretty 모듈을 찾지 못했기 때문에 standalone으로 빌드된 artifact에 pino-pretty가 없을 것 같았다. 얼른 빌드해 보았다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAC4jAAAuIwF4pT92AAACPElEQVR42p1U2XLaQBDUX+Qh5tItrW4JcQkbYxOwTdnYVEHsVPL/f9GZGRBPJEZ+aFaUVr3TM72t6baCqRIU0ztYfgwvKmAHKTqm9yVohhvCIoL79RaOnwihRWtLd75G2LZ82KaLb49bmNtfUH6EIB/DT0q0DZfQkLBDhD16iGYLxLdLWG4EJ8ykSt0JBI0Iu0xoeZg97lAtNnCon+lgiiAbIirGiPIRuC1c7UWETHZlhNg/p9i/Vug6Kfy4DzfMZQMf2LBCD991hf1Lgd/vS/TcjAaTwQmyYw/d5pJ1R2F4v0E+XcEmySFJjfsTkktrMaEqVYOh0E+PPlBpH3k1g+nFUh2De2d4UcMpMyGZ26Dpzp8/qKKx9NAjsBeverasjEvkE6Er1jBViMWuQtQvyTa5ENrqMCA/OeCSaZ8kG57Cw/st0uGI5B4JSbZLN4fJ+P/FhGJu28fweoXV9kP6xv5jL7ILasmdyyQfvMYhEfbHEhImEbpRLiu/Y9LPiHgOvPdUoUF9DMgi8/Ub+TBHkA5kU0u3P5XJ77kdPAuNZXSljx7K6zvcPLzAIuuEJJmHw7IdSqN2LfkM+J3ceypA0x1iJsuwvMHND7rTrzIIvse8KqqUr6Fuc1CE/4RJYcIe1ryj50KqZP70hvXuD5Jyinw0kwizyDqcPvW+s6CDWYkiaPVtsAglDaRaPElFh4DI5Jk/kH3/AcedSYmv1Q3v0WDG8xWWm590aoG4nIjcpKwocIenoDiHVt1DJ8Bf1qRSuQXrE3AAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"standalone-artifact-not-pino-pretty\"\n        title=\"\"\n        src=\"/static/e8889878404084c700358eafec662579/a331c/standalone-artifact-not-pino-pretty.png\"\n        srcset=\"/static/e8889878404084c700358eafec662579/b30f8/standalone-artifact-not-pino-pretty.png 500w,\n/static/e8889878404084c700358eafec662579/a331c/standalone-artifact-not-pino-pretty.png 800w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>역시나 <code class=\"language-text\">.next/standalone/node_modules</code> 에서 pino-pretty는 찾을 수 없었다. 원인을 찾았으니 이제 해결만 하면 된다. .next/standalone/node_modules에 pino-pretty 모듈만 넣어줄 수 있다면 문제는 해결 될 것이다.</p>\n<h3 id=\"outputFileTracingIncludes\" style=\"position:relative;\">outputFileTracingIncludes<a href=\"#outputFileTracingIncludes\" aria-label=\"outputFileTracingIncludes permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<p><a href=\"https://nextjs.org/docs/pages/api-reference/config/next-config-js/output#caveats\" target=\"_blank\" rel=\"nofollow\">공식문서</a>에 따르면 next.config.js 파일에 outputFileTracingIncludes 설정을 하면 추적에 필요한 파일을 standalone으로 빌드한 artifact에 포함시켜줄 수 있다고 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// next.config.js</span>\n<span class=\"token literal-property property\">outputFileTracingIncludes</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string-property property\">'/'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'./node_modules/pino-pretty/**/*'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>위와 같이 현재 로컬에 있는 <code class=\"language-text\">./node_modules/pino-pretty</code> 디렉토리를 찾아 하위에 있는 파일을 모두 artifact에 넣도록 설정한다.\n그리고 다시 빌드.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 688px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.6%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABFElEQVR42pWS2U7DMBBF/R+gpFkcZ3HsLE4TpymUggCBEIuEhJD4/8+4jI3Ux7Y8HM2D7aN7R2ZysLj7+IJZ9mjttUdocyBvhn/BeNXC3jzCbHao2tEj6o7okdFMy8aTlPosWJQWWG9vsdm/IhEKsp2gOgttZpRqQBDluFxxhHF+FiziFYkkdu8ThmWGkIakI3ihUTUjSj3QXCPKJAL3KCmOwsK0hJMuTyN6OyHOFEl7pCTMaQrZIaf6K7oXRMJLj8GcNeIlZLPF/ds3BO3UJXKCi5BT3cxzKh2nPbs3PmFCdZSxuHp4oYMWhTK0hhpprn111+BU1ZjuHyrHJDT0XZ4/f7ys7iafUvWWmL38VMK0+Ev4C+oo72TEtpHoAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"get-pino-pretty\"\n        title=\"\"\n        src=\"/static/a3205c6acc94483a883158927cab50c9/d21f0/get-pino-pretty.png\"\n        srcset=\"/static/a3205c6acc94483a883158927cab50c9/b30f8/get-pino-pretty.png 500w,\n/static/a3205c6acc94483a883158927cab50c9/d21f0/get-pino-pretty.png 688w\"\n        sizes=\"(max-width: 688px) 100vw, 688px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>드디어 잘 들어왔다.</p>\n<br/>\n<h2 id=\"다시-문제-발생\" style=\"position:relative;\">다시 문제 발생<a href=\"#%EB%8B%A4%EC%8B%9C-%EB%AC%B8%EC%A0%9C-%EB%B0%9C%EC%83%9D\" aria-label=\"다시 문제 발생 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<p>기대하는 마음을 안고 다시 테스트 서버로 배포해봤다. 하지만 이번엔 에러 메시지가 바뀌었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">uncaughtException: [Error: Cannot find module 'colorette']</code></pre></div>\n<p><code class=\"language-text\">colorette</code>는 뭐지? 프로젝트에서는 사용하지 않는 라이브러리다. 아마도 pino-pretty의 내부 종속성이 아닐까? pino-pretty/index.js에서 사용하고 있는 모듈이었다. 그러면 next.config.js에 <code class=\"language-text\">outputFileTracingIncludes</code> 에 pino-pretty에서 사용하고 있는 모듈을 넣어주면 그만이다.</p>\n<p>종속성을 파악해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">node</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"console.log(Object.keys(require('pino-pretty/package.json').dependencies || {}))\"</span></code></pre></div>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[\n<span class=\"gatsby-highlight-code-line\">  'colorette',</span>  'dateformat',\n  'fast-copy',\n  'fast-safe-stringify',\n  'help-me',\n  'joycon',\n  'minimist',\n  'on-exit-leak-free',\n  'pino-abstract-transport',\n  'pump',\n  'readable-stream',\n  'secure-json-parse',\n  'sonic-boom',\n  'strip-json-comments'\n]</code></pre></div>\n<p>하위 종속성이 꽤 많다. 프로젝트는 <a href=\"https://pnpm.io/ko/\" target=\"_blank\" rel=\"nofollow\">pnpm</a>을 사용하고 있으므로, colorette를 포함한 하위 종속성은 로컬의 <code class=\"language-text\">node_modules/.pnpm</code> 디렉토리 하위에 저장된다. 따라서 해당 경로를 찾아 artifact에 포함시켜야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token literal-property property\">outputFileTracingIncludes</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string-property property\">'/'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'./node_modules/pino-pretty/**/*'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'./node_modules/.pnpm/pino-pretty@*/*'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'./node_modules/.pnpm/pino-pretty@*/node_modules/**'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 684px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 161.20000000000002%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAgCAYAAAASYli2AAAACXBIWXMAABYlAAAWJQFJUiTwAAADE0lEQVR42p1WWVIiURDkHjOiQu97P6CBZpNFFtGYCC8w33P/A+RUFrbBOGg8+SjoVjrJrMyqR+vei+DGOeaHX0jKAaK8jzDrod313+vWCayrxReC9icPKEdT+EmBIDVwwkwqRVfqzg217AHlw6aeo149C0iOtDeUGiExQwSZwU3H07IG5Ld3/BgPrxWqxVhY9hAVA3hxIW2okPXGiOXeGvDWCVV2va2F5QpuVGgvKZ2gnrTBjTIr2QrYfpOdljVm2xd0gwSpGQnoAD/vXfy4c/Sdsttd70ujWs3FnRuh6wvL1Q7lcKbsWGRK9yk9lZ6Gcu+npR1gR2Sb6QPyuoaTlPDlYVci5EkF0kMa5Mnfu0FqAaigCZLcw+8/K5SSzVF/CJMWWn0zQNqvhZ350vFWE94buYkcD8Z1cTwcsV1uUIYxhqVBVRjUmcSp6+InHzwL/cd6Z9gWU2LHx8BxcFhtsF8sUUUJpgTLDeZZhtLzBTBUNRY9DMVtiY9cL/cvmD8+IZTmZ0bMEEPi/JRNyxwG/2Rs+njEaLmVGS+0ZzTCF0Osc3gOSDn1ao/hfKOh1vgIGGNzBSD742MhkuvNAUFiZPP0deziopLZrnTGzWim+bwU8IsMxxLuaraWccvfA87Raz7HMf2M7QWGASabJ+nhTpZEqUaEYgjl2+zGi4DznUheH3TxxtI7Mv3W+vpPsrCraIowZP+4wbkwbp1rGW6f1WkyiwoxRZbDOUvLbXMu+VklcwmQnZ4z0kc6zG3DTU5jTuvMt8zhYqNnCo1pnNZto2Ev9cxhG/il545/yTAgWHYauaQc6sJt2JJlLtuHppGtBeD+NCkC2ABwDC9tGAvJO5XMMFMmJ8YTU2zOlU8ZTmT0PMkhx4294rly03EvGmERm6OOH6NCqVl/rO7ScS4JXluO3ptk6V9FlxkbNeF0MPE4ZU/p/LdmWUdPJPPB+I2RToy803Ey5jFrzXAikTnlMFOHdUmQpbzfe/E1s7zFYL5WZymR8VHA1Fzn8vrlVZcsf4nRFMptfppw/Cg3H9T6v4+AfwE6SrV9+DZ0yQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"include-colorette\"\n        title=\"\"\n        src=\"/static/276e208c7641fcd28e086616ec75092c/bf424/include-colorette.png\"\n        srcset=\"/static/276e208c7641fcd28e086616ec75092c/b30f8/include-colorette.png 500w,\n/static/276e208c7641fcd28e086616ec75092c/bf424/include-colorette.png 684w\"\n        sizes=\"(max-width: 684px) 100vw, 684px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>하지만 여전히 테스트 서버에서는 실패한다. 이상하다. 생각해보면 pino-pretty가 <strong>로컬</strong>에서 내부적으로 모듈을 사용할 때 require 문법으로 모듈을 가져올텐데, <code class=\"language-text\">.pnpm</code> 하위 모듈을 어떻게 가져올 수 있을까?</p>\n<br/>\n<h2 id=\"pnpm의-node_modules-저장-방식\" style=\"position:relative;\">pnpm의 node_modules 저장 방식<a href=\"#pnpm%EC%9D%98-node_modules-%EC%A0%80%EC%9E%A5-%EB%B0%A9%EC%8B%9D\" aria-label=\"pnpm의 node_modules 저장 방식 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<p>모든 프로젝트에서 단말기 저장장치의 효율 및 속도 때문에 <a href=\"https://pnpm.io/ko/\" target=\"_blank\" rel=\"nofollow\">pnpm</a> 을 패키지 매니저로 사용하고 있다.</p>\n<p>node_modules는 일반적으로 flat(hoisted) 구조로 패키지에서 사용하는 종속성 하위 구조 모두 flat하게 저장하지만, pnpm은 심볼릭 링크를 통해 전역의 pnpm store에 저장된 모듈을 단순히 연결시켜주는 역할을 하고 있다.</p>\n<blockquote>\n<p>만약 패키지 매니저의 설치 매커니즘을 조금 더 깊게 알고 싶다면 아래의 블로그를 보면 도움이 될 것이다.</p>\n<ul>\n<li><a href=\"https://toss.tech/article/node-modules-and-yarn-berry\" target=\"_blank\" rel=\"nofollow\">node_modules로부터 우리를 구원해 줄 Yarn Berry - toss</a></li>\n<li><a href=\"https://engineering.ab180.co/stories/yarn-to-pnpm\" target=\"_blank\" rel=\"nofollow\">Yarn 대신 pnpm으로 넘어간 3가지 이유 - ab180</a></li>\n</ul>\n</blockquote>\n<p>기본적으로 node.js는 require 구문을 만나면 루트를 기준으로 node_modules를 찾고, 없으면 상위로 올라가며 탐색한다. (require(‘pkg’) → ./node_modules/pkg → ../node_modules/pkg … )\n그리고 .pnpm은 현재 모듈의 파일 위치에서 시작해, 상위로 올라가며 node_modules/&#x3C;이름> 을 찾는다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">project/\n└─ node_modules/\n   ├─ pino-pretty  ->  .pnpm/pino-pretty@X.Y.Z/node_modules/pino-pretty   (심링크)\n   └─ .pnpm/\n      ├─ pino-pretty@X.Y.Z/\n      │  └─ node_modules/\n      │     └─ pino-pretty/\n      │        └─ index.js   &lt;-- 여기서 require('colorette') 호출\n      └─ colorette@A.B.C/\n         └─ node_modules/\n            └─ colorette/</code></pre></div>\n<p>따라서, <strong>로컬</strong>에서 import(require) 구문으로 모듈을 가져오는건 해당 모듈(pino-pretty)를 찾고, 없으면 project/node_modules 에서 관련 모듈(colorette)을 찾아서 가져오는 형태다.</p>\n<p>즉,</p>\n<ul>\n<li>pino-pretty/index.js가 require(‘colorette’)를 호출하면,</li>\n<li>node.js는 먼저 현재 모듈 경로 기준으로 <code class=\"language-text\">../node_modules/colorette</code>를 찾고,</li>\n<li>pnpm이 만들어 둔 심링크를 따라가서 <code class=\"language-text\">.pnpm/colorette@A.B.C/node_modules/colorette</code>를 로드함.</li>\n</ul>\n<p><strong>테스트 서버</strong>로 넘어가보자.</p>\n<p>지금 빌드 artifact는 <code class=\"language-text\">.next/standalone/node_modules/pino-pretty</code>가 설치되었고 그 안에, index.js에서 <code class=\"language-text\">require('colorette')</code> 하고 있다. colorette는 <code class=\"language-text\">.next/standalone/node_modules/.pnpm/pino-pretty@10.3.1/node_modules/colorette</code> 에 존재한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">.next/\n└─ standalone/\n   └─ node_modules/\n      ├─ pino-pretty -> .pnpm/pino-pretty@X.Y.Z/node_modules/pino-pretty     (심링크)\n      ├─ .pnpm/\n      │  └─ pino-pretty@X.Y.Z/\n      │     └─ node_modules/\n      │        └─ pino-pretty/\n      │           ├─ /node_modules\n      │           │   └─ colorette@X.Y.Z       &lt;--  못찾음\n      │           └─ index.js   &lt;-- 여기서 require('colorette')\n      └─ (여기 colorette 관련 항목 없음)  ← ← ←  ⚠ MODULE_NOT_FOUND</code></pre></div>\n<p>즉, 하위 모듈을 가져가진 했지만, 디렉토리 구조 상 찾을 수 없었다.</p>\n<p>그렇다면, pnpm으로 패키지 설치 시 npm과 yarn과 같이 심볼링 링크 형태가 아니라 flat 구조로 설치하고 종속성을 가지고 들어가면 되지 않을까? 여기서 그냥 GitHub Actions에서 pnpm으로 설치한 node_modules 전체를 artifact에 포함시킬까도 고민했지만 비효율이 발생하므로 그러고 싶지 않았다.</p>\n<br/>\n<h2 id=\"pnpm의-node-linker\" style=\"position:relative;\">pnpm의 node-linker<a href=\"#pnpm%EC%9D%98-node-linker\" aria-label=\"pnpm의 node linker permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<p>pnpm도 npm과 yarn과 마찬가지로 flat하게 설치할 수 있다. pnpm의 <a href=\"https://pnpm.io/settings#nodelinker\" target=\"_blank\" rel=\"nofollow\">node-linker</a> 에서 <code class=\"language-text\">hoisted</code> 설정을 해주면 심볼릭 링크 대신 flat한 구조로 설치해준다.</p>\n<p>로컬에서 확인할 때는 <code class=\"language-text\">.npmrc</code> 파일을 프로젝트 root에 만들고 아래와 같이 적어주자.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">node-linker=hoisted</code></pre></div>\n<p>그리고 <code class=\"language-text\">pnpm install</code> 로 패키지를 다시 설치해주면 flat 구조로 node_modules가 구성되었고, 종속성 모두 새롭게 설치된 것을 볼 수 있다.</p>\n<p>하지만, 이렇게 hoisted 모드를 사용하게 되면 pnpm을 사용하는 이유가 사라진다. 글로벌 store의 의미는 퇴색된다(물론 다른 장점도 있긴 하지만..). 그래서 로컬 환경은 hoisted 모드를 사용하지말도록 .npmrc 파일을 지운다. 대신, GitHub Actions에서만 hoisted 모드를 사용하도록 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> pnpm hoisted linker setting\n  <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> pnpm config set node<span class=\"token punctuation\">-</span>linker hoisted <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>location=project</code></pre></div>\n<p>이제는 <code class=\"language-text\">.pnpm</code> 하위 디렉토리를 만들지 않을 것이므로 next.config.js 설정을 다시 바꿔주도록 하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token literal-property property\">outputFileTracingIncludes</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string-property property\">'/'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'./node_modules/pino-pretty/**/*'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// 그리고 하위 종속성 모두를 포함하는 경로를 다 적어주어야 함.</span>\n    <span class=\"token string\">'./node_modules/colorette/**/*'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// 등등</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>문제는, 하위 종속성 모두 다 적어주어야 한다는 것이다. 그리고 하위 종속성의 하위 종속성까지.. 의존성 트리 전체를 다 들고와야 한다. 그리고 pino-pretty를 업데이트라도 하는 날에는 다시 모든 의존성 트리를 검색하고, 설치한 다음 다시 들고 들어가야한다.</p>\n<p>그러면, 다시 원래대로 돌아와서 의존성 트리를 손수 관리해야 하는 문제에 봉착하게 되는 것이다. 현실적으로 pino-pretty를 프로젝트 서비스가 종료될 때까지 버전을 고정하지 않는 이상 불가능하다. 무조건 Next.js에서 빌드할 때 자동으로 추척하도록 만들어 하위 트리를 묶어 들어갈 수 있도록 조치해야만 한다.</p>\n<br/>\n<h2 id=\"Nextjs-standalone-모드에서-의존성-트리를-추적하는-방법\" style=\"position:relative;\">Next.js standalone 모드에서 의존성 트리를 추적하는 방법<a href=\"#Nextjs-standalone-%EB%AA%A8%EB%93%9C%EC%97%90%EC%84%9C-%EC%9D%98%EC%A1%B4%EC%84%B1-%ED%8A%B8%EB%A6%AC%EB%A5%BC-%EC%B6%94%EC%A0%81%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95\" aria-label=\"Nextjs standalone 모드에서 의존성 트리를 추적하는 방법 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<p>기본적으로 번들러는 <code class=\"language-text\">import</code> 및 <code class=\"language-text\">require</code> 구문을 찾고 구문이 만약 node_modules에 존재한다면 해당 모듈을 빌드 artifact로 복사한다. Next.js standalone 모드에서의 추적은 <a href=\"https://github.com/vercel/nft\" target=\"_blank\" rel=\"nofollow\">@vercel/nft</a> 라이브러리가 담당하고 있다.</p>\n<p>문서를 들여다보면, 상용 번들러와 마찬가지로 <code class=\"language-text\">import</code>, <code class=\"language-text\">require</code> 등을 추적하고 있다. 우리가 Next.js를 patch-package 해서 사용하지 않는 이상 고치는 것은 유지보수에 힘들 것이다(Next.js는 아주 잦은 업데이트가 있기 때문에…).</p>\n<p>결국 Next.js에서 제대로 pino-pretty를 추적하도록 만들어줘야만 한다.</p>\n<p>@vercel/nft는 의존성 트리를 어떻게 추적할까? 먼저 파일을 AST로 파싱해서 ‘정적’ 참조를 따라간다. 용어 정리를 해보자.</p>\n<h3 id=\"1-정적static-동적dynamic-import\" style=\"position:relative;\">1. 정적(static), 동적(dynamic) import<a href=\"#1-%EC%A0%95%EC%A0%81static-%EB%8F%99%EC%A0%81dynamic-import\" aria-label=\"1 정적static 동적dynamic import permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<h4 id=\"정적-import\" style=\"position:relative;\">정적 import<a href=\"#%EC%A0%95%EC%A0%81-import\" aria-label=\"정적 import permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h4>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> foo <span class=\"token keyword\">from</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> bar <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./bar.js'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>from절 뒤에 리터럴로 패키지를 명확하게 명시.</p>\n<h4 id=\"동적-import\" style=\"position:relative;\">동적 import<a href=\"#%EB%8F%99%EC%A0%81-import\" aria-label=\"동적 import permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h4>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'foo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>import 함수를 사용하여 파일 상단이 아닌 조건부로 패키지를 가져온다.</p>\n<blockquote>\n<p><a href=\"https://tc39.es/proposal-dynamic-import/\" target=\"_blank\" rel=\"nofollow\">ECMAScript proposal</a>: import() 에서 import()를 dynamic import라고 부름.</p>\n</blockquote>\n<h3 id=\"2-정적-참조Statically-analyzable-reference-동적-참조Dynamic-reference\" style=\"position:relative;\">2. 정적 참조(Statically analyzable reference), 동적 참조(Dynamic reference)<a href=\"#2-%EC%A0%95%EC%A0%81-%EC%B0%B8%EC%A1%B0Statically-analyzable-reference-%EB%8F%99%EC%A0%81-%EC%B0%B8%EC%A1%B0Dynamic-reference\" aria-label=\"2 정적 참조Statically analyzable reference 동적 참조Dynamic reference permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<h4 id=\"정적-참조\" style=\"position:relative;\">정적 참조<a href=\"#%EC%A0%95%EC%A0%81-%EC%B0%B8%EC%A1%B0\" aria-label=\"정적 참조 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h4>\n<p>공식 용어는 아니지만, 번들러에서 쓰는 개념.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'lodash'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ✅ 정적 참조</span>\n<span class=\"token keyword\">await</span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'pino-pretty'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ✅ 정적 참조</span></code></pre></div>\n<p>소스 코드에서 모듈 경로가 <strong>문자열 리터럴로 고정</strong>되어 있어 빌드 타임에 추적 가능한 참조.</p>\n<h4 id=\"동적-참조\" style=\"position:relative;\">동적 참조<a href=\"#%EB%8F%99%EC%A0%81-%EC%B0%B8%EC%A1%B0\" aria-label=\"동적 참조 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h4>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> name <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">LIB</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">require</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ❌ 빌드 시 추적 불가</span>\n<span class=\"token keyword\">await</span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ❌ 빌드 시 추적 불가</span></code></pre></div>\n<p>따라서 정적 import와 동적 import는 ‘정적 참조’ 이므로(리터럴 문자열로 패키지명을 적었으므로) 번들러 및 nft가 추적이 가능하다.\n하지만, pino-pretty는 왜 동적참조인가?</p>\n<p>pino-pretty를 사용하는 pino 라이브러리를 살짝 까보자.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// node_modules/pino/lib/transport.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">fixTarget</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">origin</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> filePath <span class=\"token keyword\">of</span> callers<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> filePath <span class=\"token operator\">===</span> <span class=\"token string\">'node:repl'</span> <span class=\"token operator\">?</span> process<span class=\"token punctuation\">.</span><span class=\"token function\">cwd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> sep <span class=\"token operator\">:</span> filePath<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">      fixTarget <span class=\"token operator\">=</span> <span class=\"token function\">createRequire</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>origin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fixTarget<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">unable to determine transport target for \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>origin<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> fixTarget<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>createRequire는 Node.js의 함수로, 특정 파일/디렉토리 경로를 기준으로 require.resolve를 수행할 수 있게 해준다. 결국 이건 Node의 모듈 해석 알고리즘을 따르고 있다.</p>\n<p>즉, ‘pino-pretty’ 를 문자열로 적어주면 <code class=\"language-text\">require.resolve('pino-pretty')</code> 가 되어 node_modules/pino-pretty 디렉토리를 찾아 절대 경로를 반환하게 된다. 하지만, 변수로 ‘pino-pretty’ 라는 문자열을 만들어냈으므로 이는 <strong>동적 참조</strong>이고, @vercel/nft가 추적하지 못하게 된 것이다.</p>\n<p>결국 우리에게 필요한건, 코드 베이스에 <code class=\"language-text\">import pinoPretty from 'pino-pretty'</code> 또는 <code class=\"language-text\">import(pino-pretty)</code> 이다.</p>\n<br/>\n<h2 id=\"해결-방법\" style=\"position:relative;\">해결 방법<a href=\"#%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95\" aria-label=\"해결 방법 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<p>허무하지만 정말 간단하다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> pino <span class=\"token keyword\">from</span> <span class=\"token string\">'pino'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NEXT_PUBLIC_APP_ENV</span> <span class=\"token operator\">!==</span> <span class=\"token string\">'localhost'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">await</span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'pino-pretty'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span></span>\n<span class=\"token keyword\">const</span> logger <span class=\"token operator\">=</span> <span class=\"token function\">pino</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">transport</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">target</span><span class=\"token operator\">:</span> <span class=\"token string\">'pino-pretty'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>테스트 서버 및 운영 서버에서 동적 import를 사용해서 ‘정적 참조’ 시키면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"mermaid\"><pre class=\"language-mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">flowchart</span> TD\n  <span class=\"token keyword\">classDef</span> bad <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#ffe6e6<span class=\"token punctuation\">,</span><span class=\"token property\">stroke</span><span class=\"token operator\">:</span>#ff4d4f<span class=\"token punctuation\">,</span><span class=\"token property\">color</span><span class=\"token operator\">:</span>#a8071a</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">classDef</span> good <span class=\"token style\"><span class=\"token property\">fill</span><span class=\"token operator\">:</span>#e6fffb<span class=\"token punctuation\">,</span><span class=\"token property\">stroke</span><span class=\"token operator\">:</span>#36cfc9<span class=\"token punctuation\">,</span><span class=\"token property\">color</span><span class=\"token operator\">:</span>#006d75</span><span class=\"token punctuation\">;</span>\n\n  A1<span class=\"token text string\">[\"transport.target: 'pino-pretty' ← 문자열\"]</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">[\"Next build (standalone)\"]</span>\n  A2<span class=\"token text string\">[\"await import('pino-pretty') ← 리터럴\"]</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">[\"Next build (standalone)\"]</span>\n\n  B <span class=\"token arrow operator\">--></span><span class=\"token label property\">|target 문자열만 있음|</span> C<span class=\"token text string\">[\"@vercel/nft 정적 추적 실패&lt;br/>- 리터럴 import 없음(변수처리 되어 resolve)&lt;br/>- 추적 누락\"]</span>\n  B <span class=\"token arrow operator\">--></span><span class=\"token label property\">|리터럴 import 있음|</span> C2<span class=\"token text string\">[\"@vercel/nft 정적 추적 성공&lt;br/>- pino-pretty 의존성 포함\"]</span>\n\n  C <span class=\"token arrow operator\">--></span> D<span class=\"token text string\">[\".next/standalone/node_modules&lt;br/>- pino: O&lt;br/>- pino-pretty: X&lt;br/>- deps: X\"]</span>\n  C2 <span class=\"token arrow operator\">--></span> D2<span class=\"token text string\">[\".next/standalone/node_modules&lt;br/>- pino: O&lt;br/>- pino-pretty: O&lt;br/>- deps: O\"]</span>\n\n  D <span class=\"token arrow operator\">--></span> E<span class=\"token text string\">[\"런타임: transport 로드&lt;br/>require('pino-pretty') 시도\"]</span>\n  D2 <span class=\"token arrow operator\">--></span> E2<span class=\"token text string\">[\"런타임: transport 로드&lt;br/>require('pino-pretty') 성공\"]</span>\n\n  E <span class=\"token arrow operator\">--></span> F<span class=\"token text string\">[\"에러: unable to determine transport target for 'pino-pretty'\"]</span>\n  E2 <span class=\"token arrow operator\">--></span> F2<span class=\"token text string\">[\"예쁜 로그 정상 출력\"]</span>\n\n  <span class=\"token keyword\">class</span> F bad<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">class</span> F2 good<span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 996px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 123.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAABYlAAAWJQFJUiTwAAADjklEQVR42pVV2VIaURDlJ1JJjEJYZAeBGZaBGRiGfRlQQFTc0LLykpQxeciiptS8J2pp1If4rSfd14IyVSkDD1137jC37zl9ug+WdNZAodJAudZAWq9A1laRVItoLnbQbC0hptfgy9YQylEUlxChNRyVEU2k4Q1FEY4lEFc0SMkMfOEYLDaXFylNx2BriHZ3BflyHeV6C9VGG73VdXT6a6i1OjA7y8joRZEoEk9BVlQEKTEnSqSzBCIHT2ABFn4wyjXUzEWo+SqkTA+pbIkS9FBvtpEsmQgbJqKFJoJGC37FgJcOeoIRigX4FyT4CCknFwmtTg/doAk05lIPeukBYbHaQKPdEQhTWl58w6HQs5xSESOkjE7J5gVCLV9EWErAohDdUt3EYq+PXLEJSe3TRyX0VtawSCgjuQqcqQJccaKUM+GRM/D4Q1SvKByeAOb9YUIZgzf4sBcI+cYW1ahCFI1yQ4iULZTR7Q8I4QBVKke7t4p8pQklV0BK1ameBUTjCjI5A3qxgnyJRCOBLK9eu6BSsbtETTNKcPmCQjX+kFUMRmSqTxx+UtDqcGPG5gSf4ZijPa8vrU7xnvdCZUaZoZvr1CZcguWVAT59/oJKwxQfWZ1uzNrnwd++nveN4197kXCWDpVqphCFi87vuMBSMk03u0Sy0YH/xRihwxMUtej2V4Ugbappa6mL/to6dKrnpEktI9gv5hxY39zG3d0dzs/PcXV1hcvLS7F/+26f6uSYPCHXiZs0LCXhpjbwUtOOwkfhpHZgFhNTHiXtLK/g5PQMh0fHODr+Jtazs+9Yp7FkFaeiPEPyt6mRT05P8fXwSCTj9ZQuGGxsT0+Ze47dgg+yAI+Df+dkk9AeI+TmHJAot7e3uLi4EIKMgvc/fv4U88uN/BTScQ2tFIVKHTu7e9jc3sHWcHccQ3q3u/dGTItAO5XKAVI5FBkHmwAjevbKNjllu+hDOza2h7j//RvXv37h5uYG19fXuL+/x/uDj4Kq3e2bZlICyJI5NMkDGzTTHHVymRaNIxvFrBBmitFzeoPCQDnp4+BxjCUUUZaJG5tr9JwoswD/orx/8GG6PmTV2HnZMFWixxRVsjNe2dojchJzLIhI+HRS4djc1JyQaT2YJZkmjRo/jxrdRp5oc/D6tNIWtnKD/jo1WqWkjoDcJitPo0p/BzlCNy9rsMfzsEtZ2NNV2ENxYuT5y1gfxx+2JzPBUDK/dAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"complete-pretty-log\"\n        title=\"\"\n        src=\"/static/8513faacc23b781eb52a34eb70d3c677/14920/complete-pretty-log.png\"\n        srcset=\"/static/8513faacc23b781eb52a34eb70d3c677/b30f8/complete-pretty-log.png 500w,\n/static/8513faacc23b781eb52a34eb70d3c677/14920/complete-pretty-log.png 996w\"\n        sizes=\"(max-width: 996px) 100vw, 996px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>아주 이쁘다..</p>\n<br/>\n<h2 id=\"정리\" style=\"position:relative;\">정리<a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<h3 id=\"핵심-개념-1-pino-pino-pretty-그리고-transport-로딩\" style=\"position:relative;\">핵심 개념 1: pino, pino-pretty, 그리고 transport 로딩<a href=\"#%ED%95%B5%EC%8B%AC-%EA%B0%9C%EB%85%90-1-pino-pino-pretty-%EA%B7%B8%EB%A6%AC%EA%B3%A0-transport-%EB%A1%9C%EB%94%A9\" aria-label=\"핵심 개념 1 pino pino pretty 그리고 transport 로딩 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<ul>\n<li>pino: 빠른 JSON 로거. 기본 출력은 머신 친화적(JSON) 이라서 수집 파이프라인(ELK, Loki, CloudWatch 등)에 좋다.</li>\n<li>pino-pretty: pino 로그를 사람이 읽기 좋게 변환해주는 트랜스포트(transport).\n<ul>\n<li>코드 설정: pino({ transport: { target: ‘pino-pretty’, options: {…} } })</li>\n</ul>\n</li>\n<li>transport target 동작: pino의 transport는 target에 적힌 문자열을 런타임에 require()로 해석한다. -> 동적 참조이다.\n<ul>\n<li>즉, 서버가 실제로 구동될 때 모듈을 찾는다.</li>\n<li>그런데 <strong>구동할 때 찾는다</strong>는 말은, 이미 빌드 산출물에 그 모듈이 들어있어야 한다는 뜻.</li>\n</ul>\n</li>\n</ul>\n<p>여기서 Next.js standalone과 충돌이 난다.</p>\n<h3 id=\"핵심-개념-2-Nextjs-standalone과-vercelnft의-정적-추적\" style=\"position:relative;\">핵심 개념 2: Next.js standalone과 @vercel/nft의 정적 추적<a href=\"#%ED%95%B5%EC%8B%AC-%EA%B0%9C%EB%85%90-2-Nextjs-standalone%EA%B3%BC-vercelnft%EC%9D%98-%EC%A0%95%EC%A0%81-%EC%B6%94%EC%A0%81\" aria-label=\"핵심 개념 2 Nextjs standalone과 vercelnft의 정적 추적 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<ul>\n<li>output: ‘standalone’ 빌드 시, .next/standalone 안에 실행에 필요한 최소 파일만 모여든다.</li>\n<li>무엇이 필요한가?를 결정하는 엔진이 [@vercel/nft].\n<ul>\n<li>빌드할 때 코드를 AST로 파싱해서, 정적으로 판별 가능한 import/require만 따라간다.</li>\n<li>포함됨: import ‘x’, import x from ‘x’, require(‘x’), await import(‘x’) (문자열 리터럴)</li>\n<li>누락됨: require(‘pino-’ + env), await import(variable) (표현식/변수)</li>\n</ul>\n</li>\n<li>중요한 포인트:\ntransport.target: ‘pino-pretty’는 런타임 문자열이기 때문에 빌드 타임 정적 추적 대상이 아니다.\n→ 그래서 standalone 산출물에 pino-pretty가 안 들어간다.</li>\n</ul>\n<p>실제로 .next/standalone/node_modules를 보면, pino는 있는데 pino-pretty는 없다는 걸 확인할 수 있다.</p>\n<h3 id=\"핵심-개념-3-pnpm의-구조와-왜-더-까다로워지는지\" style=\"position:relative;\">핵심 개념 3: pnpm의 구조와 왜 더 까다로워지는지<a href=\"#%ED%95%B5%EC%8B%AC-%EA%B0%9C%EB%85%90-3-pnpm%EC%9D%98-%EA%B5%AC%EC%A1%B0%EC%99%80-%EC%99%9C-%EB%8D%94-%EA%B9%8C%EB%8B%A4%EB%A1%9C%EC%9B%8C%EC%A7%80%EB%8A%94%EC%A7%80\" aria-label=\"핵심 개념 3 pnpm의 구조와 왜 더 까다로워지는지 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<ul>\n<li>pnpm은 .pnpm 디렉터리에 패키지를 설치하고, node_modules는 심볼릭 링크로 구성한다. (공간 효율 최고)</li>\n<li>npm/yarn처럼 flat하게 파일이 쫙 깔리는 게 아니라, 링크 체인을 타고 들어간다.</li>\n<li>이 구조는 @vercel/nft의 파일 추적이나, Next의 outputFileTracingIncludes에서 경로 패턴/심볼릭 링크 처리가 까다로워지게 만든다.\n→ <strong>겉보기엔 들어온 것 같은데 실행 시점엔 여전히 못 찾는</strong> 상황이 생기기 딱 좋다.</li>\n</ul>\n<br/>\n<h2 id=\"마치며\" style=\"position:relative;\">마치며<a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\" aria-label=\"마치며 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<p>이번 트러블슈팅을 하며 아무 생각 없이 썼던 import 구문에서 어떤 처리들이 일어나고 있는지를 알게 되었고, standalone 빌드 환경과 pnpm과 Next.js 빌드 관계에 대해 다시 한 번 짚어볼 수 있는 시간이었다. 아직까지도 사용하고 있는 Gatsby도 config 파일에서 문자열로 라이브러리를 등록해 사용하고 있는데, pino와 마찬가지로 리터럴 문자열로 node_modules에 있는 라이브러리를 참조하고 있다는 사실을 추가로 알게 되었다.</p>\n<p>참고로, 테스트 서버에서는 pino-pretty를 사용해 로깅하지만 운영 서버에서는 pretty를 실시간성 로그에만 사용하고, pino-pretty를 이용하지 않은 pure log를 파일로 저장해두는 것이 좋을 것 같다.</p>\n<p>프로젝트에서 Next.js의 page router를 사용하고 있어 SSR 환경에서의 API fetching이 일어날 때 자동으로 로깅을 남겨주지 않는다.\n언젠가 app router로 넘어가게 될텐데, 중요한 부분 및 파일로 로그를 적재해야할 부분은 pino로 남겨두어야겠다.</p>\n<p>덧) 사실 <a href=\"https://www.tomups.com/posts/log-nextjs-request-response-as-json/\" target=\"_blank\" rel=\"nofollow\">이런 방법</a>도 있단다..</p>","htmlAst":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Next.js를 실행하면 클라이언트 측 로그는 브라우저의 콘솔에 나타나지만, 서버 측 로그는 제대로 된 로그를 출력해주지 않았다. 이번에 프로젝트에 Next.js의 node 환경에서 log를 찍기 위해 라이브러리를 사용하면서 만난 트러블슈팅을 기록한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"먼저 "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/pinojs/pino","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"pino"}]},{"type":"text","value":"라는 라이브러리를 사용했는데, pino는 node 진영에서 "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/winstonjs/winston","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"winston"}]},{"type":"text","value":"과 함께 많이 사용되는 로깅 라이브러리다. 짧게 이야기하면 로깅 라이브러리는 비동기를 사용하는 pino로 결정. 그리고 "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/pinojs/pino-pretty","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"pino-pretty"}]},{"type":"text","value":" 라이브러리는 pino로 찍은 로그를 더 알아보기 쉬운 형태로 포매팅 해주는 도구다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 847px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 78.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsTAAALEwEAmpwYAAABmklEQVR42o2TCY7jIBBFfY60AS9hX2yM8R47mfsfaopE6R5p1N3+khEYXvELiowxbq2zzgmlpJTKGMoZynN8Qtk4juuyhanvYrMs64ef8nZA0iIqfodDCMd+d4MX3nRdQE1ENuD6ign5HQarIfQ1oyW7Qgq4polE6JRtzvkyz8KogkEEhq4Mn1bGGGu910KwsqSUEdi5rE/DnIFto5QFnjFSXXFZnYUvl0sf4zTP1jU8XdLHK2H0TvvVIU8Vb72GGcEEpo0xwzj2cQh9bNo29D1EhDYOSWBNKagAq7WGldAXySZPcJ7n8O92HPt+rOt22/dtS+1+HPfHH2ghkHMOKgj2RP8ogw+cQ7AnABEgxO3+eKxpfOtCku86l5LiwFNKv3IWUlhjuVG14lppIhThqqgqyA+m86c+0/6vSJQEg8t941ZKIXOuEJOptt8n99Npw5PY1rWfVhuWxlksNQJet8h4THm6NlJ8CzdNCxUWhimMq/ctlibBxqci5xoBX3wPxxiXeWmHwfRxmiYET0popBwyLZIGV/UP5v8C3XGMVSiCtPMAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"pino-pretty-formatting","title":"","src":"/static/7d887646d34bf30c82ed744634c1a64c/ba37d/pino-pretty-formatting.png","srcSet":["/static/7d887646d34bf30c82ed744634c1a64c/b30f8/pino-pretty-formatting.png 500w","/static/7d887646d34bf30c82ed744634c1a64c/ba37d/pino-pretty-formatting.png 847w"],"sizes":"(max-width: 847px) 100vw, 847px","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy","decoding":"async"},"children":[]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"pino를 Next.js 프로젝트에 예쁘게 입혔지만 포맷이 마음에 들지 않았기 때문에 pino-pretty 라이브러리를 추가로 설치하고 프로젝트에 설정해주었다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"로컬에서 두 도구를 사용해 API Routes, SSR 측 fetching API 로그를 콘솔에서 확인 후에 테스트를 해보기 위해 테스트 서버로 올렸다. 하지만, 로컬에선 멀쩡히 예쁘게 찍히던 pino 로그가 테스트 서버로 올리자마자 아래 에러와 함께 /500 페이지로 이동했다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"error: unable to determine transport target for \"pino-pretty\""}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"처음에는 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"설정이 틀렸나?"}]},{"type":"text","value":" 했다가, 한참을 돌아보니 Next.js의 standalone 빌드 방식 + pino의 transport 로딩 구조 + pnpm의 심볼릭 링크 특성이 합쳐져 터진 문제였다. 일단 pino 설정 코드부터 보자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"pino-설정-코드","style":"position:relative;"},"children":[{"type":"text","value":"pino 설정 코드"},{"type":"element","tagName":"a","properties":{"href":"#pino-%EC%84%A4%EC%A0%95-%EC%BD%94%EB%93%9C","ariaLabel":"pino 설정 코드 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight","has-highlighted-lines"],"dataLanguage":"ts"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ts"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ts"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"import"}]},{"type":"text","value":" pino "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"from"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'pino'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"const"}]},{"type":"text","value":" logger "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"pino"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// level 등은 생략"}]},{"type":"text","value":"\n  transport"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["gatsby-highlight-code-line"]},"children":[{"type":"text","value":"    target"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'pino-pretty'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]}]},{"type":"text","value":"    options"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n      colorize"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","boolean"]},"children":[{"type":"text","value":"true"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n      translateTime"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'SYS:HH:MM:ss'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n      customColors"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'err:red,info:blue'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"..."}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"isLocal "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"?"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":" singleLine"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","boolean"]},"children":[{"type":"text","value":"true"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"pino는 transport 옵션을 줄 수 있는데, 로그를 전송하고 변환할 수 있게 해줄 수 있는 옵션이다. 포매팅을 넣고 싶다면 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"target"}]},{"type":"text","value":" 에 적어줄 수 있다("},{"type":"element","tagName":"a","properties":{"href":"https://github.com/pinojs/pino/blob/main/docs/transports.md#pino-pretty","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"공식 문서"}]},{"type":"text","value":")."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"target에 문자열로 pino-pretty를 적어주는 방법이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1005px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 10.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAiElEQVR42j2Myw6CMADA/A8vHowmajLGNmAMgjwlICCI//8plXjw0KS9dCd0iMsq2udEWjSY9IPLB/L6QT/OxHWPV7/Q9YDfrui8Q4cxKkqQgUWFbnOHtgkX4bPbH46cbx7jsjLMb7Ky5F41FE1HNy1M8zYJIjwVIJVBSIM0dpvFP7RN/326Cr600EQo2nz5KwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"pretty-log","title":"","src":"/static/b111cfde7499f70a1c7c6eb5bf2cc100/66ac9/pretty-log.png","srcSet":["/static/b111cfde7499f70a1c7c6eb5bf2cc100/b30f8/pretty-log.png 500w","/static/b111cfde7499f70a1c7c6eb5bf2cc100/332ff/pretty-log.png 1000w","/static/b111cfde7499f70a1c7c6eb5bf2cc100/66ac9/pretty-log.png 1005w"],"sizes":"(max-width: 1005px) 100vw, 1005px","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy","decoding":"async"},"children":[]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"위 사진과 같이 이 방법으로 로컬에서 문제 없이 동작했다. 하지만, 테스트 서버에서의 로그는 unable to determine transport target for “pino-pretty” 라고 에러를 뱉고 있었다. (물론 빌드도 문제 없이 성공했다)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"처음엔 몇 가지 해결책을 시도해봤다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"devDependencies → dependencies로 승격"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"pino-pretty 라이브러리는 운영에 배포되면 안되겠다는 가벼운 생각 때문에 devDependencies로 설치했지만, 생각해보니 코드 모두 운영에 올라가야 맞다는 생각으로 dependencies로 옮겨주었다. 여전히 해결되지 않았다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{"start":2},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"import로 라이브러리 가져오기"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"문자열로 선언해서 라이브러리를 가져오지 못할 것이라 예상해서 아래 코드와 같이 먼저 import 구분으로 가져왔다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight","has-highlighted-lines"],"dataLanguage":"ts"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-ts"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-ts"]},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-highlight-code-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"import"}]},{"type":"text","value":" pinoPretty "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"from"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'pino-pretty'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]}]},{"type":"text","value":"\ntransport"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["gatsby-highlight-code-line"]},"children":[{"type":"text","value":"  target"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" pinoPretty"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]}]},{"type":"text","value":"  "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// ..."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"프로젝트는 package.json에 type module을 통해 프로젝트 전체를 ESM으로 사용하고 있었기 때문에 import 구문이 문제가 없을 것이라 생각했지만,"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"⨯ TypeError: The \"path\" argument must be of type string. Received function build\n    at eval (src/shared/server/common/config/loggerConfig.ts:15:20)\n    ...\n> 15 | const logger = pino({\n     |                    ^\n  17 |   transport: {\n  18 |     target: pinoPretty, {\n  code: 'ERR_INVALID_ARG_TYPE',"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이런 에러가 발생했다. ERR_INVALID_ARG_TYPE 에러는 Node.js에서 함수나 메서드에 넘긴 인자의 타입이 예상한 타입과 다를 때 발생하는 에러인데, path에 function 타입 대신 string 타입을 넣어야 한다는 뜻이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"node_modules에 있는 pino-pretty/index.js 파일을 까보았다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"js"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"function"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"build"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","parameter"]},"children":[{"type":"text","value":"opts "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"const"}]},{"type":"text","value":" pretty "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"prettyFactory"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"opts"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"return"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"abstractTransport"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"function"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","parameter"]},"children":[{"type":"text","value":"source"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// ..."}]},{"type":"text","value":"\n\nmodule"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"exports"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"default "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" build"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"역시 pino 및 pino-pretty는 Node.js 서버 환경에서 주로 사용하는 라이브러리라 그런지 CommonJS 형태로 작성되어 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"default로 export 하는 것은 함수다. 따라서 공식문서에서 권장하는 대로 string 값인 ‘pino-pretty’ 를 적어주는게 맞았던 것이다. CommonJs 문법으로 작성된 걸 보니 혹시나 싶어 require로 가져오도록 해봤지만 여전히 해결되지 않았다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"왜 로컬에서는 동작하고, 테스트 서버 환경에서는 동작하지 않는지 곰곰이 생각해보니 Next.js를 standalone으로 배포하고 있다는게 떠올랐다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"Nextjs의-standalone-빌드","style":"position:relative;"},"children":[{"type":"text","value":"Next.js의 standalone 빌드"},{"type":"element","tagName":"a","properties":{"href":"#Nextjs%EC%9D%98-standalone-%EB%B9%8C%EB%93%9C","ariaLabel":"Nextjs의 standalone 빌드 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://nextjs.org/docs/pages/api-reference/config/next-config-js/output#automatically-copying-traced-files","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"Next.js output 공식문서"}]},{"type":"text","value":"에 따르면 standalone은 node_modules에서 프로덕션 배포에 필요한 파일만 복사하는 방식을 사용한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"즉, 어플리케이션을 실행하는데 필요한 최소한의 코드만 node_modules에 가져가고, 이는 빌드 시 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":".next/standalone"}]},{"type":"text","value":" 하위에 저장하고 사용하겠다는 뜻이다. 즉, 사용하지 않은 코드 및 모듈은 모두 트리쉐이킹 되어 artifact에 포함되지 않는다. 그러면 docker image에 파일크기가 적은 상태로 빌드 되고, image 용량이 줄기 때문에 빌드 시간 및 EKS에 도달하는 속도도 획기적으로 줄일 수 있게 된다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"테스트 서버에서 pino-pretty 모듈을 찾지 못했기 때문에 standalone으로 빌드된 artifact에 pino-pretty가 없을 것 같았다. 얼른 빌드해 보았다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAC4jAAAuIwF4pT92AAACPElEQVR42p1U2XLaQBDUX+Qh5tItrW4JcQkbYxOwTdnYVEHsVPL/f9GZGRBPJEZ+aFaUVr3TM72t6baCqRIU0ztYfgwvKmAHKTqm9yVohhvCIoL79RaOnwihRWtLd75G2LZ82KaLb49bmNtfUH6EIB/DT0q0DZfQkLBDhD16iGYLxLdLWG4EJ8ykSt0JBI0Iu0xoeZg97lAtNnCon+lgiiAbIirGiPIRuC1c7UWETHZlhNg/p9i/Vug6Kfy4DzfMZQMf2LBCD991hf1Lgd/vS/TcjAaTwQmyYw/d5pJ1R2F4v0E+XcEmySFJjfsTkktrMaEqVYOh0E+PPlBpH3k1g+nFUh2De2d4UcMpMyGZ26Dpzp8/qKKx9NAjsBeverasjEvkE6Er1jBViMWuQtQvyTa5ENrqMCA/OeCSaZ8kG57Cw/st0uGI5B4JSbZLN4fJ+P/FhGJu28fweoXV9kP6xv5jL7ILasmdyyQfvMYhEfbHEhImEbpRLiu/Y9LPiHgOvPdUoUF9DMgi8/Ub+TBHkA5kU0u3P5XJ77kdPAuNZXSljx7K6zvcPLzAIuuEJJmHw7IdSqN2LfkM+J3ceypA0x1iJsuwvMHND7rTrzIIvse8KqqUr6Fuc1CE/4RJYcIe1ryj50KqZP70hvXuD5Jyinw0kwizyDqcPvW+s6CDWYkiaPVtsAglDaRaPElFh4DI5Jk/kH3/AcedSYmv1Q3v0WDG8xWWm590aoG4nIjcpKwocIenoDiHVt1DJ8Bf1qRSuQXrE3AAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"standalone-artifact-not-pino-pretty","title":"","src":"/static/e8889878404084c700358eafec662579/a331c/standalone-artifact-not-pino-pretty.png","srcSet":["/static/e8889878404084c700358eafec662579/b30f8/standalone-artifact-not-pino-pretty.png 500w","/static/e8889878404084c700358eafec662579/a331c/standalone-artifact-not-pino-pretty.png 800w"],"sizes":"(max-width: 800px) 100vw, 800px","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy","decoding":"async"},"children":[]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"역시나 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":".next/standalone/node_modules"}]},{"type":"text","value":" 에서 pino-pretty는 찾을 수 없었다. 원인을 찾았으니 이제 해결만 하면 된다. .next/standalone/node_modules에 pino-pretty 모듈만 넣어줄 수 있다면 문제는 해결 될 것이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"outputFileTracingIncludes","style":"position:relative;"},"children":[{"type":"text","value":"outputFileTracingIncludes"},{"type":"element","tagName":"a","properties":{"href":"#outputFileTracingIncludes","ariaLabel":"outputFileTracingIncludes permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://nextjs.org/docs/pages/api-reference/config/next-config-js/output#caveats","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"공식문서"}]},{"type":"text","value":"에 따르면 next.config.js 파일에 outputFileTracingIncludes 설정을 하면 추적에 필요한 파일을 standalone으로 빌드한 artifact에 포함시켜줄 수 있다고 한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"js"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// next.config.js"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","literal-property","property"]},"children":[{"type":"text","value":"outputFileTracingIncludes"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","string-property","property"]},"children":[{"type":"text","value":"'/'"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'./node_modules/pino-pretty/**/*'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"위와 같이 현재 로컬에 있는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"./node_modules/pino-pretty"}]},{"type":"text","value":" 디렉토리를 찾아 하위에 있는 파일을 모두 artifact에 넣도록 설정한다.\n그리고 다시 빌드."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 688px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 38.6%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABFElEQVR42pWS2U7DMBBF/R+gpFkcZ3HsLE4TpymUggCBEIuEhJD4/8+4jI3Ux7Y8HM2D7aN7R2ZysLj7+IJZ9mjttUdocyBvhn/BeNXC3jzCbHao2tEj6o7okdFMy8aTlPosWJQWWG9vsdm/IhEKsp2gOgttZpRqQBDluFxxhHF+FiziFYkkdu8ThmWGkIakI3ihUTUjSj3QXCPKJAL3KCmOwsK0hJMuTyN6OyHOFEl7pCTMaQrZIaf6K7oXRMJLj8GcNeIlZLPF/ds3BO3UJXKCi5BT3cxzKh2nPbs3PmFCdZSxuHp4oYMWhTK0hhpprn111+BU1ZjuHyrHJDT0XZ4/f7ys7iafUvWWmL38VMK0+Ev4C+oo72TEtpHoAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"get-pino-pretty","title":"","src":"/static/a3205c6acc94483a883158927cab50c9/d21f0/get-pino-pretty.png","srcSet":["/static/a3205c6acc94483a883158927cab50c9/b30f8/get-pino-pretty.png 500w","/static/a3205c6acc94483a883158927cab50c9/d21f0/get-pino-pretty.png 688w"],"sizes":"(max-width: 688px) 100vw, 688px","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy","decoding":"async"},"children":[]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"드디어 잘 들어왔다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"다시-문제-발생","style":"position:relative;"},"children":[{"type":"text","value":"다시 문제 발생"},{"type":"element","tagName":"a","properties":{"href":"#%EB%8B%A4%EC%8B%9C-%EB%AC%B8%EC%A0%9C-%EB%B0%9C%EC%83%9D","ariaLabel":"다시 문제 발생 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"기대하는 마음을 안고 다시 테스트 서버로 배포해봤다. 하지만 이번엔 에러 메시지가 바뀌었다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"uncaughtException: [Error: Cannot find module 'colorette']"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"colorette"}]},{"type":"text","value":"는 뭐지? 프로젝트에서는 사용하지 않는 라이브러리다. 아마도 pino-pretty의 내부 종속성이 아닐까? pino-pretty/index.js에서 사용하고 있는 모듈이었다. 그러면 next.config.js에 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"outputFileTracingIncludes"}]},{"type":"text","value":" 에 pino-pretty에서 사용하고 있는 모듈을 넣어주면 그만이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"종속성을 파악해보자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"sh"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-sh"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-sh"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"node"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"-e"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"console.log(Object.keys(require('pino-pretty/package.json').dependencies || {}))\""}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight","has-highlighted-lines"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"[\n"},{"type":"element","tagName":"span","properties":{"className":["gatsby-highlight-code-line"]},"children":[{"type":"text","value":"  'colorette',"}]},{"type":"text","value":"  'dateformat',\n  'fast-copy',\n  'fast-safe-stringify',\n  'help-me',\n  'joycon',\n  'minimist',\n  'on-exit-leak-free',\n  'pino-abstract-transport',\n  'pump',\n  'readable-stream',\n  'secure-json-parse',\n  'sonic-boom',\n  'strip-json-comments'\n]"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"하위 종속성이 꽤 많다. 프로젝트는 "},{"type":"element","tagName":"a","properties":{"href":"https://pnpm.io/ko/","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"pnpm"}]},{"type":"text","value":"을 사용하고 있으므로, colorette를 포함한 하위 종속성은 로컬의 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"node_modules/.pnpm"}]},{"type":"text","value":" 디렉토리 하위에 저장된다. 따라서 해당 경로를 찾아 artifact에 포함시켜야 한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"js"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","literal-property","property"]},"children":[{"type":"text","value":"outputFileTracingIncludes"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","string-property","property"]},"children":[{"type":"text","value":"'/'"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'./node_modules/pino-pretty/**/*'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'./node_modules/.pnpm/pino-pretty@*/*'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'./node_modules/.pnpm/pino-pretty@*/node_modules/**'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 684px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 161.20000000000002%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAgCAYAAAASYli2AAAACXBIWXMAABYlAAAWJQFJUiTwAAADE0lEQVR42p1WWVIiURDkHjOiQu97P6CBZpNFFtGYCC8w33P/A+RUFrbBOGg8+SjoVjrJrMyqR+vei+DGOeaHX0jKAaK8jzDrod313+vWCayrxReC9icPKEdT+EmBIDVwwkwqRVfqzg217AHlw6aeo149C0iOtDeUGiExQwSZwU3H07IG5Ld3/BgPrxWqxVhY9hAVA3hxIW2okPXGiOXeGvDWCVV2va2F5QpuVGgvKZ2gnrTBjTIr2QrYfpOdljVm2xd0gwSpGQnoAD/vXfy4c/Sdsttd70ujWs3FnRuh6wvL1Q7lcKbsWGRK9yk9lZ6Gcu+npR1gR2Sb6QPyuoaTlPDlYVci5EkF0kMa5Mnfu0FqAaigCZLcw+8/K5SSzVF/CJMWWn0zQNqvhZ350vFWE94buYkcD8Z1cTwcsV1uUIYxhqVBVRjUmcSp6+InHzwL/cd6Z9gWU2LHx8BxcFhtsF8sUUUJpgTLDeZZhtLzBTBUNRY9DMVtiY9cL/cvmD8+IZTmZ0bMEEPi/JRNyxwG/2Rs+njEaLmVGS+0ZzTCF0Osc3gOSDn1ao/hfKOh1vgIGGNzBSD742MhkuvNAUFiZPP0deziopLZrnTGzWim+bwU8IsMxxLuaraWccvfA87Raz7HMf2M7QWGASabJ+nhTpZEqUaEYgjl2+zGi4DznUheH3TxxtI7Mv3W+vpPsrCraIowZP+4wbkwbp1rGW6f1WkyiwoxRZbDOUvLbXMu+VklcwmQnZ4z0kc6zG3DTU5jTuvMt8zhYqNnCo1pnNZto2Ev9cxhG/il545/yTAgWHYauaQc6sJt2JJlLtuHppGtBeD+NCkC2ABwDC9tGAvJO5XMMFMmJ8YTU2zOlU8ZTmT0PMkhx4294rly03EvGmERm6OOH6NCqVl/rO7ScS4JXluO3ptk6V9FlxkbNeF0MPE4ZU/p/LdmWUdPJPPB+I2RToy803Ey5jFrzXAikTnlMFOHdUmQpbzfe/E1s7zFYL5WZymR8VHA1Fzn8vrlVZcsf4nRFMptfppw/Cg3H9T6v4+AfwE6SrV9+DZ0yQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"include-colorette","title":"","src":"/static/276e208c7641fcd28e086616ec75092c/bf424/include-colorette.png","srcSet":["/static/276e208c7641fcd28e086616ec75092c/b30f8/include-colorette.png 500w","/static/276e208c7641fcd28e086616ec75092c/bf424/include-colorette.png 684w"],"sizes":"(max-width: 684px) 100vw, 684px","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy","decoding":"async"},"children":[]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"하지만 여전히 테스트 서버에서는 실패한다. 이상하다. 생각해보면 pino-pretty가 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"로컬"}]},{"type":"text","value":"에서 내부적으로 모듈을 사용할 때 require 문법으로 모듈을 가져올텐데, "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":".pnpm"}]},{"type":"text","value":" 하위 모듈을 어떻게 가져올 수 있을까?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"pnpm의-node_modules-저장-방식","style":"position:relative;"},"children":[{"type":"text","value":"pnpm의 node_modules 저장 방식"},{"type":"element","tagName":"a","properties":{"href":"#pnpm%EC%9D%98-node_modules-%EC%A0%80%EC%9E%A5-%EB%B0%A9%EC%8B%9D","ariaLabel":"pnpm의 node_modules 저장 방식 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"모든 프로젝트에서 단말기 저장장치의 효율 및 속도 때문에 "},{"type":"element","tagName":"a","properties":{"href":"https://pnpm.io/ko/","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"pnpm"}]},{"type":"text","value":" 을 패키지 매니저로 사용하고 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"node_modules는 일반적으로 flat(hoisted) 구조로 패키지에서 사용하는 종속성 하위 구조 모두 flat하게 저장하지만, pnpm은 심볼릭 링크를 통해 전역의 pnpm store에 저장된 모듈을 단순히 연결시켜주는 역할을 하고 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"만약 패키지 매니저의 설치 매커니즘을 조금 더 깊게 알고 싶다면 아래의 블로그를 보면 도움이 될 것이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://toss.tech/article/node-modules-and-yarn-berry","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"node_modules로부터 우리를 구원해 줄 Yarn Berry - toss"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://engineering.ab180.co/stories/yarn-to-pnpm","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"Yarn 대신 pnpm으로 넘어간 3가지 이유 - ab180"}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"기본적으로 node.js는 require 구문을 만나면 루트를 기준으로 node_modules를 찾고, 없으면 상위로 올라가며 탐색한다. (require(‘pkg’) → ./node_modules/pkg → ../node_modules/pkg … )\n그리고 .pnpm은 현재 모듈의 파일 위치에서 시작해, 상위로 올라가며 node_modules/<이름> 을 찾는다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"project/\n└─ node_modules/\n   ├─ pino-pretty  ->  .pnpm/pino-pretty@X.Y.Z/node_modules/pino-pretty   (심링크)\n   └─ .pnpm/\n      ├─ pino-pretty@X.Y.Z/\n      │  └─ node_modules/\n      │     └─ pino-pretty/\n      │        └─ index.js   <-- 여기서 require('colorette') 호출\n      └─ colorette@A.B.C/\n         └─ node_modules/\n            └─ colorette/"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"따라서, "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"로컬"}]},{"type":"text","value":"에서 import(require) 구문으로 모듈을 가져오는건 해당 모듈(pino-pretty)를 찾고, 없으면 project/node_modules 에서 관련 모듈(colorette)을 찾아서 가져오는 형태다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"즉,"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"pino-pretty/index.js가 require(‘colorette’)를 호출하면,"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"node.js는 먼저 현재 모듈 경로 기준으로 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"../node_modules/colorette"}]},{"type":"text","value":"를 찾고,"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"pnpm이 만들어 둔 심링크를 따라가서 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":".pnpm/colorette@A.B.C/node_modules/colorette"}]},{"type":"text","value":"를 로드함."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"테스트 서버"}]},{"type":"text","value":"로 넘어가보자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"지금 빌드 artifact는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":".next/standalone/node_modules/pino-pretty"}]},{"type":"text","value":"가 설치되었고 그 안에, index.js에서 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"require('colorette')"}]},{"type":"text","value":" 하고 있다. colorette는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":".next/standalone/node_modules/.pnpm/pino-pretty@10.3.1/node_modules/colorette"}]},{"type":"text","value":" 에 존재한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":".next/\n└─ standalone/\n   └─ node_modules/\n      ├─ pino-pretty -> .pnpm/pino-pretty@X.Y.Z/node_modules/pino-pretty     (심링크)\n      ├─ .pnpm/\n      │  └─ pino-pretty@X.Y.Z/\n      │     └─ node_modules/\n      │        └─ pino-pretty/\n      │           ├─ /node_modules\n      │           │   └─ colorette@X.Y.Z       <--  못찾음\n      │           └─ index.js   <-- 여기서 require('colorette')\n      └─ (여기 colorette 관련 항목 없음)  ← ← ←  ⚠ MODULE_NOT_FOUND"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"즉, 하위 모듈을 가져가진 했지만, 디렉토리 구조 상 찾을 수 없었다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그렇다면, pnpm으로 패키지 설치 시 npm과 yarn과 같이 심볼링 링크 형태가 아니라 flat 구조로 설치하고 종속성을 가지고 들어가면 되지 않을까? 여기서 그냥 GitHub Actions에서 pnpm으로 설치한 node_modules 전체를 artifact에 포함시킬까도 고민했지만 비효율이 발생하므로 그러고 싶지 않았다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"pnpm의-node-linker","style":"position:relative;"},"children":[{"type":"text","value":"pnpm의 node-linker"},{"type":"element","tagName":"a","properties":{"href":"#pnpm%EC%9D%98-node-linker","ariaLabel":"pnpm의 node linker permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"pnpm도 npm과 yarn과 마찬가지로 flat하게 설치할 수 있다. pnpm의 "},{"type":"element","tagName":"a","properties":{"href":"https://pnpm.io/settings#nodelinker","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"node-linker"}]},{"type":"text","value":" 에서 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"hoisted"}]},{"type":"text","value":" 설정을 해주면 심볼릭 링크 대신 flat한 구조로 설치해준다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"로컬에서 확인할 때는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":".npmrc"}]},{"type":"text","value":" 파일을 프로젝트 root에 만들고 아래와 같이 적어주자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"node-linker=hoisted"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그리고 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"pnpm install"}]},{"type":"text","value":" 로 패키지를 다시 설치해주면 flat 구조로 node_modules가 구성되었고, 종속성 모두 새롭게 설치된 것을 볼 수 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"하지만, 이렇게 hoisted 모드를 사용하게 되면 pnpm을 사용하는 이유가 사라진다. 글로벌 store의 의미는 퇴색된다(물론 다른 장점도 있긴 하지만..). 그래서 로컬 환경은 hoisted 모드를 사용하지말도록 .npmrc 파일을 지운다. 대신, GitHub Actions에서만 hoisted 모드를 사용하도록 한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" pnpm hoisted linker setting\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"run"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" pnpm config set node"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"linker hoisted "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"location=project"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이제는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":".pnpm"}]},{"type":"text","value":" 하위 디렉토리를 만들지 않을 것이므로 next.config.js 설정을 다시 바꿔주도록 하자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"js"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","literal-property","property"]},"children":[{"type":"text","value":"outputFileTracingIncludes"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","string-property","property"]},"children":[{"type":"text","value":"'/'"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'./node_modules/pino-pretty/**/*'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// 그리고 하위 종속성 모두를 포함하는 경로를 다 적어주어야 함."}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'./node_modules/colorette/**/*'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// 등등"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"문제는, 하위 종속성 모두 다 적어주어야 한다는 것이다. 그리고 하위 종속성의 하위 종속성까지.. 의존성 트리 전체를 다 들고와야 한다. 그리고 pino-pretty를 업데이트라도 하는 날에는 다시 모든 의존성 트리를 검색하고, 설치한 다음 다시 들고 들어가야한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그러면, 다시 원래대로 돌아와서 의존성 트리를 손수 관리해야 하는 문제에 봉착하게 되는 것이다. 현실적으로 pino-pretty를 프로젝트 서비스가 종료될 때까지 버전을 고정하지 않는 이상 불가능하다. 무조건 Next.js에서 빌드할 때 자동으로 추척하도록 만들어 하위 트리를 묶어 들어갈 수 있도록 조치해야만 한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"Nextjs-standalone-모드에서-의존성-트리를-추적하는-방법","style":"position:relative;"},"children":[{"type":"text","value":"Next.js standalone 모드에서 의존성 트리를 추적하는 방법"},{"type":"element","tagName":"a","properties":{"href":"#Nextjs-standalone-%EB%AA%A8%EB%93%9C%EC%97%90%EC%84%9C-%EC%9D%98%EC%A1%B4%EC%84%B1-%ED%8A%B8%EB%A6%AC%EB%A5%BC-%EC%B6%94%EC%A0%81%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95","ariaLabel":"Nextjs standalone 모드에서 의존성 트리를 추적하는 방법 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"기본적으로 번들러는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"import"}]},{"type":"text","value":" 및 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"require"}]},{"type":"text","value":" 구문을 찾고 구문이 만약 node_modules에 존재한다면 해당 모듈을 빌드 artifact로 복사한다. Next.js standalone 모드에서의 추적은 "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/vercel/nft","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"@vercel/nft"}]},{"type":"text","value":" 라이브러리가 담당하고 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"문서를 들여다보면, 상용 번들러와 마찬가지로 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"import"}]},{"type":"text","value":", "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"require"}]},{"type":"text","value":" 등을 추적하고 있다. 우리가 Next.js를 patch-package 해서 사용하지 않는 이상 고치는 것은 유지보수에 힘들 것이다(Next.js는 아주 잦은 업데이트가 있기 때문에…)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"결국 Next.js에서 제대로 pino-pretty를 추적하도록 만들어줘야만 한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"@vercel/nft는 의존성 트리를 어떻게 추적할까? 먼저 파일을 AST로 파싱해서 ‘정적’ 참조를 따라간다. 용어 정리를 해보자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"1-정적static-동적dynamic-import","style":"position:relative;"},"children":[{"type":"text","value":"1. 정적(static), 동적(dynamic) import"},{"type":"element","tagName":"a","properties":{"href":"#1-%EC%A0%95%EC%A0%81static-%EB%8F%99%EC%A0%81dynamic-import","ariaLabel":"1 정적static 동적dynamic import permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"정적-import","style":"position:relative;"},"children":[{"type":"text","value":"정적 import"},{"type":"element","tagName":"a","properties":{"href":"#%EC%A0%95%EC%A0%81-import","ariaLabel":"정적 import permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"js"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"import"}]},{"type":"text","value":" foo "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"from"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'foo'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"import"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":" bar "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"from"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'./bar.js'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"from절 뒤에 리터럴로 패키지를 명확하게 명시."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"동적-import","style":"position:relative;"},"children":[{"type":"text","value":"동적 import"},{"type":"element","tagName":"a","properties":{"href":"#%EB%8F%99%EC%A0%81-import","ariaLabel":"동적 import permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"js"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"import"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'foo'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"import 함수를 사용하여 파일 상단이 아닌 조건부로 패키지를 가져온다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://tc39.es/proposal-dynamic-import/","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"ECMAScript proposal"}]},{"type":"text","value":": import() 에서 import()를 dynamic import라고 부름."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"2-정적-참조Statically-analyzable-reference-동적-참조Dynamic-reference","style":"position:relative;"},"children":[{"type":"text","value":"2. 정적 참조(Statically analyzable reference), 동적 참조(Dynamic reference)"},{"type":"element","tagName":"a","properties":{"href":"#2-%EC%A0%95%EC%A0%81-%EC%B0%B8%EC%A1%B0Statically-analyzable-reference-%EB%8F%99%EC%A0%81-%EC%B0%B8%EC%A1%B0Dynamic-reference","ariaLabel":"2 정적 참조Statically analyzable reference 동적 참조Dynamic reference permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"정적-참조","style":"position:relative;"},"children":[{"type":"text","value":"정적 참조"},{"type":"element","tagName":"a","properties":{"href":"#%EC%A0%95%EC%A0%81-%EC%B0%B8%EC%A1%B0","ariaLabel":"정적 참조 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"공식 용어는 아니지만, 번들러에서 쓰는 개념."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"js"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"require"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'lodash'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// ✅ 정적 참조"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"await"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"import"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'pino-pretty'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// ✅ 정적 참조"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"소스 코드에서 모듈 경로가 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"문자열 리터럴로 고정"}]},{"type":"text","value":"되어 있어 빌드 타임에 추적 가능한 참조."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"동적-참조","style":"position:relative;"},"children":[{"type":"text","value":"동적 참조"},{"type":"element","tagName":"a","properties":{"href":"#%EB%8F%99%EC%A0%81-%EC%B0%B8%EC%A1%B0","ariaLabel":"동적 참조 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"js"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"const"}]},{"type":"text","value":" name "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" process"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"env"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"LIB"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"require"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"name"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// ❌ 빌드 시 추적 불가"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"await"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"import"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"name"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// ❌ 빌드 시 추적 불가"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"따라서 정적 import와 동적 import는 ‘정적 참조’ 이므로(리터럴 문자열로 패키지명을 적었으므로) 번들러 및 nft가 추적이 가능하다.\n하지만, pino-pretty는 왜 동적참조인가?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"pino-pretty를 사용하는 pino 라이브러리를 살짝 까보자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight","has-highlighted-lines"],"dataLanguage":"js"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// node_modules/pino/lib/transport.js"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"function"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"fixTarget"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","parameter"]},"children":[{"type":"text","value":"origin"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// ..."}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"for"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"const"}]},{"type":"text","value":" filePath "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"of"}]},{"type":"text","value":" callers"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"try"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["gatsby-highlight-code-line"]},"children":[{"type":"text","value":"      "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"const"}]},{"type":"text","value":" context "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" filePath "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"==="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'node:repl'"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"?"}]},{"type":"text","value":" process"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"cwd"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"+"}]},{"type":"text","value":" sep "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" filePath"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-highlight-code-line"]},"children":[{"type":"text","value":"      fixTarget "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"createRequire"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"context"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"resolve"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"origin"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]}]},{"type":"text","value":"      "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"break"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"catch"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"err"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"continue"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"if"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"!"}]},{"type":"text","value":"fixTarget"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"throw"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"new"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Error"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","template-string"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","template-punctuation","string"]},"children":[{"type":"text","value":"`"}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"unable to determine transport target for \""}]},{"type":"element","tagName":"span","properties":{"className":["token","interpolation"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","interpolation-punctuation","punctuation"]},"children":[{"type":"text","value":"${"}]},{"type":"text","value":"origin"},{"type":"element","tagName":"span","properties":{"className":["token","interpolation-punctuation","punctuation"]},"children":[{"type":"text","value":"}"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""}]},{"type":"element","tagName":"span","properties":{"className":["token","template-punctuation","string"]},"children":[{"type":"text","value":"`"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"return"}]},{"type":"text","value":" fixTarget"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"createRequire는 Node.js의 함수로, 특정 파일/디렉토리 경로를 기준으로 require.resolve를 수행할 수 있게 해준다. 결국 이건 Node의 모듈 해석 알고리즘을 따르고 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"즉, ‘pino-pretty’ 를 문자열로 적어주면 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"require.resolve('pino-pretty')"}]},{"type":"text","value":" 가 되어 node_modules/pino-pretty 디렉토리를 찾아 절대 경로를 반환하게 된다. 하지만, 변수로 ‘pino-pretty’ 라는 문자열을 만들어냈으므로 이는 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"동적 참조"}]},{"type":"text","value":"이고, @vercel/nft가 추적하지 못하게 된 것이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"결국 우리에게 필요한건, 코드 베이스에 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"import pinoPretty from 'pino-pretty'"}]},{"type":"text","value":" 또는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"import(pino-pretty)"}]},{"type":"text","value":" 이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"해결-방법","style":"position:relative;"},"children":[{"type":"text","value":"해결 방법"},{"type":"element","tagName":"a","properties":{"href":"#%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95","ariaLabel":"해결 방법 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"허무하지만 정말 간단하다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight","has-highlighted-lines"],"dataLanguage":"js"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"import"}]},{"type":"text","value":" pino "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"from"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'pino'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["gatsby-highlight-code-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"if"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"process"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"env"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"NEXT_PUBLIC_APP_ENV"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"!=="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'localhost'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-highlight-code-line"]},"children":[{"type":"text","value":"  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"await"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"import"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'pino-pretty'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-highlight-code-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"const"}]},{"type":"text","value":" logger "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"pino"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","literal-property","property"]},"children":[{"type":"text","value":"transport"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","literal-property","property"]},"children":[{"type":"text","value":"target"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'pino-pretty'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// ..."}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"테스트 서버 및 운영 서버에서 동적 import를 사용해서 ‘정적 참조’ 시키면 된다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"mermaid"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-mermaid"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-mermaid"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"flowchart"}]},{"type":"text","value":" TD\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"classDef"}]},{"type":"text","value":" bad "},{"type":"element","tagName":"span","properties":{"className":["token","style"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"fill"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"#ffe6e6"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"stroke"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"#ff4d4f"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"color"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"#a8071a"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"classDef"}]},{"type":"text","value":" good "},{"type":"element","tagName":"span","properties":{"className":["token","style"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"fill"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"#e6fffb"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"stroke"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"#36cfc9"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"color"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"#006d75"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n\n  A1"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[\"transport.target: 'pino-pretty' ← 문자열\"]"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"text","value":" B"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[\"Next build (standalone)\"]"}]},{"type":"text","value":"\n  A2"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[\"await import('pino-pretty') ← 리터럴\"]"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"text","value":" B"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[\"Next build (standalone)\"]"}]},{"type":"text","value":"\n\n  B "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"element","tagName":"span","properties":{"className":["token","label","property"]},"children":[{"type":"text","value":"|target 문자열만 있음|"}]},{"type":"text","value":" C"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[\"@vercel/nft 정적 추적 실패<br/>- 리터럴 import 없음(변수처리 되어 resolve)<br/>- 추적 누락\"]"}]},{"type":"text","value":"\n  B "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"element","tagName":"span","properties":{"className":["token","label","property"]},"children":[{"type":"text","value":"|리터럴 import 있음|"}]},{"type":"text","value":" C2"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[\"@vercel/nft 정적 추적 성공<br/>- pino-pretty 의존성 포함\"]"}]},{"type":"text","value":"\n\n  C "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"text","value":" D"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[\".next/standalone/node_modules<br/>- pino: O<br/>- pino-pretty: X<br/>- deps: X\"]"}]},{"type":"text","value":"\n  C2 "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"text","value":" D2"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[\".next/standalone/node_modules<br/>- pino: O<br/>- pino-pretty: O<br/>- deps: O\"]"}]},{"type":"text","value":"\n\n  D "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"text","value":" E"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[\"런타임: transport 로드<br/>require('pino-pretty') 시도\"]"}]},{"type":"text","value":"\n  D2 "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"text","value":" E2"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[\"런타임: transport 로드<br/>require('pino-pretty') 성공\"]"}]},{"type":"text","value":"\n\n  E "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"text","value":" F"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[\"에러: unable to determine transport target for 'pino-pretty'\"]"}]},{"type":"text","value":"\n  E2 "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"text","value":" F2"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[\"예쁜 로그 정상 출력\"]"}]},{"type":"text","value":"\n\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"class"}]},{"type":"text","value":" F bad"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"class"}]},{"type":"text","value":" F2 good"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 996px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 123.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAABYlAAAWJQFJUiTwAAADjklEQVR42pVV2VIaURDlJ1JJjEJYZAeBGZaBGRiGfRlQQFTc0LLykpQxeciiptS8J2pp1If4rSfd14IyVSkDD1137jC37zl9ug+WdNZAodJAudZAWq9A1laRVItoLnbQbC0hptfgy9YQylEUlxChNRyVEU2k4Q1FEY4lEFc0SMkMfOEYLDaXFylNx2BriHZ3BflyHeV6C9VGG73VdXT6a6i1OjA7y8joRZEoEk9BVlQEKTEnSqSzBCIHT2ABFn4wyjXUzEWo+SqkTA+pbIkS9FBvtpEsmQgbJqKFJoJGC37FgJcOeoIRigX4FyT4CCknFwmtTg/doAk05lIPeukBYbHaQKPdEQhTWl58w6HQs5xSESOkjE7J5gVCLV9EWErAohDdUt3EYq+PXLEJSe3TRyX0VtawSCgjuQqcqQJccaKUM+GRM/D4Q1SvKByeAOb9YUIZgzf4sBcI+cYW1ahCFI1yQ4iULZTR7Q8I4QBVKke7t4p8pQklV0BK1ameBUTjCjI5A3qxgnyJRCOBLK9eu6BSsbtETTNKcPmCQjX+kFUMRmSqTxx+UtDqcGPG5gSf4ZijPa8vrU7xnvdCZUaZoZvr1CZcguWVAT59/oJKwxQfWZ1uzNrnwd++nveN4197kXCWDpVqphCFi87vuMBSMk03u0Sy0YH/xRihwxMUtej2V4Ugbappa6mL/to6dKrnpEktI9gv5hxY39zG3d0dzs/PcXV1hcvLS7F/+26f6uSYPCHXiZs0LCXhpjbwUtOOwkfhpHZgFhNTHiXtLK/g5PQMh0fHODr+Jtazs+9Yp7FkFaeiPEPyt6mRT05P8fXwSCTj9ZQuGGxsT0+Ze47dgg+yAI+Df+dkk9AeI+TmHJAot7e3uLi4EIKMgvc/fv4U88uN/BTScQ2tFIVKHTu7e9jc3sHWcHccQ3q3u/dGTItAO5XKAVI5FBkHmwAjevbKNjllu+hDOza2h7j//RvXv37h5uYG19fXuL+/x/uDj4Kq3e2bZlICyJI5NMkDGzTTHHVymRaNIxvFrBBmitFzeoPCQDnp4+BxjCUUUZaJG5tr9JwoswD/orx/8GG6PmTV2HnZMFWixxRVsjNe2dojchJzLIhI+HRS4djc1JyQaT2YJZkmjRo/jxrdRp5oc/D6tNIWtnKD/jo1WqWkjoDcJitPo0p/BzlCNy9rsMfzsEtZ2NNV2ENxYuT5y1gfxx+2JzPBUDK/dAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"complete-pretty-log","title":"","src":"/static/8513faacc23b781eb52a34eb70d3c677/14920/complete-pretty-log.png","srcSet":["/static/8513faacc23b781eb52a34eb70d3c677/b30f8/complete-pretty-log.png 500w","/static/8513faacc23b781eb52a34eb70d3c677/14920/complete-pretty-log.png 996w"],"sizes":"(max-width: 996px) 100vw, 996px","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy","decoding":"async"},"children":[]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"아주 이쁘다.."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"정리","style":"position:relative;"},"children":[{"type":"text","value":"정리"},{"type":"element","tagName":"a","properties":{"href":"#%EC%A0%95%EB%A6%AC","ariaLabel":"정리 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"핵심-개념-1-pino-pino-pretty-그리고-transport-로딩","style":"position:relative;"},"children":[{"type":"text","value":"핵심 개념 1: pino, pino-pretty, 그리고 transport 로딩"},{"type":"element","tagName":"a","properties":{"href":"#%ED%95%B5%EC%8B%AC-%EA%B0%9C%EB%85%90-1-pino-pino-pretty-%EA%B7%B8%EB%A6%AC%EA%B3%A0-transport-%EB%A1%9C%EB%94%A9","ariaLabel":"핵심 개념 1 pino pino pretty 그리고 transport 로딩 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"pino: 빠른 JSON 로거. 기본 출력은 머신 친화적(JSON) 이라서 수집 파이프라인(ELK, Loki, CloudWatch 등)에 좋다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"pino-pretty: pino 로그를 사람이 읽기 좋게 변환해주는 트랜스포트(transport).\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"코드 설정: pino({ transport: { target: ‘pino-pretty’, options: {…} } })"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"transport target 동작: pino의 transport는 target에 적힌 문자열을 런타임에 require()로 해석한다. -> 동적 참조이다.\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"즉, 서버가 실제로 구동될 때 모듈을 찾는다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"그런데 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"구동할 때 찾는다"}]},{"type":"text","value":"는 말은, 이미 빌드 산출물에 그 모듈이 들어있어야 한다는 뜻."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"여기서 Next.js standalone과 충돌이 난다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"핵심-개념-2-Nextjs-standalone과-vercelnft의-정적-추적","style":"position:relative;"},"children":[{"type":"text","value":"핵심 개념 2: Next.js standalone과 @vercel/nft의 정적 추적"},{"type":"element","tagName":"a","properties":{"href":"#%ED%95%B5%EC%8B%AC-%EA%B0%9C%EB%85%90-2-Nextjs-standalone%EA%B3%BC-vercelnft%EC%9D%98-%EC%A0%95%EC%A0%81-%EC%B6%94%EC%A0%81","ariaLabel":"핵심 개념 2 Nextjs standalone과 vercelnft의 정적 추적 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"output: ‘standalone’ 빌드 시, .next/standalone 안에 실행에 필요한 최소 파일만 모여든다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"무엇이 필요한가?를 결정하는 엔진이 [@vercel/nft].\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"빌드할 때 코드를 AST로 파싱해서, 정적으로 판별 가능한 import/require만 따라간다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"포함됨: import ‘x’, import x from ‘x’, require(‘x’), await import(‘x’) (문자열 리터럴)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"누락됨: require(‘pino-’ + env), await import(variable) (표현식/변수)"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"중요한 포인트:\ntransport.target: ‘pino-pretty’는 런타임 문자열이기 때문에 빌드 타임 정적 추적 대상이 아니다.\n→ 그래서 standalone 산출물에 pino-pretty가 안 들어간다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"실제로 .next/standalone/node_modules를 보면, pino는 있는데 pino-pretty는 없다는 걸 확인할 수 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"핵심-개념-3-pnpm의-구조와-왜-더-까다로워지는지","style":"position:relative;"},"children":[{"type":"text","value":"핵심 개념 3: pnpm의 구조와 왜 더 까다로워지는지"},{"type":"element","tagName":"a","properties":{"href":"#%ED%95%B5%EC%8B%AC-%EA%B0%9C%EB%85%90-3-pnpm%EC%9D%98-%EA%B5%AC%EC%A1%B0%EC%99%80-%EC%99%9C-%EB%8D%94-%EA%B9%8C%EB%8B%A4%EB%A1%9C%EC%9B%8C%EC%A7%80%EB%8A%94%EC%A7%80","ariaLabel":"핵심 개념 3 pnpm의 구조와 왜 더 까다로워지는지 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"pnpm은 .pnpm 디렉터리에 패키지를 설치하고, node_modules는 심볼릭 링크로 구성한다. (공간 효율 최고)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"npm/yarn처럼 flat하게 파일이 쫙 깔리는 게 아니라, 링크 체인을 타고 들어간다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"이 구조는 @vercel/nft의 파일 추적이나, Next의 outputFileTracingIncludes에서 경로 패턴/심볼릭 링크 처리가 까다로워지게 만든다.\n→ "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"겉보기엔 들어온 것 같은데 실행 시점엔 여전히 못 찾는"}]},{"type":"text","value":" 상황이 생기기 딱 좋다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"마치며","style":"position:relative;"},"children":[{"type":"text","value":"마치며"},{"type":"element","tagName":"a","properties":{"href":"#%EB%A7%88%EC%B9%98%EB%A9%B0","ariaLabel":"마치며 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이번 트러블슈팅을 하며 아무 생각 없이 썼던 import 구문에서 어떤 처리들이 일어나고 있는지를 알게 되었고, standalone 빌드 환경과 pnpm과 Next.js 빌드 관계에 대해 다시 한 번 짚어볼 수 있는 시간이었다. 아직까지도 사용하고 있는 Gatsby도 config 파일에서 문자열로 라이브러리를 등록해 사용하고 있는데, pino와 마찬가지로 리터럴 문자열로 node_modules에 있는 라이브러리를 참조하고 있다는 사실을 추가로 알게 되었다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"참고로, 테스트 서버에서는 pino-pretty를 사용해 로깅하지만 운영 서버에서는 pretty를 실시간성 로그에만 사용하고, pino-pretty를 이용하지 않은 pure log를 파일로 저장해두는 것이 좋을 것 같다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"프로젝트에서 Next.js의 page router를 사용하고 있어 SSR 환경에서의 API fetching이 일어날 때 자동으로 로깅을 남겨주지 않는다.\n언젠가 app router로 넘어가게 될텐데, 중요한 부분 및 파일로 로그를 적재해야할 부분은 pino로 남겨두어야겠다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"덧) 사실 "},{"type":"element","tagName":"a","properties":{"href":"https://www.tomups.com/posts/log-nextjs-request-response-as-json/","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"이런 방법"}]},{"type":"text","value":"도 있단다.."}]}],"data":{"quirksMode":false}},"excerpt":"Next.js를 실행하면 클라이언트 측 로그는 브라우저의 콘솔에 나타나지만, 서버 측 로그는 제대로 된 로그를 출력해주지 않았다. 이번에 프로젝트에 Next.js의 node 환경에서 log…","fields":{"readingTime":{"text":"13 min read"},"createdAt":"2025-09-12","modifiedAt":null},"frontmatter":{"title":"Next.js standalone 종속성 추적 삽질기 (feat. pino)","userDate":"12 September 2025","createdAt":"2025-09-12","tags":["Next.js","DevOps"],"excerpt":"Next.js를 standalone 모드로 빌드하면서 종속성 누락 문제를 겪었다. @vercel/nft의 정적 추적 방식, pnpm의 심볼릭 링크 구조, 그리고 pino-pretty를 포함해 종속성이 빠지는 이유와 해결 과정을 기록한다.","photoAuthor":"Logan Voss>>https://unsplash.com/ko/@loganvoss>>true","photoVender":"Unsplash>>https://unsplash.com","image":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIDBQb/xAAXAQADAQAAAAAAAAAAAAAAAAABAwQF/9oADAMBAAIQAxAAAAHLjx3ZaFkFf//EABsQAAICAwEAAAAAAAAAAAAAAAECAAMREhQh/9oACAEBAAEFAnPpxLKyWM2PeyKZ/8QAGREBAAIDAAAAAAAAAAAAAAAAAQARAyFR/9oACAEDAQE/AQsvkM+p/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAEDITH/2gAIAQIBAT8BwcNn/8QAHBAAAgIDAQEAAAAAAAAAAAAAAAERIgIhYTFB/9oACAEBAAY/AvkrRaxL2+GXGxYTWBN+n//EAB0QAQEAAgEFAAAAAAAAAAAAAAERACFRMXGx8PH/2gAIAQEAAT8hQSRqcHvOJg1Xj7iMcnQnepcnQqo9rk0NG4pn/9oADAMBAAIAAwAAABAk3//EABoRAQACAwEAAAAAAAAAAAAAAAEAEUGBkfD/2gAIAQMBAT8QsBgvIYC325//xAAaEQEAAgMBAAAAAAAAAAAAAAABABEhMaHw/9oACAECAQE/EEtnShGtXuT/xAAdEAEAAgICAwAAAAAAAAAAAAABETEAIVFhQXGR/9oACAEBAAE/EHrGtYOYOz0hMlN9gGSoMzSG+omMYigShQ1UmEShCIkAdarWAQjFuFX5d/KrF4U1SjU6eAz/2Q=="},"images":{"fallback":{"src":"/static/0152e08f5e4324b47115749c8231fdb1/bb4aa/main.jpg","srcSet":"/static/0152e08f5e4324b47115749c8231fdb1/a5dc9/main.jpg 500w,\n/static/0152e08f5e4324b47115749c8231fdb1/7f0a0/main.jpg 800w,\n/static/0152e08f5e4324b47115749c8231fdb1/bb4aa/main.jpg 1170w","sizes":"100vw"},"sources":[{"srcSet":"/static/0152e08f5e4324b47115749c8231fdb1/b400f/main.avif 500w,\n/static/0152e08f5e4324b47115749c8231fdb1/4ec68/main.avif 800w,\n/static/0152e08f5e4324b47115749c8231fdb1/d4b7e/main.avif 1170w","type":"image/avif","sizes":"100vw"},{"srcSet":"/static/0152e08f5e4324b47115749c8231fdb1/d4cbf/main.webp 500w,\n/static/0152e08f5e4324b47115749c8231fdb1/03a08/main.webp 800w,\n/static/0152e08f5e4324b47115749c8231fdb1/63766/main.webp 1170w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.5623931623931624}}},"author":[{"name":"Pozafly","bio":"Frontend Developer","avatar":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","backgroundColor":"#6808f8","images":{"fallback":{"src":"/static/8c061761f263c344f2c0416607c8adf1/b9493/pozafly.jpg","srcSet":"/static/8c061761f263c344f2c0416607c8adf1/5e3dc/pozafly.jpg 40w,\n/static/8c061761f263c344f2c0416607c8adf1/d18de/pozafly.jpg 80w,\n/static/8c061761f263c344f2c0416607c8adf1/b9493/pozafly.jpg 120w","sizes":"100vw"},"sources":[{"srcSet":"/static/8c061761f263c344f2c0416607c8adf1/ae5f4/pozafly.webp 40w,\n/static/8c061761f263c344f2c0416607c8adf1/87ddd/pozafly.webp 80w,\n/static/8c061761f263c344f2c0416607c8adf1/2988d/pozafly.webp 120w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":1}}}}]}},"relatedPosts":{"totalCount":2,"edges":[{"node":{"id":"ec758f9a-0a7f-5d98-8c48-7f3ce3f78621","excerpt":"Next.js를 실행하면 클라이언트 측 로그는 브라우저의 콘솔에 나타나지만, 서버 측 로그는 제대로 된 로그를 출력해주지 않았다. 이번에 프로젝트에 Next.js의 node 환경에서 log…","frontmatter":{"title":"Next.js standalone 종속성 추적 삽질기 (feat. pino)","createdAt":"2025-09-12"},"fields":{"readingTime":{"text":"13 min read"},"slug":"/nextjs/nextjs-standalone-dependency-tracing-issue/","modifiedAt":null}}},{"node":{"id":"c431dcad-0c68-56ce-aab2-d0b18ba1f626","excerpt":"메타 프레임워크 Next.js는 react…","frontmatter":{"title":"Next.js의 API Routes 코드 모듈화에 대해서","createdAt":"2023-07-26"},"fields":{"readingTime":{"text":"11 min read"},"slug":"/nextjs/about-modularizing-api-routes-code-in-nextjs/","modifiedAt":null}}}]}},"pageContext":{"slug":"/nextjs/nextjs-standalone-dependency-tracing-issue/","prev":null,"next":{"excerpt":"웹을 개발하다 보면, PDF…","frontmatter":{"title":"PDF 페이지 CSS로 안전하게 작성하기","tags":["CSS","HTML","PDF"],"createdAt":"2022-04-02T12:13:47.149Z","draft":false,"photoAuthor":null,"photoVender":null,"excerpt":"웹을 개발하다 보면, PDF로 문서를 사용자에게 제공하는 기능을 구현해야 할 때가 있다. 다른 개발자분들이 헤매지 않을 수 있도록 정리해 보았다.","image":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABKklEQVR42pWT0U7CMBSGu3nFg+iNS9DoAxB9ARIeghm9dO+i0QteQLxAJJAt8CgwE2AjoHZAu0Dy2xYDi+vidvHnpKfnfGn/0xLOObRiDHyzQQyktd3u9jV9JBMmmlgQgPZ6oN3uQWIt8zwDSrJOJpvG5TJGhMA3TPjEUFGux2fnO6io+wtNA9drda3I8zAUzSPDUJC9TFPlo/5A1fHV6h+gKJCF360WJqcWFrd3CK+u8eU4mF5cYmHbmByfgHY6BYEvTcxqNTDXxfLpGZ/3DqKHR7C3NqaWBdp+LwhsvmJWrSpoUKlg2Whgbt9gXq8LPwmo6+UE/npIEx76Qh+lkvDv6ODhIK+HminvByPisPCUk+8wDMU0+ynJfP53mITGsfanyLy0RvdTfgD4wgAkBeu5twAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/39ee9e2452b5c68830fa2ebb9eec0967/d8bb9/main.png","srcSet":"/static/39ee9e2452b5c68830fa2ebb9eec0967/8c964/main.png 750w,\n/static/39ee9e2452b5c68830fa2ebb9eec0967/10850/main.png 1080w,\n/static/39ee9e2452b5c68830fa2ebb9eec0967/d8bb9/main.png 1200w","sizes":"100vw"},"sources":[{"srcSet":"/static/39ee9e2452b5c68830fa2ebb9eec0967/17074/main.webp 750w,\n/static/39ee9e2452b5c68830fa2ebb9eec0967/e4fbc/main.webp 1080w,\n/static/39ee9e2452b5c68830fa2ebb9eec0967/7d981/main.webp 1200w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.525}}}},"fields":{"readingTime":{"text":"10 min read"},"layout":"post","slug":"/html/securely-create-a-pdf-page-with-css/","modifiedAt":"2025-08-30T12:13:47.149Z"}},"primaryTag":"Next.js"}},"staticQueryHashes":["1661920220"],"slicesMap":{}}