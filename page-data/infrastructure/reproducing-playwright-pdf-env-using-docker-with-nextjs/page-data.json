{"componentChunkName":"component---src-templates-post-tsx","path":"/infrastructure/reproducing-playwright-pdf-env-using-docker-with-nextjs/","result":{"data":{"markdownRemark":{"html":"<p>PDF를 유저에게 보여줘야 하는 일이 생겼다. PDF 생성은 전통적인 방법으로 SpringBoot의 라이브러리(OpenHTMLtoPDF등)를 사용해 서버에서 생성하는 방법이 있다. 하지만, 유저에게 보여주어야 할 PDF가 단순히 문자열로만 구성된 것이 아니라 복잡한 layout과 다양한 CSS 기법이 적용되어야 했다. 또한, 유저에 따라 동적인 layout이 적용되어야 했다.</p>\n<p>SpringBoot의 PDF 라이브러리는 text만 표시하지 않고 HTML을 렌더링해서 PDF 형식으로 만들어내는 방법도 존재했지만, CSS 지원이 제한적이라 미묘한 깨짐이 발생할 수 있다. 그리고 복잡한 layout의 PDF는 FE쪽 리소스를 투입하는게 낫다.</p>\n<p>FE에서 PDF를 생성할 수 있는 라이브러리로, <a href=\"https://pptr.dev/\" target=\"_blank\" rel=\"nofollow\">Puppeteer</a>, <a href=\"https://playwright.dev/\" target=\"_blank\" rel=\"nofollow\">Playwright</a>와 같은 Headless Browser를 이용해 렌더링 하는 방법이 떠올랐다. Playwright를 선택한 이유는 앞으로 Playwright로 E2E Testing을 할 계획을 가지고 있기도 했고, Playwright를 이전 Puppeteer 개발자 주도해 만들었기 때문이다(사실 아주 거창한 이유는 없다).</p>\n<p>Nextjs를 사용하고 있기 때문에 Node 영역에서 Playwright의 Headless Browser를 구동시켜 페이지를 렌더링 시키고, 그 페이지를 PDF로 만들어내면 되겠다. 자세한 기법은 추후 블로깅 할 생각.</p>\n<p>이번 글은 개발을 끝낸 뒤, 이걸 어떻게 배포 환경까지 안정적으로 가져갔는지에 대한 기록이다. 특히 ‘로컬에서는 되는데 배포에서는 깨지는’ 문제를 피하기 위해 실행 환경을 통제하고, 재현 가능한 형태로 굳혀간 과정을 정리한다.</p>\n<h2 id=\"얻어갈-수-있는-것\" style=\"position:relative;\">얻어갈 수 있는 것<a href=\"#%EC%96%BB%EC%96%B4%EA%B0%88-%EC%88%98-%EC%9E%88%EB%8A%94-%EA%B2%83\" aria-label=\"얻어갈 수 있는 것 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<ul>\n<li>Playwright 실행 환경(브라우저/OS 의존성/폰트)을 <strong>Base 이미지로 고정</strong>하는 방법</li>\n<li>로컬에서 배포 환경과 유사하게 재현하는 <strong>로컬 Docker 테스트 패턴</strong></li>\n<li>Playwright npm 버전 변화에 맞춰 <strong>Base 이미지 버전과 Dockerfile FROM을 자동 갱신</strong>하는 방법</li>\n<li>Docker build cache / tag 문제를 피하는 <strong>timestamp 태깅 전략</strong></li>\n<li>이미지 이동/적재(docker save/load + gzip)로 <strong>외부 다운로드 의존성 제거</strong></li>\n</ul>\n<h2 id=\"전제\" style=\"position:relative;\">전제<a href=\"#%EC%A0%84%EC%A0%9C\" aria-label=\"전제 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<p>이 글은 Next.js 기반 애플리케이션의 복잡한 PDF 생성 모듈을 Playwright를 사용하여 Docker/Kubernetes(EKS) 환경에 배포하는 과정을 다룬다. 아래 기술들에 대한 간단한 이해가 있다면 내용을 더 쉽게 파악할 수 있다.</p>\n<ul>\n<li><strong>Next.js (Page Router / Standalone)</strong>: next build 이후 standalone 아티팩트가 어떤 식으로 서버를 구성하는지</li>\n<li><strong>Playwright</strong>: Headless Browser(Chromium)를 제어해서 페이지를 렌더링하고 PDF를 생성한다는 개념</li>\n<li><strong>Docker</strong>: Dockerfile, 이미지/컨테이너, FROM/ARG/ENV/USER 같은 기본 문법과 컨테이너 네트워크</li>\n<li><strong>ECR/EKS</strong>: 이미지 push/pull, 그리고 그 이미지를 기반으로 Pod가 뜬다는 흐름</li>\n<li><strong>CI/CD</strong>: GitHub Actions로 빌드→이미지 생성→레지스트리 push→배포까지 이어지는 전체 흐름</li>\n<li><strong>기본 쉘 명령</strong>: apt-get, sed, gzip, docker save/load 같은 명령의 역할</li>\n</ul>\n<h2 id=\"환경\" style=\"position:relative;\">환경<a href=\"#%ED%99%98%EA%B2%BD\" aria-label=\"환경 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<h3 id=\"FE\" style=\"position:relative;\">FE<a href=\"#FE\" aria-label=\"FE permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<ul>\n<li>Next.js (Page Router)</li>\n<li>Playwright</li>\n</ul>\n<h3 id=\"Deployment\" style=\"position:relative;\">Deployment<a href=\"#Deployment\" aria-label=\"Deployment permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<ul>\n<li><a href=\"https://nextjs.org/docs/app/api-reference/config/next-config-js/output#automatically-copying-traced-files\" target=\"_blank\" rel=\"nofollow\">Nextjs Standalone</a></li>\n<li>GitHub Actions</li>\n<li>Docker / ECR(Amazon Elastic Container Registry)</li>\n<li>EKS(Amazon Elastic Kubernetes Service)</li>\n</ul>\n<p>아래는 현재 CI/CD 배포 파이프라인이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"mermaid\"><pre class=\"language-mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">sequenceDiagram</span>\n    actor Developer\n    <span class=\"token keyword\">participant</span> GitHub\n    <span class=\"token keyword\">participant</span> Actions Runner\n    <span class=\"token keyword\">participant</span> ECR\n    <span class=\"token keyword\">participant</span> EKS\n\n    Developer <span class=\"token arrow operator\">->></span> GitHub<span class=\"token operator\">:</span> FE commit <span class=\"token text string\">(Push)</span>\n    GitHub <span class=\"token arrow operator\">-->></span> Actions Runner<span class=\"token operator\">:</span> Workflow Trigger\n    <span class=\"token keyword\">activate</span> Actions Runner\n\n    Actions Runner <span class=\"token arrow operator\">->></span> Actions Runner<span class=\"token operator\">:</span> nextjs build <span class=\"token text string\">(Standalone Artifacts 생성)</span>\n    Actions Runner <span class=\"token arrow operator\">->></span> Actions Runner<span class=\"token operator\">:</span> Docker build 시작 <span class=\"token text string\">(Dockerfile 실행)</span>\n\n    Actions Runner <span class=\"token arrow operator\">->></span> ECR<span class=\"token operator\">:</span> Base Image Pull <span class=\"token text string\">(FROM)</span>\n    ECR <span class=\"token arrow operator\">-->></span> Actions Runner<span class=\"token operator\">:</span> Base Image 제공\n\n    Actions Runner <span class=\"token arrow operator\">->></span> Actions Runner<span class=\"token operator\">:</span> Nextjs Artifacts Copy <span class=\"token text string\">(COPY)</span>\n    Actions Runner <span class=\"token arrow operator\">->></span> Actions Runner<span class=\"token operator\">:</span> 새로운 Docker Image 생성 완료\n    Actions Runner <span class=\"token arrow operator\">->></span> ECR<span class=\"token operator\">:</span> Docker Image Push\n    ECR <span class=\"token arrow operator\">-->></span> Actions Runner<span class=\"token operator\">:</span> Image Push Success\n\n    Actions Runner <span class=\"token arrow operator\">->></span> EKS<span class=\"token operator\">:</span> 배포 요청\n    EKS <span class=\"token arrow operator\">-->></span> EKS<span class=\"token operator\">:</span> 새로운 Image로 Deployment/Pod 업데이트\n    <span class=\"token keyword\">deactivate</span> Actions Runner</code></pre></div>\n<br/>\n<h2 id=\"PDF가-유저에게-도달하는-흐름-요약\" style=\"position:relative;\">PDF가 유저에게 도달하는 흐름 (요약)<a href=\"#PDF%EA%B0%80-%EC%9C%A0%EC%A0%80%EC%97%90%EA%B2%8C-%EB%8F%84%EB%8B%AC%ED%95%98%EB%8A%94-%ED%9D%90%EB%A6%84-%EC%9A%94%EC%95%BD\" aria-label=\"PDF가 유저에게 도달하는 흐름 요약 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"mermaid\"><pre class=\"language-mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">sequenceDiagram</span>\n    <span class=\"token keyword\">autonumber</span>\n    actor 사용자\n    <span class=\"token keyword\">participant</span> Page as PDF렌더링 페이지&lt;br/><span class=\"token text string\">(PdfViewer)</span>\n    <span class=\"token keyword\">participant</span> API as API Routes\n    <span class=\"token keyword\">participant</span> Headless as Playwright&lt;br/><span class=\"token text string\">(Headless Chrome)</span>\n    <span class=\"token keyword\">participant</span> Backend as 백엔드 API&lt;br/><span class=\"token text string\">(SpringBoot)</span>\n\n    사용자<span class=\"token arrow operator\">->></span>Page<span class=\"token operator\">:</span> /pdf/something 접속\n    Page<span class=\"token arrow operator\">->></span>API<span class=\"token operator\">:</span> PDF 요청\n    API<span class=\"token arrow operator\">->></span>Headless<span class=\"token operator\">:</span> 헤드리스 브라우저 오픈\n    Headless<span class=\"token arrow operator\">->></span>Backend<span class=\"token operator\">:</span> SSR PDF 데이터 API 호출\n    Backend<span class=\"token arrow operator\">-->></span>Headless<span class=\"token operator\">:</span> 데이터 응답\n    Headless<span class=\"token arrow operator\">->></span>Headless<span class=\"token operator\">:</span> 1. SSR 페이지 오픈&lt;br/>2. PDF Buffer 생성\n    Headless<span class=\"token arrow operator\">-->></span>API<span class=\"token operator\">:</span> PDF Buffer 응답\n    API<span class=\"token arrow operator\">->></span>Page<span class=\"token operator\">:</span> PDF Buffer 전달\n    Page<span class=\"token arrow operator\">->></span>사용자<span class=\"token operator\">:</span> 환경에 따라 Blob<span class=\"token text string\">(네이티브 뷰어)</span>&lt;br/>혹은 pdf.js<span class=\"token text string\">(Canvas)</span>로 렌더링</code></pre></div>\n<p>API Routes 영역부터는 Node.js Runtime 영역이다.</p>\n<ul>\n<li>서버(Node)에서 Playwright로 Headless Chromium을 구동한다.</li>\n<li>Headless Browser가 Next.js로 배포된 “PDF 렌더링 페이지”를 연다.</li>\n<li>해당 페이지는 SSR 과정에서 백엔드(SpringBoot)로부터 데이터를 받아 렌더링된다.</li>\n<li>Playwright는 렌더링 결과를 PDF로 변환(<code class=\"language-text\">page.pdf()</code>)한다.</li>\n<li>생성된 PDF 바이너리를 API Routes가 받아 유저 브라우저로 내려준다.</li>\n</ul>\n<h2 id=\"Playwright-구성-요소\" style=\"position:relative;\">Playwright 구성 요소<a href=\"#Playwright-%EA%B5%AC%EC%84%B1-%EC%9A%94%EC%86%8C\" aria-label=\"Playwright 구성 요소 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<p>먼저, Playwright를 사용하기 위해서는 3가지를 알고 있어야 한다.</p>\n<ul>\n<li><strong>playwright 패키지</strong>: 브라우저를 제어하는 코드(런타임 라이브러리)</li>\n<li><strong>브라우저 바이너리(Chromium 등)</strong>: 실제 실행 엔진</li>\n<li><strong>브라우저 시스템 종속성(OS Dependencies)</strong>: 브라우저가 뜨기 위해 필요한 OS 라이브러리/폰트/로케일 등</li>\n</ul>\n<p>비유를 들면,</p>\n<ul>\n<li>Playwright 패키지 = 운전자 + 운전 매뉴얼</li>\n<li>브라우저 바이너리 = 실제 자동차</li>\n<li>OS 종속성 = 자동차가 달릴 수 있는 도로(기반 환경)</li>\n</ul>\n<p>PDF는 결과물이라서, 이 3개 중 하나라도 흔들리면 <strong>폰트/간격/줄바꿈 같은 것이 달라진다.</strong> 즉, PDF는 코드만 맞추면 끝나는 문제가 아니라 <strong>실행 환경까지 같이 고정해야</strong> 한다.</p>\n<h3 id=\"브라우저-시스템-종속성OS-Dependencies\" style=\"position:relative;\">브라우저 시스템 종속성(OS Dependencies)<a href=\"#%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EC%A2%85%EC%86%8D%EC%84%B1OS-Dependencies\" aria-label=\"브라우저 시스템 종속성OS Dependencies permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<h4 id=\"local-환경mac\" style=\"position:relative;\">local 환경(mac)<a href=\"#local-%ED%99%98%EA%B2%BDmac\" aria-label=\"local 환경mac permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h4>\n<p>local에서 개발할 때는 <code class=\"language-text\">$ npx playwright install chromium</code> 명령어로 local에 headless browser를 설치할 수 있다. 이때 CDN으로 <code class=\"language-text\">https://cdn.playwright.dev/dbazure/download/playwright/builds/chromium/1187/chromium-mac-arm64.zip</code> 경로를 통해 자동으로 바이너리를 받아온다(맥의 경우임, OS마다 다른 바이너리 파일을 다운 받음).</p>\n<p>브라우저 시스템 종속성은 local 환경에서는 다운 받을 필요 없다. 브라우저 실행에 필요한 OS 라이브러리가 이미 OS 자체에 있기 때문이다.</p>\n<h4 id=\"배포-환경docker-container---linux\" style=\"position:relative;\">배포 환경(docker container - linux)<a href=\"#%EB%B0%B0%ED%8F%AC-%ED%99%98%EA%B2%BDdocker-container---linux\" aria-label=\"배포 환경docker container   linux permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h4>\n<p>배포 환경은 Docker 이미지를 생성하고 실행하지만, <strong>외부 네트워크 접근에 제약이 있는 환경(내부망)이다.</strong> 이로 인해 다음과 같은 문제가 존재함.</p>\n<ol>\n<li><code class=\"language-text\">npx playwright install</code> 명령어를 통한 <strong>브라우저 바이너리(Chromium) 다운로드 불가.</strong></li>\n<li>Playwright가 요구하는 <strong>운영체제 종속성(OS Dependencies) 설치 및 버전 관리의 어려움.</strong> (내부 저장소 부재, 환경 통제의 필요성)</li>\n</ol>\n<p><a href=\"https://playwright.dev/docs/docker\" target=\"_blank\" rel=\"nofollow\">playwright의 공식 문서에서 docker 이미지</a>를 따로 제공하고 있다는 걸 알게 되었다. 이 이미지는 headless browser 바이너리와 브라우저 시스템 종속성을 포함하고 있다. 따라서 이미지를 빌드할 때 일일이 바이너리와 종속성을 따로 받지 않아도 된다. 따라서 Nextjs 빌드 결과물을 이 이미지에 입혀 EKS pod에 배포하면 되는 것이다.</p>\n<h2 id=\"문제-발생\" style=\"position:relative;\">문제 발생<a href=\"#%EB%AC%B8%EC%A0%9C-%EB%B0%9C%EC%83%9D\" aria-label=\"문제 발생 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<p>처음에는 공식 Playwright Docker 이미지를 쓰면 다 해결될 것이라고 생각했다. 실제로 공식 이미지는 브라우저 바이너리와 대부분의 OS 의존성을 포함하고 있고, Playwright가 기대하는 디렉토리 구조나 권한도 맞춰져 있다.</p>\n<p>그런데 배포 환경에서 돌려보니, 로컬에서 멀쩡하던 PDF가 깨지거나, 오류가 발생했다.</p>\n<ul>\n<li>브라우저 실행 경로 문제(/ms-playwright 하위 경로 등)</li>\n<li>브라우저 콘솔 에러, 렌더링 타이밍 이슈</li>\n<li>SSR에서 백엔드 호출 URL/네트워크 설정 문제</li>\n<li>한글 폰트/이모지 렌더링 문제</li>\n<li>쿠키/세션 처리 문제, user-agent 차이 등</li>\n</ul>\n<p>세부 오류는 여기서 다 풀지는 않겠지만 공식 이미지 만으로는 결과물이 고정되지 않는다. 브라우저/폰트/아키텍처/환경변수/네트워크가 조금만 달라도 PDF는 달라진다.</p>\n<p>그래서 완벽히 동일하진 않더라도, 최소한 <strong>로컬에서 배포 환경과 유사한 조건을 강제</strong>할 수 있어야 디버깅이 가능하다고 판단했다. 이게 Part 1(로컬 Docker 환경 구축)을 시작한 이유다.</p>\n<h2 id=\"Part-1-로컬-Docker-환경-구축\" style=\"position:relative;\">Part 1: 로컬 Docker 환경 구축<a href=\"#Part-1-%EB%A1%9C%EC%BB%AC-Docker-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%B6%95\" aria-label=\"Part 1 로컬 Docker 환경 구축 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<h3 id=\"Step-1-code-classlanguage-textdockerDockerfilelocalcode-신규-생성\" style=\"position:relative;\">Step 1. <code class=\"language-text\">docker/Dockerfile.local</code> (신규 생성)<a href=\"#Step-1-code-classlanguage-textdockerDockerfilelocalcode-%EC%8B%A0%EA%B7%9C-%EC%83%9D%EC%84%B1\" aria-label=\"Step 1 code classlanguage textdockerDockerfilelocalcode 신규 생성 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<p>기존 <code class=\"language-text\">docker/Dockerfile</code> 은 프로덕션 배포용이었기 때문에, 로컬 테스트를 위해 별도의 Dockerfile을 만든다. <code class=\"language-text\">Dockerfile.local</code> 파일을 작성한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token comment\">#\tDockerfile.local</span>\n\n<span class=\"token comment\"># 로컬 Docker 테스트용 Dockerfile (playwright 1.46.1 사용)</span>\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> mcr.microsoft.com/playwright:v1.46.1-jammy <span class=\"token keyword\">AS</span> base</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 3000</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> PORT=3000</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> HOST=0.0.0.0</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> public ./public</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> .next/standalone ./</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> .next/static ./.next/static</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> root</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> mkdir -p .next/cache &amp;&amp; chown -R pwuser:pwuser .next</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> pwuser</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENTRYPOINT</span> [<span class=\"token string\">\"node\"</span>, <span class=\"token string\">\"server.js\"</span>]</span></code></pre></div>\n<h3 id=\"세부-설명\" style=\"position:relative;\">세부 설명<a href=\"#%EC%84%B8%EB%B6%80-%EC%84%A4%EB%AA%85\" aria-label=\"세부 설명 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<p><strong><code class=\"language-text\">FROM mcr.microsoft.com/playwright:v1.46.1-jammy</code></strong></p>\n<ul>\n<li>Microsoft 공식 Playwright 이미지 사용</li>\n<li>npm에 설치된 Playwright 버전과 <strong>명시적으로 맞춘다</strong></li>\n<li>브라우저 바이너리와 OS 종속성을 직접 설치하지 않아도 됨</li>\n</ul>\n<p><strong><code class=\"language-text\">ENV HOST=0.0.0.0</code></strong></p>\n<ul>\n<li>Next.js 서버를 모든 네트워크 인터페이스에 바인딩</li>\n<li>컨테이너 내부에서 들어오는 요청을 정상적으로 받기 위함</li>\n</ul>\n<p><strong><code class=\"language-text\">USER pwuser</code></strong></p>\n<ul>\n<li>Playwright 공식 이미지에 포함된 일반 사용자</li>\n<li>root로 실행하지 않도록 기본 보안 설정 유지</li>\n<li>단, .next/cache 디렉토리는 root에서 권한만 미리 맞춰준다</li>\n</ul>\n<h3 id=\"Step-2-code-classlanguage-textenvlocal-dockercode-신규-생성\" style=\"position:relative;\">Step 2. <code class=\"language-text\">.env.local-docker</code> (신규 생성)<a href=\"#Step-2-code-classlanguage-textenvlocal-dockercode-%EC%8B%A0%EA%B7%9C-%EC%83%9D%EC%84%B1\" aria-label=\"Step 2 code classlanguage textenvlocal dockercode 신규 생성 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<p>로컬 개발 서버(pnpm dev)와 Docker 컨테이너에서 실행되는 서버는 네트워크 구조가 완전히 다르다. 그래서 기존 .env.localhost를 그대로 쓰면 의도하지 않은 문제가 생긴다.</p>\n<p>Docker 환경 전용으로 <code class=\"language-text\">.env.local-docker</code> 를 따로 만들었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"env\"><pre class=\"language-env\"><code class=\"language-env\"># .env.local-docker\nNEXT_PUBLIC_APP_ENV=local-docker\nNEXT_PUBLIC_BROWSER_API_URL=http://localhost:3000\nNEXT_PUBLIC_INTERNAL_API_URL=...\nNEXT_PUBLIC_PDF_INTERNAL_URL=http://host.docker.internal:3000\nSERVER_API_URL=...</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"env\"><pre class=\"language-env\"><code class=\"language-env\"># .env.local\nNEXT_PUBLIC_APP_ENV=localhost\nNEXT_PUBLIC_BROWSER_API_URL=http://localhost:3000\nNEXT_PUBLIC_INTERNAL_API_URL=http://localhost:3000\nNEXT_PUBLIC_PDF_INTERNAL_URL=http://localhost:3000\nSERVER_API_URL=...</code></pre></div>\n<h4 id=\"envlocal-docker-설명\" style=\"position:relative;\">.env.local-docker 설명<a href=\"#envlocal-docker-%EC%84%A4%EB%AA%85\" aria-label=\"envlocal docker 설명 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h4>\n<p><strong><code class=\"language-text\">NEXT_PUBLIC_BROWSER_API_URL=http://localhost:3000</code></strong></p>\n<ul>\n<li>브라우저(클라이언트)에서 API 호출 시 사용하는 URL</li>\n<li>사용자가 <code class=\"language-text\">http://localhost:3000</code>으로 접속하므로 그대로 유지</li>\n</ul>\n<p>단, 여기서 dev 서버는 CORS 때문에 <code class=\"language-text\">next.config.js</code>에 프록시 역할을 하도록 설정해두었었고, docker 환경에서도 프록시 역할을 하도록 해준다.</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// next.config.js</span>\n<span class=\"token comment\">// ...</span>\n<span class=\"token keyword\">async</span> <span class=\"token function\">rewrites</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NEXT_PUBLIC_APP_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">'localhost'</span> <span class=\"token operator\">||</span>\n<span class=\"gatsby-highlight-code-line\">    process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NEXT_PUBLIC_APP_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">'local-docker'</span></span>    <span class=\"token operator\">?</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// api 프록시</span>\n          <span class=\"token literal-property property\">source</span><span class=\"token operator\">:</span> <span class=\"token string\">'/b2c-api/api/:path*'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token literal-property property\">destination</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SERVER_API_URL</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/api/:path*</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token comment\">// ...</span></code></pre></div>\n<p><strong><code class=\"language-text\">NEXT_PUBLIC_INTERNAL_API_URL=...</code></strong></p>\n<ul>\n<li>SSR시, middleware 등 Node.js runtime에서 API 호출에 사용</li>\n<li>Docker 컨테이너 내부에서 <code class=\"language-text\">localhost:3000</code>은 자기 자신을 가리키므로 외부 테스트 서버 사용</li>\n<li>EKS 환경에서는 내부에 배포된 pod 서버 주소를 사용한다. (브라우저가 아니라 node 서버에서 SpringBoot 서버로 쏘므로)</li>\n</ul>\n<p><strong><code class=\"language-text\">NEXT_PUBLIC_PDF_INTERNAL_URL=http://host.docker.internal:3000</code></strong></p>\n<ul>\n<li>PDF 생성 시 Playwright가 페이지 접속에 사용하는 URL</li>\n<li>로컬 개발 서버(호스트 PC)와 달리, Docker 컨테이너 내부에서 <code class=\"language-text\">localhost</code>는 컨테이너 자신을 가리킴</li>\n<li>따라서 컨테이너에서 **호스트 머신(Next.js 서버가 실행 중인 PC)**으로 루프백 요청을 보내기 위해 Docker Desktop이 제공하는 특수 DNS인 <code class=\"language-text\">host.docker.internal</code>을 사용함.</li>\n</ul>\n<p>Playwright는 headless browser에서 PDF 생성 대상이 되는 페이지를 열기 위해 자기 자신을 호출한다. (그래야 FE에서 복잡한 CSS를 가진 페이지를 만들 수 있고, PDF 관리도 FE에서 가능하기 때문이다.)</p>\n<div class=\"gatsby-highlight\" data-language=\"mermaid\"><pre class=\"language-mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">sequenceDiagram</span>\n    box <span class=\"token string\">\"단일 로컬 PC 환경\"</span>\n        <span class=\"token keyword\">participant</span> PlaywrightApp as Playwright/Node.js 서버\n        <span class=\"token keyword\">participant</span> Browser as Playwright 헤드리스 브라우저\n    <span class=\"token keyword\">end</span>\n\n    PlaywrightApp <span class=\"token arrow operator\">->></span> Browser<span class=\"token operator\">:</span> 1. 브라우저 실행 <span class=\"token punctuation\">(</span>launch browser<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">activate</span> Browser\n\n    PlaywrightApp <span class=\"token arrow operator\">->></span> Browser<span class=\"token operator\">:</span> 2. 새 페이지 열기 <span class=\"token punctuation\">(</span>newPage<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    Browser <span class=\"token arrow operator\">-->></span> PlaywrightApp<span class=\"token operator\">:</span> 3. 페이지 인스턴스 반환\n\n    <span class=\"token keyword\">Note over</span> PlaywrightApp<span class=\"token operator\">:</span> 4. PDF 생성 대상 URL 결정&lt;br><span class=\"token text string\">(예: http://localhost:3000/content)</span>\n\n    PlaywrightApp <span class=\"token arrow operator\">->></span> Browser<span class=\"token operator\">:</span> 5. page.goto<span class=\"token text string\">('http://localhost:PORT/경로')</span>\n\n    Browser <span class=\"token arrow operator\">->></span> PlaywrightApp<span class=\"token operator\">:</span> 6. 페이지 콘텐츠를 위한 HTTP 요청 <span class=\"token text string\">(Loopback 통신)</span>\n    <span class=\"token keyword\">activate</span> PlaywrightApp\n\n    PlaywrightApp <span class=\"token arrow operator\">->></span> Browser<span class=\"token operator\">:</span> 7. HTTP 응답 <span class=\"token text string\">(HTML/CSS/JS)</span>\n    <span class=\"token keyword\">deactivate</span> PlaywrightApp\n\n    Browser <span class=\"token arrow operator\">->></span> Browser<span class=\"token operator\">:</span> 8. 페이지 콘텐츠 렌더링\n\n    PlaywrightApp <span class=\"token arrow operator\">->></span> Browser<span class=\"token operator\">:</span> 9. PDF 파일 생성 명령 <span class=\"token punctuation\">(</span>page.pdf<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    Browser <span class=\"token arrow operator\">-->></span> PlaywrightApp<span class=\"token operator\">:</span> 10. PDF 이진 데이터 반환\n\n    <span class=\"token keyword\">deactivate</span> Browser\n    PlaywrightApp <span class=\"token arrow operator\">->></span> PlaywrightApp<span class=\"token operator\">:</span> 11. PDF 파일 저장 또는 스트림 처리</code></pre></div>\n<p>자기 자신을 호출하는 것을 **로컬 루프백(Local Loopback)**이라고 한다. 이때 local(<code class=\"language-text\">pnpm dev</code>로 실행하는 dev서버)에서는 <code class=\"language-text\">http://localhost:3000</code> 주소를 사용해도 된다. 왜냐하면 Next.js가 떠있는게 localhost:3000 이기 때문이다. 같은 OS(호스트 PC) 위에서 실행되기 때문이다.</p>\n<blockquote>\n<ul>\n<li><strong>Host PC (Next.js Server):</strong> PDF 렌더링에 필요한 HTML/CSS/데이터를 제공하는 웹 서버.</li>\n<li><strong>Docker Container (Playwright App):</strong> Next.js 코드를 실행하며, Headless Browser를 구동하여 PDF를 생성하는 주체.</li>\n</ul>\n</blockquote>\n<p>하지만 Docker 환경은 다르다. Docker Container 내부에서 localhost는 호스트 PC가 아닌 Docker Container 자기 자신이기 때문이다. 컨테이너 내부 3000번 포트로 요청을 보낸다. 그러면 dev 서버와 동일하게 자기자신을 가리키기 때문에 문제 없이 호출되어야 하는 것이 맞다. 하지만 localhost:3000이 실패했고, <code class=\"language-text\">host.docker.internal:3000</code> 으로 접근했을 경우만 성공했다.</p>\n<p>왜냐면 docker container 내부에 localhost가 네트워크로 바인딩 되어있지 않기 때문이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># docker container 내부</span>\n\n$ <span class=\"token function\">cat</span> /etc/hosts\n<span class=\"token number\">127.0</span>.0.1       localhost\n::1     localhost ip6-localhost ip6-loopback\nfe00::  ip6-localnet\nff00::  ip6-mcastprefix\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\n<span class=\"token number\">172.17</span>.0.2      3c2c98fbe2ae</code></pre></div>\n<p>DNS로 127.0.0.1에 localhost가 바인딩 되어있지만, 실제로는 172.17.0.2에 Next.js 어플리케이션이 떠있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># docker container 내부</span>\n\n$ <span class=\"token function\">node</span> /app/server.js\n ⨯ Failed to start server\nError: listen EADDRINUSE: address already <span class=\"token keyword\">in</span> use <span class=\"token number\">172.17</span>.0.2:3000\n    at <span class=\"token operator\">&lt;</span>unknown<span class=\"token operator\">></span> <span class=\"token punctuation\">(</span>Error: listen EADDRINUSE: address already <span class=\"token keyword\">in</span> use <span class=\"token number\">172.17</span>.0.2:3000<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  code: <span class=\"token string\">'EADDRINUSE'</span>,\n  errno: -98,\n  syscall: <span class=\"token string\">'listen'</span>,\n  address: <span class=\"token string\">'172.17.0.2'</span>,\n  port: <span class=\"token number\">3000</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Next.js 서버를 다시 한번 실행하는 명령어인데, 이미 <code class=\"language-text\">172.17.0.2:3000</code> 에 떠 있는 것을 볼 수 있기 때문이다. 그렇다면 방법은 두 가지다.</p>\n<ol>\n<li><code class=\"language-text\">NEXT_PUBLIC_PDF_INTERNAL_URL</code>에 localhost:3000 대신, <code class=\"language-text\">172.17.0.2:3000</code> 이 주소를 넣어준다.</li>\n<li>docker run 시 <code class=\"language-text\">--dns=127.0.01</code> 옵션을 준다.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1454px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAuklEQVR42kWP6wrCMAyF+/6vJ4oI+mPrel9vyjYn2zHtigZCTr6EQ8K4MHA+oR8UTucbLtc7jAtwY4KlNC7WamuNjR/atllhxaPsMqkdpvmNmJ6QykIZV7UPCaOPVYeYf+nIyIeMlF+ImfYa09bXXZZpUGKaZnCh0PUCHRcQ0tDVsjKhDPW6cY2BmCRW+qIHoXF/dGQcwNBiXT/oORnyYqLpHQ9Pb4RYLg21HheG2tvRY14W7PuGbfvnF4GCLjuJnRJxAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"dns-option\"\n        title=\"\"\n        src=\"/static/c4e19889ca88eb4eb19b6c172744cf7a/b62b2/dns-option.png\"\n        srcset=\"/static/c4e19889ca88eb4eb19b6c172744cf7a/b30f8/dns-option.png 500w,\n/static/c4e19889ca88eb4eb19b6c172744cf7a/332ff/dns-option.png 1000w,\n/static/c4e19889ca88eb4eb19b6c172744cf7a/b62b2/dns-option.png 1454w\"\n        sizes=\"(max-width: 1454px) 100vw, 1454px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n<ul>\n<li><a href=\"https://docs.docker.com/engine/network/#dns-services\" target=\"_blank\" rel=\"nofollow\">https://docs.docker.com/engine/network/#dns-services</a></li>\n</ul>\n</li>\n<li><code class=\"language-text\">NEXT_PUBLIC_PDF_INTERNAL_URL</code>에 host.docker.internal을 주어 <strong>호스트 NAT 우회</strong> 한다.</li>\n</ol>\n<p>나는 3번을 선택했는데, 호스트 PC를 호출해서 호스트 PC가 다시 docker container의 Next.js 서버를 찌르게 만드는 방법이다. 이는 docker에서 제공하는 특수 DNS 이름이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"mermaid\"><pre class=\"language-mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">sequenceDiagram</span>\n    <span class=\"token keyword\">autonumber</span>\n\n    box <span class=\"token string\">\"Host PC\"</span>\n        <span class=\"token keyword\">participant</span> Browser as Browser <span class=\"token text string\">(Client)</span>\n        <span class=\"token keyword\">participant</span> NAT as Docker NAT / Port Publish\n    <span class=\"token keyword\">end</span>\n\n    box <span class=\"token string\">\"Docker Container\"</span>\n        <span class=\"token keyword\">participant</span> App as Next.js + Playwright\n        <span class=\"token keyword\">participant</span> B as Headless Chromium\n    <span class=\"token keyword\">end</span>\n\n    Browser<span class=\"token arrow operator\">->></span>App<span class=\"token operator\">:</span> /api/pdf 요청 <span class=\"token text string\">(localhost:3000)</span>\n    App<span class=\"token arrow operator\">->></span>B<span class=\"token operator\">:</span> launch + page.newPage\n\n    <span class=\"token keyword\">Note over</span> App<span class=\"token operator\">:</span> 내부 접근 시도&lt;br/>http<span class=\"token operator\">:</span>//localhost<span class=\"token operator\">:</span>3000/content\n    B<span class=\"token arrow operator\">->></span>App<span class=\"token operator\">:</span> GET localhost<span class=\"token operator\">:</span>3000 ❌ <span class=\"token text string\">(실패)</span>\n\n    <span class=\"token keyword\">Note over</span> App<span class=\"token operator\">:</span> 우회 경로 선택&lt;br/>http<span class=\"token operator\">:</span>//host.docker.internal<span class=\"token operator\">:</span>3000/content\n    B<span class=\"token arrow operator\">->></span>NAT<span class=\"token operator\">:</span> GET host.docker.internal<span class=\"token operator\">:</span>3000\n    NAT<span class=\"token arrow operator\">->></span>App<span class=\"token operator\">:</span> 포트 매핑으로 전달\n    App<span class=\"token arrow operator\">-->></span>B<span class=\"token operator\">:</span> HTML/CSS/JS\n\n    B<span class=\"token arrow operator\">->></span>B<span class=\"token operator\">:</span> 렌더링 + PDF 생성\n    B<span class=\"token arrow operator\">-->></span>App<span class=\"token operator\">:</span> PDF 바이너리\n    App<span class=\"token arrow operator\">-->></span>Browser<span class=\"token operator\">:</span> PDF 응답</code></pre></div>\n<p>위와 같은 경로로 전달된다. 당연히 local에서 docker를 통해 테스트를 하기 때문에 host.docker.internal을 사용했지만, 실제 배포 환경에서는 저런 방식으로 우회해서 사용하는게 아니라 명확한 주소를 매핑 시켜놓는 것이 좋다. 또한 만약 docker 정책이 container 자신의 주소가 172.17.0.2가 아닌 다른 주소가 된다해도 host.docker.internal를 사용하고 있으므로 local에서 테스트 용도로 적합하다고 생각했다.</p>\n<h3 id=\"Step-3-code-classlanguage-textpackagejsoncode\" style=\"position:relative;\">Step 3. <code class=\"language-text\">package.json</code><a href=\"#Step-3-code-classlanguage-textpackagejsoncode\" aria-label=\"Step 3 code classlanguage textpackagejsoncode permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<p>로컬 Docker 테스트는 <code class=\"language-text\">빌드 -> 이미지 생성 -> 실행</code> 을 매번 손으로 하면 바로 귀찮아진다. 한 줄로 끝나야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token comment\">// package.json</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"local-docker.build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"env-cmd -f .env.local-docker next build\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"local-docker.start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"pnpm local-docker.build &amp;&amp; docker build -f ./docker/Dockerfile.local -t my-next-app:local --platform linux/amd64 . &amp;&amp; docker run --rm -p 3000:3000 my-next-app:local\"</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"세부-설명-1\" style=\"position:relative;\">세부 설명<a href=\"#%EC%84%B8%EB%B6%80-%EC%84%A4%EB%AA%85-1\" aria-label=\"세부 설명 1 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<p><strong><code class=\"language-text\">local-docker.build</code></strong></p>\n<ul>\n<li><code class=\"language-text\">.env.local-docker</code> 환경변수를 사용하여 Next.js 빌드</li>\n<li><code class=\"language-text\">env-cmd -f</code> 플래그로 특정 환경 파일 지정</li>\n</ul>\n<p><strong><code class=\"language-text\">local-docker.start</code></strong></p>\n<ul>\n<li>전체 프로세스를 한 번에 실행하는 통합 스크립트\n<ul>\n<li>Next.js 빌드 -> Docker 이미지 생성 -> 컨테이너 실행</li>\n</ul>\n</li>\n<li><code class=\"language-text\">-platform linux/amd64</code>: M1/M2/M3 Mac에서도 호환성 보장</li>\n<li><code class=\"language-text\">-rm</code>: 컨테이너 종료 시 자동 삭제</li>\n</ul>\n<p>이제 아래 명령어 한 줄로 현재 작성된 Next.js 코드를 local에서 docker container로 띄운 환경에 접속 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">pnpm</span> local-docker.start</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 2000px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.800000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB7ElEQVR42pWS6W7bMBCE9RwFXDu2DovUaV2MJFsW5CM+UrcpigZF2/d/i8mQdtqk//rjw1IrcnZ3SKtoz8jrE1J1QLm8QHUXuGEDW1SwpcJMlJi4ASaONIxt78YcH2cuRLRAlBWIi5oMsPzFGX56gswvkMUTxQaKKTjBPRxJAopLilNYFzDirwUYx7bAaOpxHcOLN7BkdkKQP+IaPyEoLvwxUHhFwRrzZIN5umPcQiweyMHgJzuI7Ghyfrol3BP3sIwICcsnhMUXeFGHOy80I41t/w8TR/zD35zeO/UiNqIF2ZFgd7pDHc2IHO+OG8wBV94OefTMecd4dvVyTC/v3NA0Y8n8TLErWsgJao7bmnG1uP626eXUz1gkJgm7IfPEFLqKvwr22kP6V3xGUH41F6NjWH5DVD0jrn8irL4bkvoX+Y1Y/UCkns3aT498BYriqZlI+2iJdE2D15CLAUHWI8y3SKoDonKPqNgx30HEDWS6NIikJQ1E2iLMeDZW7E6YG3f4Cqzt4YTd8YzNwxH70yOqZoWsuodqOzRdz+8lMlWjrFuzLkn1BtWuEOeKRTN4QQyr3x7M4yzrFZr1gLbfoBv2SLjpw8SmP55hNHXfrUdvcvpirrfuw6pXPWSSm7Zn88DgiIjGy9vT+T9eAFOVVnjZrtKvAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"docker-build-cli.png\"\n        title=\"\"\n        src=\"/static/32eb77f9e39ce13b0a2824b76df8492c/99e71/docker-build-cli.png\"\n        srcset=\"/static/32eb77f9e39ce13b0a2824b76df8492c/b30f8/docker-build-cli.png 500w,\n/static/32eb77f9e39ce13b0a2824b76df8492c/332ff/docker-build-cli.png 1000w,\n/static/32eb77f9e39ce13b0a2824b76df8492c/99e71/docker-build-cli.png 2000w,\n/static/32eb77f9e39ce13b0a2824b76df8492c/c6eff/docker-build-cli.png 2074w\"\n        sizes=\"(max-width: 2000px) 100vw, 2000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 2000px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 3.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAPklEQVR42k3LMRJAAAwFUfc/qCL5ChLCmFiGxuu22EGayFg455E+Vj4Xf5lJVSEJM6O733Z3IuL5A3Ox7c0NSm5Nd21hDz4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"docker-desktop-result.png\"\n        title=\"\"\n        src=\"/static/adeb59617629efc07580f91f40f9abfe/99e71/docker-desktop-result.png\"\n        srcset=\"/static/adeb59617629efc07580f91f40f9abfe/b30f8/docker-desktop-result.png 500w,\n/static/adeb59617629efc07580f91f40f9abfe/332ff/docker-desktop-result.png 1000w,\n/static/adeb59617629efc07580f91f40f9abfe/99e71/docker-desktop-result.png 2000w,\n/static/adeb59617629efc07580f91f40f9abfe/ed510/docker-desktop-result.png 2128w\"\n        sizes=\"(max-width: 2000px) 100vw, 2000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h3 id=\"로컬-Docker에서도-완전히-같지는-않다\" style=\"position:relative;\">로컬 Docker에서도 완전히 같지는 않다<a href=\"#%EB%A1%9C%EC%BB%AC-Docker%EC%97%90%EC%84%9C%EB%8F%84-%EC%99%84%EC%A0%84%ED%9E%88-%EA%B0%99%EC%A7%80%EB%8A%94-%EC%95%8A%EB%8B%A4\" aria-label=\"로컬 Docker에서도 완전히 같지는 않다 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<p>PDF 결과물의 폰트 및 간격이 amd64로 빌드 했을 때 달라져 꽤 오랜시간 애를 먹었다. 원인은 docker build 할 때 platform을 설정했기 때문이었다.</p>\n<p><code class=\"language-text\">--platform linux/amd64</code> 같은 경우 EKS pod 환경이 linux/amd64 이기 때문에 플랫폼을 맞춰주기 위해서 넣은 것이다. 하지만, mac에서 amd64 플랫폼으로 동작하지만, PDF를 브라우저에 렌더링 했을 경우 폰트 및 간격이 실제 EKS에 배포했을 때와는 다르다. 이유는 Mac은 arm64 환경이기 때문이다.</p>\n<blockquote>\n<ul>\n<li><a href=\"https://www.docker.com/blog/faster-multi-platform-builds-dockerfile-cross-compilation-guide/\" target=\"_blank\" rel=\"nofollow\">멀티 플랫폼 빌드(크로스 컴파일 가이드) - Docker 공식 블로그</a></li>\n<li><a href=\"https://www.docker.com/blog/multi-arch-images/\" target=\"_blank\" rel=\"nofollow\">Docker Desktop을 사용하여 Arm 및 x86용 멀티 아키텍처 이미지 빌드하기 - Docker 공식 블로그</a></li>\n</ul>\n</blockquote>\n<p>따라서 <code class=\"language-text\">--platform</code> 옵션은 실제 ECR에 올릴 이미지를 생성할 때만 넣어주어야 한다.</p>\n<p>그래서 로컬 검증은 <strong>기능 동작 여부</strong> 중심으로 하고, 결과물의 픽셀 단위 동일성은 <strong>실제 아키텍처 amd64(Mac)에서 최종 확인</strong>하는 방식으로 했다.</p>\n<br/>\n<h2 id=\"Part-2-ECR-Base-이미지-작성-및-배포-프로세스\" style=\"position:relative;\">Part 2: ECR Base 이미지 작성 및 배포 프로세스<a href=\"#Part-2-ECR-Base-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EC%9E%91%EC%84%B1-%EB%B0%8F-%EB%B0%B0%ED%8F%AC-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4\" aria-label=\"Part 2 ECR Base 이미지 작성 및 배포 프로세스 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<p>로컬에서 Playwright 이미지에 Nextjs 빌드 결과물을 Docker Container로 띄웠다면, 이제 실제 EKS에 배포될 이미지의 기본값이 될 playwright base 이미지를 만들어야 한다.</p>\n<p>Playwright는 단순한 npm 패키지가 아니다.</p>\n<ul>\n<li>브라우저 바이너리</li>\n<li>OS 종속성</li>\n<li>폰트, locale, timezone</li>\n<li>Chromium 버전</li>\n</ul>\n<p>이 모든 것이 <strong>Base 이미지에 강하게 결합</strong>되어 있다. 즉, Base 이미지가 흔들리면 PDF 결과물도 같이 흔들린다. Playwright Base 이미지를 직접 만들고, ECR에 올리고, 그 버전만 사용하도록 한다.</p>\n<blockquote>\n<p>※ playwright 버전</p>\n<p>기존에 <a href=\"mailto:playwright@1.41.1\" target=\"_blank\" rel=\"nofollow\">playwright@1.41.1</a>을 사용하고 있었지만, 보안 취약점이 발견되어 최신 버전의 이미지(1.57.0)를 사용해야 했다. npm package에서 playwright 버전이 올라가면 playwright docker 이미지도 버전이 올라가야 한다. 만약 npm playwright 버전과 playwright 이미지의 버전이 맞지 않는다면 headless browser가 실행되지 않는다.</p>\n<p>따라서 FE에서 npm을 통해 playwright를 업데이트하면 당연히 base 이미지도 업데이트 해야 한다.</p>\n</blockquote>\n<p>위에서 봤듯, FE 배포 프로세스를 보면 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"mermaid\"><pre class=\"language-mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> LR\n\t\tA<span class=\"token text string\">[developer]</span> <span class=\"token arrow operator\">--></span><span class=\"token label property\">|FE commit push|</span> B\n    B<span class=\"token text string\">[GitHub]</span> <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">(Actions Runner)</span>\n    C <span class=\"token arrow operator\">--></span><span class=\"token label property\">|playwright base 이미지 요청|</span> D<span class=\"token text string\">[(ECR)]</span>\n    D <span class=\"token arrow operator\">--></span><span class=\"token label property\">|playwright base 이미지 응답|</span> C\n    C <span class=\"token arrow operator\">--></span><span class=\"token label property\">|base 이미지에 Next.js Artifact ㅊ추가|</span> F<span class=\"token text string\">[EKS]</span></code></pre></div>\n<p>배포때 GitHub Actions에서 ECR로 playwright base 이미지를 요청하게 된다. 저 base 이미지를 local PC해서 만들고 내부망으로 이동시켜 ECR에 푸시하도록 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"mermaid\"><pre class=\"language-mermaid\"><code class=\"language-mermaid\"><span class=\"token keyword\">graph</span> LR\n    A<span class=\"token text string\">[로컬 빌드]</span> <span class=\"token arrow operator\">--></span> B<span class=\"token text string\">(tar 압축)</span>\n    B <span class=\"token arrow operator\">--></span> C<span class=\"token text string\">[내부망 이동]</span>\n    C <span class=\"token arrow operator\">--></span> D<span class=\"token text string\">[(ECR 푸시)]</span></code></pre></div>\n<h3 id=\"Step-1-code-classlanguage-textdockerDockerfilebasecode-신규-생성\" style=\"position:relative;\">Step 1. <code class=\"language-text\">docker/Dockerfile.base</code> (신규 생성)<a href=\"#Step-1-code-classlanguage-textdockerDockerfilebasecode-%EC%8B%A0%EA%B7%9C-%EC%83%9D%EC%84%B1\" aria-label=\"Step 1 code classlanguage textdockerDockerfilebasecode 신규 생성 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<ol>\n<li><strong>Playwright 공식 이미지</strong>를 기반,</li>\n<li><strong>한국 시간대 / 한글 + 이모지 폰트 / HTTPS APT / 안정적인 apt-get 패턴 / 이미지 용량 정리</strong>를 설정하고</li>\n<li>마지막에 <strong>비루트 계정(pwuser)</strong> 로 내려서 브라우저와 Node를 구동하는, PDF/스크린샷 생성에 최적화된 베이스 이미지를 만든다.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># docker/Dockerfile.base</span>\n\n<span class=\"token comment\"># 골든 베이스: Playwright + 폰트/타임존</span>\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> mcr.microsoft.com/playwright:latest</span>\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> root</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> DEBIAN_FRONTEND=noninteractive</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> TZ=Asia/Seoul</span>\n<span class=\"token comment\"># ── 견고한 APT 패턴: HTTPS 미러, 인덱스 초기화, 재시도, 한 RUN에서 update→install→clean ──</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> set -eux; <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># 0) 미러 HTTPS로 고정(사내 미러 쓰면 여기서 sources.list 교체)</span>\n    sed -i <span class=\"token string\">'s|http://archive.ubuntu.com|https://archive.ubuntu.com|g'</span> /etc/apt/sources.list; <span class=\"token operator\">\\</span>\n    sed -i <span class=\"token string\">'s|http://security.ubuntu.com|https://security.ubuntu.com|g'</span> /etc/apt/sources.list; <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># 1) 인덱스 초기화 + 재시도 옵션</span>\n    rm -rf /var/lib/apt/lists/*; mkdir -p /var/lib/apt/lists/partial; <span class=\"token operator\">\\</span>\n    echo <span class=\"token string\">'Acquire::Retries \"5\";'</span> > /etc/apt/apt.conf.d/80-retries; <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># 2) 타임존 사전 지정(프롬프트 방지)</span>\n    ln -snf /usr/share/zoneinfo/<span class=\"token variable\">$TZ</span> /etc/localtime; echo <span class=\"token string\">\"$TZ\"</span> > /etc/timezone; <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># 3) 업데이트</span>\n    apt-get update -o Acquire::http::No-Cache=true -o Acquire::http::Pipeline-Depth=0; <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># 4) 필요한 패키지 일괄 설치(폰트 + tzdata + 인증서)</span>\n    apt-get install -y --no-install-recommends <span class=\"token operator\">\\</span>\n        fonts-noto-cjk <span class=\"token operator\">\\</span>\n        fonts-noto-color-emoji <span class=\"token operator\">\\</span>\n        tzdata <span class=\"token operator\">\\</span>\n        ca-certificates <span class=\"token operator\">\\</span>\n    ; <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># (환경에 따라) tzdata 재설정도 비대화식으로 강제</span>\n    dpkg-reconfigure -f noninteractive tzdata; <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># 5) 클린업</span>\n    rm -rf /var/lib/apt/lists/*</span>\n<span class=\"token comment\"># 권장: 기본 유저를 Playwright의 pwuser로</span>\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> pwuser</span></code></pre></div>\n<h4 id=\"세부-설명-2\" style=\"position:relative;\">세부 설명<a href=\"#%EC%84%B8%EB%B6%80-%EC%84%A4%EB%AA%85-2\" aria-label=\"세부 설명 2 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h4>\n<h3 id=\"code-classlanguage-textFROM-mcrmicrosoftcomplaywrightlatestcode\" style=\"position:relative;\"><code class=\"language-text\">FROM mcr.microsoft.com/playwright:latest</code><a href=\"#code-classlanguage-textFROM-mcrmicrosoftcomplaywrightlatestcode\" aria-label=\"code classlanguage textFROM mcrmicrosoftcomplaywrightlatestcode permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<ul>\n<li>브라우저 설치, OS 의존성, 디스플레이 관련 설정 등을 직접 신경쓰지 않아도 됨.</li>\n<li>Playwright가 기대하는 디렉토리 구조, 유저, 퍼미션이 맞춰져 있음.</li>\n<li>즉, Node + 브라우저까지 설치 되어 있는 OS</li>\n</ul>\n<h3 id=\"code-classlanguage-textENV-TZAsiaSeoulcode\" style=\"position:relative;\"><code class=\"language-text\">ENV TZ=Asia/Seoul</code><a href=\"#code-classlanguage-textENV-TZAsiaSeoulcode\" aria-label=\"code classlanguage textENV TZAsiaSeoulcode permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<ul>\n<li>컨테이너 기본 타임존을 한국 시간으로 맞춘다.</li>\n<li>PDF 생성 시각/로그 타임스탬프/서버 시간 해석이 로컬/서버에서 어긋나는 문제를 줄인다.</li>\n</ul>\n<h3 id=\"code-classlanguage-textapt-get-update-code\" style=\"position:relative;\"><code class=\"language-text\">apt-get update ...</code><a href=\"#code-classlanguage-textapt-get-update-code\" aria-label=\"code classlanguage textapt get update code permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<ul>\n<li><code class=\"language-text\">No-Cache</code>, <code class=\"language-text\">Pipeline-Depth=0</code> 같은 옵션으로 네트워크/프록시 환경에서 실패율을 낮추려는 설정.</li>\n</ul>\n<h3 id=\"code-classlanguage-textapt-get-install--y---no-install-recommends-code\" style=\"position:relative;\"><code class=\"language-text\">apt-get install -y --no-install-recommends ...</code><a href=\"#code-classlanguage-textapt-get-install--y---no-install-recommends-code\" aria-label=\"code classlanguage textapt get install  y   no install recommends code permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<ul>\n<li>필요한 것만 최소 설치.</li>\n<li>설치 항목 의미:\n<ul>\n<li><code class=\"language-text\">fonts-noto-cjk</code>: 한글(CJK) 폰트. PDF에서 한글 깨짐 방지</li>\n<li><code class=\"language-text\">fonts-noto-color-emoji</code>: 컬러 이모지 렌더링</li>\n<li><code class=\"language-text\">tzdata</code>: 타임존 데이터</li>\n<li><code class=\"language-text\">ca-certificates</code>: HTTPS 통신(내부/외부) 인증서 신뢰 기반</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"code-classlanguage-textdpkg-reconfigure--f-noninteractive-tzdatacode\" style=\"position:relative;\"><code class=\"language-text\">dpkg-reconfigure -f noninteractive tzdata</code><a href=\"#code-classlanguage-textdpkg-reconfigure--f-noninteractive-tzdatacode\" aria-label=\"code classlanguage textdpkg reconfigure  f noninteractive tzdatacode permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<ul>\n<li>tzdata 설치 후 재설정도 <strong>비대화식으로 강제</strong> 시킴.</li>\n<li>빌드 환경에 따라 타임존 적용이 안되는 것을 막음.</li>\n</ul>\n<h3 id=\"code-classlanguage-textrm--rf-varlibaptlistscode\" style=\"position:relative;\"><code class=\"language-text\">rm -rf /var/lib/apt/lists/*</code><a href=\"#code-classlanguage-textrm--rf-varlibaptlistscode\" aria-label=\"code classlanguage textrm  rf varlibaptlistscode permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<ul>\n<li>레이어 용량을 줄이기 위해 apt-get으로 설치한 라이브러리 리스트 제거.</li>\n<li>이미지 사이즈 감소 + 캐시 오염 방지 목적.</li>\n</ul>\n<h3 id=\"Step-2-Base-이미지-빌드-로컬\" style=\"position:relative;\">Step 2. Base 이미지 빌드 (로컬)<a href=\"#Step-2-Base-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%B9%8C%EB%93%9C-%EB%A1%9C%EC%BB%AC\" aria-label=\"Step 2 Base 이미지 빌드 로컬 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<p>package.json에 스크립트를 생성하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token property\">\"docker.build-base:amd64\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"docker build -f ./docker/Dockerfile.base -t [...].dkr.ecr.ap-northeast-2.amazonaws.com/common/playwright:latest-with-font --platform linux/amd64 .\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">build -f ./docker/Dockerfile.base</code> : <code class=\"language-text\">./docker/Dockerfile.base</code> 파일을 사용해 빌드</li>\n<li><code class=\"language-text\">-t [...].dkr.ecr.ap-northeast-2.amazonaws.com/common/playwright:latest-with-font</code> : ECR 리포지토리: <code class=\"language-text\">common/playwright</code> 주소 설정과 태그를 붙임</li>\n<li><code class=\"language-text\">--platform linux/amd64</code>: ECR은 linux/amd64이므로 플랫폼 강제 고정</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">pnpm</span> docker.build-base:amd64</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1804px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 4.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAL0lEQVR42lWJSQoAMAwC+//fZsWbIUKhFWQGPQDo7szMjxEhf/dbMxM33a1/WVUcMctNLzMJMMEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"docker-build-base-amd64.png\"\n        title=\"\"\n        src=\"/static/b7a465c545342b5133a3adba5f0c5021/e9bfc/docker-build-base-amd64.png\"\n        srcset=\"/static/b7a465c545342b5133a3adba5f0c5021/b30f8/docker-build-base-amd64.png 500w,\n/static/b7a465c545342b5133a3adba5f0c5021/332ff/docker-build-base-amd64.png 1000w,\n/static/b7a465c545342b5133a3adba5f0c5021/e9bfc/docker-build-base-amd64.png 1804w\"\n        sizes=\"(max-width: 1804px) 100vw, 1804px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h3 id=\"Step-3-Base-이미지를-tar-파일로-고정\" style=\"position:relative;\">Step 3. Base 이미지를 tar 파일로 고정<a href=\"#Step-3-Base-%EC%9D%B4%EB%AF%B8%EC%A7%80%EB%A5%BC-tar-%ED%8C%8C%EC%9D%BC%EB%A1%9C-%EA%B3%A0%EC%A0%95\" aria-label=\"Step 3 Base 이미지를 tar 파일로 고정 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<p>docker image를 내부 망으로 들이기위해 tar 파일로 저장한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">docker</span> save <span class=\"token punctuation\">[</span><span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">]</span>.dkr.ecr.ap-northeast-2.amazonaws.com/common/playwright:latest-with-font <span class=\"token parameter variable\">-o</span> playwright-base.tar</code></pre></div>\n<h3 id=\"Step-4-내부망으로-전송-및-ECR-push\" style=\"position:relative;\">Step 4. 내부망으로 전송 및 ECR push<a href=\"#Step-4-%EB%82%B4%EB%B6%80%EB%A7%9D%EC%9C%BC%EB%A1%9C-%EC%A0%84%EC%86%A1-%EB%B0%8F-ECR-push\" aria-label=\"Step 4 내부망으로 전송 및 ECR push permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<p>내부망으로 들일 때는 tar로 압축해서 보내면 리소스를 아낄 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">gzip</span> playwright-base.tar</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 198px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 139.3939393939394%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAYAAABh2p9gAAAACXBIWXMAABYlAAAWJQFJUiTwAAACyUlEQVR42q2V60/aYBTG+buXLEuWZR+WLPugkUYuCopzyRY1mvnFfUAWFy/RkcBwAbkoYROBXqAthbbPzjmzCU7cqFmTk5a276/P+5wLEcxweJ4H3/dneRUR/OdjKpDVBOG6LjRNg67rjwcOh0No+m9Ip9PBq9dvsKAswrKsxwEt2xZVqqoKNBpLIpFagUHX/X4/PNAe2jAMQ2ADAijxJSixBBxnKB/hZ6G3zEp4oWWaiBIwvpxG9eIClcoFGo0GwZ3ZgfzyYDAQqEPw5y9eIrG0DJs8bLfbuLm5kY+GApqkjIHj8RhPnj7D/IIi191ul6ITEjhyYFNiGMrw/dxnnJ19pXuWeNjr9cIBR6ORLAigrjume454augGVE0N5yFvjRcwlIOh7GngK2c/NJBV8lknRcViEaVSSUAmQVmpQ89DAbnlOLg7uEwal5eiVJI16MsH/wkMJgp7x8ZLUBKCruE25OCymWnLPKaCEJVj9872WfGk+tDja3LqPGp8cdGen5+jXC7j+vpaolarodVqyb1qtSpxenoqSQp6evKDkckbW1tbWF1dRTweRzQaxfb2NtLpNFKpFLLZrFwrioLNzU1sbGzg5OTknpd3FDabTcmqdduzV1dXkqBgZNXrdeTzeRHA9cleT91yoJCzF2yDzefgZ1x/nOlgggedxCX0JzQSZJeP/VwOsdgikskkMmtv6TqO9fV3KBQKtN0VzM3N4+j4GHt7n5DJZLCzs3OvHu8o5Bpjs0ulb2jUaPaVv6NerVA9dlGtlFEqFmTgHn45wO7uR7HE972/FPbt2XB81HouuqaPNtlnku8tw4dm+/hpuGiqVKs+ZilsX7A/1BF2830s5zS8O9RRbA7x4VjH2oGG90cGElnqHpML+/7/9VSFztgnVaTI8iT6tgfV9NAbuNDpd5fOUxIc/o9+loaJPLSQ17ID/gPxEPAXTKBqUyi5H/8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"base-image-gzip\"\n        title=\"\"\n        src=\"/static/fdc3afe38070999d9115b1f3568d7512/920f7/base-image-gzip.png\"\n        srcset=\"/static/fdc3afe38070999d9115b1f3568d7512/920f7/base-image-gzip.png 198w\"\n        sizes=\"(max-width: 198px) 100vw, 198px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h3 id=\"Step-5-내부망에서-ECR-푸시\" style=\"position:relative;\">Step 5. 내부망에서 ECR 푸시<a href=\"#Step-5-%EB%82%B4%EB%B6%80%EB%A7%9D%EC%97%90%EC%84%9C-ECR-%ED%91%B8%EC%8B%9C\" aria-label=\"Step 5 내부망에서 ECR 푸시 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ gunzip playwright-base.tar.gz</code></pre></div>\n<p>압축을 푼다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">docker</span> load <span class=\"token parameter variable\">-i</span> playwright-base.tar\n$ <span class=\"token function\">docker</span> images <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> playwright</code></pre></div>\n<p>docker image를 내부망 컴퓨터에 로드시킨 후, docker images 명령어로 이미지가 제대로 로드 되었는지 확인한다.</p>\n<p>그다음 PC에서 aws cli로 ECR에 로그인 후, push 하면 된다.</p>\n<h3 id=\"결과-확인\" style=\"position:relative;\">결과 확인<a href=\"#%EA%B2%B0%EA%B3%BC-%ED%99%95%EC%9D%B8\" aria-label=\"결과 확인 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<p>이제 FE에서 playwright 버전(1.57.0)을 업데이트하고 commit 후 push해서 GitHub Actions가 돌게 한 후, 배포를 기다려보자. 완료 이후 PDF를 출력해보니 문제가 생겼다.</p>\n<p>Next.js node runtime의 playwright 버전은 1.57.0 버전이지만, 이미지 버전은 여전히 1.46.1 버전이라는 에러 문구다.</p>\n<p>어떻게 된건지 GitHub Actions의 Dockerfile을 보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span>  [...].dkr.ecr.ap-northeast-2.amazonaws.com/common/playwright:latest-with-font <span class=\"token keyword\">AS</span> base</span>\n\n<span class=\"token comment\"># ...</span></code></pre></div>\n<p>ECR에 push 했을 때 분명 새로운 이미지로 교체 되었는데 여전히 새로운 이미지로 빌드되지 않았다. 문제는 <strong>태그</strong>였는데, 새로운 이미지의 태그도 <code class=\"language-text\">latest-with-font</code> 였고, <code class=\"language-text\">docker build --pull</code> 명령어가 아닌 <code class=\"language-text\">docker build</code>로만 실행되었기 때문에 기존에 있는 base 이미지로만 사용했기 때문에 문제가 되었다. 같은 태그를 쓰면 Docker는 로컬에 캐시된 이미지를 우선 사용해서, ECR에 새 이미지를 올려도 빌드가 그대로 지난 이미지가 사용된다.</p>\n<h3 id=\"태그를-timestamp-기반으로\" style=\"position:relative;\">태그를 timestamp 기반으로<a href=\"#%ED%83%9C%EA%B7%B8%EB%A5%BC-timestamp-%EA%B8%B0%EB%B0%98%EC%9C%BC%EB%A1%9C\" aria-label=\"태그를 timestamp 기반으로 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<p>새로운 이미지는 새로운 태그로 대체하기로 했다. <code class=\"language-text\">docker build --pull</code> 옵션을 주면 docker 이미지 digest가 변경되었다면 새로 pull 받아 이미지를 생성한다. 하지만, 사람이 알아보는 것은 쉽지 않다. 따라서 현재 빌드 시점을 태깅해서 ECR로 push 하고, 빌드 시 해당 태그의 이미지를 사용하도록 한다.</p>\n<p>이렇게 하면 Docker cache가 무력화되고 FROM 단계에서 반드시 새 이미지를 사용하게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># scripts/build-and-update-base.sh</span>\n\n<span class=\"token comment\">#!/bin/bash</span>\n<span class=\"token builtin class-name\">set</span> <span class=\"token parameter variable\">-e</span>\n\n<span class=\"token comment\"># Timestamp 생성</span>\n<span class=\"token assign-left variable\">TIMESTAMP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> +%Y%m%d-%H%M%S<span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">VERSION_TAG</span><span class=\"token operator\">=</span><span class=\"token string\">\"v<span class=\"token variable\">${TIMESTAMP}</span>\"</span>\n\n<span class=\"token comment\"># ECR 정보</span>\n<span class=\"token assign-left variable\">ECR_REGISTRY</span><span class=\"token operator\">=</span><span class=\"token string\">\"[...].dkr.ecr.ap-northeast-2.amazonaws.com\"</span>\n<span class=\"token assign-left variable\">IMAGE_NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"common/playwright\"</span>\n<span class=\"token assign-left variable\">FULL_IMAGE</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${ECR_REGISTRY}</span>/<span class=\"token variable\">${IMAGE_NAME}</span>:<span class=\"token variable\">${VERSION_TAG}</span>\"</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🚀 Docker base 이미지 빌드 중...\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Version: <span class=\"token variable\">${VERSION_TAG}</span>\"</span><span class=\"token punctuation\">\\</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span>\n\n<span class=\"token comment\"># Docker 빌드</span>\n<span class=\"token function\">docker</span> build <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-f</span> ./docker/Dockerfile.base <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-t</span> <span class=\"token string\">\"<span class=\"token variable\">${FULL_IMAGE}</span>\"</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--platform</span> linux/amd64 <span class=\"token punctuation\">\\</span>\n  --no-cache <span class=\"token punctuation\">\\</span>\n  <span class=\"token builtin class-name\">.</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"✅ Docker 이미지 빌드 완료: <span class=\"token variable\">${FULL_IMAGE}</span>\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span></code></pre></div>\n<p>자동화 스크립트를 작성하고 package.json에서 명령어에 이 sh 파일을 실행시킨다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"docker.build-base:amd64\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sh ./scripts/build-and-update-base.sh\"</span></code></pre></div>\n<p>하지만, GitHub Actions에서 도는 Dockerfile은 하드코딩으로 태그 값이 박혀있다. 조금 위험할 수도 있지만 이것도 자동화 해보자. Dockerfile FROM절에 방금 만든 timestamp로 태그 명을 대체하고 자동 commit을 생성하는 방법이다. 쉘 스크립트에 이어서 추가한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># scripts/build-and-update-base.sh 이어서</span>\n\n<span class=\"token comment\"># ...</span>\n\n<span class=\"token comment\"># Dockerfile 업데이트</span>\n<span class=\"token assign-left variable\">DOCKERFILE_PATH</span><span class=\"token operator\">=</span><span class=\"token string\">\"./docker/Dockerfile\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"📝 <span class=\"token variable\">${DOCKERFILE_PATH}</span> 태그 업데이트 중...\"</span>\n\n<span class=\"token comment\"># FROM 절 업데이트 (sed를 사용하여 기존 태그를 새 버전으로 변경)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token environment constant\">$OSTYPE</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"darwin\"</span>* <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token comment\"># macOS</span>\n  <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">''</span> <span class=\"token string\">\"s|FROM  <span class=\"token variable\">${ECR_REGISTRY}</span>/<span class=\"token variable\">${IMAGE_NAME}</span>:.*AS base|FROM  <span class=\"token variable\">${ECR_REGISTRY}</span>/<span class=\"token variable\">${IMAGE_NAME}</span>:<span class=\"token variable\">${VERSION_TAG}</span> AS base|g\"</span> <span class=\"token string\">\"<span class=\"token variable\">${DOCKERFILE_PATH}</span>\"</span>\n<span class=\"token keyword\">else</span>\n  <span class=\"token comment\"># Linux</span>\n  <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s|FROM  <span class=\"token variable\">${ECR_REGISTRY}</span>/<span class=\"token variable\">${IMAGE_NAME}</span>:.*AS base|FROM  <span class=\"token variable\">${ECR_REGISTRY}</span>/<span class=\"token variable\">${IMAGE_NAME}</span>:<span class=\"token variable\">${VERSION_TAG}</span> AS base|g\"</span> <span class=\"token string\">\"<span class=\"token variable\">${DOCKERFILE_PATH}</span>\"</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"✅ Dockerfile 업데이트 완료 (버전: <span class=\"token variable\">${VERSION_TAG}</span>)\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span>\n\n<span class=\"token comment\"># Git commit</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"📦 변경사항 커밋 중...\"</span>\n<span class=\"token function\">git</span> <span class=\"token function\">add</span> <span class=\"token string\">\"<span class=\"token variable\">${DOCKERFILE_PATH}</span>\"</span>\n<span class=\"token function\">git</span> commit <span class=\"token parameter variable\">-m</span> <span class=\"token string\">\"chore: bump version docker golden image <span class=\"token variable\">${VERSION_TAG}</span>\"</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🎉 완료!\"</span></code></pre></div>\n<p>이렇게 해주면 <code class=\"language-text\">pnpm docker.build-base:amd64</code> 한 줄로</p>\n<ul>\n<li>playwright 최신 버전 이미지 pull</li>\n<li>Dockerfile.base에서 font, tz 등 작업</li>\n<li>이미지 생성(태그 timestamp)</li>\n<li>ECR에서 pull 받아 작업할 Dockerfile FROM절에 timestamp 태깅</li>\n<li>Dockerfile commit</li>\n</ul>\n<p>자동화가 완성되었다.</p>\n<h3 id=\"playwright-버전-자동화\" style=\"position:relative;\">playwright 버전 자동화<a href=\"#playwright-%EB%B2%84%EC%A0%84-%EC%9E%90%EB%8F%99%ED%99%94\" aria-label=\"playwright 버전 자동화 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<p>다시 돌아가보자. playwright가 1.47.1 버전이 취약함에 따라 버전 업데이트가 필요했고, 베이스 이미지도 업데이트가 필요했으므로 일일이 버전 업데이트를 진행해주어야 한다. 일일이 변경해주기보다, package.json에 playwright를 업데이트하면 그 버전 값을 보고 그 버전에 해당하는 playwright docker 이미지를 base로 하도록 하자.</p>\n<p>Dockerfile에서 ARG 를 이용해 외부에서 값을 받아올 수 있도록 하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># Dockerfile.base</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> PLAYWRIGHT_VERSION</span>\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> mcr.microsoft.com/playwright:v<span class=\"token variable\">${PLAYWRIGHT_VERSION}</span>-jammy</span>\n\n<span class=\"token comment\"># ...</span></code></pre></div>\n<p>그리고 local docker image 빌드, ECR에 배포할 이미지 빌드시 <code class=\"language-text\">--build-arg</code> 에 playwright 버전 값을 넣어주도록 하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"local-docker.build-base\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"docker build -f ./docker/Dockerfile.base -t application-base:local --build-arg PLAYWRIGHT_VERSION=$(node -p \\\"require('./package.json').dependencies.playwright\\\") .\"</span></code></pre></div>\n<p><code class=\"language-text\">$ node -p \"require('./package.json').dependencies.playwright\"</code> 로 package.json을 참조하도록 한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1052px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.3999999999999995%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAS0lEQVR42h3KSRKAIAwFUQ8jmhCgHHBMIQfw/uf5Rha96XpdzhWqL+K0wfECjgUkJ3qawUEhqYLC1XK8wqdiPeYUoxxm7ub+P/gdH+IIH0R8sEDLAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"node-p-reference\"\n        title=\"\"\n        src=\"/static/b0b165a161a14e1b5523aa078967f04d/8f870/node-p-reference.png\"\n        srcset=\"/static/b0b165a161a14e1b5523aa078967f04d/b30f8/node-p-reference.png 500w,\n/static/b0b165a161a14e1b5523aa078967f04d/332ff/node-p-reference.png 1000w,\n/static/b0b165a161a14e1b5523aa078967f04d/8f870/node-p-reference.png 1052w\"\n        sizes=\"(max-width: 1052px) 100vw, 1052px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>이제 FE에서 npm playwright 패키지만 업데이트 하면 base 이미지는 자동으로 해당 버전에 맞는 이미지를 가져오도록 설정 되었다.</p>\n<h3 id=\"local-docker-image와-ECR에-배포할-base를-한-파일로\" style=\"position:relative;\">local docker image와 ECR에 배포할 base를 한 파일로<a href=\"#local-docker-image%EC%99%80-ECR%EC%97%90-%EB%B0%B0%ED%8F%AC%ED%95%A0-base%EB%A5%BC-%ED%95%9C-%ED%8C%8C%EC%9D%BC%EB%A1%9C\" aria-label=\"local docker image와 ECR에 배포할 base를 한 파일로 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h3>\n<p>현재 local에서 테스트용 docker image, ECR에 배포할 base 이미지를 만드는 Dockerfile은 다르지만 내용은 동일하게 맞춰주어야 local에서 테스트하는 의미가 있다.</p>\n<p>따라서, 아래와 같이 base 용 이미지 생성 Dockerfile과 어플리케이션 전용 Dockerfile만 나누어 진행하도록 하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">docker/\n  ├── Dockerfile.base    # 공통 Base 이미지 - 로컬/프로덕션 모두 사용\n  ├── Dockerfile.local   # 로컬 테스트용 애플리케이션\n  └── Dockerfile         # 프로덕션용 애플리케이션</code></pre></div>\n<p>최종 Dockerfile이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># Dockerfile.base</span>\n\n<span class=\"token comment\"># ============================================</span>\n<span class=\"token comment\"># 골든 베이스: Playwright + 폰트/타임존</span>\n<span class=\"token comment\"># ============================================</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> PLAYWRIGHT_VERSION</span>\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> mcr.microsoft.com/playwright:v<span class=\"token variable\">${PLAYWRIGHT_VERSION}</span>-jammy</span>\n\n<span class=\"token comment\"># FROM 이후 ARG 재선언 (scope 유지)</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> PLAYWRIGHT_VERSION</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> root</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> DEBIAN_FRONTEND=noninteractive</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> TZ=Asia/Seoul</span>\n\n<span class=\"token comment\"># ARG 검증: PLAYWRIGHT_VERSION이 비어있으면 빌드 실패</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> test -n <span class=\"token string\">\"${PLAYWRIGHT_VERSION}\"</span> || (echo <span class=\"token string\">\"ERROR: PLAYWRIGHT_VERSION is required\"</span> &amp;&amp; exit 1)</span>\n\n<span class=\"token comment\"># 견고한 APT 패턴: HTTPS 미러, 인덱스 초기화, 재시도, 한 RUN에서 update→install→clean</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> set -eux; <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># 0) 미러 HTTPS로 고정</span>\n    sed -i <span class=\"token string\">'s|http://archive.ubuntu.com|https://archive.ubuntu.com|g'</span> /etc/apt/sources.list; <span class=\"token operator\">\\</span>\n    sed -i <span class=\"token string\">'s|http://security.ubuntu.com|https://security.ubuntu.com|g'</span> /etc/apt/sources.list; <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># 1) 인덱스 초기화 + 재시도 옵션</span>\n    rm -rf /var/lib/apt/lists/*; mkdir -p /var/lib/apt/lists/partial; <span class=\"token operator\">\\</span>\n    echo <span class=\"token string\">'Acquire::Retries \"5\";'</span> > /etc/apt/apt.conf.d/80-retries; <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># 2) 타임존 사전 지정(프롬프트 방지)</span>\n    ln -snf /usr/share/zoneinfo/<span class=\"token variable\">$TZ</span> /etc/localtime; echo <span class=\"token string\">\"$TZ\"</span> > /etc/timezone; <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># 3) 업데이트</span>\n    apt-get update -o Acquire::http::No-Cache=true -o Acquire::http::Pipeline-Depth=0; <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># 4) 필요한 패키지 일괄 설치(폰트 + tzdata + 인증서)</span>\n    apt-get install -y --no-install-recommends <span class=\"token operator\">\\</span>\n        fonts-noto-cjk <span class=\"token operator\">\\</span>\n        fonts-noto-color-emoji <span class=\"token operator\">\\</span>\n        tzdata <span class=\"token operator\">\\</span>\n        ca-certificates <span class=\"token operator\">\\</span>\n    ; <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># 5) tzdata 재설정도 비대화식으로 강제</span>\n    dpkg-reconfigure -f noninteractive tzdata; <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># 6) 클린업</span>\n    rm -rf /var/lib/apt/lists/*</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> pwuser</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># Dockerfile.local</span>\n\n<span class=\"token comment\"># ============================================</span>\n<span class=\"token comment\"># Application (Base 이미지 참조)</span>\n<span class=\"token comment\"># ============================================</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> BASE_IMAGE</span>\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> <span class=\"token variable\">${BASE_IMAGE}</span></span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 3000</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> PORT=3000</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> HOST=0.0.0.0</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> public ./public</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> .next/standalone ./</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> .next/static ./.next/static</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> root</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> mkdir -p .next/cache &amp;&amp; chown -R pwuser:pwuser .next</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> pwuser</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENTRYPOINT</span> [<span class=\"token string\">\"node\"</span>, <span class=\"token string\">\"server.js\"</span>]</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># Dockerfile</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span>  [...].dkr.ecr.ap-northeast-2.amazonaws.com/common/playwright:v20205... <span class=\"token keyword\">AS</span> base</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 3000</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> PORT 3000</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> HOST 0.0.0.0</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> public ./public</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> .next/standalone ./</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> .next/static ./.next/static</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> root</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> mkdir -p .next/cache &amp;&amp; chown -R pwuser:pwuser .next</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> pwuser</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENTRYPOINT</span> [<span class=\"token string\">\"node\"</span>, <span class=\"token string\">\"server.js\"</span>]</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token comment\">// package.json</span>\n\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"local-docker.build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"env-cmd -f .env.local-docker next build\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"local-docker.build-base\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"docker build -f ./docker/Dockerfile.base -t application-base:local --build-arg PLAYWRIGHT_VERSION=$(node -p \\\"require('./package.json').dependencies.playwright\\\") .\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"local-docker.start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"pnpm local-docker.build-base &amp;&amp; pnpm local-docker.build &amp;&amp; docker build -f ./docker/Dockerfile.local -t application-local:local --build-arg BASE_IMAGE=application-base:local . &amp;&amp; docker run --rm -p 3000:3000 application-local:local\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"docker.build-base:amd64\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sh ./scripts/build-and-update-base.sh\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># scripts/build-and-update-base.sh</span>\n\n<span class=\"token comment\">#!/bin/bash</span>\n<span class=\"token builtin class-name\">set</span> <span class=\"token parameter variable\">-e</span>\n\n<span class=\"token comment\"># Timestamp 생성</span>\n<span class=\"token assign-left variable\">TIMESTAMP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> +%Y%m%d-%H%M%S<span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">VERSION_TAG</span><span class=\"token operator\">=</span><span class=\"token string\">\"v<span class=\"token variable\">${TIMESTAMP}</span>\"</span>\n\n<span class=\"token comment\"># ECR 정보</span>\n<span class=\"token assign-left variable\">ECR_REGISTRY</span><span class=\"token operator\">=</span><span class=\"token string\">\"[...].dkr.ecr.ap-northeast-2.amazonaws.com\"</span>\n<span class=\"token assign-left variable\">IMAGE_NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"common/playwright\"</span>\n<span class=\"token assign-left variable\">FULL_IMAGE</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${ECR_REGISTRY}</span>/<span class=\"token variable\">${IMAGE_NAME}</span>:<span class=\"token variable\">${VERSION_TAG}</span>\"</span>\n\n<span class=\"token comment\"># Playwright 버전 가져오기</span>\n<span class=\"token assign-left variable\">PLAYWRIGHT_VERSION</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">node</span> <span class=\"token parameter variable\">-p</span> <span class=\"token string\">\"require('./package.json').dependencies.playwright\"</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🚀 Docker base 이미지 빌드 중...\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Version: <span class=\"token variable\">${VERSION_TAG}</span>\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"   Playwright: <span class=\"token variable\">${PLAYWRIGHT_VERSION}</span>\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span>\n\n<span class=\"token comment\"># Docker 빌드</span>\n<span class=\"token function\">docker</span> build <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-f</span> ./docker/Dockerfile.base <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">-t</span> <span class=\"token string\">\"<span class=\"token variable\">${FULL_IMAGE}</span>\"</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token parameter variable\">--platform</span> linux/amd64 <span class=\"token punctuation\">\\</span>\n  --build-arg <span class=\"token assign-left variable\">PLAYWRIGHT_VERSION</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${PLAYWRIGHT_VERSION}</span>\"</span> <span class=\"token punctuation\">\\</span>\n  --no-cache <span class=\"token punctuation\">\\</span>\n  <span class=\"token builtin class-name\">.</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"✅ Docker 이미지 빌드 완료: <span class=\"token variable\">${FULL_IMAGE}</span>\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span>\n\n<span class=\"token comment\"># Dockerfile 업데이트</span>\n<span class=\"token assign-left variable\">DOCKERFILE_PATH</span><span class=\"token operator\">=</span><span class=\"token string\">\"./docker/Dockerfile\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"📝 <span class=\"token variable\">${DOCKERFILE_PATH}</span> 태그 업데이트 중...\"</span>\n\n<span class=\"token comment\"># FROM 절 업데이트 (sed를 사용하여 기존 태그를 새 버전으로 변경)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token environment constant\">$OSTYPE</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"darwin\"</span>* <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token comment\"># macOS</span>\n  <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">''</span> <span class=\"token string\">\"s|FROM  <span class=\"token variable\">${ECR_REGISTRY}</span>/<span class=\"token variable\">${IMAGE_NAME}</span>:.*AS base|FROM  <span class=\"token variable\">${ECR_REGISTRY}</span>/<span class=\"token variable\">${IMAGE_NAME}</span>:<span class=\"token variable\">${VERSION_TAG}</span> AS base|g\"</span> <span class=\"token string\">\"<span class=\"token variable\">${DOCKERFILE_PATH}</span>\"</span>\n<span class=\"token keyword\">else</span>\n  <span class=\"token comment\"># Linux</span>\n  <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s|FROM  <span class=\"token variable\">${ECR_REGISTRY}</span>/<span class=\"token variable\">${IMAGE_NAME}</span>:.*AS base|FROM  <span class=\"token variable\">${ECR_REGISTRY}</span>/<span class=\"token variable\">${IMAGE_NAME}</span>:<span class=\"token variable\">${VERSION_TAG}</span> AS base|g\"</span> <span class=\"token string\">\"<span class=\"token variable\">${DOCKERFILE_PATH}</span>\"</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"✅ Dockerfile 업데이트 완료 (버전: <span class=\"token variable\">${VERSION_TAG}</span>)\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span>\n\n<span class=\"token comment\"># Git commit</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"📦 변경사항 커밋 중...\"</span>\n<span class=\"token function\">git</span> <span class=\"token function\">add</span> <span class=\"token string\">\"<span class=\"token variable\">${DOCKERFILE_PATH}</span>\"</span>\n<span class=\"token function\">git</span> commit <span class=\"token parameter variable\">-m</span> <span class=\"token string\">\"chore: bump version docker golden image <span class=\"token variable\">${VERSION_TAG}</span>\"</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🎉 완료!\"</span></code></pre></div>\n<h2 id=\"마치며\" style=\"position:relative;\">마치며<a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\" aria-label=\"마치며 permalink\" class=\"auto-link after\"><svg viewBox=\"0 0 16 16\" width=\"16\" height=\"16\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a></h2>\n<p>환경 통제에 관련한 부분은 쉽지 않은 것 같다. 환경이 서로 다르기 때문에 개발 결과물과 배포 시 결과물이 서로 다를 때는 어떤 부분을 어떻게 접근해야하는지 때로는 감이 오지 않는 경우가 많다. 이번 기회에 docker로 local에서 배포 환경과 최대한 비슷하게 환경을 맞추고 어떤 부분에서 문제가 생겼는지 디버깅 하면서 인프라에 대한 지식을 조금이나마 얻을 수 있었던 것 같다.</p>\n<p>덤으로, 이 구조의 단점은 이미지가 크다는 점이다. local에서 확인하기 위해 만들어지는 이미지는 총 2개로, playwright base 이미지와 base 이미지에 Next.js 빌드 결과물을 COPY 한 이미지(application 이미지) 총 2가지인데, 각각 3.5GB, 3.79GB이다. 그리고 ECR에 push할 이미지는 802MB다. 이는 playwright의 이미지 자체가 alpine처럼 최소화 한 이미지가 아닌, ubuntu 기반의 이미지라서인데 <a href=\"https://playwright.dev/docs/docker#build-your-own-image\" target=\"_blank\" rel=\"nofollow\">playwright 공식 문서에서 Docker 커스텀 이미지 생성 방법</a>도 제안하고 있다. 단, Node.js, Playwight 브라우저 바이너리, OS 종속성을 직접 설치하는 방법이다. 이 방법을 통해 추후에 이미지 용량을 최적화해볼 수 있을 것 같다.</p>\n<p>그리고 작업을 하면서 Next.js가 동작할 Application 이미지에 굳이 playwright 용 이미지 위에 올릴 필요는 없겠다는 생각도 들었다. 지금이야 하나의 어플리케이션이 pod에 배포되는 구조이지만, PDF 렌더링만 담당하는 Node.js 서버를 따로 만들고 해당 서버에서 Next.js 페이지를 참조할 통로를 열고 Next.js -> Playwright PDF 렌더링 서버 -> Nest.js 리턴 하는 방법을 사용하면 서로를 격리시키면서 단일 책임만 가져가게끔 작업하면 좋겠다는 생각도 했다.</p>\n<p>그리고 build-and-update-base.sh에서 이미지 버전을 자동으로 commit을 남겨주는 방법을 사용한건 GitHub Actions를 최대한 건들이고 싶지 않았는데, 충분히 다른 방법을 통해 개선할 수 있을 것 같다. 예를 들면, GitHub Actions에서 BASE_IMAGE_TAG를 입력값/환경변수로 받아 Dockerfile을 건드리지 않고 빌드하도록 만드는 방법이 있을 것 같다.</p>","htmlAst":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"PDF를 유저에게 보여줘야 하는 일이 생겼다. PDF 생성은 전통적인 방법으로 SpringBoot의 라이브러리(OpenHTMLtoPDF등)를 사용해 서버에서 생성하는 방법이 있다. 하지만, 유저에게 보여주어야 할 PDF가 단순히 문자열로만 구성된 것이 아니라 복잡한 layout과 다양한 CSS 기법이 적용되어야 했다. 또한, 유저에 따라 동적인 layout이 적용되어야 했다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"SpringBoot의 PDF 라이브러리는 text만 표시하지 않고 HTML을 렌더링해서 PDF 형식으로 만들어내는 방법도 존재했지만, CSS 지원이 제한적이라 미묘한 깨짐이 발생할 수 있다. 그리고 복잡한 layout의 PDF는 FE쪽 리소스를 투입하는게 낫다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"FE에서 PDF를 생성할 수 있는 라이브러리로, "},{"type":"element","tagName":"a","properties":{"href":"https://pptr.dev/","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"Puppeteer"}]},{"type":"text","value":", "},{"type":"element","tagName":"a","properties":{"href":"https://playwright.dev/","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"Playwright"}]},{"type":"text","value":"와 같은 Headless Browser를 이용해 렌더링 하는 방법이 떠올랐다. Playwright를 선택한 이유는 앞으로 Playwright로 E2E Testing을 할 계획을 가지고 있기도 했고, Playwright를 이전 Puppeteer 개발자 주도해 만들었기 때문이다(사실 아주 거창한 이유는 없다)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Nextjs를 사용하고 있기 때문에 Node 영역에서 Playwright의 Headless Browser를 구동시켜 페이지를 렌더링 시키고, 그 페이지를 PDF로 만들어내면 되겠다. 자세한 기법은 추후 블로깅 할 생각."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이번 글은 개발을 끝낸 뒤, 이걸 어떻게 배포 환경까지 안정적으로 가져갔는지에 대한 기록이다. 특히 ‘로컬에서는 되는데 배포에서는 깨지는’ 문제를 피하기 위해 실행 환경을 통제하고, 재현 가능한 형태로 굳혀간 과정을 정리한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"얻어갈-수-있는-것","style":"position:relative;"},"children":[{"type":"text","value":"얻어갈 수 있는 것"},{"type":"element","tagName":"a","properties":{"href":"#%EC%96%BB%EC%96%B4%EA%B0%88-%EC%88%98-%EC%9E%88%EB%8A%94-%EA%B2%83","ariaLabel":"얻어갈 수 있는 것 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Playwright 실행 환경(브라우저/OS 의존성/폰트)을 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Base 이미지로 고정"}]},{"type":"text","value":"하는 방법"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"로컬에서 배포 환경과 유사하게 재현하는 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"로컬 Docker 테스트 패턴"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Playwright npm 버전 변화에 맞춰 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Base 이미지 버전과 Dockerfile FROM을 자동 갱신"}]},{"type":"text","value":"하는 방법"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Docker build cache / tag 문제를 피하는 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"timestamp 태깅 전략"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"이미지 이동/적재(docker save/load + gzip)로 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"외부 다운로드 의존성 제거"}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"전제","style":"position:relative;"},"children":[{"type":"text","value":"전제"},{"type":"element","tagName":"a","properties":{"href":"#%EC%A0%84%EC%A0%9C","ariaLabel":"전제 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이 글은 Next.js 기반 애플리케이션의 복잡한 PDF 생성 모듈을 Playwright를 사용하여 Docker/Kubernetes(EKS) 환경에 배포하는 과정을 다룬다. 아래 기술들에 대한 간단한 이해가 있다면 내용을 더 쉽게 파악할 수 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Next.js (Page Router / Standalone)"}]},{"type":"text","value":": next build 이후 standalone 아티팩트가 어떤 식으로 서버를 구성하는지"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Playwright"}]},{"type":"text","value":": Headless Browser(Chromium)를 제어해서 페이지를 렌더링하고 PDF를 생성한다는 개념"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Docker"}]},{"type":"text","value":": Dockerfile, 이미지/컨테이너, FROM/ARG/ENV/USER 같은 기본 문법과 컨테이너 네트워크"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"ECR/EKS"}]},{"type":"text","value":": 이미지 push/pull, 그리고 그 이미지를 기반으로 Pod가 뜬다는 흐름"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"CI/CD"}]},{"type":"text","value":": GitHub Actions로 빌드→이미지 생성→레지스트리 push→배포까지 이어지는 전체 흐름"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"기본 쉘 명령"}]},{"type":"text","value":": apt-get, sed, gzip, docker save/load 같은 명령의 역할"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"환경","style":"position:relative;"},"children":[{"type":"text","value":"환경"},{"type":"element","tagName":"a","properties":{"href":"#%ED%99%98%EA%B2%BD","ariaLabel":"환경 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"FE","style":"position:relative;"},"children":[{"type":"text","value":"FE"},{"type":"element","tagName":"a","properties":{"href":"#FE","ariaLabel":"FE permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Next.js (Page Router)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Playwright"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"Deployment","style":"position:relative;"},"children":[{"type":"text","value":"Deployment"},{"type":"element","tagName":"a","properties":{"href":"#Deployment","ariaLabel":"Deployment permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://nextjs.org/docs/app/api-reference/config/next-config-js/output#automatically-copying-traced-files","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"Nextjs Standalone"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"GitHub Actions"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Docker / ECR(Amazon Elastic Container Registry)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"EKS(Amazon Elastic Kubernetes Service)"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"아래는 현재 CI/CD 배포 파이프라인이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"mermaid"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-mermaid"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-mermaid"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"sequenceDiagram"}]},{"type":"text","value":"\n    actor Developer\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"participant"}]},{"type":"text","value":" GitHub\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"participant"}]},{"type":"text","value":" Actions Runner\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"participant"}]},{"type":"text","value":" ECR\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"participant"}]},{"type":"text","value":" EKS\n\n    Developer "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":" GitHub"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" FE commit "},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(Push)"}]},{"type":"text","value":"\n    GitHub "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->>"}]},{"type":"text","value":" Actions Runner"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Workflow Trigger\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"activate"}]},{"type":"text","value":" Actions Runner\n\n    Actions Runner "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":" Actions Runner"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" nextjs build "},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(Standalone Artifacts 생성)"}]},{"type":"text","value":"\n    Actions Runner "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":" Actions Runner"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Docker build 시작 "},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(Dockerfile 실행)"}]},{"type":"text","value":"\n\n    Actions Runner "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":" ECR"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Base Image Pull "},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(FROM)"}]},{"type":"text","value":"\n    ECR "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->>"}]},{"type":"text","value":" Actions Runner"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Base Image 제공\n\n    Actions Runner "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":" Actions Runner"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Nextjs Artifacts Copy "},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(COPY)"}]},{"type":"text","value":"\n    Actions Runner "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":" Actions Runner"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 새로운 Docker Image 생성 완료\n    Actions Runner "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":" ECR"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Docker Image Push\n    ECR "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->>"}]},{"type":"text","value":" Actions Runner"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Image Push Success\n\n    Actions Runner "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":" EKS"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 배포 요청\n    EKS "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->>"}]},{"type":"text","value":" EKS"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 새로운 Image로 Deployment/Pod 업데이트\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"deactivate"}]},{"type":"text","value":" Actions Runner"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"PDF가-유저에게-도달하는-흐름-요약","style":"position:relative;"},"children":[{"type":"text","value":"PDF가 유저에게 도달하는 흐름 (요약)"},{"type":"element","tagName":"a","properties":{"href":"#PDF%EA%B0%80-%EC%9C%A0%EC%A0%80%EC%97%90%EA%B2%8C-%EB%8F%84%EB%8B%AC%ED%95%98%EB%8A%94-%ED%9D%90%EB%A6%84-%EC%9A%94%EC%95%BD","ariaLabel":"PDF가 유저에게 도달하는 흐름 요약 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"mermaid"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-mermaid"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-mermaid"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"sequenceDiagram"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"autonumber"}]},{"type":"text","value":"\n    actor 사용자\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"participant"}]},{"type":"text","value":" Page as PDF렌더링 페이지<br/>"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(PdfViewer)"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"participant"}]},{"type":"text","value":" API as API Routes\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"participant"}]},{"type":"text","value":" Headless as Playwright<br/>"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(Headless Chrome)"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"participant"}]},{"type":"text","value":" Backend as 백엔드 API<br/>"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(SpringBoot)"}]},{"type":"text","value":"\n\n    사용자"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":"Page"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" /pdf/something 접속\n    Page"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":"API"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" PDF 요청\n    API"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":"Headless"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 헤드리스 브라우저 오픈\n    Headless"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":"Backend"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" SSR PDF 데이터 API 호출\n    Backend"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->>"}]},{"type":"text","value":"Headless"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 데이터 응답\n    Headless"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":"Headless"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 1. SSR 페이지 오픈<br/>2. PDF Buffer 생성\n    Headless"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->>"}]},{"type":"text","value":"API"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" PDF Buffer 응답\n    API"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":"Page"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" PDF Buffer 전달\n    Page"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":"사용자"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 환경에 따라 Blob"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(네이티브 뷰어)"}]},{"type":"text","value":"<br/>혹은 pdf.js"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(Canvas)"}]},{"type":"text","value":"로 렌더링"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"API Routes 영역부터는 Node.js Runtime 영역이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"서버(Node)에서 Playwright로 Headless Chromium을 구동한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Headless Browser가 Next.js로 배포된 “PDF 렌더링 페이지”를 연다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"해당 페이지는 SSR 과정에서 백엔드(SpringBoot)로부터 데이터를 받아 렌더링된다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Playwright는 렌더링 결과를 PDF로 변환("},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"page.pdf()"}]},{"type":"text","value":")한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"생성된 PDF 바이너리를 API Routes가 받아 유저 브라우저로 내려준다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"Playwright-구성-요소","style":"position:relative;"},"children":[{"type":"text","value":"Playwright 구성 요소"},{"type":"element","tagName":"a","properties":{"href":"#Playwright-%EA%B5%AC%EC%84%B1-%EC%9A%94%EC%86%8C","ariaLabel":"Playwright 구성 요소 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"먼저, Playwright를 사용하기 위해서는 3가지를 알고 있어야 한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"playwright 패키지"}]},{"type":"text","value":": 브라우저를 제어하는 코드(런타임 라이브러리)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"브라우저 바이너리(Chromium 등)"}]},{"type":"text","value":": 실제 실행 엔진"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"브라우저 시스템 종속성(OS Dependencies)"}]},{"type":"text","value":": 브라우저가 뜨기 위해 필요한 OS 라이브러리/폰트/로케일 등"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"비유를 들면,"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Playwright 패키지 = 운전자 + 운전 매뉴얼"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"브라우저 바이너리 = 실제 자동차"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"OS 종속성 = 자동차가 달릴 수 있는 도로(기반 환경)"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"PDF는 결과물이라서, 이 3개 중 하나라도 흔들리면 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"폰트/간격/줄바꿈 같은 것이 달라진다."}]},{"type":"text","value":" 즉, PDF는 코드만 맞추면 끝나는 문제가 아니라 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"실행 환경까지 같이 고정해야"}]},{"type":"text","value":" 한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"브라우저-시스템-종속성OS-Dependencies","style":"position:relative;"},"children":[{"type":"text","value":"브라우저 시스템 종속성(OS Dependencies)"},{"type":"element","tagName":"a","properties":{"href":"#%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EC%A2%85%EC%86%8D%EC%84%B1OS-Dependencies","ariaLabel":"브라우저 시스템 종속성OS Dependencies permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"local-환경mac","style":"position:relative;"},"children":[{"type":"text","value":"local 환경(mac)"},{"type":"element","tagName":"a","properties":{"href":"#local-%ED%99%98%EA%B2%BDmac","ariaLabel":"local 환경mac permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"local에서 개발할 때는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ npx playwright install chromium"}]},{"type":"text","value":" 명령어로 local에 headless browser를 설치할 수 있다. 이때 CDN으로 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"https://cdn.playwright.dev/dbazure/download/playwright/builds/chromium/1187/chromium-mac-arm64.zip"}]},{"type":"text","value":" 경로를 통해 자동으로 바이너리를 받아온다(맥의 경우임, OS마다 다른 바이너리 파일을 다운 받음)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"브라우저 시스템 종속성은 local 환경에서는 다운 받을 필요 없다. 브라우저 실행에 필요한 OS 라이브러리가 이미 OS 자체에 있기 때문이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"배포-환경docker-container---linux","style":"position:relative;"},"children":[{"type":"text","value":"배포 환경(docker container - linux)"},{"type":"element","tagName":"a","properties":{"href":"#%EB%B0%B0%ED%8F%AC-%ED%99%98%EA%B2%BDdocker-container---linux","ariaLabel":"배포 환경docker container   linux permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"배포 환경은 Docker 이미지를 생성하고 실행하지만, "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"외부 네트워크 접근에 제약이 있는 환경(내부망)이다."}]},{"type":"text","value":" 이로 인해 다음과 같은 문제가 존재함."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"npx playwright install"}]},{"type":"text","value":" 명령어를 통한 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"브라우저 바이너리(Chromium) 다운로드 불가."}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Playwright가 요구하는 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"운영체제 종속성(OS Dependencies) 설치 및 버전 관리의 어려움."}]},{"type":"text","value":" (내부 저장소 부재, 환경 통제의 필요성)"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://playwright.dev/docs/docker","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"playwright의 공식 문서에서 docker 이미지"}]},{"type":"text","value":"를 따로 제공하고 있다는 걸 알게 되었다. 이 이미지는 headless browser 바이너리와 브라우저 시스템 종속성을 포함하고 있다. 따라서 이미지를 빌드할 때 일일이 바이너리와 종속성을 따로 받지 않아도 된다. 따라서 Nextjs 빌드 결과물을 이 이미지에 입혀 EKS pod에 배포하면 되는 것이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"문제-발생","style":"position:relative;"},"children":[{"type":"text","value":"문제 발생"},{"type":"element","tagName":"a","properties":{"href":"#%EB%AC%B8%EC%A0%9C-%EB%B0%9C%EC%83%9D","ariaLabel":"문제 발생 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"처음에는 공식 Playwright Docker 이미지를 쓰면 다 해결될 것이라고 생각했다. 실제로 공식 이미지는 브라우저 바이너리와 대부분의 OS 의존성을 포함하고 있고, Playwright가 기대하는 디렉토리 구조나 권한도 맞춰져 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그런데 배포 환경에서 돌려보니, 로컬에서 멀쩡하던 PDF가 깨지거나, 오류가 발생했다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"브라우저 실행 경로 문제(/ms-playwright 하위 경로 등)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"브라우저 콘솔 에러, 렌더링 타이밍 이슈"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"SSR에서 백엔드 호출 URL/네트워크 설정 문제"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"한글 폰트/이모지 렌더링 문제"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"쿠키/세션 처리 문제, user-agent 차이 등"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"세부 오류는 여기서 다 풀지는 않겠지만 공식 이미지 만으로는 결과물이 고정되지 않는다. 브라우저/폰트/아키텍처/환경변수/네트워크가 조금만 달라도 PDF는 달라진다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그래서 완벽히 동일하진 않더라도, 최소한 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"로컬에서 배포 환경과 유사한 조건을 강제"}]},{"type":"text","value":"할 수 있어야 디버깅이 가능하다고 판단했다. 이게 Part 1(로컬 Docker 환경 구축)을 시작한 이유다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"Part-1-로컬-Docker-환경-구축","style":"position:relative;"},"children":[{"type":"text","value":"Part 1: 로컬 Docker 환경 구축"},{"type":"element","tagName":"a","properties":{"href":"#Part-1-%EB%A1%9C%EC%BB%AC-Docker-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%B6%95","ariaLabel":"Part 1 로컬 Docker 환경 구축 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"Step-1-code-classlanguage-textdockerDockerfilelocalcode-신규-생성","style":"position:relative;"},"children":[{"type":"text","value":"Step 1. "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker/Dockerfile.local"}]},{"type":"text","value":" (신규 생성)"},{"type":"element","tagName":"a","properties":{"href":"#Step-1-code-classlanguage-textdockerDockerfilelocalcode-%EC%8B%A0%EA%B7%9C-%EC%83%9D%EC%84%B1","ariaLabel":"Step 1 code classlanguage textdockerDockerfilelocalcode 신규 생성 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"기존 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker/Dockerfile"}]},{"type":"text","value":" 은 프로덕션 배포용이었기 때문에, 로컬 테스트를 위해 별도의 Dockerfile을 만든다. "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Dockerfile.local"}]},{"type":"text","value":" 파일을 작성한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"docker"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-docker"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-docker"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"#\tDockerfile.local"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 로컬 Docker 테스트용 Dockerfile (playwright 1.46.1 사용)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":" mcr.microsoft.com/playwright:v1.46.1-jammy "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"AS"}]},{"type":"text","value":" base"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"WORKDIR"}]},{"type":"text","value":" /app"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"EXPOSE"}]},{"type":"text","value":" 3000"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" PORT=3000"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" HOST=0.0.0.0"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"COPY"}]},{"type":"text","value":" public ./public"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"COPY"}]},{"type":"text","value":" .next/standalone ./"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"COPY"}]},{"type":"text","value":" .next/static ./.next/static"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"USER"}]},{"type":"text","value":" root"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" mkdir -p .next/cache && chown -R pwuser:pwuser .next"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"USER"}]},{"type":"text","value":" pwuser"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENTRYPOINT"}]},{"type":"text","value":" ["},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"node\""}]},{"type":"text","value":", "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"server.js\""}]},{"type":"text","value":"]"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"세부-설명","style":"position:relative;"},"children":[{"type":"text","value":"세부 설명"},{"type":"element","tagName":"a","properties":{"href":"#%EC%84%B8%EB%B6%80-%EC%84%A4%EB%AA%85","ariaLabel":"세부 설명 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"FROM mcr.microsoft.com/playwright:v1.46.1-jammy"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Microsoft 공식 Playwright 이미지 사용"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"npm에 설치된 Playwright 버전과 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"명시적으로 맞춘다"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"브라우저 바이너리와 OS 종속성을 직접 설치하지 않아도 됨"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"ENV HOST=0.0.0.0"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Next.js 서버를 모든 네트워크 인터페이스에 바인딩"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"컨테이너 내부에서 들어오는 요청을 정상적으로 받기 위함"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"USER pwuser"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Playwright 공식 이미지에 포함된 일반 사용자"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"root로 실행하지 않도록 기본 보안 설정 유지"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"단, .next/cache 디렉토리는 root에서 권한만 미리 맞춰준다"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"Step-2-code-classlanguage-textenvlocal-dockercode-신규-생성","style":"position:relative;"},"children":[{"type":"text","value":"Step 2. "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":".env.local-docker"}]},{"type":"text","value":" (신규 생성)"},{"type":"element","tagName":"a","properties":{"href":"#Step-2-code-classlanguage-textenvlocal-dockercode-%EC%8B%A0%EA%B7%9C-%EC%83%9D%EC%84%B1","ariaLabel":"Step 2 code classlanguage textenvlocal dockercode 신규 생성 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"로컬 개발 서버(pnpm dev)와 Docker 컨테이너에서 실행되는 서버는 네트워크 구조가 완전히 다르다. 그래서 기존 .env.localhost를 그대로 쓰면 의도하지 않은 문제가 생긴다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Docker 환경 전용으로 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":".env.local-docker"}]},{"type":"text","value":" 를 따로 만들었다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"env"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-env"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-env"]},"children":[{"type":"text","value":"# .env.local-docker\nNEXT_PUBLIC_APP_ENV=local-docker\nNEXT_PUBLIC_BROWSER_API_URL=http://localhost:3000\nNEXT_PUBLIC_INTERNAL_API_URL=...\nNEXT_PUBLIC_PDF_INTERNAL_URL=http://host.docker.internal:3000\nSERVER_API_URL=..."}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"env"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-env"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-env"]},"children":[{"type":"text","value":"# .env.local\nNEXT_PUBLIC_APP_ENV=localhost\nNEXT_PUBLIC_BROWSER_API_URL=http://localhost:3000\nNEXT_PUBLIC_INTERNAL_API_URL=http://localhost:3000\nNEXT_PUBLIC_PDF_INTERNAL_URL=http://localhost:3000\nSERVER_API_URL=..."}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"envlocal-docker-설명","style":"position:relative;"},"children":[{"type":"text","value":".env.local-docker 설명"},{"type":"element","tagName":"a","properties":{"href":"#envlocal-docker-%EC%84%A4%EB%AA%85","ariaLabel":"envlocal docker 설명 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"NEXT_PUBLIC_BROWSER_API_URL=http://localhost:3000"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"브라우저(클라이언트)에서 API 호출 시 사용하는 URL"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"사용자가 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"http://localhost:3000"}]},{"type":"text","value":"으로 접속하므로 그대로 유지"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"단, 여기서 dev 서버는 CORS 때문에 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"next.config.js"}]},{"type":"text","value":"에 프록시 역할을 하도록 설정해두었었고, docker 환경에서도 프록시 역할을 하도록 해준다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight","has-highlighted-lines"],"dataLanguage":"js"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-js"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// next.config.js"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// ..."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"async"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"rewrites"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"return"}]},{"type":"text","value":" process"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"env"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"NEXT_PUBLIC_APP_ENV"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"==="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'localhost'"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"||"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["gatsby-highlight-code-line"]},"children":[{"type":"text","value":"    process"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"env"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"NEXT_PUBLIC_APP_ENV"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"==="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'local-docker'"}]}]},{"type":"text","value":"    "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"?"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// api 프록시"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","literal-property","property"]},"children":[{"type":"text","value":"source"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'/b2c-api/api/:path*'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","literal-property","property"]},"children":[{"type":"text","value":"destination"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","template-string"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","template-punctuation","string"]},"children":[{"type":"text","value":"`"}]},{"type":"element","tagName":"span","properties":{"className":["token","interpolation"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","interpolation-punctuation","punctuation"]},"children":[{"type":"text","value":"${"}]},{"type":"text","value":"process"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"env"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"SERVER_API_URL"}]},{"type":"element","tagName":"span","properties":{"className":["token","interpolation-punctuation","punctuation"]},"children":[{"type":"text","value":"}"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"/api/:path*"}]},{"type":"element","tagName":"span","properties":{"className":["token","template-punctuation","string"]},"children":[{"type":"text","value":"`"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// ..."}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"NEXT_PUBLIC_INTERNAL_API_URL=..."}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"SSR시, middleware 등 Node.js runtime에서 API 호출에 사용"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Docker 컨테이너 내부에서 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"localhost:3000"}]},{"type":"text","value":"은 자기 자신을 가리키므로 외부 테스트 서버 사용"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"EKS 환경에서는 내부에 배포된 pod 서버 주소를 사용한다. (브라우저가 아니라 node 서버에서 SpringBoot 서버로 쏘므로)"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"NEXT_PUBLIC_PDF_INTERNAL_URL=http://host.docker.internal:3000"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"PDF 생성 시 Playwright가 페이지 접속에 사용하는 URL"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"로컬 개발 서버(호스트 PC)와 달리, Docker 컨테이너 내부에서 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"localhost"}]},{"type":"text","value":"는 컨테이너 자신을 가리킴"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"따라서 컨테이너에서 **호스트 머신(Next.js 서버가 실행 중인 PC)**으로 루프백 요청을 보내기 위해 Docker Desktop이 제공하는 특수 DNS인 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"host.docker.internal"}]},{"type":"text","value":"을 사용함."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Playwright는 headless browser에서 PDF 생성 대상이 되는 페이지를 열기 위해 자기 자신을 호출한다. (그래야 FE에서 복잡한 CSS를 가진 페이지를 만들 수 있고, PDF 관리도 FE에서 가능하기 때문이다.)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"mermaid"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-mermaid"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-mermaid"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"sequenceDiagram"}]},{"type":"text","value":"\n    box "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"단일 로컬 PC 환경\""}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"participant"}]},{"type":"text","value":" PlaywrightApp as Playwright/Node.js 서버\n        "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"participant"}]},{"type":"text","value":" Browser as Playwright 헤드리스 브라우저\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]},{"type":"text","value":"\n\n    PlaywrightApp "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":" Browser"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 1. 브라우저 실행 "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"launch browser"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"activate"}]},{"type":"text","value":" Browser\n\n    PlaywrightApp "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":" Browser"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 2. 새 페이지 열기 "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"newPage"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n    Browser "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->>"}]},{"type":"text","value":" PlaywrightApp"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 3. 페이지 인스턴스 반환\n\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"Note over"}]},{"type":"text","value":" PlaywrightApp"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 4. PDF 생성 대상 URL 결정<br>"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(예: http://localhost:3000/content)"}]},{"type":"text","value":"\n\n    PlaywrightApp "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":" Browser"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 5. page.goto"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"('http://localhost:PORT/경로')"}]},{"type":"text","value":"\n\n    Browser "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":" PlaywrightApp"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 6. 페이지 콘텐츠를 위한 HTTP 요청 "},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(Loopback 통신)"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"activate"}]},{"type":"text","value":" PlaywrightApp\n\n    PlaywrightApp "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":" Browser"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 7. HTTP 응답 "},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(HTML/CSS/JS)"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"deactivate"}]},{"type":"text","value":" PlaywrightApp\n\n    Browser "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":" Browser"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 8. 페이지 콘텐츠 렌더링\n\n    PlaywrightApp "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":" Browser"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 9. PDF 파일 생성 명령 "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"page.pdf"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n    Browser "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->>"}]},{"type":"text","value":" PlaywrightApp"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 10. PDF 이진 데이터 반환\n\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"deactivate"}]},{"type":"text","value":" Browser\n    PlaywrightApp "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":" PlaywrightApp"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 11. PDF 파일 저장 또는 스트림 처리"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"자기 자신을 호출하는 것을 **로컬 루프백(Local Loopback)**이라고 한다. 이때 local("},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"pnpm dev"}]},{"type":"text","value":"로 실행하는 dev서버)에서는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"http://localhost:3000"}]},{"type":"text","value":" 주소를 사용해도 된다. 왜냐하면 Next.js가 떠있는게 localhost:3000 이기 때문이다. 같은 OS(호스트 PC) 위에서 실행되기 때문이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Host PC (Next.js Server):"}]},{"type":"text","value":" PDF 렌더링에 필요한 HTML/CSS/데이터를 제공하는 웹 서버."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Docker Container (Playwright App):"}]},{"type":"text","value":" Next.js 코드를 실행하며, Headless Browser를 구동하여 PDF를 생성하는 주체."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"하지만 Docker 환경은 다르다. Docker Container 내부에서 localhost는 호스트 PC가 아닌 Docker Container 자기 자신이기 때문이다. 컨테이너 내부 3000번 포트로 요청을 보낸다. 그러면 dev 서버와 동일하게 자기자신을 가리키기 때문에 문제 없이 호출되어야 하는 것이 맞다. 하지만 localhost:3000이 실패했고, "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"host.docker.internal:3000"}]},{"type":"text","value":" 으로 접근했을 경우만 성공했다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"왜냐면 docker container 내부에 localhost가 네트워크로 바인딩 되어있지 않기 때문이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# docker container 내부"}]},{"type":"text","value":"\n\n$ "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"cat"}]},{"type":"text","value":" /etc/hosts\n"},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"127.0"}]},{"type":"text","value":".0.1       localhost\n::1     localhost ip6-localhost ip6-loopback\nfe00::  ip6-localnet\nff00::  ip6-mcastprefix\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\n"},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"172.17"}]},{"type":"text","value":".0.2      3c2c98fbe2ae"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"DNS로 127.0.0.1에 localhost가 바인딩 되어있지만, 실제로는 172.17.0.2에 Next.js 어플리케이션이 떠있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# docker container 내부"}]},{"type":"text","value":"\n\n$ "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"node"}]},{"type":"text","value":" /app/server.js\n ⨯ Failed to start server\nError: listen EADDRINUSE: address already "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"in"}]},{"type":"text","value":" use "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"172.17"}]},{"type":"text","value":".0.2:3000\n    at "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"<"}]},{"type":"text","value":"unknown"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"Error: listen EADDRINUSE: address already "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"in"}]},{"type":"text","value":" use "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"172.17"}]},{"type":"text","value":".0.2:3000"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  code: "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'EADDRINUSE'"}]},{"type":"text","value":",\n  errno: -98,\n  syscall: "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'listen'"}]},{"type":"text","value":",\n  address: "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'172.17.0.2'"}]},{"type":"text","value":",\n  port: "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"3000"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Next.js 서버를 다시 한번 실행하는 명령어인데, 이미 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"172.17.0.2:3000"}]},{"type":"text","value":" 에 떠 있는 것을 볼 수 있기 때문이다. 그렇다면 방법은 두 가지다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"NEXT_PUBLIC_PDF_INTERNAL_URL"}]},{"type":"text","value":"에 localhost:3000 대신, "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"172.17.0.2:3000"}]},{"type":"text","value":" 이 주소를 넣어준다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"docker run 시 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"--dns=127.0.01"}]},{"type":"text","value":" 옵션을 준다.\n"},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1454px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 18%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAuklEQVR42kWP6wrCMAyF+/6vJ4oI+mPrel9vyjYn2zHtigZCTr6EQ8K4MHA+oR8UTucbLtc7jAtwY4KlNC7WamuNjR/atllhxaPsMqkdpvmNmJ6QykIZV7UPCaOPVYeYf+nIyIeMlF+ImfYa09bXXZZpUGKaZnCh0PUCHRcQ0tDVsjKhDPW6cY2BmCRW+qIHoXF/dGQcwNBiXT/oORnyYqLpHQ9Pb4RYLg21HheG2tvRY14W7PuGbfvnF4GCLjuJnRJxAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"dns-option","title":"","src":"/static/c4e19889ca88eb4eb19b6c172744cf7a/b62b2/dns-option.png","srcSet":["/static/c4e19889ca88eb4eb19b6c172744cf7a/b30f8/dns-option.png 500w","/static/c4e19889ca88eb4eb19b6c172744cf7a/332ff/dns-option.png 1000w","/static/c4e19889ca88eb4eb19b6c172744cf7a/b62b2/dns-option.png 1454w"],"sizes":"(max-width: 1454px) 100vw, 1454px","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy","decoding":"async"},"children":[]},{"type":"text","value":"\n    "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://docs.docker.com/engine/network/#dns-services","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"https://docs.docker.com/engine/network/#dns-services"}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"NEXT_PUBLIC_PDF_INTERNAL_URL"}]},{"type":"text","value":"에 host.docker.internal을 주어 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"호스트 NAT 우회"}]},{"type":"text","value":" 한다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"나는 3번을 선택했는데, 호스트 PC를 호출해서 호스트 PC가 다시 docker container의 Next.js 서버를 찌르게 만드는 방법이다. 이는 docker에서 제공하는 특수 DNS 이름이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"mermaid"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-mermaid"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-mermaid"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"sequenceDiagram"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"autonumber"}]},{"type":"text","value":"\n\n    box "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Host PC\""}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"participant"}]},{"type":"text","value":" Browser as Browser "},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(Client)"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"participant"}]},{"type":"text","value":" NAT as Docker NAT / Port Publish\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]},{"type":"text","value":"\n\n    box "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Docker Container\""}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"participant"}]},{"type":"text","value":" App as Next.js + Playwright\n        "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"participant"}]},{"type":"text","value":" B as Headless Chromium\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"end"}]},{"type":"text","value":"\n\n    Browser"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":"App"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" /api/pdf 요청 "},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(localhost:3000)"}]},{"type":"text","value":"\n    App"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":"B"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" launch + page.newPage\n\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"Note over"}]},{"type":"text","value":" App"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 내부 접근 시도<br/>http"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"//localhost"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"3000/content\n    B"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":"App"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" GET localhost"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"3000 ❌ "},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(실패)"}]},{"type":"text","value":"\n\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"Note over"}]},{"type":"text","value":" App"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 우회 경로 선택<br/>http"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"//host.docker.internal"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"3000/content\n    B"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":"NAT"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" GET host.docker.internal"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"3000\n    NAT"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":"App"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 포트 매핑으로 전달\n    App"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->>"}]},{"type":"text","value":"B"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" HTML/CSS/JS\n\n    B"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"->>"}]},{"type":"text","value":"B"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" 렌더링 + PDF 생성\n    B"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->>"}]},{"type":"text","value":"App"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" PDF 바이너리\n    App"},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->>"}]},{"type":"text","value":"Browser"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" PDF 응답"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"위와 같은 경로로 전달된다. 당연히 local에서 docker를 통해 테스트를 하기 때문에 host.docker.internal을 사용했지만, 실제 배포 환경에서는 저런 방식으로 우회해서 사용하는게 아니라 명확한 주소를 매핑 시켜놓는 것이 좋다. 또한 만약 docker 정책이 container 자신의 주소가 172.17.0.2가 아닌 다른 주소가 된다해도 host.docker.internal를 사용하고 있으므로 local에서 테스트 용도로 적합하다고 생각했다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"Step-3-code-classlanguage-textpackagejsoncode","style":"position:relative;"},"children":[{"type":"text","value":"Step 3. "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"package.json"}]},{"type":"element","tagName":"a","properties":{"href":"#Step-3-code-classlanguage-textpackagejsoncode","ariaLabel":"Step 3 code classlanguage textpackagejsoncode permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"로컬 Docker 테스트는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"빌드 -> 이미지 생성 -> 실행"}]},{"type":"text","value":" 을 매번 손으로 하면 바로 귀찮아진다. 한 줄로 끝나야 한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"json"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-json"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-json"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// package.json"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"scripts\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"local-docker.build\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"env-cmd -f .env.local-docker next build\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"local-docker.start\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"pnpm local-docker.build && docker build -f ./docker/Dockerfile.local -t my-next-app:local --platform linux/amd64 . && docker run --rm -p 3000:3000 my-next-app:local\""}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// ..."}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"세부-설명-1","style":"position:relative;"},"children":[{"type":"text","value":"세부 설명"},{"type":"element","tagName":"a","properties":{"href":"#%EC%84%B8%EB%B6%80-%EC%84%A4%EB%AA%85-1","ariaLabel":"세부 설명 1 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"local-docker.build"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":".env.local-docker"}]},{"type":"text","value":" 환경변수를 사용하여 Next.js 빌드"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"env-cmd -f"}]},{"type":"text","value":" 플래그로 특정 환경 파일 지정"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"local-docker.start"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"전체 프로세스를 한 번에 실행하는 통합 스크립트\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Next.js 빌드 -> Docker 이미지 생성 -> 컨테이너 실행"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"-platform linux/amd64"}]},{"type":"text","value":": M1/M2/M3 Mac에서도 호환성 보장"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"-rm"}]},{"type":"text","value":": 컨테이너 종료 시 자동 삭제"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이제 아래 명령어 한 줄로 현재 작성된 Next.js 코드를 local에서 docker container로 띄운 환경에 접속 가능하다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"pnpm"}]},{"type":"text","value":" local-docker.start"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 2000px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 52.800000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB7ElEQVR42pWS6W7bMBCE9RwFXDu2DovUaV2MJFsW5CM+UrcpigZF2/d/i8mQdtqk//rjw1IrcnZ3SKtoz8jrE1J1QLm8QHUXuGEDW1SwpcJMlJi4ASaONIxt78YcH2cuRLRAlBWIi5oMsPzFGX56gswvkMUTxQaKKTjBPRxJAopLilNYFzDirwUYx7bAaOpxHcOLN7BkdkKQP+IaPyEoLvwxUHhFwRrzZIN5umPcQiweyMHgJzuI7Ghyfrol3BP3sIwICcsnhMUXeFGHOy80I41t/w8TR/zD35zeO/UiNqIF2ZFgd7pDHc2IHO+OG8wBV94OefTMecd4dvVyTC/v3NA0Y8n8TLErWsgJao7bmnG1uP626eXUz1gkJgm7IfPEFLqKvwr22kP6V3xGUH41F6NjWH5DVD0jrn8irL4bkvoX+Y1Y/UCkns3aT498BYriqZlI+2iJdE2D15CLAUHWI8y3SKoDonKPqNgx30HEDWS6NIikJQ1E2iLMeDZW7E6YG3f4Cqzt4YTd8YzNwxH70yOqZoWsuodqOzRdz+8lMlWjrFuzLkn1BtWuEOeKRTN4QQyr3x7M4yzrFZr1gLbfoBv2SLjpw8SmP55hNHXfrUdvcvpirrfuw6pXPWSSm7Zn88DgiIjGy9vT+T9eAFOVVnjZrtKvAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"docker-build-cli.png","title":"","src":"/static/32eb77f9e39ce13b0a2824b76df8492c/99e71/docker-build-cli.png","srcSet":["/static/32eb77f9e39ce13b0a2824b76df8492c/b30f8/docker-build-cli.png 500w","/static/32eb77f9e39ce13b0a2824b76df8492c/332ff/docker-build-cli.png 1000w","/static/32eb77f9e39ce13b0a2824b76df8492c/99e71/docker-build-cli.png 2000w","/static/32eb77f9e39ce13b0a2824b76df8492c/c6eff/docker-build-cli.png 2074w"],"sizes":"(max-width: 2000px) 100vw, 2000px","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy","decoding":"async"},"children":[]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 2000px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 3.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAPklEQVR42k3LMRJAAAwFUfc/qCL5ChLCmFiGxuu22EGayFg455E+Vj4Xf5lJVSEJM6O733Z3IuL5A3Ox7c0NSm5Nd21hDz4AAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"docker-desktop-result.png","title":"","src":"/static/adeb59617629efc07580f91f40f9abfe/99e71/docker-desktop-result.png","srcSet":["/static/adeb59617629efc07580f91f40f9abfe/b30f8/docker-desktop-result.png 500w","/static/adeb59617629efc07580f91f40f9abfe/332ff/docker-desktop-result.png 1000w","/static/adeb59617629efc07580f91f40f9abfe/99e71/docker-desktop-result.png 2000w","/static/adeb59617629efc07580f91f40f9abfe/ed510/docker-desktop-result.png 2128w"],"sizes":"(max-width: 2000px) 100vw, 2000px","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy","decoding":"async"},"children":[]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"로컬-Docker에서도-완전히-같지는-않다","style":"position:relative;"},"children":[{"type":"text","value":"로컬 Docker에서도 완전히 같지는 않다"},{"type":"element","tagName":"a","properties":{"href":"#%EB%A1%9C%EC%BB%AC-Docker%EC%97%90%EC%84%9C%EB%8F%84-%EC%99%84%EC%A0%84%ED%9E%88-%EA%B0%99%EC%A7%80%EB%8A%94-%EC%95%8A%EB%8B%A4","ariaLabel":"로컬 Docker에서도 완전히 같지는 않다 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"PDF 결과물의 폰트 및 간격이 amd64로 빌드 했을 때 달라져 꽤 오랜시간 애를 먹었다. 원인은 docker build 할 때 platform을 설정했기 때문이었다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"--platform linux/amd64"}]},{"type":"text","value":" 같은 경우 EKS pod 환경이 linux/amd64 이기 때문에 플랫폼을 맞춰주기 위해서 넣은 것이다. 하지만, mac에서 amd64 플랫폼으로 동작하지만, PDF를 브라우저에 렌더링 했을 경우 폰트 및 간격이 실제 EKS에 배포했을 때와는 다르다. 이유는 Mac은 arm64 환경이기 때문이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://www.docker.com/blog/faster-multi-platform-builds-dockerfile-cross-compilation-guide/","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"멀티 플랫폼 빌드(크로스 컴파일 가이드) - Docker 공식 블로그"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://www.docker.com/blog/multi-arch-images/","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"Docker Desktop을 사용하여 Arm 및 x86용 멀티 아키텍처 이미지 빌드하기 - Docker 공식 블로그"}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"따라서 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"--platform"}]},{"type":"text","value":" 옵션은 실제 ECR에 올릴 이미지를 생성할 때만 넣어주어야 한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그래서 로컬 검증은 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"기능 동작 여부"}]},{"type":"text","value":" 중심으로 하고, 결과물의 픽셀 단위 동일성은 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"실제 아키텍처 amd64(Mac)에서 최종 확인"}]},{"type":"text","value":"하는 방식으로 했다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"br","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"Part-2-ECR-Base-이미지-작성-및-배포-프로세스","style":"position:relative;"},"children":[{"type":"text","value":"Part 2: ECR Base 이미지 작성 및 배포 프로세스"},{"type":"element","tagName":"a","properties":{"href":"#Part-2-ECR-Base-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EC%9E%91%EC%84%B1-%EB%B0%8F-%EB%B0%B0%ED%8F%AC-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4","ariaLabel":"Part 2 ECR Base 이미지 작성 및 배포 프로세스 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"로컬에서 Playwright 이미지에 Nextjs 빌드 결과물을 Docker Container로 띄웠다면, 이제 실제 EKS에 배포될 이미지의 기본값이 될 playwright base 이미지를 만들어야 한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Playwright는 단순한 npm 패키지가 아니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"브라우저 바이너리"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"OS 종속성"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"폰트, locale, timezone"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Chromium 버전"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이 모든 것이 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Base 이미지에 강하게 결합"}]},{"type":"text","value":"되어 있다. 즉, Base 이미지가 흔들리면 PDF 결과물도 같이 흔들린다. Playwright Base 이미지를 직접 만들고, ECR에 올리고, 그 버전만 사용하도록 한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"※ playwright 버전"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"기존에 "},{"type":"element","tagName":"a","properties":{"href":"mailto:playwright@1.41.1","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"playwright@1.41.1"}]},{"type":"text","value":"을 사용하고 있었지만, 보안 취약점이 발견되어 최신 버전의 이미지(1.57.0)를 사용해야 했다. npm package에서 playwright 버전이 올라가면 playwright docker 이미지도 버전이 올라가야 한다. 만약 npm playwright 버전과 playwright 이미지의 버전이 맞지 않는다면 headless browser가 실행되지 않는다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"따라서 FE에서 npm을 통해 playwright를 업데이트하면 당연히 base 이미지도 업데이트 해야 한다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"위에서 봤듯, FE 배포 프로세스를 보면 아래와 같다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"mermaid"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-mermaid"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-mermaid"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"graph"}]},{"type":"text","value":" LR\n\t\tA"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[developer]"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"element","tagName":"span","properties":{"className":["token","label","property"]},"children":[{"type":"text","value":"|FE commit push|"}]},{"type":"text","value":" B\n    B"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[GitHub]"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"text","value":" C"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(Actions Runner)"}]},{"type":"text","value":"\n    C "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"element","tagName":"span","properties":{"className":["token","label","property"]},"children":[{"type":"text","value":"|playwright base 이미지 요청|"}]},{"type":"text","value":" D"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[(ECR)]"}]},{"type":"text","value":"\n    D "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"element","tagName":"span","properties":{"className":["token","label","property"]},"children":[{"type":"text","value":"|playwright base 이미지 응답|"}]},{"type":"text","value":" C\n    C "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"element","tagName":"span","properties":{"className":["token","label","property"]},"children":[{"type":"text","value":"|base 이미지에 Next.js Artifact ㅊ추가|"}]},{"type":"text","value":" F"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[EKS]"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"배포때 GitHub Actions에서 ECR로 playwright base 이미지를 요청하게 된다. 저 base 이미지를 local PC해서 만들고 내부망으로 이동시켜 ECR에 푸시하도록 한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"mermaid"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-mermaid"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-mermaid"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"graph"}]},{"type":"text","value":" LR\n    A"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[로컬 빌드]"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"text","value":" B"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"(tar 압축)"}]},{"type":"text","value":"\n    B "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"text","value":" C"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[내부망 이동]"}]},{"type":"text","value":"\n    C "},{"type":"element","tagName":"span","properties":{"className":["token","arrow","operator"]},"children":[{"type":"text","value":"-->"}]},{"type":"text","value":" D"},{"type":"element","tagName":"span","properties":{"className":["token","text","string"]},"children":[{"type":"text","value":"[(ECR 푸시)]"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"Step-1-code-classlanguage-textdockerDockerfilebasecode-신규-생성","style":"position:relative;"},"children":[{"type":"text","value":"Step 1. "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker/Dockerfile.base"}]},{"type":"text","value":" (신규 생성)"},{"type":"element","tagName":"a","properties":{"href":"#Step-1-code-classlanguage-textdockerDockerfilebasecode-%EC%8B%A0%EA%B7%9C-%EC%83%9D%EC%84%B1","ariaLabel":"Step 1 code classlanguage textdockerDockerfilebasecode 신규 생성 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Playwright 공식 이미지"}]},{"type":"text","value":"를 기반,"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"한국 시간대 / 한글 + 이모지 폰트 / HTTPS APT / 안정적인 apt-get 패턴 / 이미지 용량 정리"}]},{"type":"text","value":"를 설정하고"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"마지막에 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"비루트 계정(pwuser)"}]},{"type":"text","value":" 로 내려서 브라우저와 Node를 구동하는, PDF/스크린샷 생성에 최적화된 베이스 이미지를 만든다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# docker/Dockerfile.base"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 골든 베이스: Playwright + 폰트/타임존"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":" mcr.microsoft.com/playwright:latest"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"USER"}]},{"type":"text","value":" root"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" DEBIAN_FRONTEND=noninteractive"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" TZ=Asia/Seoul"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ── 견고한 APT 패턴: HTTPS 미러, 인덱스 초기화, 재시도, 한 RUN에서 update→install→clean ──"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" set -eux; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 0) 미러 HTTPS로 고정(사내 미러 쓰면 여기서 sources.list 교체)"}]},{"type":"text","value":"\n    sed -i "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'s|http://archive.ubuntu.com|https://archive.ubuntu.com|g'"}]},{"type":"text","value":" /etc/apt/sources.list; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    sed -i "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'s|http://security.ubuntu.com|https://security.ubuntu.com|g'"}]},{"type":"text","value":" /etc/apt/sources.list; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 1) 인덱스 초기화 + 재시도 옵션"}]},{"type":"text","value":"\n    rm -rf /var/lib/apt/lists/*; mkdir -p /var/lib/apt/lists/partial; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    echo "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'Acquire::Retries \"5\";'"}]},{"type":"text","value":" > /etc/apt/apt.conf.d/80-retries; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 2) 타임존 사전 지정(프롬프트 방지)"}]},{"type":"text","value":"\n    ln -snf /usr/share/zoneinfo/"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$TZ"}]},{"type":"text","value":" /etc/localtime; echo "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"$TZ\""}]},{"type":"text","value":" > /etc/timezone; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 3) 업데이트"}]},{"type":"text","value":"\n    apt-get update -o Acquire::http::No-Cache=true -o Acquire::http::Pipeline-Depth=0; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 4) 필요한 패키지 일괄 설치(폰트 + tzdata + 인증서)"}]},{"type":"text","value":"\n    apt-get install -y --no-install-recommends "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n        fonts-noto-cjk "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n        fonts-noto-color-emoji "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n        tzdata "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n        ca-certificates "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    ; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# (환경에 따라) tzdata 재설정도 비대화식으로 강제"}]},{"type":"text","value":"\n    dpkg-reconfigure -f noninteractive tzdata; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 5) 클린업"}]},{"type":"text","value":"\n    rm -rf /var/lib/apt/lists/*"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 권장: 기본 유저를 Playwright의 pwuser로"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"USER"}]},{"type":"text","value":" pwuser"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"세부-설명-2","style":"position:relative;"},"children":[{"type":"text","value":"세부 설명"},{"type":"element","tagName":"a","properties":{"href":"#%EC%84%B8%EB%B6%80-%EC%84%A4%EB%AA%85-2","ariaLabel":"세부 설명 2 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"code-classlanguage-textFROM-mcrmicrosoftcomplaywrightlatestcode","style":"position:relative;"},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"FROM mcr.microsoft.com/playwright:latest"}]},{"type":"element","tagName":"a","properties":{"href":"#code-classlanguage-textFROM-mcrmicrosoftcomplaywrightlatestcode","ariaLabel":"code classlanguage textFROM mcrmicrosoftcomplaywrightlatestcode permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"브라우저 설치, OS 의존성, 디스플레이 관련 설정 등을 직접 신경쓰지 않아도 됨."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Playwright가 기대하는 디렉토리 구조, 유저, 퍼미션이 맞춰져 있음."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"즉, Node + 브라우저까지 설치 되어 있는 OS"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"code-classlanguage-textENV-TZAsiaSeoulcode","style":"position:relative;"},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"ENV TZ=Asia/Seoul"}]},{"type":"element","tagName":"a","properties":{"href":"#code-classlanguage-textENV-TZAsiaSeoulcode","ariaLabel":"code classlanguage textENV TZAsiaSeoulcode permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"컨테이너 기본 타임존을 한국 시간으로 맞춘다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"PDF 생성 시각/로그 타임스탬프/서버 시간 해석이 로컬/서버에서 어긋나는 문제를 줄인다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"code-classlanguage-textapt-get-update-code","style":"position:relative;"},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"apt-get update ..."}]},{"type":"element","tagName":"a","properties":{"href":"#code-classlanguage-textapt-get-update-code","ariaLabel":"code classlanguage textapt get update code permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"No-Cache"}]},{"type":"text","value":", "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Pipeline-Depth=0"}]},{"type":"text","value":" 같은 옵션으로 네트워크/프록시 환경에서 실패율을 낮추려는 설정."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"code-classlanguage-textapt-get-install--y---no-install-recommends-code","style":"position:relative;"},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"apt-get install -y --no-install-recommends ..."}]},{"type":"element","tagName":"a","properties":{"href":"#code-classlanguage-textapt-get-install--y---no-install-recommends-code","ariaLabel":"code classlanguage textapt get install  y   no install recommends code permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"필요한 것만 최소 설치."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"설치 항목 의미:\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"fonts-noto-cjk"}]},{"type":"text","value":": 한글(CJK) 폰트. PDF에서 한글 깨짐 방지"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"fonts-noto-color-emoji"}]},{"type":"text","value":": 컬러 이모지 렌더링"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"tzdata"}]},{"type":"text","value":": 타임존 데이터"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"ca-certificates"}]},{"type":"text","value":": HTTPS 통신(내부/외부) 인증서 신뢰 기반"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"code-classlanguage-textdpkg-reconfigure--f-noninteractive-tzdatacode","style":"position:relative;"},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"dpkg-reconfigure -f noninteractive tzdata"}]},{"type":"element","tagName":"a","properties":{"href":"#code-classlanguage-textdpkg-reconfigure--f-noninteractive-tzdatacode","ariaLabel":"code classlanguage textdpkg reconfigure  f noninteractive tzdatacode permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"tzdata 설치 후 재설정도 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"비대화식으로 강제"}]},{"type":"text","value":" 시킴."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"빌드 환경에 따라 타임존 적용이 안되는 것을 막음."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"code-classlanguage-textrm--rf-varlibaptlistscode","style":"position:relative;"},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"rm -rf /var/lib/apt/lists/*"}]},{"type":"element","tagName":"a","properties":{"href":"#code-classlanguage-textrm--rf-varlibaptlistscode","ariaLabel":"code classlanguage textrm  rf varlibaptlistscode permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"레이어 용량을 줄이기 위해 apt-get으로 설치한 라이브러리 리스트 제거."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"이미지 사이즈 감소 + 캐시 오염 방지 목적."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"Step-2-Base-이미지-빌드-로컬","style":"position:relative;"},"children":[{"type":"text","value":"Step 2. Base 이미지 빌드 (로컬)"},{"type":"element","tagName":"a","properties":{"href":"#Step-2-Base-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%B9%8C%EB%93%9C-%EB%A1%9C%EC%BB%AC","ariaLabel":"Step 2 Base 이미지 빌드 로컬 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"package.json에 스크립트를 생성하자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"json"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-json"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-json"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"scripts\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// ..."}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"docker.build-base:amd64\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"docker build -f ./docker/Dockerfile.base -t [...].dkr.ecr.ap-northeast-2.amazonaws.com/common/playwright:latest-with-font --platform linux/amd64 .\""}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"build -f ./docker/Dockerfile.base"}]},{"type":"text","value":" : "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"./docker/Dockerfile.base"}]},{"type":"text","value":" 파일을 사용해 빌드"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"-t [...].dkr.ecr.ap-northeast-2.amazonaws.com/common/playwright:latest-with-font"}]},{"type":"text","value":" : ECR 리포지토리: "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"common/playwright"}]},{"type":"text","value":" 주소 설정과 태그를 붙임"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"--platform linux/amd64"}]},{"type":"text","value":": ECR은 linux/amd64이므로 플랫폼 강제 고정"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"pnpm"}]},{"type":"text","value":" docker.build-base:amd64"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1804px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 4.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAL0lEQVR42lWJSQoAMAwC+//fZsWbIUKhFWQGPQDo7szMjxEhf/dbMxM33a1/WVUcMctNLzMJMMEAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"docker-build-base-amd64.png","title":"","src":"/static/b7a465c545342b5133a3adba5f0c5021/e9bfc/docker-build-base-amd64.png","srcSet":["/static/b7a465c545342b5133a3adba5f0c5021/b30f8/docker-build-base-amd64.png 500w","/static/b7a465c545342b5133a3adba5f0c5021/332ff/docker-build-base-amd64.png 1000w","/static/b7a465c545342b5133a3adba5f0c5021/e9bfc/docker-build-base-amd64.png 1804w"],"sizes":"(max-width: 1804px) 100vw, 1804px","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy","decoding":"async"},"children":[]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"Step-3-Base-이미지를-tar-파일로-고정","style":"position:relative;"},"children":[{"type":"text","value":"Step 3. Base 이미지를 tar 파일로 고정"},{"type":"element","tagName":"a","properties":{"href":"#Step-3-Base-%EC%9D%B4%EB%AF%B8%EC%A7%80%EB%A5%BC-tar-%ED%8C%8C%EC%9D%BC%EB%A1%9C-%EA%B3%A0%EC%A0%95","ariaLabel":"Step 3 Base 이미지를 tar 파일로 고정 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"docker image를 내부 망으로 들이기위해 tar 파일로 저장한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"docker"}]},{"type":"text","value":" save "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":".."}]},{"type":"text","value":"."},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":".dkr.ecr.ap-northeast-2.amazonaws.com/common/playwright:latest-with-font "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"-o"}]},{"type":"text","value":" playwright-base.tar"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"Step-4-내부망으로-전송-및-ECR-push","style":"position:relative;"},"children":[{"type":"text","value":"Step 4. 내부망으로 전송 및 ECR push"},{"type":"element","tagName":"a","properties":{"href":"#Step-4-%EB%82%B4%EB%B6%80%EB%A7%9D%EC%9C%BC%EB%A1%9C-%EC%A0%84%EC%86%A1-%EB%B0%8F-ECR-push","ariaLabel":"Step 4 내부망으로 전송 및 ECR push permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"내부망으로 들일 때는 tar로 압축해서 보내면 리소스를 아낄 수 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"gzip"}]},{"type":"text","value":" playwright-base.tar"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 198px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 139.3939393939394%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAYAAABh2p9gAAAACXBIWXMAABYlAAAWJQFJUiTwAAACyUlEQVR42q2V60/aYBTG+buXLEuWZR+WLPugkUYuCopzyRY1mvnFfUAWFy/RkcBwAbkoYROBXqAthbbPzjmzCU7cqFmTk5a276/P+5wLEcxweJ4H3/dneRUR/OdjKpDVBOG6LjRNg67rjwcOh0No+m9Ip9PBq9dvsKAswrKsxwEt2xZVqqoKNBpLIpFagUHX/X4/PNAe2jAMQ2ADAijxJSixBBxnKB/hZ6G3zEp4oWWaiBIwvpxG9eIClcoFGo0GwZ3ZgfzyYDAQqEPw5y9eIrG0DJs8bLfbuLm5kY+GApqkjIHj8RhPnj7D/IIi191ul6ITEjhyYFNiGMrw/dxnnJ19pXuWeNjr9cIBR6ORLAigrjume454augGVE0N5yFvjRcwlIOh7GngK2c/NJBV8lknRcViEaVSSUAmQVmpQ89DAbnlOLg7uEwal5eiVJI16MsH/wkMJgp7x8ZLUBKCruE25OCymWnLPKaCEJVj9872WfGk+tDja3LqPGp8cdGen5+jXC7j+vpaolarodVqyb1qtSpxenoqSQp6evKDkckbW1tbWF1dRTweRzQaxfb2NtLpNFKpFLLZrFwrioLNzU1sbGzg5OTknpd3FDabTcmqdduzV1dXkqBgZNXrdeTzeRHA9cleT91yoJCzF2yDzefgZ1x/nOlgggedxCX0JzQSZJeP/VwOsdgikskkMmtv6TqO9fV3KBQKtN0VzM3N4+j4GHt7n5DJZLCzs3OvHu8o5Bpjs0ulb2jUaPaVv6NerVA9dlGtlFEqFmTgHn45wO7uR7HE972/FPbt2XB81HouuqaPNtlnku8tw4dm+/hpuGiqVKs+ZilsX7A/1BF2830s5zS8O9RRbA7x4VjH2oGG90cGElnqHpML+/7/9VSFztgnVaTI8iT6tgfV9NAbuNDpd5fOUxIc/o9+loaJPLSQ17ID/gPxEPAXTKBqUyi5H/8AAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"base-image-gzip","title":"","src":"/static/fdc3afe38070999d9115b1f3568d7512/920f7/base-image-gzip.png","srcSet":["/static/fdc3afe38070999d9115b1f3568d7512/920f7/base-image-gzip.png 198w"],"sizes":"(max-width: 198px) 100vw, 198px","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy","decoding":"async"},"children":[]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"Step-5-내부망에서-ECR-푸시","style":"position:relative;"},"children":[{"type":"text","value":"Step 5. 내부망에서 ECR 푸시"},{"type":"element","tagName":"a","properties":{"href":"#Step-5-%EB%82%B4%EB%B6%80%EB%A7%9D%EC%97%90%EC%84%9C-ECR-%ED%91%B8%EC%8B%9C","ariaLabel":"Step 5 내부망에서 ECR 푸시 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ gunzip playwright-base.tar.gz"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"압축을 푼다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"text","value":"$ "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"docker"}]},{"type":"text","value":" load "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"-i"}]},{"type":"text","value":" playwright-base.tar\n$ "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"docker"}]},{"type":"text","value":" images "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"|"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"grep"}]},{"type":"text","value":" playwright"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"docker image를 내부망 컴퓨터에 로드시킨 후, docker images 명령어로 이미지가 제대로 로드 되었는지 확인한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그다음 PC에서 aws cli로 ECR에 로그인 후, push 하면 된다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"결과-확인","style":"position:relative;"},"children":[{"type":"text","value":"결과 확인"},{"type":"element","tagName":"a","properties":{"href":"#%EA%B2%B0%EA%B3%BC-%ED%99%95%EC%9D%B8","ariaLabel":"결과 확인 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이제 FE에서 playwright 버전(1.57.0)을 업데이트하고 commit 후 push해서 GitHub Actions가 돌게 한 후, 배포를 기다려보자. 완료 이후 PDF를 출력해보니 문제가 생겼다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Next.js node runtime의 playwright 버전은 1.57.0 버전이지만, 이미지 버전은 여전히 1.46.1 버전이라는 에러 문구다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"어떻게 된건지 GitHub Actions의 Dockerfile을 보자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":"  [...].dkr.ecr.ap-northeast-2.amazonaws.com/common/playwright:latest-with-font "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"AS"}]},{"type":"text","value":" base"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"ECR에 push 했을 때 분명 새로운 이미지로 교체 되었는데 여전히 새로운 이미지로 빌드되지 않았다. 문제는 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"태그"}]},{"type":"text","value":"였는데, 새로운 이미지의 태그도 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"latest-with-font"}]},{"type":"text","value":" 였고, "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker build --pull"}]},{"type":"text","value":" 명령어가 아닌 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker build"}]},{"type":"text","value":"로만 실행되었기 때문에 기존에 있는 base 이미지로만 사용했기 때문에 문제가 되었다. 같은 태그를 쓰면 Docker는 로컬에 캐시된 이미지를 우선 사용해서, ECR에 새 이미지를 올려도 빌드가 그대로 지난 이미지가 사용된다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"태그를-timestamp-기반으로","style":"position:relative;"},"children":[{"type":"text","value":"태그를 timestamp 기반으로"},{"type":"element","tagName":"a","properties":{"href":"#%ED%83%9C%EA%B7%B8%EB%A5%BC-timestamp-%EA%B8%B0%EB%B0%98%EC%9C%BC%EB%A1%9C","ariaLabel":"태그를 timestamp 기반으로 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"새로운 이미지는 새로운 태그로 대체하기로 했다. "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker build --pull"}]},{"type":"text","value":" 옵션을 주면 docker 이미지 digest가 변경되었다면 새로 pull 받아 이미지를 생성한다. 하지만, 사람이 알아보는 것은 쉽지 않다. 따라서 현재 빌드 시점을 태깅해서 ECR로 push 하고, 빌드 시 해당 태그의 이미지를 사용하도록 한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이렇게 하면 Docker cache가 무력화되고 FROM 단계에서 반드시 새 이미지를 사용하게 된다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"sh"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-sh"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-sh"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# scripts/build-and-update-base.sh"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"#!/bin/bash"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"set"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"-e"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Timestamp 생성"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","assign-left","variable"]},"children":[{"type":"text","value":"TIMESTAMP"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$("}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"date"}]},{"type":"text","value":" +%Y%m%d-%H%M%S"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":")"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","assign-left","variable"]},"children":[{"type":"text","value":"VERSION_TAG"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"v"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${TIMESTAMP}"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ECR 정보"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","assign-left","variable"]},"children":[{"type":"text","value":"ECR_REGISTRY"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"[...].dkr.ecr.ap-northeast-2.amazonaws.com\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","assign-left","variable"]},"children":[{"type":"text","value":"IMAGE_NAME"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"common/playwright\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","assign-left","variable"]},"children":[{"type":"text","value":"FULL_IMAGE"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${ECR_REGISTRY}"}]},{"type":"text","value":"/"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${IMAGE_NAME}"}]},{"type":"text","value":":"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${VERSION_TAG}"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"🚀 Docker base 이미지 빌드 중...\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"   Version: "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${VERSION_TAG}"}]},{"type":"text","value":"\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Docker 빌드"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"docker"}]},{"type":"text","value":" build "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"-f"}]},{"type":"text","value":" ./docker/Dockerfile.base "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"-t"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${FULL_IMAGE}"}]},{"type":"text","value":"\""}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"--platform"}]},{"type":"text","value":" linux/amd64 "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n  --no-cache "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"✅ Docker 이미지 빌드 완료: "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${FULL_IMAGE}"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"\""}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"자동화 스크립트를 작성하고 package.json에서 명령어에 이 sh 파일을 실행시킨다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"json"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-json"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-json"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"docker.build-base:amd64\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"sh ./scripts/build-and-update-base.sh\""}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"하지만, GitHub Actions에서 도는 Dockerfile은 하드코딩으로 태그 값이 박혀있다. 조금 위험할 수도 있지만 이것도 자동화 해보자. Dockerfile FROM절에 방금 만든 timestamp로 태그 명을 대체하고 자동 commit을 생성하는 방법이다. 쉘 스크립트에 이어서 추가한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"sh"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-sh"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-sh"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# scripts/build-and-update-base.sh 이어서"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Dockerfile 업데이트"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","assign-left","variable"]},"children":[{"type":"text","value":"DOCKERFILE_PATH"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"./docker/Dockerfile\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"📝 "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${DOCKERFILE_PATH}"}]},{"type":"text","value":" 태그 업데이트 중...\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# FROM 절 업데이트 (sed를 사용하여 기존 태그를 새 버전으로 변경)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"if"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","environment","constant"]},"children":[{"type":"text","value":"$OSTYPE"}]},{"type":"text","value":"\""}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"=="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"darwin\""}]},{"type":"text","value":"* "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"then"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# macOS"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"sed"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"-i"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"''"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"s|FROM  "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${ECR_REGISTRY}"}]},{"type":"text","value":"/"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${IMAGE_NAME}"}]},{"type":"text","value":":.*AS base|FROM  "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${ECR_REGISTRY}"}]},{"type":"text","value":"/"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${IMAGE_NAME}"}]},{"type":"text","value":":"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${VERSION_TAG}"}]},{"type":"text","value":" AS base|g\""}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${DOCKERFILE_PATH}"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"else"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Linux"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"sed"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"-i"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"s|FROM  "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${ECR_REGISTRY}"}]},{"type":"text","value":"/"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${IMAGE_NAME}"}]},{"type":"text","value":":.*AS base|FROM  "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${ECR_REGISTRY}"}]},{"type":"text","value":"/"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${IMAGE_NAME}"}]},{"type":"text","value":":"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${VERSION_TAG}"}]},{"type":"text","value":" AS base|g\""}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${DOCKERFILE_PATH}"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"fi"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"✅ Dockerfile 업데이트 완료 (버전: "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${VERSION_TAG}"}]},{"type":"text","value":")\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Git commit"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"📦 변경사항 커밋 중...\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"git"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"add"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${DOCKERFILE_PATH}"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"git"}]},{"type":"text","value":" commit "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"-m"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"chore: bump version docker golden image "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${VERSION_TAG}"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"🎉 완료!\""}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이렇게 해주면 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"pnpm docker.build-base:amd64"}]},{"type":"text","value":" 한 줄로"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"playwright 최신 버전 이미지 pull"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Dockerfile.base에서 font, tz 등 작업"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"이미지 생성(태그 timestamp)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"ECR에서 pull 받아 작업할 Dockerfile FROM절에 timestamp 태깅"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Dockerfile commit"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"자동화가 완성되었다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"playwright-버전-자동화","style":"position:relative;"},"children":[{"type":"text","value":"playwright 버전 자동화"},{"type":"element","tagName":"a","properties":{"href":"#playwright-%EB%B2%84%EC%A0%84-%EC%9E%90%EB%8F%99%ED%99%94","ariaLabel":"playwright 버전 자동화 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"다시 돌아가보자. playwright가 1.47.1 버전이 취약함에 따라 버전 업데이트가 필요했고, 베이스 이미지도 업데이트가 필요했으므로 일일이 버전 업데이트를 진행해주어야 한다. 일일이 변경해주기보다, package.json에 playwright를 업데이트하면 그 버전 값을 보고 그 버전에 해당하는 playwright docker 이미지를 base로 하도록 하자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Dockerfile에서 ARG 를 이용해 외부에서 값을 받아올 수 있도록 하자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Dockerfile.base"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ARG"}]},{"type":"text","value":" PLAYWRIGHT_VERSION"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":" mcr.microsoft.com/playwright:v"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${PLAYWRIGHT_VERSION}"}]},{"type":"text","value":"-jammy"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ..."}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그리고 local docker image 빌드, ECR에 배포할 이미지 빌드시 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"--build-arg"}]},{"type":"text","value":" 에 playwright 버전 값을 넣어주도록 하자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"json"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-json"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-json"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"local-docker.build-base\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"docker build -f ./docker/Dockerfile.base -t application-base:local --build-arg PLAYWRIGHT_VERSION=$(node -p \\\"require('./package.json').dependencies.playwright\\\") .\""}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"$ node -p \"require('./package.json').dependencies.playwright\""}]},{"type":"text","value":" 로 package.json을 참조하도록 한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1052px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 7.3999999999999995%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAS0lEQVR42h3KSRKAIAwFUQ8jmhCgHHBMIQfw/uf5Rha96XpdzhWqL+K0wfECjgUkJ3qawUEhqYLC1XK8wqdiPeYUoxxm7ub+P/gdH+IIH0R8sEDLAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"node-p-reference","title":"","src":"/static/b0b165a161a14e1b5523aa078967f04d/8f870/node-p-reference.png","srcSet":["/static/b0b165a161a14e1b5523aa078967f04d/b30f8/node-p-reference.png 500w","/static/b0b165a161a14e1b5523aa078967f04d/332ff/node-p-reference.png 1000w","/static/b0b165a161a14e1b5523aa078967f04d/8f870/node-p-reference.png 1052w"],"sizes":"(max-width: 1052px) 100vw, 1052px","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy","decoding":"async"},"children":[]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이제 FE에서 npm playwright 패키지만 업데이트 하면 base 이미지는 자동으로 해당 버전에 맞는 이미지를 가져오도록 설정 되었다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"local-docker-image와-ECR에-배포할-base를-한-파일로","style":"position:relative;"},"children":[{"type":"text","value":"local docker image와 ECR에 배포할 base를 한 파일로"},{"type":"element","tagName":"a","properties":{"href":"#local-docker-image%EC%99%80-ECR%EC%97%90-%EB%B0%B0%ED%8F%AC%ED%95%A0-base%EB%A5%BC-%ED%95%9C-%ED%8C%8C%EC%9D%BC%EB%A1%9C","ariaLabel":"local docker image와 ECR에 배포할 base를 한 파일로 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"현재 local에서 테스트용 docker image, ECR에 배포할 base 이미지를 만드는 Dockerfile은 다르지만 내용은 동일하게 맞춰주어야 local에서 테스트하는 의미가 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"따라서, 아래와 같이 base 용 이미지 생성 Dockerfile과 어플리케이션 전용 Dockerfile만 나누어 진행하도록 하자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker/\n  ├── Dockerfile.base    # 공통 Base 이미지 - 로컬/프로덕션 모두 사용\n  ├── Dockerfile.local   # 로컬 테스트용 애플리케이션\n  └── Dockerfile         # 프로덕션용 애플리케이션"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"최종 Dockerfile이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Dockerfile.base"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ============================================"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 골든 베이스: Playwright + 폰트/타임존"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ============================================"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ARG"}]},{"type":"text","value":" PLAYWRIGHT_VERSION"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":" mcr.microsoft.com/playwright:v"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${PLAYWRIGHT_VERSION}"}]},{"type":"text","value":"-jammy"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# FROM 이후 ARG 재선언 (scope 유지)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ARG"}]},{"type":"text","value":" PLAYWRIGHT_VERSION"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"USER"}]},{"type":"text","value":" root"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" DEBIAN_FRONTEND=noninteractive"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" TZ=Asia/Seoul"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ARG 검증: PLAYWRIGHT_VERSION이 비어있으면 빌드 실패"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" test -n "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"${PLAYWRIGHT_VERSION}\""}]},{"type":"text","value":" || (echo "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"ERROR: PLAYWRIGHT_VERSION is required\""}]},{"type":"text","value":" && exit 1)"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 견고한 APT 패턴: HTTPS 미러, 인덱스 초기화, 재시도, 한 RUN에서 update→install→clean"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" set -eux; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 0) 미러 HTTPS로 고정"}]},{"type":"text","value":"\n    sed -i "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'s|http://archive.ubuntu.com|https://archive.ubuntu.com|g'"}]},{"type":"text","value":" /etc/apt/sources.list; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    sed -i "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'s|http://security.ubuntu.com|https://security.ubuntu.com|g'"}]},{"type":"text","value":" /etc/apt/sources.list; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 1) 인덱스 초기화 + 재시도 옵션"}]},{"type":"text","value":"\n    rm -rf /var/lib/apt/lists/*; mkdir -p /var/lib/apt/lists/partial; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    echo "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'Acquire::Retries \"5\";'"}]},{"type":"text","value":" > /etc/apt/apt.conf.d/80-retries; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 2) 타임존 사전 지정(프롬프트 방지)"}]},{"type":"text","value":"\n    ln -snf /usr/share/zoneinfo/"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$TZ"}]},{"type":"text","value":" /etc/localtime; echo "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"$TZ\""}]},{"type":"text","value":" > /etc/timezone; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 3) 업데이트"}]},{"type":"text","value":"\n    apt-get update -o Acquire::http::No-Cache=true -o Acquire::http::Pipeline-Depth=0; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 4) 필요한 패키지 일괄 설치(폰트 + tzdata + 인증서)"}]},{"type":"text","value":"\n    apt-get install -y --no-install-recommends "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n        fonts-noto-cjk "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n        fonts-noto-color-emoji "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n        tzdata "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n        ca-certificates "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    ; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 5) tzdata 재설정도 비대화식으로 강제"}]},{"type":"text","value":"\n    dpkg-reconfigure -f noninteractive tzdata; "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# 6) 클린업"}]},{"type":"text","value":"\n    rm -rf /var/lib/apt/lists/*"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"USER"}]},{"type":"text","value":" pwuser"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Dockerfile.local"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ============================================"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Application (Base 이미지 참조)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ============================================"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ARG"}]},{"type":"text","value":" BASE_IMAGE"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${BASE_IMAGE}"}]}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"WORKDIR"}]},{"type":"text","value":" /app"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"EXPOSE"}]},{"type":"text","value":" 3000"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" PORT=3000"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" HOST=0.0.0.0"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"COPY"}]},{"type":"text","value":" public ./public"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"COPY"}]},{"type":"text","value":" .next/standalone ./"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"COPY"}]},{"type":"text","value":" .next/static ./.next/static"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"USER"}]},{"type":"text","value":" root"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" mkdir -p .next/cache && chown -R pwuser:pwuser .next"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"USER"}]},{"type":"text","value":" pwuser"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENTRYPOINT"}]},{"type":"text","value":" ["},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"node\""}]},{"type":"text","value":", "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"server.js\""}]},{"type":"text","value":"]"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Dockerfile"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":"  [...].dkr.ecr.ap-northeast-2.amazonaws.com/common/playwright:v20205... "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"AS"}]},{"type":"text","value":" base"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"WORKDIR"}]},{"type":"text","value":" /app"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"EXPOSE"}]},{"type":"text","value":" 3000"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" PORT 3000"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" HOST 0.0.0.0"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"COPY"}]},{"type":"text","value":" public ./public"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"COPY"}]},{"type":"text","value":" .next/standalone ./"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"COPY"}]},{"type":"text","value":" .next/static ./.next/static"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"USER"}]},{"type":"text","value":" root"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" mkdir -p .next/cache && chown -R pwuser:pwuser .next"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"USER"}]},{"type":"text","value":" pwuser"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","instruction"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENTRYPOINT"}]},{"type":"text","value":" ["},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"node\""}]},{"type":"text","value":", "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"server.js\""}]},{"type":"text","value":"]"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"json"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-json"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-json"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// package.json"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"scripts\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"local-docker.build\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"env-cmd -f .env.local-docker next build\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"local-docker.build-base\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"docker build -f ./docker/Dockerfile.base -t application-base:local --build-arg PLAYWRIGHT_VERSION=$(node -p \\\"require('./package.json').dependencies.playwright\\\") .\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"local-docker.start\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"pnpm local-docker.build-base && pnpm local-docker.build && docker build -f ./docker/Dockerfile.local -t application-local:local --build-arg BASE_IMAGE=application-base:local . && docker run --rm -p 3000:3000 application-local:local\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"docker.build-base:amd64\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"sh ./scripts/build-and-update-base.sh\""}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# scripts/build-and-update-base.sh"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"#!/bin/bash"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"set"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"-e"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Timestamp 생성"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","assign-left","variable"]},"children":[{"type":"text","value":"TIMESTAMP"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$("}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"date"}]},{"type":"text","value":" +%Y%m%d-%H%M%S"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":")"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","assign-left","variable"]},"children":[{"type":"text","value":"VERSION_TAG"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"v"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${TIMESTAMP}"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ECR 정보"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","assign-left","variable"]},"children":[{"type":"text","value":"ECR_REGISTRY"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"[...].dkr.ecr.ap-northeast-2.amazonaws.com\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","assign-left","variable"]},"children":[{"type":"text","value":"IMAGE_NAME"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"common/playwright\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","assign-left","variable"]},"children":[{"type":"text","value":"FULL_IMAGE"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${ECR_REGISTRY}"}]},{"type":"text","value":"/"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${IMAGE_NAME}"}]},{"type":"text","value":":"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${VERSION_TAG}"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Playwright 버전 가져오기"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","assign-left","variable"]},"children":[{"type":"text","value":"PLAYWRIGHT_VERSION"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$("}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"node"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"-p"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"require('./package.json').dependencies.playwright\""}]},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":")"}]}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"🚀 Docker base 이미지 빌드 중...\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"   Version: "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${VERSION_TAG}"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"   Playwright: "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${PLAYWRIGHT_VERSION}"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Docker 빌드"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"docker"}]},{"type":"text","value":" build "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"-f"}]},{"type":"text","value":" ./docker/Dockerfile.base "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"-t"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${FULL_IMAGE}"}]},{"type":"text","value":"\""}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"--platform"}]},{"type":"text","value":" linux/amd64 "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n  --build-arg "},{"type":"element","tagName":"span","properties":{"className":["token","assign-left","variable"]},"children":[{"type":"text","value":"PLAYWRIGHT_VERSION"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${PLAYWRIGHT_VERSION}"}]},{"type":"text","value":"\""}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n  --no-cache "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"\\"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"✅ Docker 이미지 빌드 완료: "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${FULL_IMAGE}"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Dockerfile 업데이트"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","assign-left","variable"]},"children":[{"type":"text","value":"DOCKERFILE_PATH"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"./docker/Dockerfile\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"📝 "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${DOCKERFILE_PATH}"}]},{"type":"text","value":" 태그 업데이트 중...\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# FROM 절 업데이트 (sed를 사용하여 기존 태그를 새 버전으로 변경)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"if"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","environment","constant"]},"children":[{"type":"text","value":"$OSTYPE"}]},{"type":"text","value":"\""}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"=="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"darwin\""}]},{"type":"text","value":"* "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"then"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# macOS"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"sed"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"-i"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"''"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"s|FROM  "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${ECR_REGISTRY}"}]},{"type":"text","value":"/"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${IMAGE_NAME}"}]},{"type":"text","value":":.*AS base|FROM  "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${ECR_REGISTRY}"}]},{"type":"text","value":"/"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${IMAGE_NAME}"}]},{"type":"text","value":":"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${VERSION_TAG}"}]},{"type":"text","value":" AS base|g\""}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${DOCKERFILE_PATH}"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"else"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Linux"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"sed"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"-i"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"s|FROM  "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${ECR_REGISTRY}"}]},{"type":"text","value":"/"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${IMAGE_NAME}"}]},{"type":"text","value":":.*AS base|FROM  "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${ECR_REGISTRY}"}]},{"type":"text","value":"/"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${IMAGE_NAME}"}]},{"type":"text","value":":"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${VERSION_TAG}"}]},{"type":"text","value":" AS base|g\""}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${DOCKERFILE_PATH}"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"fi"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"✅ Dockerfile 업데이트 완료 (버전: "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${VERSION_TAG}"}]},{"type":"text","value":")\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Git commit"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"📦 변경사항 커밋 중...\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"git"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"add"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${DOCKERFILE_PATH}"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"git"}]},{"type":"text","value":" commit "},{"type":"element","tagName":"span","properties":{"className":["token","parameter","variable"]},"children":[{"type":"text","value":"-m"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"chore: bump version docker golden image "},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${VERSION_TAG}"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"🎉 완료!\""}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"마치며","style":"position:relative;"},"children":[{"type":"text","value":"마치며"},{"type":"element","tagName":"a","properties":{"href":"#%EB%A7%88%EC%B9%98%EB%A9%B0","ariaLabel":"마치며 permalink","className":["auto-link","after"]},"children":[{"type":"element","tagName":"svg","properties":{"viewBox":"0 0 16 16","width":"16","height":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"환경 통제에 관련한 부분은 쉽지 않은 것 같다. 환경이 서로 다르기 때문에 개발 결과물과 배포 시 결과물이 서로 다를 때는 어떤 부분을 어떻게 접근해야하는지 때로는 감이 오지 않는 경우가 많다. 이번 기회에 docker로 local에서 배포 환경과 최대한 비슷하게 환경을 맞추고 어떤 부분에서 문제가 생겼는지 디버깅 하면서 인프라에 대한 지식을 조금이나마 얻을 수 있었던 것 같다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"덤으로, 이 구조의 단점은 이미지가 크다는 점이다. local에서 확인하기 위해 만들어지는 이미지는 총 2개로, playwright base 이미지와 base 이미지에 Next.js 빌드 결과물을 COPY 한 이미지(application 이미지) 총 2가지인데, 각각 3.5GB, 3.79GB이다. 그리고 ECR에 push할 이미지는 802MB다. 이는 playwright의 이미지 자체가 alpine처럼 최소화 한 이미지가 아닌, ubuntu 기반의 이미지라서인데 "},{"type":"element","tagName":"a","properties":{"href":"https://playwright.dev/docs/docker#build-your-own-image","target":"_blank","rel":["nofollow"]},"children":[{"type":"text","value":"playwright 공식 문서에서 Docker 커스텀 이미지 생성 방법"}]},{"type":"text","value":"도 제안하고 있다. 단, Node.js, Playwight 브라우저 바이너리, OS 종속성을 직접 설치하는 방법이다. 이 방법을 통해 추후에 이미지 용량을 최적화해볼 수 있을 것 같다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그리고 작업을 하면서 Next.js가 동작할 Application 이미지에 굳이 playwright 용 이미지 위에 올릴 필요는 없겠다는 생각도 들었다. 지금이야 하나의 어플리케이션이 pod에 배포되는 구조이지만, PDF 렌더링만 담당하는 Node.js 서버를 따로 만들고 해당 서버에서 Next.js 페이지를 참조할 통로를 열고 Next.js -> Playwright PDF 렌더링 서버 -> Nest.js 리턴 하는 방법을 사용하면 서로를 격리시키면서 단일 책임만 가져가게끔 작업하면 좋겠다는 생각도 했다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그리고 build-and-update-base.sh에서 이미지 버전을 자동으로 commit을 남겨주는 방법을 사용한건 GitHub Actions를 최대한 건들이고 싶지 않았는데, 충분히 다른 방법을 통해 개선할 수 있을 것 같다. 예를 들면, GitHub Actions에서 BASE_IMAGE_TAG를 입력값/환경변수로 받아 Dockerfile을 건드리지 않고 빌드하도록 만드는 방법이 있을 것 같다."}]}],"data":{"quirksMode":false}},"excerpt":"PDF를 유저에게 보여줘야 하는 일이 생겼다. PDF 생성은 전통적인 방법으로 SpringBoot의 라이브러리(OpenHTMLtoPDF등)를 사용해 서버에서 생성하는 방법이 있다. 하지만, 유저에게 보여주어야 할 PDF…","fields":{"readingTime":{"text":"21 min read"},"createdAt":"2025-12-13","modifiedAt":null},"frontmatter":{"title":"Playwright PDF 생성 환경을 로컬에서 재현하기 (with Next.js)","userDate":"13 December 2025","createdAt":"2025-12-13","tags":["Infrastructure","Docker","Playwright"],"excerpt":"로컬과 배포 환경 차이로 깨지던 Playwright PDF를, Docker 기반 환경 통제로 재현·안정화한 과정 정리","photoAuthor":"Shubham Dhage>>https://unsplash.com/ko/@theshubhamdhage>>true","photoVender":"Unsplash>>https://unsplash.com","image":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/webp;base64,UklGRqwAAABXRUJQVlA4IKAAAAAQBACdASoUAAsAPm0qkUWkIqGYBABABsSgCdAYw61bS/YRfeeJuMdAAAD++vgTrYPnqteIiXOdoeneNNQtSXBJ9v+Z4eAUc+KxOyIY4Maf7CadQU7SfY2M6bYpmUZy46AWXEPq8YwLNk/R6gd9eq/7N8nqj+HOyYqRJ+drSRVCdsai03zbYcH4VT5i7BLj7/ITeZTY+AJ6ABOH0Ad2sAAA"},"images":{"fallback":{"src":"/static/9990ba7500d931bbb6c858b0a5da1e77/63766/main.webp","srcSet":"/static/9990ba7500d931bbb6c858b0a5da1e77/d4cbf/main.webp 500w,\n/static/9990ba7500d931bbb6c858b0a5da1e77/03a08/main.webp 800w,\n/static/9990ba7500d931bbb6c858b0a5da1e77/63766/main.webp 1170w","sizes":"100vw"},"sources":[{"srcSet":"/static/9990ba7500d931bbb6c858b0a5da1e77/b400f/main.avif 500w,\n/static/9990ba7500d931bbb6c858b0a5da1e77/4ec68/main.avif 800w,\n/static/9990ba7500d931bbb6c858b0a5da1e77/d4b7e/main.avif 1170w","type":"image/avif","sizes":"100vw"}]},"width":1,"height":0.5623931623931624}}},"author":[{"name":"Pozafly","bio":"Frontend Developer","avatar":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","backgroundColor":"#6808f8","images":{"fallback":{"src":"/static/8c061761f263c344f2c0416607c8adf1/b9493/pozafly.jpg","srcSet":"/static/8c061761f263c344f2c0416607c8adf1/5e3dc/pozafly.jpg 40w,\n/static/8c061761f263c344f2c0416607c8adf1/d18de/pozafly.jpg 80w,\n/static/8c061761f263c344f2c0416607c8adf1/b9493/pozafly.jpg 120w","sizes":"100vw"},"sources":[{"srcSet":"/static/8c061761f263c344f2c0416607c8adf1/ae5f4/pozafly.webp 40w,\n/static/8c061761f263c344f2c0416607c8adf1/87ddd/pozafly.webp 80w,\n/static/8c061761f263c344f2c0416607c8adf1/2988d/pozafly.webp 120w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":1}}}}]}},"relatedPosts":{"totalCount":2,"edges":[{"node":{"id":"27c6080f-b471-57d0-a912-b21f4c30dda2","excerpt":"PDF를 유저에게 보여줘야 하는 일이 생겼다. PDF 생성은 전통적인 방법으로 SpringBoot의 라이브러리(OpenHTMLtoPDF등)를 사용해 서버에서 생성하는 방법이 있다. 하지만, 유저에게 보여주어야 할 PDF…","frontmatter":{"title":"Playwright PDF 생성 환경을 로컬에서 재현하기 (with Next.js)","createdAt":"2025-12-13"},"fields":{"readingTime":{"text":"21 min read"},"slug":"/infrastructure/reproducing-playwright-pdf-env-using-docker-with-nextjs/","modifiedAt":null}}},{"node":{"id":"ec758f9a-0a7f-5d98-8c48-7f3ce3f78621","excerpt":"Next.js를 실행하면 클라이언트 측 로그는 브라우저의 콘솔에 나타나지만, 서버 측 로그는 제대로 된 로그를 출력해주지 않았다. 이번에 프로젝트에 Next.js의 node 환경에서 log…","frontmatter":{"title":"Next.js standalone 종속성 추적 삽질기 (feat. pino)","createdAt":"2025-09-12"},"fields":{"readingTime":{"text":"13 min read"},"slug":"/nextjs/nextjs-standalone-dependency-tracing-issue/","modifiedAt":null}}}]}},"pageContext":{"slug":"/infrastructure/reproducing-playwright-pdf-env-using-docker-with-nextjs/","prev":null,"next":{"excerpt":"Next.js를 실행하면 클라이언트 측 로그는 브라우저의 콘솔에 나타나지만, 서버 측 로그는 제대로 된 로그를 출력해주지 않았다. 이번에 프로젝트에 Next.js의 node 환경에서 log…","frontmatter":{"title":"Next.js standalone 종속성 추적 삽질기 (feat. pino)","tags":["Next.js","Infrastructure"],"createdAt":"2025-09-12","draft":false,"photoAuthor":"Logan Voss>>https://unsplash.com/ko/@loganvoss","photoVender":"Unsplash>>https://unsplash.com","excerpt":"Next.js를 standalone 모드로 빌드하면서 종속성 누락 문제를 겪었다. @vercel/nft의 정적 추적 방식, pnpm의 심볼릭 링크 구조, 그리고 pino-pretty를 포함해 종속성이 빠지는 이유와 해결 과정을 기록한다.","image":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIDBQb/xAAXAQADAQAAAAAAAAAAAAAAAAABAwQF/9oADAMBAAIQAxAAAAHLjx3ZaFkFf//EABsQAAICAwEAAAAAAAAAAAAAAAECAAMREhQh/9oACAEBAAEFAnPpxLKyWM2PeyKZ/8QAGREBAAIDAAAAAAAAAAAAAAAAAQARAyFR/9oACAEDAQE/AQsvkM+p/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAEDITH/2gAIAQIBAT8BwcNn/8QAHBAAAgIDAQEAAAAAAAAAAAAAAAERIgIhYTFB/9oACAEBAAY/AvkrRaxL2+GXGxYTWBN+n//EAB0QAQEAAgEFAAAAAAAAAAAAAAERACFRMXGx8PH/2gAIAQEAAT8hQSRqcHvOJg1Xj7iMcnQnepcnQqo9rk0NG4pn/9oADAMBAAIAAwAAABAk3//EABoRAQACAwEAAAAAAAAAAAAAAAEAEUGBkfD/2gAIAQMBAT8QsBgvIYC325//xAAaEQEAAgMBAAAAAAAAAAAAAAABABEhMaHw/9oACAECAQE/EEtnShGtXuT/xAAdEAEAAgICAwAAAAAAAAAAAAABETEAIVFhQXGR/9oACAEBAAE/EHrGtYOYOz0hMlN9gGSoMzSG+omMYigShQ1UmEShCIkAdarWAQjFuFX5d/KrF4U1SjU6eAz/2Q=="},"images":{"fallback":{"src":"/static/0152e08f5e4324b47115749c8231fdb1/a464d/main.jpg","srcSet":"/static/0152e08f5e4324b47115749c8231fdb1/796f4/main.jpg 750w,\n/static/0152e08f5e4324b47115749c8231fdb1/8d2a5/main.jpg 1080w,\n/static/0152e08f5e4324b47115749c8231fdb1/91332/main.jpg 1366w,\n/static/0152e08f5e4324b47115749c8231fdb1/a464d/main.jpg 1920w","sizes":"100vw"},"sources":[{"srcSet":"/static/0152e08f5e4324b47115749c8231fdb1/d704a/main.webp 750w,\n/static/0152e08f5e4324b47115749c8231fdb1/b21f9/main.webp 1080w,\n/static/0152e08f5e4324b47115749c8231fdb1/4094c/main.webp 1366w,\n/static/0152e08f5e4324b47115749c8231fdb1/91943/main.webp 1920w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.5625}}}},"fields":{"readingTime":{"text":"13 min read"},"layout":"post","slug":"/nextjs/nextjs-standalone-dependency-tracing-issue/","modifiedAt":null}},"primaryTag":"Infrastructure"}},"staticQueryHashes":["1661920220"],"slicesMap":{}}