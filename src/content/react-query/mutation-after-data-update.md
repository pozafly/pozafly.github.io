---
layout: post
title: 'React Queryμ—μ„ mutation μ΄ν›„ λ°μ΄ν„°λ¥Ό μ—…λ°μ΄νΈν•λ” 4κ°€μ§€ λ°©λ²•'
author: [Pozafly]
tags: [React-Query, React]
date: '2023-07-02'
image: ../img/react-query/mutation-after-data-update/main.webp
draft: false
excerpt: React Queryμ mutation μ‹¤ν–‰ μ΄ν›„ ν΄λΌμ΄μ–ΈνΈμ μ„λ²„ λ°μ΄ν„°λ” λ³€κ²½ λμ§€ μ•μ€ μƒνƒμ΄λ‹¤. ν™”λ©΄μ„ μ—…λ°μ΄νΈ ν•λ” μ—¬λ¬ κ°€μ§€ λ°©λ²•μ„ μ•μ•„λ³΄λ©΄μ„, μ–΄λ–¤ μƒν™©μ—μ„ μ–΄λ–¤ λ°©λ²•μ„ μ‚¬μ©ν•΄μ•Ό ν•λ”μ§€ μ•μ•„λ³΄μ.
---

React Queryλ” λ°μ΄ν„° fetching λΌμ΄λΈλ¬λ¦¬λ΅ μ†κ°λμ§€λ§, **μ„λ²„ μƒνƒ κ°€μ Έμ¤κΈ°, μΊμ‹±, λ™κΈ°ν™” λ° μ—…λ°μ΄νΈ**λ¥Ό μ‰½κ²ν•  μ μλ” λΌμ΄λΈλ¬λ¦¬λ‹¤. μ¦‰, React Queryλ¥Ό μ‚¬μ©ν•λ”λΌλ„ μ‹¤μ  API μ”μ²­μ„ λ³΄λ‚΄λ” κ²ƒμ€ Axios λΌμ΄λΈλ¬λ¦¬ νΉμ€ fetch ν•¨μλ¥Ό μ‚¬μ©ν•΄μ•Όν•λ‹¤.

λ€λ¶€λ¶„μ μƒνƒ κ΄€λ¦¬ λΌμ΄λΈλ¬λ¦¬λ” ν΄λΌμ΄μ–ΈνΈ μƒνƒ μ‘μ—…μ—λ” μ ν•©ν•μ§€λ§, λΉ„λ™κΈ° λλ” μ„λ²„ μƒνƒ μ‘μ—…μ—λ” μ ν•©ν•μ§€ μ•λ‹¤. μ„λ²„ μƒνƒκ°€ μ™„μ „ν λ‹¤λ¥΄κΈ° λ•λ¬Έμ΄λ‹¤.

React Queryμ μ‚¬μ© λ©μ μ€, ν…λ§λ‚ UI λ“±μ μ–΄ν”λ¦¬μΌ€μ΄μ…μ—μ„λ§ ν•„μ”ν• λ°μ΄ν„°λ¥Ό Client Stateλ΅ κ·μ •μ§“κ³ , μ„λ²„μ—μ„ λ°›μ•„μ¤λ” λ°μ΄ν„°λ¥Ό Server Stateλ΅ κ·μ •μ§€μ–΄ ν΄λΌμ΄μ–ΈνΈ μƒνƒμ™€, μ„λ²„ μƒνƒλ¥Ό λ‚λ„μ–΄μ„ μƒκ°ν•  μ μλ„λ΅ λ„μ™€μ£ΌκΈ° λ•λ¬Έμ— μ‚¬μ©ν•λ‹¤. React Queryλ” μ„λ²„ λ°μ΄ν„°λ¥Ό μ λ‹¤λ£° μ μλ„λ΅, λ°›μ•„μ¨ μ„λ²„ λ°μ΄ν„°λ¥Ό μΊμ‹±ν•΄μ£ΌκΈ°λ„ ν•λ©° λΈλΌμ°μ € μ°½μ„ λ‹¤μ‹ ν¬μ»¤μ¤λ¥Ό λ§μ¶”μ—μ„ λ• λλ” μ”μ²­ μ‹ μ¤λ¥κ°€ λ°μƒν–μ„ λ• μ΄ν›„μ—, APIλ¥Ό μ¬μ΅°ν ν•  μ μλ” μΆ‹μ€ μµμ…μ„ κ°€μ§€κ³  μλ‹¤.

<br />

## mutation

React Queryμ μ„λ²„ λ°μ΄ν„° κ΄€λ ¨ μ¤‘μ” μ»¨μ…‰ μ¤‘ ν•λ‚λ”, μ„λ²„ λ°μ΄ν„°λ¥Ό μ΅°νν•κ³  μ„λ²„ λ°μ΄ν„°λ¥Ό κ°€κ³µν•λ” κ°λ…μ„ λ‚λ„μ–΄ μ‚¬μ©ν•λ„λ΅ ν•λ‹¤λ” κ²ƒμ΄λ‹¤. `query` λ” μ„λ²„ λ°μ΄ν„°λ¥Ό **μ΅°ν**(GET)ν•  μ μλ‹¤. `useQuery` ν›…μ„ μ‚¬μ©ν•λ‹¤. `mutation` μ€ queryμ™€ λ‹¤λ¥΄κ² **μƒμ„±**(POST), **μμ •**(PUT or PATCH), **μ‚­μ **(DELETE)μ™€ κ°™μ€ λ°μ΄ν„°λ¥Ό λ³€κ²½ν•λ” μ‘μ—…μ„ ν•  μ μλ„λ΅ ν•λ” ν•¨μλ‹¤. `useMutation` ν›…μ„ μ‚¬μ©ν•λ‹¤.

### μ™ queryμ™€ mutationμ„ λ”°λ΅ λ‚λ„μ–΄λ†¨μ„κΉ?

μ°μ„  μ©μ–΄λ¶€ν„° μ•μ•„λ³΄μ. mutationμ΄λ€, 'λμ—°λ³€μ΄' νΉμ€ 'λ³€ν•'μ΄λΌλ” λ»μ„ κ°€μ§€κ³  μλ‹¤. 'κ°€λ³€'μ΄λΌκ³  λ¶λ¦¬κΈ°λ„ ν•λ‹¤. ν”„λ΅κ·Έλλ° μ„Έκ³„μ—μ„ mutationμ€ μ‚¬μ΄λ“ μ΄ν™νΈλ¥Ό μΌμΌν‚¤λ” λ°©λ²•μ΄λ‹¤. ([λ§ν¬](https://en.wikibooks.org/wiki/Scheme_Programming/Mutability)) λ°μ΄ν„°λ¥Ό λ³€κ²½μ‹ν‚¤λ” κ²ƒμ€ μ‚¬μ΄λ“ μ΄ν™νΈλ¥Ό μΌμΌν‚¤λ©° λ°μ΄ν„°μ μ¶”μ μ„ μ–΄λ µκ² λ§λ“ λ‹¤. ν•μ§€λ§ μ‚¬μ΄λ“ μ΄ν™νΈκ°€ μΌμ–΄λ‚λ‹¤κ³  ν•΄μ„ λ°μ΄ν„°λ¥Ό λ³€κ²½μ‹μΌμ„λ” μ•λλ‹¤λ” λ§μ€ μ•„λ‹λ‹¤. ν΄λΌμ΄μ–ΈνΈ λ° μ„λ²„μ—μ„ λ‹¤λ£¨λ” λ°μ΄ν„°λ” λ³€κ²½μ΄ μΌμ–΄λ‚μ•Όν•κ³ , λ³€κ²½μ΄ μΌμ–΄λ‚μ•Ό μλ―Έμλ” λ°μ΄ν„°κ°€ μ™„μ„±λλ‹¤.

λ°λ©΄, λ°μ΄ν„°λ¥Ό μ΅°νν•λ” κ²ƒμ€ μ‚¬μ΄λ“ μ΄ν™νΈλ¥Ό λ°μƒμ‹ν‚¤μ§€ μ•λ”λ‹¤. React Queryλ” μ΄ λ‘μ κ°λ…μ„ λ‚λ„κ³ , μ‚¬μ©ν•λ” λ°©λ²•λ„ λ‹¤λ¥΄κ² κµ¬μ„±ν•΄λ‘μ—λ‹¤. queryλ” μ„ μ–Έμ μΌλ΅ μ‚¬μ©ν•  μ μμΌλ©°, mutationμ€ λ…λ Ήν•μΌλ΅ λ°–μ— μ‚¬μ©ν•μ§€ μ•λ„λ΅ λ§μ΄λ‹¤.

```tsx
export function App() {
  // λ§μ΄νΈ μ¦‰μ‹ μ„λ²„μ™€ ν†µμ‹  ν›„ λ°μ΄ν„°λ¥Ό λ°›μ•„μ΄. μ„ μ–Έμ .
  const { data } = useQuery({ queryKey: ['todos'], queryFn: getTodos });

  // λ®¤ν…μ΄μ… κ°μ²΄λ¥Ό λ¨Όμ € μƒμ„± ν›„ μ΄λ²¤νΈκ°€ μΌμ–΄λ‚¬μ„ λ• μ‚¬μ©ν•¨. λ…λ Ήμ .
  const mutation = useMutation({ mutationFn: updateTodos });

  return (
    <>
      {data.something}
      {/* μ΄λ²¤νΈ λ°μƒ μ‹ μ‚¬μ© */}
      <button onClick={() => mutation.mutate({ something: 'some' })}></button>
    </>
  );
}
```

queryλ” μ»΄ν¬λ„νΈκ°€ λ§μ΄νΈ λ  λ• μ¦‰μ‹ μ‹¤ν–‰λμ–΄ μ„λ²„μ—μ„ λ°μ΄ν„°λ¥Ό κ°€μ Έμ¨λ‹¤. ν›…μΌλ΅ μ„ μ–Έλ§ ν•΄λ‘λ©΄ μ•μ•„μ„ λ°μ΄ν„°λ¥Ό μ΅°νν•λ‹¤.

ν•μ§€λ§ mutationμ€ μ„λ²„ λ°μ΄ν„°λ¥Ό λ³€ν•μ‹ν‚¤λ” κ²ƒμ΄κΈ° λ•λ¬Έμ—, μΌλ°μ μΌλ΅ μ»΄ν¬λ„νΈκ°€ λ§μ΄νΈ λ  λ• μ‹¤ν–‰λλ©΄ μ•λλ‹¤. μ»΄ν¬λ„νΈκ°€ λ§μ΄νΈ λμλ§μ λ¬Όκ±΄μ΄ κ²°μ κ°€ λλ©΄ μ΄μƒν•λ“―μ΄ λ§μ΄λ‹¤. λ€μ‹ , useMutation ν›…μ„ μ‚¬μ©ν•΄ mutation κ°μ²΄λ¥Ό κ°€μ Έμ¤κ³ , λ…λ Ήμ μΌλ΅ ν•„μ”ν•  λ• νΈμ¶ν•λ„λ΅ ν•κ³  μλ‹¤.

λ”°λΌμ„ queryλ” μ‚¬μ΄λ“ μ΄ν™νΈλ¥Ό λ°μƒμ‹ν‚¤μ§€ μ•μΌλ©°, μ„ μ–Έμ μΌλ΅ μ‚¬μ©ν•  μ μκ³ , mutationμ€ μ‚¬μ΄λ“ μ΄ν™νΈλ¥Ό λ°μƒμ‹ν‚¬ μ μμΌλ©°, λ…λ Ήν•μΌλ΅ μ‚¬μ©ν•  μ μλ‹¤. React Queryλ” μ΄λ° μ°¨μ΄μ  λ•λ¬Έμ— λ‘μ„ λ‚λ„μ–΄ μ‚¬μ©ν•λ„λ΅ ν–λ‹¤.

<br />

## mutation μ΄ν›„ λ™μ‘

mutationμ΄ μ‹¤ν–‰λ μ΄ν›„ μ„λ²„μ λ°μ΄ν„°λ” λ³€κ²½λμ—μ§€λ§(μ. μ„λ²„μ DB λ°μ΄ν„° λ³€κ²½), React Queryμ mutation μ‹¤ν–‰ μ΄ν›„ ν΄λΌμ΄μ–ΈνΈμ μ„λ²„ λ°μ΄ν„°λ” λ³€κ²½ λμ§€ μ•μ€ μƒνƒμ΄λ‹¤. ν™”λ©΄μ„ μ—…λ°μ΄νΈ ν•λ” μ—¬λ¬ κ°€μ§€ λ°©λ²•μ„ μ•μ•„λ³΄λ©΄μ„, μ–΄λ–¤ μƒν™©μ—μ„ μ–΄λ–¤ λ°©λ²•μ„ μ‚¬μ©ν•΄μ•Ό ν•λ”μ§€ μ•μ•„λ³΄μ. ν΄λΌμ΄μ–ΈνΈμ μ„λ²„ λ°μ΄ν„°λΌν•¨μ€, queryλ΅ μ΅°νν•΄μ¨ μ„λ²„ λ°μ΄ν„°κ°€ ν΄λΌμ΄μ–ΈνΈμ μƒνƒλ΅ λ„μ–΄μ¨ κ²ƒμ„ λ§ν•λ‹¤. ν΄λΌμ΄μ–ΈνΈλ΅ λ„μ–΄μ¨ μ„λ²„ λ°μ΄ν„° κΈ°μ¤€μΌλ΅ ν™”λ©΄μ„ κ·Έλ ¤μ¤„ μ μλ‹¤.

> π“ ν΄λΌμ΄μ–ΈνΈμ μ„λ²„ λ°μ΄ν„°λ” μ²μ λ§ν–λ ν΄λΌμ΄μ–ΈνΈ λ°μ΄ν„°(ui νΉμ€ themeμ™€ κ°™μ€)μ™€λ” λ‹¤λ¥΄λ‹¤. μ΄μ  μ•„λμ—μ„ λ§ν•λ” ν΄λΌμ΄μ–ΈνΈ λ°μ΄ν„°λ€, μ„λ²„μ—μ„ ν΄λΌμ΄μ–ΈνΈλ΅ λ°›μ•„μ¨ μ„λ²„ λ°μ΄ν„°λ¥Ό λ§ν•λ‹¤.

μ•„λμ μμ‹λ“¤μ€ delete κΈ°μ¤€μΌλ΅ mutation μ΄ν›„ μ–΄λ–»κ² ν™”λ©΄μ— λ°μ΄ν„°κ°€ μ—…λ°μ΄νΈ λλ”μ§€λ¥Ό μ„¤λ…ν•λ‹¤. React Queryκ°€ μ κ³µν•λ” useMutation ν›…μ„ ν†µν•΄ mutationμ„ ν•  μ μλ‹¤.

```ts
export const useDeleteDoc = () => {
  return useMutation<DriveFile | string, AxiosError, string>({
    mutationKey: [DIARY_KEY],
    mutationFn: (fileId: string) => deleteDoc(fileId),
  });
};
```

- `mutationKey` : mutationμ„ μ‹λ³„ν•  μ μκ³ , ν›„μ— `useIsMutating` ν›…μ„ ν†µν•΄ mutation μ¤‘μΈ μ‘μ—…μ„ λ΅λ”© μ¤ν”Όλ„λ΅ μ‚¬μ©μμ—κ² λ°μ΄ν„°λ¥Ό μ²λ¦¬ν•κ³  μλ‹¤λ” ν‘μ‹λ¥Ό μ¤„ μμλ‹¤.
- `mutationFn` : axiosλ‚ fetch ν•¨μλ¥Ό μ‚¬μ©ν•΄ μ„λ²„μ— API μ”μ²­μ„ λ³΄λ‚΄λ” ν•¨μκ°€ μ‹¤ν–‰λλ‹¤.

β€» useMutation ν›…μ typeμ€ [react-queryμ— typescript μ μ©ν•κΈ°](https://gusrb3164.github.io/web/2022/01/23/react-query-typescript/)λ¥Ό μ°Έκ³ ν–λ‹¤.

ν•μ§€λ§, μ„ μ‘μ—…μ€ λ‹¨μ§€ μ„λ²„μ— APIλ¥Ό λ³΄λ‚΄κ³  μ„λ²„μ— μ΅΄μ¬ν•λ” λ°μ΄ν„°λ¥Ό λ³€κ²½ν•  λΏ, ν΄λΌμ΄μ–ΈνΈμ λ°μ΄ν„°λ¥Ό λ³€κ²½μ‹μΌμ£Όμ§€ μ•λ”λ‹¤. λ¬Όλ΅  ν΄λΌμ΄μ–ΈνΈμ λ°μ΄ν„°κ°€ λ³€ν•μ§€ μ•μ•κΈ° λ•λ¬Έμ— ν™”λ©΄μ΄ λ³€κ²½λμ§€λ„ μ•λ”λ‹¤. λ³€κ²½λ λ°μ΄ν„°λ¥Ό λ‹¤μ‹ ν™”λ©΄μ— ν‘μ‹ν•λ ¤λ©΄ μ¶”κ°€μ μΈ μ‘μ—…μ΄ ν•„μ”ν•λ‹¤.

1. **μ„λ²„μ—μ„** μ΅°νν• λ°μ΄ν„°λ΅ ν΄λΌμ΄μ–ΈνΈ λ°μ΄ν„° μ—…λ°μ΄νΈ
2. **ν΄λΌμ΄μ–ΈνΈμ—μ„** μ”μ²­ λ°μ΄ν„°λ΅ μ μ©

<br />

## 1. μ„λ²„μ—μ„ μ΅°νν• λ°μ΄ν„°λ΅ ν΄λΌμ΄μ–ΈνΈ λ°μ΄ν„° μ—…λ°μ΄νΈ

ν΄λΌμ΄μ–ΈνΈκ°€ μ„λ²„μ— λ°μ΄ν„°λ¥Ό μ”μ²­ν• ν›„ λ³€κ²½λ λ°μ΄ν„°λ¥Ό λ°›μ•„μ™€μ„ ν΄λΌμ΄μ–ΈνΈ λ°μ΄ν„°λ¥Ό μ—…λ°μ΄νΈ ν•λ” λ°©λ²•μ΄λ‹¤.

- responseμ— λ³€κ²½λ λ°μ΄ν„°λ¥Ό λ°›λ” λ°©λ²• (setQueryData)
- μ”μ²­ μ„±κ³µ ν›„ μ¬μ΅°νλ¥Ό ν†µν•΄ λ°μ΄ν„°λ¥Ό λ°›λ” λ°©λ²• (invalidateQueries)

### 1.1 responseμ— λ³€κ²½λ λ°μ΄ν„° λ°›κΈ° (setQueryData)

`setQueryData` λ” useQueryλ΅ μ΅°νλ λ°μ΄ν„°κ°€ μΊμ‹μ— λ“¤μ–΄μμ„ κ²½μ°, μΊμ‹μ μ΅°ν λ°μ΄ν„°λ¥Ό μ—…λ°μ΄νΈ ν•΄μ¤„ μ μλ” λ©”μ„λ“λ‹¤. reduxλ΅ μƒκ°ν•΄λ΄¤μ„ λ•, storeμ— μλ” μƒνƒ κ°’μ„ λ³€κ²½μ‹μΌμ¤„ μ μλ” ν•¨μλ‹¤. mutationμ—μ„λ” μ•„λμ™€ κ°™μ΄ μ‚¬μ©ν•  μ μλ‹¤.

```ts{5-7}
export const useDeleteDoc = () => {
  return useMutation<DriveFile | string, AxiosError, string>({
    mutationKey: [DIARY_KEY],
    mutationFn: (fileId: string) => deleteDoc(fileId),
    onSuccess(data) {
      queryClient.setQueryData<DriveFile>([DIARY_KEY, 'docList'], data);
    },
  });
};
```

`onSuccess` λ©”μ„λ“μ κ²½μ° mutationμ΄ μ„±κ³µμ μΌλ΅ μ™„λ£λλ©΄ νΈμ¶λλ” λ©”μ„λ“λ‹¤. μ΄ 3κ°μ μΈμλ¥Ό λ°›μ„ μ μλ”λ°, κ·Έ μ¤‘ μ²« λ²μ§Έλ” μ„λ²„μ—μ„ λ°ν™λ dataλ¥Ό μΈμλ΅ λ°›μ•„μ¬ μ μλ‹¤.

μ΄ λ°©λ²•μ„ μ‚¬μ©ν•κΈ° μ„ν•΄μ„λ”, μ„λ²„κ°€ ν΄λΌμ΄μ–ΈνΈ μ”μ²­μ— λ”°λΌ μμ‹ μ λ°μ΄ν„°λ¥Ό μ—…λ°μ΄νΈ ν• ν›„, **μ—…λ°μ΄νΈ λ λ°μ΄ν„°λ¥Ό λ°λ“μ‹ ν΄λΌμ΄μ–ΈνΈμ—κ² μμ •λ λ°μ΄ν„°λ¥Ό λ‚΄λ ¤**μ£Όμ–΄μ•Όλ§ ν•λ‹¤. μμ •λ λ°μ΄ν„°κ°€ ν΄λΌμ΄μ–ΈνΈμ μΊμ‹ λ°μ΄ν„°μ— μƒλ΅­κ² λ“¤μ–΄κ°€κ² λκ³ , μ΄λ” λ°λ“μ‹ μ„λ²„ μΈ΅μ΄ λ°μ΄ν„° μ²λ¦¬ μ‘μ—… ν›„ μ²λ¦¬λ λ°μ΄ν„°λ¥Ό responseμ— λ‹΄μ•„ ν΄λΌμ΄μ–ΈνΈμ— μ „μ†΅ν•΄μ•Ό ν•λ‹¤.

λ°μ΄ν„° νλ¦„μ€ μ•„λμ™€ κ°™λ‹¤.

- `ν΄λΌμ΄μ–ΈνΈ -> μ„λ²„` : λ°μ΄ν„° λ³€κ²½ μ”μ²­
- `μ„λ²„` : DB μΈμ¤ν„΄μ¤μ— λ°μ΄ν„° λ³€κ²½
- `μ„λ²„ -> ν΄λΌμ΄μ–ΈνΈ` : λ³€κ²½λ λ°μ΄ν„° λ°ν™

### 1.2 μ¬μ΅°ν (invalidateQueries)

ν•μ§€λ§, μ„λ²„μ—μ„ λ³€κ²½λ λ°μ΄ν„°λ¥Ό λ‚΄λ ¤μ£Όμ§€ μ•μ„ μλ„ μλ‹¤. κ·Έλ¬λ©΄, ν΄λΌμ΄μ–ΈνΈμ—μ„λ” μ„λ²„μ— λ³€κ²½λ λ°μ΄ν„°λ¥Ό λ‹¤μ‹ μ΅°νν•΄μ„ λ¬Έμ λ¥Ό ν•΄κ²°ν•  μ μλ‹¤. μ¦‰, ν΄λΌμ΄μ–ΈνΈλ” μμ„μ— λ§κ² μ„λ²„μ— λ°μ΄ν„° λ³€κ²½ μ”μ²­μ„ ν•κ³ , μ¬μ΅°ν μ”μ²­μ„ ν•΄μ„ μ›ν•λ” κ²°κ³Όλ¥Ό μ–»λ” κ²ƒμ΄λ‹¤.

μ„λ²„μ—μ„ μ¬μ΅°ν ν•λ” λ°©λ²•μ€, `queryClient.invalidateQueries` λ©”μ„λ“λ¥Ό ν†µν•΄ ν•  μ μλ‹¤.

```ts{8}
export const useDeleteDoc = () => {
  const queryClient = useQueryClient(); // queryClientλ¥Ό κ°€μ Έμ™€μ•Ό ν•¨

  return useMutation<DriveFile | string, AxiosError, string>({
    mutationKey: [DIARY_KEY],
    mutationFn: (fileId: string) => deleteDoc(fileId),
    onSuccess(data) {
      queryClient.invalidateQueries({ queryKey: [DIARY_KEY] });
    },
  });
};
```

`onSuccess` λ©”μ„λ“λ¥Ό μƒμ„±ν•κ³ , λ¶λ¬μ¨ queryClientλ¥Ό ν†µν•΄ `invlidateQueries` λ©”μ„λ“λ¥Ό μΏΌλ¦¬ν‚¤μ™€ ν•¨κ» νΈμ¶ν•λ©΄, κΈ°μ΅΄μ— useQueryλ΅ μ΅°νν•΄μ¨ λ°μ΄ν„°κ°€ λ‹¤μ‹ μ΅°νκ°€ λλ©΄μ„ κΈ°μ΅΄ λ°μ΄ν„°κ°€ λ³€κ²½λλ‹¤.

λ°μ΄ν„° νλ¦„μ€ μ•„λμ™€ κ°™λ‹¤.

- `ν΄λΌμ΄μ–ΈνΈ -> μ„λ²„` : λ°μ΄ν„° λ³€κ²½ μ”μ²­
- `μ„λ²„ -> DB` : DBμ— λ°μ΄ν„° λ³€κ²½
- `μ„λ²„ -> ν΄λΌμ΄μ–ΈνΈ` : **μ„±κ³µ message** λ°ν™
- `ν΄λΌμ΄μ–ΈνΈ -> μ„λ²„` : λ³€κ²½λ λ°μ΄ν„° μ΅°ν μ”μ²­
- `μ„λ²„ -> DB` : DBμ— λ°μ΄ν„° μ΅°ν
- `μ„λ²„ -> ν΄λΌμ΄μ–ΈνΈ` : **λ³€κ²½λ λ°μ΄ν„°** λ°ν™

![invalidate-queries](../img/react-query/mutation-after-data-update/invalidate-queries.png)

λ„¤νΈμ›ν¬ νƒ­μ„ λ³΄λ©΄, μ‚­μ  μ”μ²­μ΄ μ™„λ£λ μ¦‰μ‹ μ΅°ν μ”μ²­μ΄ κ°„ κ²ƒμ„ λ³Ό μ μλ‹¤. μ΄ λ°©μ‹μ„ μ‚¬μ©ν•  κ²½μ°, μ„λ²„ λ°μ΄ν„°κ°€ μƒλ΅­κ² μ΅°νλμ–΄ ν΄λΌμ΄μ–ΈνΈμ λ°μ΄ν„°κ°€ λ³€κ²½λκ³  ν™”λ©΄μ΄ μƒλ΅­κ² κ·Έλ ¤μ§„λ‹¤.

ν•μ§€λ§, λ§μ•½ μ„λ²„μ— μ—¬λ¬ μ‹μ¤ν…μ΄ μ—°λ™λμ–΄ μμ„ κ²½μ° νΉμ€ μ„λ²„μ—μ„ λ°μ΄ν„° λ³€κ²½μ— λ”λ μ΄κ°€ κ±Έλ¦° κ²½μ°μ—, λ³€κ²½ λ‚΄μ©μ΄ λ°μλμ§€ μ•μ€ μ±„ λ³€κ²½ μ „ λ°μ΄ν„°κ°€ μ΅°νλ  κ°€λ¥μ„±μ΄ μλ‹¤. μ„λ²„κ°€ λΉ„λ™κΈ°λ΅ λ™μ‘ν•κ±°λ‚ μ μ© λλ”λ° μ‹κ°„μ΄ κ±Έλ¦¬λ” κ²½μ°μ΄λ‹¤.

κ°€λ Ή, Google APIμ—μ„ Drive File APIμ— μ‚­μ  μ”μ²­μ„ ν–κ³ , Drive Fileκ³Ό μ—°λ™λμ–΄ μλ” Doc Fileμ„ μ¬μ΅°ν ν•λ‹¤λ©΄ 1μ΄ λ―Έλ§μ ν…€μ„ μ£Όμ–΄μ•Ό μ •μƒμ μΌλ΅ νμΌμ΄ μ‚­μ λ listλ¥Ό λ°›μ•„μ¬ μ μλ‹¤. μ΄λ° κ²½μ°, λ”λ μ΄λ¥Ό μ£Όμ–΄ μ¬μ΅°ν ν•΄μ¤„ μ μλ‹¤.

```ts{2,4}
onSuccess() {
  setTimeout(() => {
    queryClient.invalidateQueries({ queryKey: [DIARY_KEY] });
  }, 800);
}
```

ν•μ§€λ§, μ΄ μ‘μ—…μ„ ν•  κ²½μ° mutationμ‹ λ™μ‘ν–λ, loading spinnerκ°€ ν• λ² λ‚νƒ€λ‚κ³ , λ‹¤μ‹ queryν•  λ• λ‚νƒ€λ‚λ” loading spinnerκ°€ μ΄μ–΄μ„ λ‚νƒ€λ‚λ‹¤.

![loading-spinner-twice](../img/react-query/mutation-after-data-update/loading-spinner-twice.gif)

loading spinnerλ¥Ό λ„μ°λ” μ΅°κ±΄μ„ λ‹¤λ¥΄κ² μ£Όλ©΄ ν•΄κ²°λκ² μ§€λ§, λ”°λ΅ μ²λ¦¬λ¥Ό ν•΄μ£Όμ–΄μ•Ό ν•λ” λ²κ±°λ΅μ›€μ΄ μƒκΈ΄λ‹¤. λ λ‹¤λ¥Έ λ¬Έμ λ„ μλ‹¤. `800ms` μ΄ μ •ν™•ν• μμΉκ°€ μ•„λ‹λ‹¤. μ„λ²„μ μƒνƒμ— λ”°λΌ μ‹κ°„μ„ λ” λ§μ΄ μ¤μ•Όν•  μλ„ μλ‹¤. μ„λ²„μ λ°μ΄ν„°κ°€ μ •ν•©μ„±μ„ λ§μ¶”λ”λ° μ‹κ°„μ΄ κ±Έλ¦¬λ” μƒνƒλΌλ©΄, λ‹¤μ‹ λ³€κ²½λμ§€ μ•μ€ λ°μ΄ν„°κ°€ μ΅°νλ  ν™•λ¥ μ΄ λ†’κΈ° λ•λ¬Έμ΄λ‹¤.

---

2κ°€μ§€ μ¤‘ μ„λ²„ λ°μ΄ν„°λ΅ ν΄λΌμ΄μ–ΈνΈ λ°μ΄ν„°λ¥Ό λ³€κ²½ν•λ” λ°©λ²•μ„ μ•μ•„λ΄¤λ‹¤. Best Caseλ” μ„λ²„μ—μ„ λ³€κ²½λ λ°μ΄ν„°λ¥Ό μ •ν™•ν•κ² responseμ— λ‹΄μ•„ λ‚΄λ ¤μ¤€λ‹¤λ©΄ ν΄λΌμ΄μ–ΈνΈμ—μ„ λ°›μ•„ ν™”λ©΄μ„ μƒλ΅­κ² κ·Έλ ¤μ£Όλ” `setQueryData` λ©”μ„λ“λ¥Ό μ‚¬μ©ν• λ°©λ²•μ΄λ‹¤. ν•μ§€λ§ μ„λ²„μ—μ„ λ°μ΄ν„°λ¥Ό λ‚΄λ ¤μ£Όμ§€ λ»ν•λ” μƒν™©μ΄λΌλ©΄, ν΄λΌμ΄μ–ΈνΈμ—μ„ μ”μ²­μ„ λ³΄λ‚Έ λ°μ΄ν„°λ¥Ό κΈ°λ°μΌλ΅ ν™”λ©΄μ„ κ·Έλ ¤μ£Όλ” λ°©λ²•λ„ μ΅΄μ¬ν•λ‹¤.

<br />

## 2. μ”μ²­ λ°μ΄ν„°λ΅ ν΄λΌμ΄μ–ΈνΈ λ°μ΄ν„° λ³€κ²½

μ”μ²­ ν•  λ• λ³΄λ‚΄λ” ν΄λΌμ΄μ–ΈνΈμ λ°μ΄ν„° κΈ°λ°μΌλ΅ μ¤μ¤λ΅μ λ°μ΄ν„°λ¥Ό λ³€κ²½ν•  μ μλ‹¤.

1. μ§μ ‘ κ°€κ³µ (getQueryData & setQueryData λλ” setQueryData & Updater)
2. λ‚™κ΄€μ  μ—…λ°μ΄νΈ (onMutate)

### 2.1 μ§μ ‘ κ°€κ³µ

#### getQueryData & setQueryData

react-queryμ `getQueryData`λ” μ΅°νν• λ°μ΄ν„° μΊμ‹μ λ°μ΄ν„°λ¥Ό κ°€μ Έμ¤λ” μ‘μ—…μ΄λ‹¤. onSucessμ λ‘ λ²μ§Έ μΈμλ΅, μ”μ²­ μ‹ λ³΄λƒλ κ°’μ„ λ°›μ•„μ¬ μ μλ‹¤.

```ts{2,5}
onSuccess(data, variables) { // variablesλ” mutateν•¨μκ°€ λ°›λ” λ³€μλ‹¤.
  const oldData = queryClient.getQueryData<DriveFile>([DIARY_KEY, 'docList']);
  queryClient.setQueryData<DriveFile>([DIARY_KEY, 'docList'], {
    ...oldData,
    files: oldData?.files.filter(file => file.id !== variables) as File[],
  });
}
```

`getQueryData`λ¥Ό ν†µν•΄ λ³€κ²½λκΈ° μ „ λ°μ΄ν„°λ¥Ό μΊμ‹μ—μ„ μ΅°νν•λ‹¤. κ·Έλ¦¬κ³ , `filter`μ™€ κ°™μ€ λ©”μ„λ“λ΅ μΊμ‹ λ°μ΄ν„°λ¥Ό κ°€κ³µν•λ‹¤. μ΄ν›„μ—, κ°€κ³µν• λ°μ΄ν„°λ¥Ό λ¶λ³€μ„±μ„ μ§€μΌμ„ `setQueryData` λ©”μ„λ“μ μΈμλ΅ λ„£μ–΄μ¤€λ‹¤. κ·Έλ¬λ©΄, ν΄λΌμ΄μ–ΈνΈμ λ°μ΄ν„°κ°€ λ³€κ²½λλ©°, queryλ¥Ό μ„ μ–Έν• μ»΄ν¬λ„νΈκ°€ λ¦¬λ λ”λ§ λλ©΄μ„ ν™”λ©΄μ΄ μƒλ΅­κ² κ·Έλ ¤μ§„λ‹¤.

π“ μ£Όμμ μ€ λ°λ“μ‹ λ¶λ³€μ„±μ„ μ§€μΌμ„ λ„£μ–΄μ£Όμ–΄μ•Ό ν•λ‹¤. λ¶λ³€μ„±μ„ μ§€μΌμ£Όμ§€ μ•μΌλ©΄ ν™”λ©΄μ΄ λ³€κ²½λμ§€ μ•λ”λ‹¤.

λ°μ΄ν„° νλ¦„μ€ μ•„λμ™€ κ°™λ‹¤.

- `ν΄λΌμ΄μ–ΈνΈ -> μ„λ²„` : λ°μ΄ν„° λ³€κ²½ μ”μ²­
- `μ„λ²„ -> ν΄λΌμ΄μ–ΈνΈ` : μ„±κ³µ message λ°ν™
- ν΄λΌμ΄μ–ΈνΈ λ°μ΄ν„° μ¤μ¤λ΅ κ°€κ³µ ν›„ λ³€κ²½

#### setQueryData & Updater

getQueryDataλ¥Ό μ‚¬μ©ν•μ§€ μ•κ³  `setQueryData` λ§ μ‚¬μ©ν•λ” λ°©λ²•μ΄λ‹¤. μ΄ λ°©λ²•μ€ μΊμ‹μ—μ„ λ‹¤μ‹ μ΅°νν•λ” λ΅μ§μ΄ μ—†μ–΄λ„ useMutation μμ²΄μ—μ„ μ κ³µν•λ” λ°©λ²•μ΄λ‹¤. μ—…λ°μ΄ν„° ν•¨μλ¥Ό μ„ μ–Έν•λ©΄ μ•μ•„μ„ ν΄λΌμ΄μ–ΈνΈ λ°μ΄ν„°λ¥Ό λ³€κ²½μ‹μΌμ¤€λ‹¤.

```ts{3-6}
onSuccess(_, variables) {
  queryClient.setQueryData<DriveFile>([DIARY_KEY, 'docList'],
    (oldData): DriveFile => ({
      ...oldData,
      files: oldData?.files.filter(file => file.id !== variables) as File[],
    })
  );
},
```

`setQueryData`μ λ‘λ²μ§Έ μΈμλ΅ ν•¨μλ¥Ό λ„£μ–΄μ¤„ μ μλ”λ°, μ΄κ²ƒμ΄ μ—…λ°μ΄ν„° ν•¨μμ΄λ‹¤. μ—…λ°μ΄ν„° ν•¨μλ” reactμ setState ν•¨μμ™€ μ‚¬μ©λ²•μ΄ λ™μΌν•λ‹¤. μΈμλ΅ κΈ°μ΅΄ μΏΌλ¦¬ν• λ°μ΄ν„°λ¥Ό κ°€μ§€κ³  μ¤λ©°, μΏΌλ¦¬ν• λ°μ΄ν„°λ¥Ό κΈ°λ°μΌλ΅ κ°€κ³µν• κ°’μ„ λ¶λ³€μ„±μ„ μ§€μΌ λ°ν™ν•λ©΄, μΊμ‹λ λ°μ΄ν„°κ°€ μ—…λ°μ΄νΈ λκ³  ν™”λ©΄μ΄ λ¦¬λ λ”λ§ λλ‹¤.

μ²«λ²μ§Έ λ°©λ²•μ²λΌ, μ΅°ν ν• ν›„ μ—…λ°μ΄νΈ ν•κΈ°λ³΄λ‹¤λ” μ—…λ°μ΄ν„° ν•¨μλ¥Ό μ‚¬μ©ν•λ” λ°©λ²•μ΄ μΆ€ λ” κ°„νΈν•λ‹¤κ³  λκ»΄μ§„λ‹¤. λ°μ΄ν„°μ νλ¦„μ€ λ™μΌν•λ‹¤.

### 2.2 λ‚™κ΄€μ  μ—…λ°μ΄νΈ(onMutate)

λ‚™κ΄€μ  μ—…λ°μ΄νΈλ€ λ‹¨μ–΄κ°€ μ–΄μƒ‰ν•κ² λκ»΄μ§ μ μμ§€λ§, λ‚™κ΄€μ μ΄λΌλ” λ§μ€ μ„λ²„λ΅ λ³΄λ‚Έ μ”μ²­μ΄ μ •μƒμ μΌ κ²ƒμ„ μμƒν•κ³ , ν΄λΌμ΄μ–ΈνΈμ λ°μ΄ν„°λ¥Ό λ³€κ²½μ‹μΌ μ”μ²­ responseκ°€ μ¤κΈ° μ „μ— ν΄λΌμ΄μ–ΈνΈμ λ°μ΄ν„°λ¥Ό λ―Έλ¦¬ λ³€κ²½μ‹ν‚¤λ” μ‘μ—…μ„ λ§ν•λ‹¤. μ΄λ” useMutateion ν›…μ—μ„ `onSuccess` λ€μ‹  `onMutate` λ©”μ„λ“μ™€ `onError` λ©”μ„λ“λ¥Ό μ΅°ν•©ν•μ—¬ κµ¬ν„ν•  μ μλ‹¤.

```ts
onMutate: async variables => {
  // refetch λ©”μ„λ“κ°€ μ‚¬μ©λμ§€ μ•λ„λ΅ λ―Έλ¦¬ λ§‰μ•„λ‘ .
  await queryClient.cancelQueries({ queryKey: [DIARY_KEY] });

  const oldData = queryClient.getQueryData<DriveFile>([DIARY_KEY, 'docList']);
  queryClient.setQueryData<DriveFile>([DIARY_KEY, 'docList'], {
    ...oldData,
    files: oldData?.files.filter(file => file.id !== variables) as File[],
  });

  return { oldData };
},
onError: (err, newTodo, context: { oldData: DriveFile }) => {
  // μ—λ¬κ°€ λ°μƒν•λ©΄, κΈ°μ΅΄ λ°μ΄ν„° ν΄λ°±
  queryClient.setQueryData([DIARY_KEY, 'docList'], { ...context.oldData });
},
```

onMutate λ©”μ„λ“ μ•μ—λ” API μ”μ²­μ΄ μ„±κ³µν–μ„ κ²½μ°λ¥Ό κ°€μ •ν•κ³ , λ°μ΄ν„°λ¥Ό κ°€κ³µν•΄ ν™”λ©΄μ„ μ—…λ°μ΄νΈ ν•λ‹¤. νΉμ΄ν• λ¶€λ¶„μ€ `cancelQueries` λ¥Ό μ‚¬μ©ν•λ‹¤λ” μ μΈλ°, cancelQueriesλ” API μ”μ²­ μ΄ν›„μ— λ°μƒν•λ” μ”μ²­μ„ μ·¨μ†ν•λ” λ©”μ„λ“μ΄λ―€λ΅ μ”μ²­μ΄ Errorκ°€ λ°μƒν–λ‹¤λ©΄ refetchκ°€ μΌμ–΄λ‚μ§€ μ•λ„λ΅ λ°©μ§€ν•λ” μ—­ν• μ„ ν•΄μ¤€λ‹¤.

onMutate λ©”μ„λ“μ μ•„λ λ¶€λ¶„μ€ **μΊμ‹ λ°μ΄ν„°λ¥Ό μ§μ ‘ κ°€κ³µ**ν•λ” λ¶€λ¶„κ³Ό λ™μΌν•λ‹¤.

onError λ©”μ„λ“λ” API μ”μ²­μ„ λ³΄λ‚΄ μ„±κ³µμ„ κ°€μ •ν•κ³  ν™”λ©΄μ€ μ—…λ°μ΄νΈ ν–μ§€λ§, μ‹¤ν¨ν• μ‚¬λ΅€μ— λ€ν• μ²λ¦¬ λ΅μ§μ΄ λ“¤μ–΄κ°„λ‹¤. λ§μ•½ μ„λ²„μ—μ„ μ—λ¬λ¥Ό λ°ν™ν–λ‹¤λ©΄ κΈ°μ΅΄ λ°μ΄ν„°λ΅ ν΄λ°±ν•λ‹¤. `context` μ—λ” μ”μ²­μ„ λ³΄λƒμ„ λ‹Ήμ‹μ λ°μ΄ν„°κ°€ λ‹΄κ²¨μλ‹¤.

![optimistic-updates](../img/react-query/mutation-after-data-update/optimistic-updates.gif)

λ°μ΄ν„° νλ¦„μ€ μ•„λμ™€ κ°™λ‹¤.

- `ν΄λΌμ΄μ–ΈνΈ -> μ„λ²„` : λ°μ΄ν„° λ³€κ²½ μ”μ²­
- μ„±κ³µ responseκ°€ λμ•„μ¤μ§€ μ•μ•„λ„, ν΄λΌμ΄μ–ΈνΈ λ°μ΄ν„° μ¤μ¤λ΅ κ°€κ³µ ν›„ λ³€κ²½
  - λ§μ•½ μ‹¤ν¨ μ‹ κΈ°μ΅΄ λ°μ΄ν„°λ΅ ν΄λ°±

---

<br />

## μ •λ¦¬

React Queryμ—μ„ mutation μ΄ν›„ λ°μ΄ν„°λ¥Ό ν†µν•΄ ν™”λ©΄μ„ μ—…λ°μ΄νΈ ν•λ” λ°©λ²•μ€ μ•„λμ™€ κ°™λ‹¤.

- **μ„λ²„μ—μ„** μ΅°νν• λ°μ΄ν„°λ΅ ν΄λΌμ΄μ–ΈνΈ λ°μ΄ν„° μ—…λ°μ΄νΈ
  - responseμ— λ³€κ²½λ λ°μ΄ν„° λ°›κΈ°
  - μ¬μ΅°ν
- **ν΄λΌμ΄μ–ΈνΈμ—μ„** μ”μ²­ λ°μ΄ν„°λ΅ μ μ©
  - μ§μ ‘ κ°€κ³µ
  - λ‚™κ΄€μ  μ—…λ°μ΄νΈ

κ° λ°©λ²•μ— λ”°λΌ μ¥λ‹¨μ μ΄ μκΈ° λ•λ¬Έμ— λ°μ΄ν„°μ μ¤‘μ”λ„μ— λ”°λΌ, μ„λ²„ κ°λ°μμ™€μ μ»¤λ®¤λ‹μΌ€μ΄μ…μ„ ν†µν•΄ μ μ ν• λ°©λ²•μ„ μ„ νƒν•  μ μλ‹¤. λ‚΄κ°€ μƒκ°ν•κΈ°μ— μ–΄λ–¤ μƒν™©μ—μ„ μ‚¬μ©ν•λ©΄ μΆ‹μ„μ§€ μμƒν•΄λ³΄μ•λ‹¤.

- responseμ— λ³€κ²½λ λ°μ΄ν„° λ°›κΈ° : κ°€μ¥ μ •ν™•ν•κ³  μ‹ λΆ°ν• λ§ν• μ—…λ°μ΄νΈ. λ”°λΌμ„ μ¤‘μ”ν• λ°μ΄ν„°λ¥Ό ν‘μ‹ν•΄μ£Όμ–΄μ•Ό ν•λ‹¤λ©΄ μ΄ λ°©λ²•μ„ μ„ νƒν•  κ²ƒμ΄λ‹¤. μλ¥Ό λ“¤μ–΄ λ΅κ·ΈμΈ μ²λ¦¬ νΉμ€ κ²°μ  μ²λ¦¬.
- μ¬μ΅°ν, μ§μ ‘ κ°€κ³µ : μ„λ²„μ μƒν™©μ΄ μΆ‹μ§€ μ•κ±°λ‚, responseκ°€ ν™•μ‹¤ν•λ‹¤κ³  λ³΄μ¥ν•μ§€ λ»ν•  λ•.
- λ‚™κ΄€μ  μ—…λ°μ΄νΈ : λ°μ΄ν„°κ°€ ν¬κ² μ¤‘μ”ν•μ§€ μ•μ§€λ§, μ‚¬μ©μμ—κ² λΉ λ¥Έ ν”Όλ“λ°±μ„ λ³΄μ—¬μ£Όκ³  μ‹¶μ„ λ•. μλ¥Ό λ“¤μ–΄ SNSμ μΆ‹μ•„μ” κΈ°λ¥.

<br />

## λ§μΉλ©°

React Queryμ mutation μ΄ν›„ λ°μ΄ν„° μ²λ¦¬ λ°©λ²•μ— λ€ν•΄μ„ μ•μ•„λ΄¤λ‹¤.

React Queryλ¥Ό μ‚¬μ©ν•μ§€ μ•κ³  μ΄μ „μ— κ°λ°ν•  λ•λ”, λ°μ΄ν„°λ¥Ό νμΉ­ν•  λ• λ¬΄μ΅°κ±΄ λ΅λ”© ν‘μ‹λ¥Ό ν†µν•΄ μ‚¬μ©μμ—κ² κΈ°λ‹¤λ¦¬κ² ν–λ‹¤. ν•μ§€λ§ μ¤‘μ”λ„μ— λ”°λΌ, λ μ„λ²„μ μƒνƒμ— λ”°λΌ μ—¬λ¬ UXλ¥Ό κµ¬ν„ν•  μ μλ‹¤λ” μ μ„ μ•κ² λμ—λ‹¤.

μ„λ²„ λ°μ΄ν„°μ™€ ν΄λΌμ΄μ–ΈνΈ λ°μ΄ν„°λ¥Ό μ„λ΅ κ²©λ¦¬ μ‹μΌ λ‹¤λ£¬λ‹¤λ” κ°λ…λ„ μ‹ μ„ ν–μ§€λ§ λ°μ΄ν„° νμΉ­κ³Ό κ΄€λ ¨λ λΌμ΄λΈλ¬λ¦¬λ΅ νΉν™”λμ–΄ μκΈ° λ•λ¬Έμ— UXμ™€ κ΄€λ ¨λ λ‹¤μ–‘ν• κΈ°λ¥μ΄ κ°λ°λμ§€ μ•μ•λ‚ μƒκ°ν•λ‹¤. νΉν μ‚¬μ©μμ λ””λ°”μ΄μ¤ μ„±λ¥μ΄ μ¬λΌκ°μ— λ”°λΌ μ—¬λ¬ UXλ¥Ό ν‘ν„ν•  μ μκ² λμ—κ³ , λ°μ΄ν„°λ¥Ό μΊμ‹±ν•κ±°λ‚ μ„λ²„μ™€μ λ°μ΄ν„°λ¥Ό 'μ—°λ™' ν•λ‹¤λ” κ°λ…μ΄ μƒκΈ΄ κ²ƒ κ°™λ‹¤. (μ—„λ°€ν λ§ν•λ©΄ μ—°λ™μ€ μ•„λ‹. React Queryμ—μ„λ” requestμ™€ responseκ°€ μ§€μ†μ μΌλ΅ μΌμ–΄λ‚λ” λ§¤μ»¤λ‹μ¦μ„ κ°–κ³  μκΈ° λ•λ¬Έμ΄λ©° μ»¤λ„¥μ…μ„ κ³„μ† κ°€μ§€κ³  μμ§€ μ•κΈ° λ•λ¬Έμ΄λ‹¤.)

> μ°Έκ³ 
>
> - https://tkdodo.eu/blog/mastering-mutations-in-react-query
> - https://tanstack.com/query/latest/docs/react/guides/optimistic-updates
